---
date: 2025-12-28 15:01
aliases:
tags:
---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[]]

---

# C# éåŒæ­¥ç¨‹å¼è¨­è¨ˆ (Async/Await) å®Œæ•´æ•™å­¸æ–‡ä»¶

## ç›®éŒ„

1. [ç‚ºä»€éº¼éœ€è¦éåŒæ­¥ç¨‹å¼è¨­è¨ˆ](https://claude.ai/chat/a1ae2fc6-3d15-47a5-a3a4-ef3d1790d5f5#1-%E7%82%BA%E4%BB%80%E9%BA%BC%E9%9C%80%E8%A6%81%E9%9D%9E%E5%90%8C%E6%AD%A5%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88)
2. [æ ¸å¿ƒè§€å¿µèˆ‡åŸºç¤çŸ¥è­˜](https://claude.ai/chat/a1ae2fc6-3d15-47a5-a3a4-ef3d1790d5f5#2-%E6%A0%B8%E5%BF%83%E8%A7%80%E5%BF%B5%E8%88%87%E5%9F%BA%E7%A4%8E%E7%9F%A5%E8%AD%98)
3. [await çš„å®Œæ•´é‹ä½œæ©Ÿåˆ¶](https://claude.ai/chat/a1ae2fc6-3d15-47a5-a3a4-ef3d1790d5f5#3-await-%E7%9A%84%E5%AE%8C%E6%95%B4%E9%81%8B%E4%BD%9C%E6%A9%9F%E5%88%B6)
4. [åŸ·è¡Œç·’çš„ç”Ÿå‘½é€±æœŸè©³è§£](https://claude.ai/chat/a1ae2fc6-3d15-47a5-a3a4-ef3d1790d5f5#4-%E5%9F%B7%E8%A1%8C%E7%B7%92%E7%9A%84%E7%94%9F%E5%91%BD%E9%80%B1%E6%9C%9F%E8%A9%B3%E8%A7%A3)
5. [ç‹€æ…‹æ©Ÿï¼ˆState Machineï¼‰æ·±å…¥å‰–æ](https://claude.ai/chat/a1ae2fc6-3d15-47a5-a3a4-ef3d1790d5f5#5-%E7%8B%80%E6%85%8B%E6%A9%9Fstate-machine%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90)
6. [éŒ¯èª¤è™•ç†èˆ‡ç•°å¸¸ç®¡ç†](https://claude.ai/chat/a1ae2fc6-3d15-47a5-a3a4-ef3d1790d5f5#6-%E9%8C%AF%E8%AA%A4%E8%99%95%E7%90%86%E8%88%87%E7%95%B0%E5%B8%B8%E7%AE%A1%E7%90%86)
7. [å¯¦å‹™ç¯„ä¾‹èˆ‡æƒ…å¢ƒåˆ†æ](https://claude.ai/chat/a1ae2fc6-3d15-47a5-a3a4-ef3d1790d5f5#7-%E5%AF%A6%E5%8B%99%E7%AF%84%E4%BE%8B%E8%88%87%E6%83%85%E5%A2%83%E5%88%86%E6%9E%90)
8. [æœ€ä½³å¯¦è¸èˆ‡å¸¸è¦‹é™·é˜±](https://claude.ai/chat/a1ae2fc6-3d15-47a5-a3a4-ef3d1790d5f5#8-%E6%9C%80%E4%BD%B3%E5%AF%A6%E8%B8%90%E8%88%87%E5%B8%B8%E8%A6%8B%E9%99%B7%E9%98%B1)

---

## 1. ç‚ºä»€éº¼éœ€è¦éåŒæ­¥ç¨‹å¼è¨­è¨ˆ

### 1.1 åŒæ­¥ vs éåŒæ­¥çš„æœ¬è³ªå·®ç•°

#### ç”Ÿæ´»åŒ–æ¯”å–»

æƒ³åƒä½ åœ¨ä¸€å®¶é¤å»³ç•¶å»šå¸«ï¼š

**åŒæ­¥åŸ·è¡Œï¼ˆSynchronousï¼‰**

- ä½ é»ç«ç…®éºµï¼Œç„¶å¾Œç«™åœ¨çˆç«æ—ç™¼å‘† 5 åˆ†é˜
- é€™æœŸé–“ä½ ä¸èƒ½é»é¤ã€ä¸èƒ½åˆ‡èœï¼Œç›´åˆ°éºµç…®å¥½
- é€™å°±æ˜¯ã€Œé˜»å¡ï¼ˆBlockingï¼‰ã€ï¼Œæ•ˆç‡æ¥µä½

**éåŒæ­¥åŸ·è¡Œï¼ˆAsynchronousï¼‰**

- ä½ é»ç«ç…®éºµï¼Œè¨­å€‹é¬§é˜
- è½‰èº«å»å¹«ä¸‹ä¸€ä½å®¢äººé»é¤
- ç­‰é¬§é˜éŸ¿äº†ï¼Œä½ å†å›ä¾†è™•ç†éºµ
- é€™å°±æ˜¯ `await` çš„ç²¾ç¥ï¼šã€Œä¸ç­‰å¾…ï¼Œå…ˆå»åšåˆ¥çš„äº‹ï¼Œç­‰å¥½äº†å†å›ä¾†ã€

#### æŠ€è¡“å±¤é¢æ¯”è¼ƒ

|ç‰¹æ€§|åŒæ­¥åŸ·è¡Œ|éåŒæ­¥åŸ·è¡Œ (await)|
|---|---|---|
|**åŸ·è¡Œç·’è¡Œç‚º**|æ­»å®ˆç¾å ´ï¼Œç›´åˆ°å·¥ä½œå®Œæˆ|æš«æ”¾å·¥ä½œï¼Œå…ˆå»è™•ç†åˆ¥çš„äº‹|
|**è³‡æºåˆ©ç”¨**|è€—è²»åŸ·è¡Œç·’ç­‰å¾…ï¼Œæµªè²»è³‡æº|é‡‹æ”¾åŸ·è¡Œç·’ï¼Œæé«˜ååé‡|
|**ä½¿ç”¨è€…é«”é©—**|ä»‹é¢å¯èƒ½å¡æ­» (Not Responding)|ä»‹é¢ä¿æŒæµæš¢ï¼Œå¯åŒæ™‚æ“ä½œ|
|**éŒ¯èª¤è™•ç†**|ç›´æ¥æ‹‹å‡ºéŒ¯èª¤|æ‹†é–‹ `AggregateException` å‘ˆç¾åŸè²Œ|

### 1.2 æ ¸å¿ƒè§’è‰²å®šç¾©

åœ¨ç†è§£éåŒæ­¥ç¨‹å¼è¨­è¨ˆæ™‚ï¼Œæˆ‘å€‘å¯ä»¥ç”¨é¤å»³çš„æ¯”å–»ä¾†å°æ‡‰ï¼š

- **åŸ·è¡Œç·’ï¼ˆThreadï¼‰**ï¼šå°±æ˜¯æœå‹™ç”Ÿ ğŸ§‘â€ğŸ³
- **è€—æ™‚ä»»å‹™ï¼ˆTaskï¼‰**ï¼šåƒæ˜¯å»šæˆ¿è£½ä½œä¸€ä»½éœ€è¦çƒ¤ 30 åˆ†é˜çš„æ’é¤
- **await**ï¼šæœå‹™ç”ŸæŠŠé»å–®äº¤çµ¦å»šæˆ¿å¾Œï¼Œè½‰èº«å»æœå‹™å…¶ä»–å®¢äººçš„å‹•ä½œ
- **åŸ·è¡Œç·’æ± ï¼ˆThread Poolï¼‰**ï¼šé¤å»³çš„æœå‹™ç”Ÿåœ˜éšŠ
- **ç‹€æ…‹æ©Ÿï¼ˆState Machineï¼‰**ï¼šæœå‹™ç”Ÿçš„ç­†è¨˜æœ¬ï¼Œè¨˜éŒ„æ¯æ¡Œçš„é€²åº¦

---

## 2. æ ¸å¿ƒè§€å¿µèˆ‡åŸºç¤çŸ¥è­˜

### 2.1 async èˆ‡ await çš„åŸºæœ¬èªæ³•

```csharp
public async Task OrderCoffeeAsync()
{
    Console.WriteLine("1. é–‹å§‹ç…®å’–å•¡...");
    
    // é‡åˆ° awaitï¼šæª¢æŸ¥ç‹€æ…‹ã€ç´€éŒ„ä½ç½®ã€é‡‹æ”¾åŸ·è¡Œç·’
    // æª¢æŸ¥ Task æ˜¯å¦å·²å®Œæˆ
    // ç´€éŒ„å·²åŸ·è¡Œåˆ°çš„ç¨‹å¼ç¢¼ä½ç½®
    // å…ˆé‚è¼¯é‡‹æ”¾(Caller)ï¼Œå†å¯¦é«”é‡‹æ”¾(Thread Pool)
    await Task.Delay(3000); // æ¨¡æ“¬ç…®å’–å•¡éœ€è¦ 3 ç§’
    
    // 3 ç§’å¾Œï¼šå›åˆ°ç‹€æ…‹æ©Ÿç´€éŒ„çš„ä½ç½®ç¹¼çºŒåŸ·è¡Œ
    Console.WriteLine("2. å’–å•¡ç…®å¥½äº†ï¼");
}
```

### 2.2 Task çš„æœ¬è³ª

`Task` ä»£è¡¨ä¸€å€‹å¯èƒ½é‚„æ²’å®Œæˆçš„æ“ä½œï¼Œå®ƒåŒ…å«ï¼š

- æ“ä½œçš„ç‹€æ…‹ï¼ˆæœªé–‹å§‹ã€åŸ·è¡Œä¸­ã€å·²å®Œæˆã€å·²å–æ¶ˆã€ç™¼ç”ŸéŒ¯èª¤ï¼‰
- æ“ä½œçš„çµæœï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
- éŒ¯èª¤è³‡è¨Šï¼ˆå¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼‰

### 2.3 åŸ·è¡Œç·’èˆ‡ Task çš„é—œä¿‚

**é‡è¦è§€å¿µ**ï¼šTask ä¸ç­‰æ–¼ Thread

- ä¸€å€‹ Task å¯èƒ½ç”±å¤šå€‹ Thread æ¥åŠ›å®Œæˆ
- å¤šå€‹ Task å¯èƒ½ç”±åŒä¸€å€‹ Thread è™•ç†
- Task æ˜¯é‚è¼¯ä¸Šçš„å·¥ä½œå–®ä½ï¼ŒThread æ˜¯å¯¦éš›åŸ·è¡Œçš„å·¥äºº

---

## 3. await çš„å®Œæ•´é‹ä½œæ©Ÿåˆ¶

### 3.1 await åŸ·è¡Œæ™‚çš„äº”å€‹éšæ®µ

#### ç¬¬ä¸€éšæ®µï¼šå•Ÿå‹•èˆ‡æª¢æŸ¥

```csharp
// ç•¶ç¨‹å¼åŸ·è¡Œåˆ°é€™è¡Œ
await SomeAsyncMethod();
```

**ç™¼ç”Ÿçš„äº‹æƒ…**ï¼š

1. é¦–å…ˆå‘¼å« `SomeAsyncMethod()`
2. è©²æ–¹æ³•åŸ·è¡Œç›´åˆ°é‡åˆ°å®ƒå…§éƒ¨çš„ç¬¬ä¸€å€‹ `await`
3. æª¢æŸ¥å›å‚³çš„ `Task.IsCompleted`
    - å¦‚æœ `true`ï¼šç›´æ¥åŒæ­¥ç¹¼çºŒåŸ·è¡Œï¼ˆå„ªåŒ–è·¯å¾‘ï¼‰
    - å¦‚æœ `false`ï¼šé€²å…¥æš«åœæµç¨‹

**é—œéµè§€å¯Ÿ**ï¼šä¸æ˜¯çœ‹åˆ° `await` å°±ç«‹åˆ»æš«åœï¼Œè€Œæ˜¯è¦ç­‰æ–¹æ³•å›å‚³ Task ä¸”è©² Task æœªå®Œæˆ

#### ç¬¬äºŒéšæ®µï¼šæš«åœèˆ‡ç´€éŒ„ï¼ˆé€²å…¥ç‹€æ…‹æ©Ÿï¼‰

ç•¶ä»»å‹™å°šæœªå®Œæˆæ™‚ï¼š

**å»ºç«‹ã€Œæ›¸ç±¤ã€**ï¼š

```csharp
// ç·¨è­¯å™¨ç”¢ç”Ÿçš„è™›æ“¬ç¨‹å¼ç¢¼
class GeneratedStateMachine
{
    int state;           // ç›®å‰åŸ·è¡Œåˆ°å“ªå€‹ awaitï¼ˆæ›¸ç±¤é ç¢¼ï¼‰
    TaskAwaiter awaiter; // æ­£åœ¨ç­‰å¾…çš„ä»»å‹™
    
    // å€åŸŸè®Šæ•¸
    string localVar1;
    int localVar2;
    
    // åŸå§‹æ–¹æ³•é‚è¼¯
    void MoveNext() { ... }
}
```

**ç´€éŒ„å…§å®¹**ï¼š

- ç›®å‰åŸ·è¡Œåˆ°å“ªä¸€è¡Œï¼ˆstateï¼‰
- æ‰€æœ‰å€åŸŸè®Šæ•¸çš„å€¼
- æ­£åœ¨ç­‰å¾…çš„ Task åƒè€ƒ

#### ç¬¬ä¸‰éšæ®µï¼šé‡‹æ”¾åŸ·è¡Œç·’

é€™æ˜¯éåŒæ­¥æœ€ç¥å¥‡çš„åœ°æ–¹ï¼ŒåŒ…å«å…©å€‹å±¤æ¬¡ï¼š

**1. é‚è¼¯ä¸Šçš„é‡‹æ”¾**

```csharp
// Thread A æ­£åœ¨åŸ·è¡Œ
await Task.Delay(1000); // <- Thread A åœ¨é€™è£¡ã€Œé‚è¼¯æš«åœã€
// Thread A å°‡æ§åˆ¶æ¬Šäº¤å›çµ¦å‘¼å«è€…
```

- æ–¹æ³•æš«åœåŸ·è¡Œ
- å°‡é€²åº¦ä¿å­˜åœ¨ç‹€æ…‹æ©Ÿ (state)
- å›å‚³ Task çµ¦å‘¼å«è€… (ğŸš¨await æ‰€åœ¨çš„ Task (å°šæœªå®Œæˆ))
- UI å¯ä»¥ç¹¼çºŒå›æ‡‰

**2. å¯¦é«”ä¸Šçš„é‡‹æ”¾**

```csharp
// ç•¶æœ€ä¸Šå±¤çš„æ–¹æ³•ä¹Ÿ await å¾Œ
// Thread A å®Œå…¨æ²’äº‹åšäº†
// Thread A å›åˆ°åŸ·è¡Œç·’æ± 
```

- åŸ·è¡Œç·’å®Œæˆæ‰€æœ‰å­˜æª”å‹•ä½œ
- å›åˆ°åŸ·è¡Œç·’æ± å¾…å‘½
- å¯ä»¥å»è™•ç†å…¶ä»–è«‹æ±‚

#### ç¬¬å››éšæ®µï¼šä»»å‹™å®Œæˆèˆ‡å›æ­¸

```csharp
// 1 ç§’å¾Œï¼Œè¨ˆæ™‚å™¨å®Œæˆ
// è¨ˆæ™‚å™¨é€é callback æ–¹å¼é€šçŸ¥ç‹€æ…‹æ©Ÿï¼šã€Œæ™‚é–“åˆ°äº†ï¼Œå¯ä»¥ç¹¼çºŒäº†ã€
// ç‹€æ…‹æ©Ÿè«‹ Thread Poolï¼šã€Œçµ¦æˆ‘ä¸€å€‹åŸ·è¡Œç·’ä¾†ç¹¼çºŒå·¥ä½œã€
// Thread Pool æ´¾å‡º Thread B
// Thread B è®€å–ç‹€æ…‹æ©Ÿè¨˜éŒ„çš„ã€Œæ›¸ç±¤ã€ï¼ˆåœ¨å“ªå€‹ await æš«åœï¼‰
// Thread B æ¢å¾©æ‰€æœ‰è®Šæ•¸ï¼Œå¾ await ä¸‹ä¸€è¡Œç¹¼çºŒåŸ·è¡Œ
```

**åŸ·è¡Œç·’çš„é¸æ“‡**ï¼š

- å¯èƒ½æ˜¯åŸæœ¬çš„ Thread Aï¼ˆå¦‚æœå®ƒå‰›å¥½æœ‰ç©ºï¼‰
- å¯èƒ½æ˜¯ä»»ä½•å…¶ä»–åŸ·è¡Œç·’
- ç”±åŸ·è¡Œç·’æ± è‡ªå‹•èª¿åº¦

#### ç¬¬äº”éšæ®µï¼šéŒ¯èª¤è™•ç†ï¼ˆæ‹†ç®±ä½œæ¥­ï¼‰

```csharp
try
{
    await SomeMethodThatThrows();
}
catch (FileNotFoundException ex) // ç›´æ¥æ•æ‰åŸå§‹ç•°å¸¸
{
    // await å·²ç¶“å¹«ä½ å¾ AggregateException æ‹†å‡ºçœŸæ­£çš„éŒ¯èª¤
}
```

**æ‹†ç®±éç¨‹**ï¼š

1. éåŒæ­¥ä»»å‹™çš„éŒ¯èª¤æœƒè¢«åŒ…åœ¨ `AggregateException`
2. `await` è‡ªå‹•è§£åŒ…ï¼Œå–å‡ºç¬¬ä¸€å€‹ï¼ˆé€šå¸¸ä¹Ÿæ˜¯å”¯ä¸€çš„ï¼‰å…§éƒ¨ç•°å¸¸
3. è®“ä½ ç”¨å‚³çµ± try-catch è™•ç†

### 3.2 await çš„é¡å¤–å·¥ä½œ

#### æ•æ‰ä¸Šä¸‹æ–‡ï¼ˆCapture Contextï¼‰

```csharp
// åœ¨ UI åŸ·è¡Œç·’ä¸Š
await DownloadDataAsync();
// await æœƒè©¦åœ–å›åˆ° UI åŸ·è¡Œç·’
UpdateUI(); // é€™æ¨£æ‰èƒ½å®‰å…¨æ›´æ–°ä»‹é¢
```

**SynchronizationContext çš„è§’è‰²**ï¼š

- è¨˜ä½åŸæœ¬çš„åŸ·è¡Œç’°å¢ƒï¼ˆUI åŸ·è¡Œç·’ã€ASP.NET è«‹æ±‚ç­‰ï¼‰
- ä»»å‹™å®Œæˆå¾Œç›¡é‡å›åˆ°ç›¸åŒç’°å¢ƒ
- å¯ç”¨ `ConfigureAwait(false)` é—œé–‰æ­¤è¡Œç‚º

---

## 4. åŸ·è¡Œç·’çš„ç”Ÿå‘½é€±æœŸè©³è§£

### 4.1 å®Œæ•´ç¯„ä¾‹ç¨‹å¼ç¢¼

```csharp
static async Task Main()
{
    Console.WriteLine("Line-1");
    await ProcessData();
    Console.WriteLine("Line-2");
}

static async Task ProcessData()
{
    Console.WriteLine("Line-3");
    await DoHeavyWorkAsync();
    Console.WriteLine("Line-4");
}

static async Task DoHeavyWorkAsync()
{
    Console.WriteLine("Line-5");
    await Task.Delay(1000);
    Console.WriteLine("Line-6");
}
```

### 4.2 åŸ·è¡Œæµç¨‹è©³ç´°åˆ†è§£

#### éšæ®µä¸€ï¼šåŒæ­¥é–‹å§‹ï¼ˆä¸€è·¯å‘ä¸‹ï¼‰

|æ­¥é©Ÿ|ç¨‹å¼ç¢¼|åŸ·è¡Œç·’|èªªæ˜|
|---|---|---|---|
|1|`Console.WriteLine("Line-1")`|Thread A|Main é–‹å§‹åŸ·è¡Œ|
|2|`await ProcessData()`|Thread A|**é€²å…¥** ProcessDataï¼ˆé‚„æ²’æš«åœï¼‰|
|3|`Console.WriteLine("Line-3")`|Thread A|ç¹¼çºŒåŒæ­¥åŸ·è¡Œ|
|4|`await DoHeavyWorkAsync()`|Thread A|**é€²å…¥** DoHeavyWorkAsync|
|5|`Console.WriteLine("Line-5")`|Thread A|ä»ç„¶åŒæ­¥åŸ·è¡Œ|

**é—œéµè§€å¿µ**ï¼šå³ä½¿ç¶“éå¤šå€‹ async æ–¹æ³•ï¼Œ<mark style="background: #FFF3A3A6;">åœ¨ç¢°åˆ°ç¬¬ä¸€å€‹ã€ŒçœŸæ­£éœ€è¦ç­‰å¾…ã€çš„æ“ä½œå‰ï¼Œéƒ½æ˜¯åŒä¸€å€‹åŸ·è¡Œç·’åœ¨åŸ·è¡Œ</mark>

#### éšæ®µäºŒï¼šæš«åœèˆ‡é€£é–é‡‹æ”¾

```
åŸ·è¡Œæµç¨‹åœ–ï¼š
Thread A åŸ·è¡Œè·¯å¾‘ï¼šMain â†’ ProcessData â†’ DoHeavyWorkAsync
                                              â†“
                                    await Task.Delay(1000) â† æ’ç‰†äº†ï¼
                                              â†“
                          DoHeavyWorkAsync å›å‚³ Taskï¼ˆæœªå®Œæˆï¼‰/ ä¸æ˜¯ await å›å‚³ Taskï¼ˆæœªå®Œæˆï¼‰
                                              â†“
                            ProcessData æ”¶åˆ°æœªå®Œæˆçš„ Task
                                              â†“
                              ProcessData ä¹Ÿå›å‚³ Task
                                              â†“
                                Main æ”¶åˆ°æœªå®Œæˆçš„ Task
                                              â†“
                              Thread A å›åˆ°åŸ·è¡Œç·’æ± 
```

#### éšæ®µä¸‰ï¼šæ¢å¾©åŸ·è¡Œï¼ˆé€£è²«æ€§ï¼‰

```
1000ms å¾Œ...
è¨ˆæ™‚å™¨ï¼šã€Œæ™‚é–“åˆ°äº†ï¼ã€
åŸ·è¡Œç·’æ± ï¼šã€ŒThread Bï¼Œä½ å»è™•ç†ã€

Thread B çš„åŸ·è¡Œè·¯å¾‘ï¼š
1. è®€å– DoHeavyWorkAsync çš„ç‹€æ…‹æ©Ÿ â†’ åŸ·è¡Œ Line-6
2. DoHeavyWorkAsync å®Œæˆ â†’ è§¸ç™¼ ProcessData çš„ await
3. ç¹¼çºŒåŸ·è¡Œ Line-4ï¼ˆThread B æ²’æœ‰å›æ± å­ï¼‰
4. ProcessData å®Œæˆ â†’ è§¸ç™¼ Main çš„ await
5. ç¹¼çºŒåŸ·è¡Œ Line-2ï¼ˆThread B ä¸€è·¯åšåˆ°åº•ï¼‰
```

**é‡è¦è§€å¯Ÿ**ï¼š<mark style="background: #FFF3A3A6;">Thread B æœƒç›¡å¯èƒ½æŠŠæ‰€æœ‰å¾ŒçºŒå·¥ä½œä¸€æ¬¡å®Œæˆï¼Œä¸æœƒæ¯å€‹ await éƒ½æ›åŸ·è¡Œç·’</mark>

### 4.3 åŸ·è¡Œç·’é‡‹æ”¾çš„è©³ç´°æ™‚æ©Ÿ

|ç¨‹å¼ç¢¼éšæ®µ|åŸ·è¡Œè€…|ç‹€æ…‹è®Šæ›´|è©³ç´°èªªæ˜|
|---|---|---|---|
|é–‹å§‹åŸ·è¡Œ|Thread A|**ä½”ç”¨ä¸­**|åŸ·è¡Œ Line-1, 3, 5|
|`await Task.Delay`|Thread A|**é‡‹æ”¾ä¸­**|é‡åˆ°æœªå®Œæˆä»»å‹™ï¼Œé–‹å§‹å­˜æª”|
|é€£é–é‡‹æ”¾|Thread A|**é‡‹æ”¾ä¸­**|æ²¿å‘¼å«å †ç–Šå›å‚³ Task|
|å›åˆ°æ± å­|Thread A|**å·²é‡‹æ”¾**|Thread A å¯è™•ç†å…¶ä»–è«‹æ±‚|
|ç­‰å¾…æœŸé–“|(ç„¡)|**æš«åœ**|åªæœ‰è¨ˆæ™‚å™¨åœ¨è·‘|
|ä»»å‹™å®Œæˆ|Thread B|**é‡æ–°æŒ‡æ´¾**|å¾æ± å­æ´¾å‡ºæœ‰ç©ºçš„åŸ·è¡Œç·’|
|ç¹¼çºŒåŸ·è¡Œ|Thread B|**ä½”ç”¨ä¸­**|åŸ·è¡Œ Line-6, 4, 2|

---

## 5. ç‹€æ…‹æ©Ÿï¼ˆState Machineï¼‰æ·±å…¥å‰–æ

### 5.1 ç‹€æ…‹æ©Ÿçš„çµ„æˆçµæ§‹

ç·¨è­¯å™¨æœƒå°‡ä½ çš„ async æ–¹æ³•è½‰æ›æˆé¡ä¼¼é€™æ¨£çš„çµæ§‹ï¼š

```csharp
// åŸå§‹ç¨‹å¼ç¢¼
public async Task<int> CalculateAsync(int x)
{
    int temp = x * 2;
    await Task.Delay(1000);
    return temp + 10;
}

// ç·¨è­¯å™¨ç”¢ç”Ÿçš„ç‹€æ…‹æ©Ÿï¼ˆç°¡åŒ–ç‰ˆï¼‰
struct CalculateAsync_StateMachine
{
    // ç‹€æ…‹è¿½è¹¤
    public int state;
    public AsyncTaskMethodBuilder<int> builder;
    
    // åƒæ•¸å’Œå€åŸŸè®Šæ•¸
    public int x;
    public int temp;
    
    // ç­‰å¾…å™¨
    private TaskAwaiter delayAwaiter;
    
    // æ ¸å¿ƒæ–¹æ³•
    public void MoveNext()
    {
        int result;
        try
        {
            switch (state)
            {
                case -1: // åˆå§‹ç‹€æ…‹
                    temp = x * 2;
                    delayAwaiter = Task.Delay(1000).GetAwaiter();
                    
                    if (!delayAwaiter.IsCompleted)
                    {
                        state = 0; // è¨˜ä½ä½ç½®
                        // è¨»å†Šå›å‘¼ï¼Œç„¶å¾Œè¿”å›
                        return;
                    }
                    break;
                    
                case 0: // å¾ await æ¢å¾©
                    delayAwaiter.GetResult(); // æª¢æŸ¥æ˜¯å¦æœ‰ç•°å¸¸
                    break;
            }
            
            result = temp + 10;
            builder.SetResult(result);
        }
        catch (Exception ex)
        {
            builder.SetException(ex);
        }
    }
}
```

### 5.2 ç‹€æ…‹æ©Ÿçš„å››å¤§åŠŸèƒ½

#### 1. å€åŸŸè®Šæ•¸çš„ã€Œä¿éšªç®±ã€

- **å•é¡Œ**ï¼šåŸ·è¡Œç·’é›¢é–‹å¾Œï¼ŒStack ä¸Šçš„è®Šæ•¸æœƒæ¶ˆå¤±
- **è§£æ±º**ï¼šç‹€æ…‹æ©Ÿå°‡è®Šæ•¸å­˜åœ¨ Heap ä¸Š
- **æ•ˆæœ**ï¼šä¸åŒåŸ·è¡Œç·’å¯ä»¥å­˜å–ç›¸åŒè³‡æ–™

#### 2. ç¨‹å¼ç¢¼çš„ã€Œæ›¸ç±¤ã€

ç‹€æ…‹å€¼çš„æ„ç¾©ï¼š

- `-1`ï¼šæ–¹æ³•å‰›é–‹å§‹åŸ·è¡Œ
- `0`ï¼šåœåœ¨ç¬¬ä¸€å€‹ await
- `1`ï¼šåœåœ¨ç¬¬äºŒå€‹ await
- `...`ï¼šä¾æ­¤é¡æ¨
- `-2`ï¼šæ–¹æ³•åŸ·è¡Œå®Œç•¢

#### 3. ã€Œä¸‹ä¸€æ­¥ã€çš„è¯ç¹«æ–¹å¼

```csharp
// ç‹€æ…‹æ©ŸæŒæœ‰ TaskAwaiter
// ç•¶ Task å®Œæˆæ™‚ï¼Œæœƒå‘¼å« MoveNext
awaiter.OnCompleted(() => stateMachine.MoveNext());
```

#### 4. æ–¹æ³•æœ¬èº«çš„ç‹€æ…‹ç®¡ç†

- æ›´æ–° `Task.Status`
- è¨­å®š `Task.Result`ï¼ˆå¦‚æœæœ‰å›å‚³å€¼ï¼‰
- è¨˜éŒ„ `Task.Exception`ï¼ˆå¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼‰

### 5.3 ç‚ºä»€éº¼éœ€è¦ç‹€æ…‹æ©Ÿï¼Ÿ

|å•é¡Œ|ç‹€æ…‹æ©Ÿçš„è§£æ±ºæ–¹æ¡ˆ|
|---|---|
|åŸ·è¡Œç·’åˆ‡æ›å¾Œå¦‚ä½•ç¹¼çºŒï¼Ÿ|state æ¬„ä½è¨˜ä½åŸ·è¡Œä½ç½®|
|å€åŸŸè®Šæ•¸æœƒæ¶ˆå¤±ï¼Ÿ|è®Šæ•¸è®Šæˆç‹€æ…‹æ©Ÿçš„æ¬„ä½|
|å¦‚ä½•çŸ¥é“ä»»å‹™å®Œæˆï¼Ÿ|TaskAwaiter è¨»å†Šå›å‘¼|
|éŒ¯èª¤å¦‚ä½•å‚³éï¼Ÿ|é€é builder.SetException|

---

## 6. éŒ¯èª¤è™•ç†èˆ‡ç•°å¸¸ç®¡ç†

### 6.1 await èˆ‡ try-catch çš„æ­£ç¢ºé…ç½®

#### æ­£ç¢ºç¯„ä¾‹ï¼šawait åœ¨ try å…§

```csharp
public async Task ProcessUserAction()
{
    try 
    {
        // âœ… æ­£ç¢ºï¼šå°‡ await æ”¾åœ¨ try è£¡é¢
        await OrderCoffeeAsync(); 
        
        Console.WriteLine("3. äº¤ä»˜å’–å•¡çµ¦å®¢äººã€‚");
    }
    catch (Exception ex) 
    {
        Console.WriteLine($"[éŒ¯èª¤è™•ç†] ç™¼ç”Ÿäº†ç‹€æ³ï¼š{ex.Message}");
    }
}
```

#### éŒ¯èª¤ç¯„ä¾‹ï¼šawait åœ¨ try å¤–

```csharp
public async Task ProcessUserAction()
{
    // âŒ éŒ¯èª¤ï¼šawait åœ¨ try å¤–é¢
    await OrderCoffeeAsync();
    
    try 
    {
        Console.WriteLine("3. äº¤ä»˜å’–å•¡çµ¦å®¢äººã€‚");
    }
    catch (Exception ex) 
    {
        // å¦‚æœ OrderCoffeeAsync å‡ºéŒ¯ï¼Œé€™è£¡æŠ“ä¸åˆ°ï¼
    }
}
```

### 6.2 ç‚ºä»€éº¼ä½ç½®é€™éº¼é‡è¦ï¼Ÿ

**ç”Ÿæ´»åŒ–æ¯”å–»**ï¼š

- **éŒ¯èª¤ç¤ºç¯„**ï¼šä½ åœ¨é–€å£ç­‰å¿«éï¼Œç­‰å¿«éå“¡æŠŠæ±è¥¿äº¤çµ¦ä½ å¾Œï¼Œæ‰é€²å±‹æº–å‚™è™•ç†å·¥å…·ã€‚å¦‚æœå¿«éå“¡èªªã€ŒåŒ…è£¹å¼„ä¸Ÿäº†ã€ï¼Œä½ é‚„æ²’é€²å±‹ï¼Œæ²’è¾¦æ³•è™•ç†ã€‚
- **æ­£ç¢ºåšæ³•**ï¼šä½ å…ˆæº–å‚™å¥½è™•ç†å·¥å…·ï¼Œç„¶å¾Œåœ¨é€™ç¨®ç‹€æ…‹ä¸‹å»é–€å£ç­‰å¿«éã€‚ä¸€æ—¦å¿«éå“¡èªªæœ‰å•é¡Œï¼Œç«‹åˆ»å°±èƒ½è™•ç†ã€‚

### 6.3 ç«å¾Œä¸ç†ï¼ˆFire and Forgetï¼‰çš„å•é¡Œ

#### å•é¡Œç¯„ä¾‹

```csharp
static async Task ProcessData()
{
    Console.WriteLine("Line-3");
    DoHeavyWorkAsync();  // æ²’æœ‰ awaitï¼
    Console.WriteLine("Line-4");
}

static async Task DoHeavyWorkAsync()
{
    Console.WriteLine("Line-5");
    await Task.Delay(1000);
    throw new Exception("ç³Ÿç³•ï¼");  // é€™å€‹éŒ¯èª¤æœƒæ¶ˆå¤±
    Console.WriteLine("Line-6");
}
```

**å•é¡Œåˆ†æ**ï¼š

1. `DoHeavyWorkAsync` å›å‚³çš„ Task ç„¡äººèªé ˜
2. ç•°å¸¸è¢«å›°åœ¨ Task.Exception å±¬æ€§è£¡
3. æ²’æœ‰ await æˆ– .Result ä¾†è§¸ç™¼ç•°å¸¸æ‹‹å‡º
4. ç¨‹å¼å¯èƒ½å®Œå…¨ä¸çŸ¥é“å‡ºééŒ¯

#### è§£æ±ºæ–¹æ¡ˆä¸€ï¼šå»¶å¾Œ await

```csharp
static async Task ProcessData()
{
    Console.WriteLine("Line-3");
    
    // å…ˆå­˜ä¸‹ Taskï¼Œä½†ä¸ç«‹åˆ» await
    Task heavyTask = DoHeavyWorkAsync(); 
    
    // å¯ä»¥å…ˆåšå…¶ä»–äº‹
    Console.WriteLine("Line-4"); 
    await Task.Run(() => ReportWork());
    Console.WriteLine("Line-7");
    
    // æœ€å¾Œè¨˜å¾—è¦è² è²¬
    await heavyTask; // å¦‚æœæœ‰éŒ¯èª¤ï¼Œæœƒåœ¨é€™è£¡æ‹‹å‡º
}
```

#### è§£æ±ºæ–¹æ¡ˆäºŒï¼šå…§éƒ¨è™•ç†

```csharp
static async Task DoHeavyWorkAsync()
{
    try 
    {
        Console.WriteLine("Line-5");
        await Task.Delay(1000);
        // å¯èƒ½ç™¼ç”Ÿçš„éŒ¯èª¤
    }
    catch (Exception ex)
    {
        // è‡ªå·±è™•ç†ï¼Œç¢ºä¿éŒ¯èª¤è¢«è¨˜éŒ„
        Console.WriteLine($"[éŒ¯èª¤ç´€éŒ„]: {ex.Message}");
    }
}
```

### 6.4 ç•°å¸¸é¡å‹çš„å·®ç•°

|å­˜å–æ–¹å¼|ç•°å¸¸é¡å‹|ç¯„ä¾‹ç¨‹å¼ç¢¼|
|---|---|---|
|`await task`|åŸå§‹ç•°å¸¸|`catch (FileNotFoundException)`|
|`task.Wait()`|AggregateException|`catch (AggregateException)`|
|`task.Result`|AggregateException|`catch (AggregateException)`|
|ä¸å­˜å–|ç„¡ï¼ˆéŒ¯èª¤éºå¤±ï¼‰|æ°¸é ä¸æœƒè§¸ç™¼ catch|

---

## 7. å¯¦å‹™ç¯„ä¾‹èˆ‡æƒ…å¢ƒåˆ†æ

### 7.1 UI æ‡‰ç”¨ç¨‹å¼ç¯„ä¾‹

```csharp
public partial class MainForm : Form
{
    private async void btnDownload_Click(object sender, EventArgs e)
    {
        try
        {
            // åœç”¨æŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
            btnDownload.Enabled = false;
            lblStatus.Text = "ä¸‹è¼‰ä¸­...";
            
            // éåŒæ­¥ä¸‹è¼‰ï¼ŒUI ä¸æœƒå‡çµ
            string content = await DownloadFileAsync("https://example.com/data.json");
            
            // è‡ªå‹•å›åˆ° UI åŸ·è¡Œç·’
            txtContent.Text = content;
            lblStatus.Text = "ä¸‹è¼‰å®Œæˆï¼";
        }
        catch (Exception ex)
        {
            MessageBox.Show($"ä¸‹è¼‰å¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            btnDownload.Enabled = true;
        }
    }
    
    private async Task<string> DownloadFileAsync(string url)
    {
        using (var client = new HttpClient())
        {
            // çœŸæ­£çš„éåŒæ­¥ I/O æ“ä½œ
            return await client.GetStringAsync(url);
        }
    }
}
```

### 7.2 Web API ç¯„ä¾‹

```csharp
[ApiController]
[Route("[controller]")]
public class WeatherController : ControllerBase
{
    private readonly IWeatherService _weatherService;
    private readonly ILogger<WeatherController> _logger;
    
    public WeatherController(IWeatherService weatherService, ILogger<WeatherController> logger)
    {
        _weatherService = weatherService;
        _logger = logger;
    }
    
    [HttpGet("{city}")]
    public async Task<ActionResult<WeatherData>> GetWeather(string city)
    {
        try
        {
            // å¯èƒ½åŒæ™‚è™•ç†å¤šå€‹è«‹æ±‚
            _logger.LogInformation($"ç²å– {city} çš„å¤©æ°£è³‡æ–™");
            
            // éåŒæ­¥å‘¼å«å¤–éƒ¨ API
            var weatherData = await _weatherService.GetWeatherAsync(city);
            
            // éåŒæ­¥å¯«å…¥å¿«å–
            await CacheService.SetAsync($"weather:{city}", weatherData);
            
            return Ok(weatherData);
        }
        catch (CityNotFoundException)
        {
            return NotFound($"æ‰¾ä¸åˆ°åŸå¸‚ï¼š{city}");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç²å–å¤©æ°£è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            return StatusCode(500, "å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤");
        }
    }
}
```

### 7.3 ä¸¦è¡Œè™•ç†ç¯„ä¾‹

```csharp
public async Task ProcessMultipleFilesAsync(string[] filePaths)
{
    // æ–¹æ³•ä¸€ï¼šä¾åºè™•ç†ï¼ˆè¼ƒæ…¢ï¼‰
    foreach (var path in filePaths)
    {
        await ProcessFileAsync(path);
    }
    
    // æ–¹æ³•äºŒï¼šä¸¦è¡Œè™•ç†ï¼ˆè¼ƒå¿«ï¼‰
    var tasks = filePaths.Select(path => ProcessFileAsync(path));
    await Task.WhenAll(tasks);
    
    // æ–¹æ³•ä¸‰ï¼šé™åˆ¶ä¸¦è¡Œåº¦
    var semaphore = new SemaphoreSlim(3); // æœ€å¤š 3 å€‹ä¸¦è¡Œ
    var tasks = filePaths.Select(async path =>
    {
        await semaphore.WaitAsync();
        try
        {
            await ProcessFileAsync(path);
        }
        finally
        {
            semaphore.Release();
        }
    });
    await Task.WhenAll(tasks);
}
```

---

## 8. æœ€ä½³å¯¦è¸èˆ‡å¸¸è¦‹é™·é˜±

### 8.1 æœ€ä½³å¯¦è¸

#### 1. Async All the Way

```csharp
// âœ… å¥½ï¼šä¸€è·¯ async
public async Task<string> GetDataAsync()
{
    return await FetchFromDatabaseAsync();
}

// âŒ å£ï¼šæ··ç”¨åŒæ­¥å’ŒéåŒæ­¥
public string GetData()
{
    return FetchFromDatabaseAsync().Result; // å¯èƒ½æ­»é–ï¼
}
```

#### 2. ä½¿ç”¨ ConfigureAwait

```csharp
// åœ¨ç¨‹å¼åº«ä¸­ï¼Œé€šå¸¸ä¸éœ€è¦å›åˆ°åŸå§‹ä¸Šä¸‹æ–‡
public async Task<string> GetDataAsync()
{
    return await FetchFromDatabaseAsync()
        .ConfigureAwait(false); // æå‡æ•ˆèƒ½
}
```

#### 3. å–æ¶ˆæ”¯æ´

```csharp
public async Task<string> DownloadAsync(string url, CancellationToken cancellationToken)
{
    using (var client = new HttpClient())
    {
        var response = await client.GetAsync(url, cancellationToken);
        return await response.Content.ReadAsStringAsync();
    }
}
```

### 8.2 å¸¸è¦‹é™·é˜±

#### 1. async void çš„å±éšª

```csharp
// âŒ å±éšªï¼šasync void
public async void ProcessData()
{
    await Task.Delay(1000);
    throw new Exception("é€™å€‹éŒ¯èª¤æœƒè®“ç¨‹å¼å´©æ½°ï¼");
}

// âœ… å®‰å…¨ï¼šasync Task
public async Task ProcessDataAsync()
{
    await Task.Delay(1000);
    throw new Exception("é€™å€‹éŒ¯èª¤å¯ä»¥è¢«æ•æ‰");
}
```

**è¦å‰‡**ï¼šé™¤äº†äº‹ä»¶è™•ç†å™¨ï¼Œæ°¸é ä½¿ç”¨ `async Task`

#### 2. æ­»é–å•é¡Œ

```csharp
// âŒ åœ¨ UI æˆ– ASP.NET ä¸­å¯èƒ½æ­»é–
public void ButtonClick()
{
    var result = GetDataAsync().Result; // æ­»é–ï¼
}

// âœ… æ­£ç¢ºåšæ³•
public async void ButtonClick()
{
    var result = await GetDataAsync();
}
```

#### 3. å¿˜è¨˜ await

```csharp
// âŒ å¿˜è¨˜ await
public async Task ProcessAsync()
{
    DoSomethingAsync(); // Fire and forgetï¼ŒéŒ¯èª¤æœƒéºå¤±
}

// âœ… è¨˜å¾— await
public async Task ProcessAsync()
{
    await DoSomethingAsync();
}
```

### 8.3 æ•ˆèƒ½è€ƒé‡

#### 1. ValueTask vs Task

```csharp
// ç•¶çµæœç¶“å¸¸å·²ç¶“å¯ç”¨æ™‚ï¼Œä½¿ç”¨ ValueTask
public async ValueTask<int> GetCachedValueAsync()
{
    if (_cache.TryGetValue(key, out var value))
        return value; // ä¸æœƒé…ç½® Task ç‰©ä»¶
    
    return await LoadFromDatabaseAsync();
}
```

#### 2. é¿å…ä¸å¿…è¦çš„ async

```csharp
// âŒ ä¸å¿…è¦çš„ async/await
public async Task<string> GetNameAsync()
{
    return await Task.FromResult("Name");
}

// âœ… ç›´æ¥å›å‚³ Task
public Task<string> GetNameAsync()
{
    return Task.FromResult("Name");
}
```

---

## ç¸½çµ

éåŒæ­¥ç¨‹å¼è¨­è¨ˆçš„æ ¸å¿ƒåƒ¹å€¼åœ¨æ–¼ã€Œç­‰å¾…ä½†ä¸ç©ºç­‰ã€ã€‚é€éç‹€æ…‹æ©Ÿçš„æ©Ÿåˆ¶ï¼Œ.NET è®“æˆ‘å€‘èƒ½ç”¨å¯«åŒæ­¥ç¨‹å¼çš„ç›´è¦ºï¼Œå¯«å‡ºé«˜æ•ˆèƒ½çš„éåŒæ­¥ç¨‹å¼ã€‚

### é—œéµè¦é»å›é¡§

1. **åŸ·è¡Œç·’çš„ç”Ÿå‘½é€±æœŸ**ï¼šåŒæ­¥èµ·è·‘ â†’ é‡åˆ°ç­‰å¾… â†’ å­˜æª”é‡‹æ”¾ â†’ ä»»å‹™å®Œæˆ â†’ æ¢å¾©åŸ·è¡Œ
2. **ç‹€æ…‹æ©Ÿçš„è§’è‰²**ï¼šä¿å­˜è®Šæ•¸ã€è¨˜éŒ„ä½ç½®ã€ç®¡ç†çºŒæ¥
3. **éŒ¯èª¤è™•ç†åŸå‰‡**ï¼šawait å¿…é ˆåœ¨ try å…§ã€é¿å… fire-and-forget
4. **æœ€ä½³å¯¦è¸**ï¼šAsync all the wayã€æ­£ç¢ºä½¿ç”¨ ConfigureAwaitã€æ”¯æ´å–æ¶ˆ

è¨˜ä½ï¼šé€™å¥—ã€Œé»é¤ â†’ å›æ«ƒå° â†’ èª°æœ‰ç©ºèª°é€é¤ã€çš„é‚è¼¯ï¼Œå°±æ˜¯ .NET é”åˆ°é«˜æ•ˆèƒ½èˆ‡é«˜ååé‡çš„ç§˜å¯†ã€‚