---
date : 2025-10-20 17:39
aliases:
  - åˆ¥åæ¸¬è©¦1
  - åˆ¥åæ¸¬è©¦2
tags:
  - æ¨™ç±¤æ¸¬è©¦1
  - æ¨™ç±¤æ¸¬è©¦2

---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[]]

---

# C# SynchronizationContext èˆ‡ async/await å®Œæ•´ç­†è¨˜

## ç›®éŒ„

- [[#1. æ ¸å¿ƒå•é¡Œï¼šç‚ºä»€éº¼éœ€è¦ SynchronizationContext]]
- [[#2. SynchronizationContext é‹ä½œåŸç†]]
- [[#3. å¾æ‰‹å‹•æ“ä½œåˆ° async/await è‡ªå‹•åŒ–]]
- [[#4. AspNetSynchronizationContext çš„è§’è‰²]]
- [[#5. ConfigureAwait(false) çš„é‡è¦æ€§]]
- [[#6. æ­»çµ (Deadlock) å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ]]
- [[#7. æ‰‹å‹•å¯¦ä½œï¼šé‚„åŸ async/await çš„èªæ³•ç³–]]
- [[#8. ContinueWith çš„éé˜»å¡ç‰¹æ€§]]
- [[#9. Task.Delay vs Task.Run + Thread.Sleep]]
- [[#10. ä¸åŒç’°å¢ƒçš„ SynchronizationContext è¡Œç‚º]]

---

## 1. æ ¸å¿ƒå•é¡Œï¼šç‚ºä»€éº¼éœ€è¦ SynchronizationContext

### ç”Ÿæ´»æ¯”å–»ï¼šé¤å»³å»šæˆ¿

**ä¸»å»š (Head Chef) = UI åŸ·è¡Œç·’ (UI Thread)**

- å”¯ä¸€èƒ½å¤ å°æœ€çµ‚çš„èœé¤šï¼ˆUI æ§åˆ¶é …ï¼‰é€²è¡Œæ“ºç›¤å’Œè£é£¾çš„äºº
- å¿…é ˆç¢ºä¿å“è³ªä¸€è‡´ï¼Œç”±ä»–å…¨æ¬Šè² è²¬

**å‚™æ–™å»šå¸« (Prep Cook) = èƒŒæ™¯åŸ·è¡Œç·’ (Background Thread)**

- åœ¨å»šæˆ¿å¦ä¸€å€è² è²¬æ´—èœã€åˆ‡èœã€è™•ç†é£Ÿæ
- åˆ†æ“”ä¸»å»šçš„å¤§é‡å·¥ä½œï¼Œè®“ä¸»å»šå°ˆå¿ƒåœ¨æœ€é‡è¦çš„æ“ºç›¤ä¸Š

### æ ¸å¿ƒè¦å‰‡

> **åªæœ‰ UI åŸ·è¡Œç·’å¯ä»¥ä¿®æ”¹ UI æ§åˆ¶é …ï¼**

å¦‚æœå‚™æ–™å»šå¸«ï¼ˆèƒŒæ™¯åŸ·è¡Œç·’ï¼‰ç›´æ¥æŠŠåˆ‡å¥½çš„æ´‹è”¥ä¸Ÿåˆ°å®¢äººï¼ˆUIï¼‰çš„ç›¤å­è£¡ï¼Œæœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ

### å¯èƒ½çš„å•é¡Œ

#### 1. ç«¶çˆ­æ¢ä»¶ (Race Condition)

- ä¸»å»šæ­£æº–å‚™åœ¨ç›¤å­ä¸Šç•«é†¬æ±åœ–æ¡ˆï¼Œå‚™æ–™å»šå¸«çªç„¶ä¸Ÿä¸Šæ´‹è”¥
- å…©å€‹å‚™æ–™å»šå¸«åŒæ™‚æƒ³æŠŠé£Ÿææ”¾ä¸Šç›¤å­
- **ç¨‹å¼ä¸­çš„è¡¨ç¾**ï¼šUI æ§åˆ¶é …çš„ç‹€æ…‹æœƒè®Šå¾—æ··äº‚ä¸”ä¸å¯é æ¸¬

#### 2. ç¨‹å¼ç›´æ¥å´©æ½° (Cross-Thread Exception)

- å¤§å¤šæ•¸ UI æ¡†æ¶ï¼ˆWindows Forms, WPF, MAUIï¼‰çš„åš´æ ¼è¦å®š
- å¦‚æœæ¡†æ¶åµæ¸¬åˆ°é UI åŸ·è¡Œç·’è©¦åœ–ä¿®æ”¹ UIï¼Œæœƒç«‹åˆ»æ‹‹å‡ºç•°å¸¸
- **çµæœ**ï¼šæ‡‰ç”¨ç¨‹å¼ç›´æ¥é–ƒé€€

### æŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆ

**æŒ‘æˆ°ï¼š**

1. éœ€è¦èƒŒæ™¯åŸ·è¡Œç·’è™•ç†è€—æ™‚å·¥ä½œï¼Œé¿å…ç•«é¢å¡ä½
2. ä½†èƒŒæ™¯åŸ·è¡Œç·’ä¸è¢«å…è¨±ç›´æ¥æ›´æ–°ç•«é¢

**è§£æ±ºæ–¹æ¡ˆï¼š**

- éœ€è¦ä¸€å€‹ã€Œæºé€šçš„æ©‹æ¨‘ã€æˆ–ã€Œå‚³éå“¡ã€
- å‚™æ–™å»šå¸«æŠŠé£Ÿææ”¾åˆ°ç‰¹å®šçš„å‚³é€å¸¶ä¸Š
- ä¸»å»šåœ¨æœ‰ç©ºæ™‚å¾å‚³é€å¸¶æ‹¿èµ·é£Ÿæï¼Œå„ªé›…åœ°æ“ºåˆ°ç›¤å­ä¸Š

> **SynchronizationContext å°±æ˜¯é€™å€‹ã€Œå‚³é€å¸¶ã€æˆ–ã€Œå‚³éå“¡ã€ï¼**

---

## 2. SynchronizationContext é‹ä½œåŸç†

### ä¸Šä¸‹æ–‡æ•ç² (Context Capturing)

**ç”Ÿæ´»æ¯”å–»ï¼š**

- ä½ ï¼ˆä¸»å»š/UI åŸ·è¡Œç·’ï¼‰èº«é‚Šæœ‰ä¸€ä½å°ˆå±¬ç§˜æ›¸ï¼ˆUI åŸ·è¡Œç·’çš„ SynchronizationContextï¼‰
- ç§˜æ›¸çš„ç­†è¨˜æœ¬ä¸Šè¨˜éŒ„è‘—å¦‚ä½•å°‡ä»»ä½•äº‹æƒ…æ’å…¥ä½ çš„å·¥ä½œæ¸…å–®ä¸­

### å®Œæ•´æµç¨‹

#### 1. åˆ†æ´¾ä»»å‹™ (Dispatching a Task)

```csharp
// UI åŸ·è¡Œç·’äº¤å‡ºè€—æ™‚ä»»å‹™æ™‚
// æ¡†æ¶å‘Šè¨´èƒŒæ™¯åŸ·è¡Œç·’ï¼šã€Œå®Œæˆå¾Œï¼Œè¦é€éé€™ä½ã€ç§˜æ›¸ã€å›å ±ã€
```

- é€™å°±æ˜¯ã€Œæ•ç²ã€çš„éç¨‹
- èƒŒæ™¯åŸ·è¡Œç·’æ‹¿åˆ°äº†å°ˆå±¬æ–¼ UI åŸ·è¡Œç·’çš„ã€Œç§˜æ›¸ã€çš„è¯çµ¡æ–¹å¼

#### 2. å®Œæˆä»»å‹™èˆ‡å›å ± (Completing the Task)

```csharp
// èƒŒæ™¯åŸ·è¡Œç·’å®Œæˆå·¥ä½œå¾Œ
// æ‰¾åˆ°ã€Œç§˜æ›¸ã€ï¼ˆè¢«æ•ç²çš„ SynchronizationContextï¼‰
// äº¤çµ¦å¥¹çµæœï¼šã€Œè«‹è½‰äº¤çµ¦ä¸»å»šã€
```

#### 3. å®‰å…¨åœ°æ’å…¥å·¥ä½œä½‡åˆ— (Safely Queuing)

```csharp
// ç§˜æ›¸èµ°åˆ°ä¸»å»šå·¥ä½œå°æ—é‚Š
// çœ‹è‘—ä¸»å»šçš„å·¥ä½œæ¸…å–®ï¼ˆè¨Šæ¯ä½‡åˆ— Message Queueï¼‰
// æŠŠã€Œæ›´æ–°ç•«é¢ã€é€™é …æ–°ä»»å‹™ï¼Œä¾åºæ’å…¥æ¸…å–®æœ«å°¾
```

#### 4. è¼ªåˆ°ä½ äº† (Execution)

```csharp
// ä¸»å»šä¸æ–·è™•ç†æ¸…å–®ä¸Šçš„å·¥ä½œ
// è™•ç†å®Œæ‰‹é‚Šçš„äº‹å¾Œï¼Œçœ‹åˆ°ä¸‹ä¸€é …æ˜¯ã€Œæ›´æ–°ç•«é¢ã€
// è¦ªè‡ªå‹•æ‰‹ï¼Œå®‰å…¨åœ°æ›´æ–° UI
```

### ä¸»è¦æ–¹æ³•

#### Post(callback, state) - éåŒæ­¥æ“ä½œ

```csharp
// å‚™æ–™å»šå¸«æŠŠé£Ÿææ”¾åˆ°å‚³é€å¸¶å¾Œå°±è½‰èº«é›¢é–‹
// ä¸éœ€ç­‰å¾…ä¸»å»šæ¥æ”¶
// é€™æ˜¯ UI æ›´æ–°æœ€ç†æƒ³çš„æ–¹å¼
uiContext.Post(state => 
{
    myLabel.Text = state.ToString();
}, result);
```

#### Send(callback, state) - åŒæ­¥æ“ä½œ

```csharp
// å‚™æ–™å»šå¸«è¦ªæ‰‹äº¤çµ¦ä¸»å»š
// å¿…é ˆç«™åœ¨æ—é‚Šï¼Œè¦ªçœ¼çœ‹è‘—ä¸»å»šè™•ç†å®Œæ‰èƒ½é›¢é–‹
// æœƒå°è‡´èƒŒæ™¯åŸ·è¡Œç·’è¢«ã€Œå¡ä½ã€
// æ¯”è¼ƒå°‘ç”¨ï¼Œè‹¥ä½¿ç”¨ä¸ç•¶å®¹æ˜“é€ æˆæ­»çµ (Deadlock)
uiContext.Send(state => 
{
    myLabel.Text = state.ToString();
}, result);
```

---

## 3. å¾æ‰‹å‹•æ“ä½œåˆ° async/await è‡ªå‹•åŒ–

### æ—©æœŸæ‰‹å‹•æ“ä½œæ–¹å¼

```csharp
// å‡è¨­é€™æ˜¯ä¸€å€‹ WinForms æˆ– WPF æ‡‰ç”¨ç¨‹å¼çš„æŒ‰éˆ•é»æ“Šäº‹ä»¶
private void button1_Click(object sender, EventArgs e)
{
    // 1. åœ¨ UI åŸ·è¡Œç·’ä¸Šï¼Œæ•ç²ç•¶å‰çš„ SynchronizationContext
    var uiContext = SynchronizationContext.Current;
    
    // å°‡ä¸‹è¼‰ä»»å‹™äº¤çµ¦èƒŒæ™¯åŸ·è¡Œç·’æ± å»åŸ·è¡Œ
    ThreadPool.QueueUserWorkItem(_ => 
    {
        // --- ä»¥ä¸‹ç¨‹å¼ç¢¼åœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¸­åŸ·è¡Œ ---
        
        // æ¨¡æ“¬ä¸€å€‹è€—æ™‚5ç§’çš„ä¸‹è¼‰å·¥ä½œ
        Thread.Sleep(5000); 
        string result = "æª”æ¡ˆä¸‹è¼‰å®Œæˆï¼";
        
        // --- ä¸‹è¼‰å®Œæˆï¼Œéœ€è¦æ›´æ–° UI ---
        
        // âŒ éŒ¯èª¤çš„åšæ³•ï¼šç›´æ¥æ›´æ–° UIï¼Œæœƒå°è‡´ç¨‹å¼å´©æ½°ï¼
        // myLabel.Text = result; // <--- Cross-Thread Exception!

        // âœ… æ­£ç¢ºçš„åšæ³•ï¼šä½¿ç”¨æ•ç²åˆ°çš„ uiContext
        // å°‡æ›´æ–°ä»»å‹™ã€ŒPostã€å› UI åŸ·è¡Œç·’
        uiContext.Post(state => 
        {
            // --- é€™æ®µç¨‹å¼ç¢¼æœƒè¢«å®‰å…¨åœ°åœ¨ UI åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ ---
            myLabel.Text = state.ToString();
            
        }, result); // 'result' æœƒé€é 'state' åƒæ•¸å‚³éé€²å»
    });
    
    myLabel.Text = "ä¸‹è¼‰ä¸­ï¼Œè«‹ç¨å€™...";
}
```

**å•é¡Œï¼š**

- éœ€è¦æ‰‹å‹•æ•ç² SynchronizationContext
- éœ€è¦æ‰‹å‹•å‘¼å« Post
- ä½¿ç”¨ Lambda è¡¨é”å¼
- ç¨‹å¼ç¢¼è¤‡é›œä¸”å®¹æ˜“å‡ºéŒ¯

### ç¾ä»£ async/await å¯«æ³•

```csharp
// åªéœ€è¦åœ¨æ–¹æ³•ç°½ç« åŠ ä¸Š async
private async void button1_Click(object sender, EventArgs e)
{
    myLabel.Text = "ä¸‹è¼‰ä¸­ï¼Œè«‹ç¨å€™...";
    
    // 1. await æœƒè‡ªå‹•æ•ç² SynchronizationContext
    // 2. Task.Delay æœƒåœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œï¼ŒåŒæ™‚ UI åŸ·è¡Œç·’è¢«é‡‹æ”¾
    // 3. UI åŸ·è¡Œç·’ä¸æœƒå¡ä½
    await Task.Delay(5000); // ä½¿ç”¨ Task.Delay æ¨¡æ“¬è€—æ™‚å·¥ä½œ
    
    // 4. ç•¶ await å®Œæˆå¾Œï¼Œå¾ŒçºŒç¨‹å¼ç¢¼æœƒè¢«è‡ªå‹• Post å›åŸæœ¬çš„ UI åŸ·è¡Œç·’
    // 5. æ‰€ä»¥æˆ‘å€‘å¯ä»¥å®‰å…¨åœ°ç›´æ¥æ›´æ–° UIï¼
    
    // âœ… é€™ä¸€è¡Œ 100% æ˜¯åœ¨ã€ŒUI Threadã€ä¸ŠåŸ·è¡Œçš„ï¼
    myLabel.Text = "æª”æ¡ˆä¸‹è¼‰å®Œæˆï¼"; 
}
```

**å„ªå‹¢ï¼š**

- è‡ªå‹•æ•ç² SynchronizationContext
- è‡ªå‹• Post å› UI åŸ·è¡Œç·’
- ç¨‹å¼ç¢¼çœ‹èµ·ä¾†åƒåŒæ­¥ç¨‹å¼ç¢¼ä¸€æ¨£ç°¡æ½”
- èƒŒå¾Œè‡ªå‹•å®Œæˆæ‰€æœ‰è¤‡é›œçš„å·¥ä½œ

---

## 4. AspNetSynchronizationContext çš„è§’è‰²

### ç‚ºä»€éº¼ ASP.NET ä¹Ÿéœ€è¦ SynchronizationContextï¼Ÿ

**å•é¡Œï¼š** ç¶²ç«™ä¼ºæœå™¨æ²’æœ‰ UI ç•«é¢ï¼Œç‚ºä»€éº¼ä¹Ÿéœ€è¦ï¼Ÿ

**ç­”æ¡ˆï¼š** åœ¨å‚³çµ±çš„ ASP.NET Framework ä¸­ï¼Œéœ€è¦ç¶­è­· **HttpContext**

### HttpContext çš„é‡è¦æ€§

**HttpContext å°±åƒè™•ç†ä¸€æ¬¡ç¶²é è«‹æ±‚çš„ã€Œéš¨èº«å…¬äº‹åŒ…ã€**

åŒ…å«çš„è³‡è¨Šï¼š

- ä½¿ç”¨è€…æ˜¯èª° (`HttpContext.User`)
- Session ç‹€æ…‹ (`HttpContext.Session`)
- è«‹æ±‚çš„æ–‡åŒ–è³‡è¨Šï¼ˆèªè¨€ã€åœ°å€ï¼‰
- ...ç­‰ç­‰

> **é€™å€‹ã€Œå…¬äº‹åŒ…ã€æ˜¯èˆ‡è™•ç†è©²è«‹æ±‚çš„åŸå§‹åŸ·è¡Œç·’ç¶å®šçš„**

### AspNetSynchronizationContext çš„ç›®çš„

**ç¢ºä¿ `await` ä¹‹å¾Œçš„ç¨‹å¼ç¢¼ï¼Œèƒ½å¤ åœ¨ä¸€å€‹å¯ä»¥å­˜å–åˆ°åŸå§‹ HttpContext çš„åŸ·è¡Œç·’ä¸Šç¹¼çºŒåŸ·è¡Œ**

**å¦‚æœæ²’æœ‰å®ƒï¼š**

- `await` å¾Œç¨‹å¼ç¢¼å¯èƒ½åœ¨åŸ·è¡Œç·’æ± ä¸­éš¨æ©Ÿçš„ã€å…¨æ–°çš„åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ
- åœ¨æ–°åŸ·è¡Œç·’ä¸Šï¼Œ`HttpContext.Current` æœƒæ˜¯ `null`
- å˜—è©¦è®€å–ä½¿ç”¨è€…è³‡è¨Šæ™‚ç¨‹å¼å°±æœƒå´©æ½°

### UI ç’°å¢ƒ vs ASP.NET ç’°å¢ƒæ¯”è¼ƒ

| æ¯”è¼ƒé …ç›®         | SynchronizationContext (UI ç’°å¢ƒ)                | AspNetSynchronizationContext (èˆŠç‰ˆ ASP.NET)                            |
| ------------ | --------------------------------------------- | -------------------------------------------------------------------- |
| **ğŸ¯ ä¸»è¦ç›®çš„**  | å°‡å·¥ä½œå…§å®¹æ’å…¥ç‰¹å®šçš„ **UI åŸ·è¡Œç·’**ï¼Œä»¥å®‰å…¨åœ°æ›´æ–°ç•«é¢å…ƒç´               | å°‡å·¥ä½œå…§å®¹æ’å›ä¸€å€‹èƒ½å­˜å–åŸå§‹ **HttpContext** çš„åŸ·è¡Œç·’                                  |
| **ğŸ  æ‰€åœ¨ç’°å¢ƒ**  | Windows Forms, WPF, MAUI, UWP ç­‰æ¡Œé¢æ‡‰ç”¨ç¨‹å¼         | å‚³çµ±çš„ ASP.NET Framework (é€šå¸¸åœ¨ IIS ä¸Šé‹è¡Œ)                                  |
| **ğŸ”§ è§£æ±ºçš„å•é¡Œ** | é¿å…ã€Œè·¨åŸ·è¡Œç·’å­˜å– UIã€é€ æˆçš„ç¨‹å¼å´©æ½° (Cross-Thread Exception) | é¿å…åœ¨ `await` å¾Œï¼Œå›  `HttpContext.Current` ç‚º `null` è€Œé€ æˆçš„ç¨‹å¼éŒ¯èª¤              |
| **ğŸ’¡ ç”Ÿæ´»æ¯”å–»**  | ç¢ºä¿åªæœ‰**ä¸»å»š**æ‰èƒ½æ“ºç›¤ï¼Œé¿å…å»šæˆ¿å¤§äº‚                         | ç¢ºä¿æœå‹™ç”Ÿé€é¤æ™‚ï¼Œæ‹¿çš„æ˜¯**æ­£ç¢ºçš„å®¢äººå¸³å–®**èˆ‡é»é¤è³‡è¨Š                                         |
| **â­ é‡è¦æé†’**   | ç”± `async/await` è‡ªå‹•è™•ç†ï¼Œå¹¾ä¹ä¸éœ€æ‰‹å‹•æ“ä½œ                 | åœ¨ç¾ä»£åŒ–çš„ **ASP.NET Core** ä¸­ï¼Œé€™å€‹æ©Ÿåˆ¶å·²è¢«ç§»é™¤ï¼Œå› ç‚ºå®ƒçš„åŸ·è¡Œæ¨¡å‹ä¸å†ä¾è³´ `HttpContext.Current` |

---

## 5. ConfigureAwait(false) çš„é‡è¦æ€§

### ConfigureAwait çš„å…©ç¨®æ¨¡å¼

#### ConfigureAwait(true) - é è¨­è¡Œç‚º

```csharp
// é è¨­è¡Œç‚ºï¼Œä¸éœ€æ˜ç¢ºå¯«å‡º
await Task.Delay(1000);
// ç­‰åŒæ–¼
await Task.Delay(1000).ConfigureAwait(true);
```

**è¡Œç‚ºï¼š**

- `await` æœƒæ•ç²ç•¶å‰çš„ SynchronizationContext
- èƒŒæ™¯ä»»å‹™å®Œæˆå¾Œï¼Œç›¡åŠ›å°‡å¾ŒçºŒç¨‹å¼ç¢¼ Post å›åˆ°è¢«æ•ç²çš„ä¸Šä¸‹æ–‡ä¸­

**ç”Ÿæ´»æ¯”å–»ï¼š**

- å‚™æ–™å»šå¸«å®Œæˆå·¥ä½œå¾Œï¼Œå¿…é ˆé€éç§˜æ›¸ï¼ŒæŠŠçµæœäº¤é‚„çµ¦åŸä¾†çš„ä¸»å»š
- ä»–æœ‰å¼·çƒˆçš„ã€Œæ­¸å±¬æ„Ÿã€ï¼Œä¸€å®šè¦å›åˆ°åŸé»

#### ConfigureAwait(false) - æ˜ç¢ºæŒ‡ç¤º

```csharp
await Task.Delay(1000).ConfigureAwait(false);
```

**è¡Œç‚ºï¼š**

- æ˜ç¢ºå‘Šè¨´ `await`ï¼šã€Œæˆ‘ä¸åœ¨ä¹å¾Œé¢çš„ç¨‹å¼ç¢¼åœ¨å“ªå€‹åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œã€
- èƒŒæ™¯ä»»å‹™å®Œæˆå¾Œï¼Œä¸éœ€è¦å›åˆ°åŸæœ¬çš„ä¸Šä¸‹æ–‡
- åœ¨å®Œæˆä»»å‹™çš„é‚£å€‹åŸ·è¡Œç·’ï¼ˆé€šå¸¸æ˜¯åŸ·è¡Œç·’æ± çš„åŸ·è¡Œç·’ï¼‰ä¸Šç¹¼çºŒåŸ·è¡Œ

**ç”Ÿæ´»æ¯”å–»ï¼š**

- å‚™æ–™å»šå¸«å®Œæˆå·¥ä½œå¾Œï¼Œç™¼ç¾ä¸‹ä¸€é“å·¥åºä»»ä½•å»šå¸«éƒ½èƒ½åš
- ä¸ä¸€å®šéœ€è¦ä¸»å»šè¦ªè‡ªä¾†
- ç›´æ¥äº¤çµ¦æ—é‚Šæœ‰ç©ºçš„ä»»ä½•ä¸€ä½å»šå¸«
- æ•ˆç‡æ›´é«˜ï¼Œä¸æœƒæ‰“æ“¾æ­£åœ¨å¿™ç¢Œçš„ä¸»å»š

```csharp
private async Task button1_Click(object sender, EventArgs e)
{
	myLabel.Text = "ä¸‹è¼‰ä¸­ï¼Œè«‹ç¨å€™...";
	await Task.Delay(5000).ConfigureAwait(false);
	myLabel.Text = "æª”æ¡ˆä¸‹è¼‰å®Œæˆï¼";
}
```

### é»ƒé‡‘æ³•å‰‡ï¼šä½•æ™‚ä½¿ç”¨ ConfigureAwait(false)

> **å¦‚æœä½ æ­£åœ¨æ’°å¯«çš„æ˜¯é€šç”¨çš„ã€Œå‡½å¼åº« (Library)ã€ç¨‹å¼ç¢¼ï¼Œä½ æ‡‰è©²åœ¨æ‰€æœ‰ await å¾Œé¢éƒ½åŠ ä¸Š `.ConfigureAwait(false)`**

| æƒ…å¢ƒ         | ä½¿ç”¨æ–¹å¼                                 | åŸå›                                |
| ---------- | ------------------------------------ | -------------------------------- |
| **æ‡‰ç”¨ç¨‹å¼å±¤**  | é è¨­ `await ... .ConfigureAwait(true)` | å¾ŒçºŒç¨‹å¼ç¢¼é€šå¸¸éœ€è¦æ›´æ–° UI æˆ–å­˜å– `HttpContext` |
| **é€šç”¨å‡½å¼åº«å±¤** | `await ... .ConfigureAwait(false)`   | å‡½å¼åº«ä¸æ‡‰è©²å°å‘¼å«è€…çš„ä¸Šä¸‹æ–‡åšä»»ä½•å‡è¨­              |

### è©³ç´°æ¯”è¼ƒè¡¨

| æƒ…å¢ƒ          | `await Task.Delay(1000);` (é è¨­è¡Œç‚º)              | `await Task.Delay(1000).ConfigureAwait(false);` |
| ----------- | --------------------------------------------- | ----------------------------------------------- |
| **çºŒè¡Œè¡Œç‚º**    | **å˜—è©¦**å›åˆ°åŸå§‹ SynchronizationContext (ä¾‹å¦‚ UI åŸ·è¡Œç·’) | åœ¨ä»»ä½•å¯ç”¨çš„åŸ·è¡Œç·’æ±  (Thread Pool) åŸ·è¡Œç·’ä¸Šç¹¼çºŒ                 |
| **é©ç”¨æ™‚æ©Ÿ âœ…**  | åœ¨**æ‡‰ç”¨ç¨‹å¼å±¤**çš„ç¨‹å¼ç¢¼ä¸­ï¼Œä¾‹å¦‚æŒ‰éˆ•é»æ“Šäº‹ä»¶ã€Controller Actions   | åœ¨**é€šç”¨å‡½å¼åº«å±¤**çš„ç¨‹å¼ç¢¼ä¸­ï¼Œå› ç‚ºå‡½å¼åº«ä¸æ‡‰è©²å°å‘¼å«è€…çš„ä¸Šä¸‹æ–‡åšä»»ä½•å‡è¨­          |
| **å„ªé» âœ¨**    | æ’°å¯« UI ç›¸é—œç¨‹å¼ç¢¼éå¸¸æ–¹ä¾¿ï¼Œä¸ç”¨æ‰‹å‹•åˆ‡æ›åŸ·è¡Œç·’                     | **1. é¿å…æ­»çµ**ï¼šæé«˜å‡½å¼åº«çš„ç©©å®šæ€§<br>**2. æå‡æ•ˆèƒ½**ï¼šçœå»åˆ‡æ›ä¸Šä¸‹æ–‡çš„é–‹éŠ· |
| **æ½›åœ¨é¢¨éšª âš ï¸** | è‹¥è¢«ä¸ç•¶çš„åŒæ­¥ç­‰å¾… (`.Result`) å‘¼å«ï¼Œå¯èƒ½å°è‡´æ­»çµ               | è‹¥åœ¨éœ€è¦æ›´æ–° UI çš„åœ°æ–¹èª¤ç”¨ï¼Œæœƒå°è‡´è·¨åŸ·è¡Œç·’å­˜å–éŒ¯èª¤                     |
|             |                                               |                                                 |

### ç°¡å–®è¨˜æ†¶æ³•

âœ… **ä½ åœ¨æœ€å¤–å±¤ï¼Œç›´æ¥è·Ÿ UI æˆ– HTTP è«‹æ±‚æ‰“äº¤é“å—ï¼Ÿ** â†’ ç”¨é è¨­çš„ `await` å°±å¥½

âœ… **ä½ åœ¨å¯«ä¸€å€‹å¯èƒ½æœƒè¢«å…¶ä»–å°ˆæ¡ˆå¼•ç”¨çš„åº•å±¤æˆ–å…±ç”¨é‚è¼¯å—ï¼Ÿ** â†’ å‹™å¿…åŠ ä¸Š `.ConfigureAwait(false)`

---

## 6. æ­»çµ (Deadlock) å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### ç¶“å…¸çš„æ­»çµç¯„ä¾‹

```csharp
// --- UI æ‡‰ç”¨ç¨‹å¼çš„ç¨‹å¼ç¢¼ ---
// âŒ é€™æ˜¯ä¸€å€‹éå¸¸ä¸å¥½çš„å¯«æ³•ï¼Œä½†å¾ˆå¸¸è¦‹
private void myButton_Click(object sender, EventArgs e)
{
    // UI åŸ·è¡Œç·’åœ¨é€™è£¡å‘¼å«äº† Library çš„æ–¹æ³•
    // ä¸¦ä¸”ç”¨ .Result æŠŠå®ƒå¡ä½ï¼ŒåŒæ­¥ç­‰å¾…çµæœ
    string data = MyAwesomeLibrary.GetDataAsync().Result; // <-- è‡´å‘½é» 1
    myLabel.Text = data;
}

// --- ä½ å¯«çš„é€šç”¨å‡½å¼åº« (Library) ç¨‹å¼ç¢¼ ---
public static class MyAwesomeLibrary
{
    public static async Task<string> GetDataAsync()
    {
        // æ¨¡æ“¬ä¸€å€‹éåŒæ­¥çš„ç¶²è·¯è«‹æ±‚
        await Task.Delay(1000); // <-- è‡´å‘½é» 2 (é è¨­æ˜¯ ConfigureAwait(true))        
        return "é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™";
    }
}
```

### æ­»çµç™¼ç”Ÿçš„ã€Œæ­»äº¡ä¹‹èˆã€

#### æ­¥é©Ÿåˆ†æ

1. **[UI åŸ·è¡Œç·’]** ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•ï¼Œ`myButton_Click` åœ¨ UI åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ
    
2. **[UI åŸ·è¡Œç·’]** åŸ·è¡Œåˆ° `GetDataAsync().Result`
    - é€™æœƒå°è‡´ UI åŸ·è¡Œç·’è¢«**å®Œå…¨å¡ä½ (Block)**
    - å®ƒæœƒåœåœ¨é€™è£¡ï¼Œç›´åˆ° `GetDataAsync` é€™å€‹ Task å®Œæˆç‚ºæ­¢

3. **[å‡½å¼åº«, UI åŸ·è¡Œç·’ä¸Š]** `GetDataAsync` é–‹å§‹åŸ·è¡Œ
    
4. **[å‡½å¼åº«]** åŸ·è¡Œåˆ° `await Task.Delay(1000)`
    - å› ç‚ºæ˜¯é è¨­è¡Œç‚º `ConfigureAwait(true)`
    - `await` æœƒåšå…©ä»¶äº‹ï¼š
        - å®‰æ’ `Task.Delay` åœ¨èƒŒæ™¯åŸ·è¡Œ
        - **æ•ç²ç•¶å‰çš„ SynchronizationContext**ï¼ˆUI åŸ·è¡Œç·’çš„ä¸Šä¸‹æ–‡ï¼‰
        - è¨ˆç•«åœ¨ Delay å®Œæˆå¾Œï¼Œå°‡å¾ŒçºŒç¨‹å¼ç¢¼é€å›é€™å€‹ä¸Šä¸‹æ–‡ä¾†åŸ·è¡Œ

5. **[èƒŒæ™¯åŸ·è¡Œç·’]** 1 ç§’é˜éå¾Œï¼Œ`Task.Delay` å®Œæˆäº†
    
6. **[await æ©Ÿåˆ¶]** `await` æº–å‚™å±¥è¡Œæ‰¿è«¾
    - å˜—è©¦å°‡å¾ŒçºŒç¨‹å¼ç¢¼ Post å›åˆ°å®ƒä¹‹å‰æ•ç²çš„ UI åŸ·è¡Œç·’ä¸Š

#### ğŸ’¥ æ­»çµ (DEADLOCK) ç™¼ç”Ÿï¼ğŸ’¥

```
await æ­£åœ¨ç­‰å¾… UI åŸ·è¡Œç·’è®Šç‚ºå¯ç”¨ç‹€æ…‹
â†“
ä½† UI åŸ·è¡Œç·’åœ¨ç¬¬ 2 æ­¥å°±è¢« .Result å¡ä½äº†
â†“
UI åŸ·è¡Œç·’æ­£åœ¨ç­‰å¾… GetDataAsync é€™å€‹ Task å®Œæˆ
â†“
é€™å€‹ Task æ°¸é ç„¡æ³•å®Œæˆ
â†“
å› ç‚ºå®ƒæ­£ç­‰è‘—åœ¨ UI åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œæœ€å¾Œä¸€éƒ¨åˆ†ç¨‹å¼ç¢¼
â†“
äº’ç›¸ç­‰å¾…çš„ç„¡é™å¾ªç’°
```

**çµæœï¼š** æ‡‰ç”¨ç¨‹å¼ç•«é¢å®Œå…¨å‡çµï¼Œæ²’æœ‰ä»»ä½•åæ‡‰

### è§£æ±ºæ–¹æ¡ˆ 1ï¼šå‡½å¼åº«ä½¿ç”¨ ConfigureAwait(false)

```csharp
// --- é€šç”¨å‡½å¼åº« (Library) ç¨‹å¼ç¢¼ (ä¿®æ­£ç‰ˆ) ---
public static class MyAwesomeLibrary
{
    public static async Task<string> GetDataAsync()
    {
        // âœ… å‘Šè¨´ awaitï¼šæˆ‘ä¸éœ€è¦å›åˆ°åŸæœ¬çš„ä¸Šä¸‹æ–‡ï¼
        await Task.Delay(1000).ConfigureAwait(false); 
        
        // é€™æ®µç¨‹å¼ç¢¼å°‡æœƒåœ¨æŸå€‹åŸ·è¡Œç·’æ± çš„åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ
        // è€Œä¸æ˜¯ UI åŸ·è¡Œç·’
        return "é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™";
    }
}
```

**æ•ˆæœï¼š**

- ç•¶ç¬¬ 6 æ­¥ç™¼ç”Ÿæ™‚ï¼Œ`await` å› ç‚ºè¢«å‘ŠçŸ¥äº† `ConfigureAwait(false)`
- å®ƒä¸æœƒå˜—è©¦å›åˆ° UI åŸ·è¡Œç·’
- ç›´æ¥åœ¨èƒŒæ™¯çš„åŸ·è¡Œç·’æ± ä¸ŠåŸ·è¡Œå¾ŒçºŒç¨‹å¼ç¢¼
- å®Œæˆ Taskï¼Œ`.Result` æ‹¿åˆ°çµæœ
- UI åŸ·è¡Œç·’è¢«è§£é™¤å°é–ï¼Œä¸€åˆ‡æ¢å¾©æ­£å¸¸

### è§£æ±ºæ–¹æ¡ˆ 2ï¼šæ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ async/await

```csharp
// âœ… æ­£ç¢ºçš„å¯«æ³•
// 1. æŠŠäº‹ä»¶è™•ç†å¸¸å¼æ”¹æˆ async "Task"
//    (æˆ– async "void"ï¼Œä½† async Task æ›´å¥½)
private async Task myButton_Click(object sender, EventArgs e)
{
    // 2. æŠŠã€Œ.Resultã€é€™å€‹ã€ŒåŒæ­¥ç­‰å¾…ã€
    //    æ›æˆã€Œawaitã€é€™å€‹ã€ŒéåŒæ­¥ç­‰å¾…ã€
    string data = await MyAwesomeLibrary.GetDataAsync();
    
    // 3. å› ç‚ºæˆ‘å€‘æ˜¯ awaitï¼ŒUI åŸ·è¡Œç·’åœ¨é€™è£¡æ˜¯è‡ªç”±çš„
    //    await å®Œæˆå¾Œï¼Œé€™è¡Œç¨‹å¼ç¢¼æœƒè¢«å®‰å…¨åœ° Post å› UI åŸ·è¡Œç·’åŸ·è¡Œ
    myLabel.Text = data;
}

// å‡½å¼åº«ç¨‹å¼ç¢¼ä¿æŒä¸è®Š (æˆ–æœ€å¥½åŠ ä¸Š ConfigureAwait(false))
public static class MyAwesomeLibrary
{
    public static async Task<string> GetDataAsync()
    {
        // ç‚ºäº†é¿å…æ½›åœ¨çš„æ­»çµï¼Œå‡½å¼åº«æœ€å¥½æ°¸é åŠ ä¸Š ConfigureAwait(false)
        await Task.Delay(1000).ConfigureAwait(false);
        return "é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™";
    }
}
```

### ç‚ºä»€éº¼é€™æ¨£å°±è§£é–‹äº†ï¼Ÿ

#### æ–°çš„æµç¨‹

1. **[UI åŸ·è¡Œç·’]** ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•ï¼Œ`myButton_Click` åœ¨ UI åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ
    
2. **[UI åŸ·è¡Œç·’]** åŸ·è¡Œåˆ° `await MyAwesomeLibrary.GetDataAsync()`    
    - `await` åšäº†å…©ä»¶äº‹ï¼š
        - æ•ç²ç•¶å‰çš„ UI ä¸Šä¸‹æ–‡
        - **ç«‹åˆ»æ­¸é‚„ (return) åŸ·è¡Œç·’çµ¦ UI è¨Šæ¯è¿´åœˆ**
		
3. **[UI åŸ·è¡Œç·’]** UI åŸ·è¡Œç·’ç¾åœ¨æ˜¯**è‡ªç”±çš„**ï¼    
    - å¯ä»¥ç¹¼çºŒç•«å‹•ç•«ã€å›æ‡‰å…¶ä»–æŒ‰éˆ•é»æ“Š
    - æ‡‰ç”¨ç¨‹å¼æ²’æœ‰è¢«å‡çµ
	
4. **[èƒŒæ™¯åŸ·è¡Œç·’]** `GetDataAsync` è£¡é¢çš„ `Task.Delay` åœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¸Šè·‘
    
5. **[èƒŒæ™¯åŸ·è¡Œç·’]** `Task.Delay` å®Œæˆäº†
    
6. **[await æ©Ÿåˆ¶]** `await` æº–å‚™å±¥è¡Œæ‰¿è«¾    
    - å°‡å¾ŒçºŒç¨‹å¼ç¢¼ (`myLabel.Text = data;`) Post å›åˆ°å®ƒä¹‹å‰æ•ç²çš„ UI ä¸Šä¸‹æ–‡
	
7. **[UI åŸ·è¡Œç·’]** UI åŸ·è¡Œç·’åœ¨å®ƒæœ‰ç©ºçš„æ™‚å€™ï¼ˆå®ƒä¸€ç›´éƒ½æœ‰ç©ºï¼Œå› ç‚ºæ²’è¢«å¡ä½ï¼‰    
    - å¾ä½‡åˆ—ä¸­å–å‡ºé€™é …å·¥ä½œ
	
8. **[UI åŸ·è¡Œç·’]** å®‰å…¨åœ°åŸ·è¡Œ `myLabel.Text = data;`    

### ç¸½çµ

|æ–¹å¼|çµæœ|
|---|---|
|`.Result` (å£)|æœƒéœ¸ä½”ä¸¦å¡ä½ UI åŸ·è¡Œç·’ï¼Œå°è‡´æ­»çµ|
|`await` (å¥½)|æœƒé‡‹æ”¾ UI åŸ·è¡Œç·’ï¼Œè®“å®ƒå»è™•ç†åˆ¥çš„äº‹ï¼Œç­‰ä»»å‹™å®Œæˆå¾Œå†å›ä¾†|

> **async/await çš„ã€ŒéåŒæ­¥çš„å‚³æŸ“æ€§ã€**ï¼šä¸€æ—¦åœ¨åº•å±¤ç”¨äº† asyncï¼Œæœ€å¥½ä¸€è·¯å¾€ä¸Šå‚³æ’­ï¼Œç›´åˆ°æœ€ä¸Šå±¤çš„äº‹ä»¶è™•ç†å¸¸å¼ï¼ŒæŠŠ `void` æ”¹æˆ `async Task` (æˆ– `async void`)

---

## 7. æ‰‹å‹•å¯¦ä½œï¼šé‚„åŸ async/await çš„èªæ³•ç³–

### UI å±¤çš„æ‰‹å‹•æ”¹å¯«

#### åŸå§‹ async å¯«æ³•

```csharp
private async Task myButton_Click(object sender, EventArgs e)
{
    string data = await MyAwesomeLibrary.GetDataAsync();
    myLabel.Text = data;
}
```

#### æ‰‹å‹• SynchronizationContext èˆŠå¯«æ³•

```csharp
// 1. ä¸èƒ½ç”¨ async Taskï¼Œæ”¹å› void
private void myButton_Click(object sender, EventArgs e)
{
    // 2. æ‰‹å‹•æ•ç²ç•¶å‰çš„ UI ä¸Šä¸‹æ–‡ (SynchronizationContext)
    var uiContext = SynchronizationContext.Current;
    
    // 3. å‘¼å«å‡½å¼åº«æ–¹æ³•ï¼Œé€™æœƒå‚³å›ä¸€å€‹ Task ç‰©ä»¶
    Task<string> dataTask = MyAwesomeLibrary.GetDataAsync();
    
    // 4. ã€Œawaitã€çš„çœŸæ­£æ›¿ä»£å“ï¼š.ContinueWith
    //    æ„æ€æ˜¯ã€Œç•¶ dataTask å®Œæˆå¾Œï¼Œè«‹åŸ·è¡Œä»¥ä¸‹...ã€
    dataTask.ContinueWith(task => 
    {
        // --- é€™æ®µç¨‹å¼ç¢¼å¯èƒ½åœ¨ã€Œä»»ä½•åŸ·è¡Œç·’ã€ä¸ŠåŸ·è¡Œ ---
        // (ç‰¹åˆ¥æ˜¯å› ç‚ºæˆ‘å€‘çš„å‡½å¼åº«ç”¨äº† ConfigureAwait(false))
        
        // 5. å¾å®Œæˆçš„ Task ä¸­å–å¾—çµæœ
        string result = task.Result; 
        
        // 6. é—œéµæ­¥é©Ÿï¼š
        //    æˆ‘å€‘ä¸èƒ½åœ¨é€™è£¡ç›´æ¥æ›´æ–° myLabel.Text (æœƒå´©æ½°ï¼)
        //    å¿…é ˆä½¿ç”¨ä¸€é–‹å§‹æ•ç²çš„ uiContext
        //    æŠŠæ›´æ–°ä»»å‹™ã€ŒPostã€å› UI åŸ·è¡Œç·’
        
        // âœ… æ¨™æº–å¯«æ³•ï¼šé€é state åƒæ•¸å‚³éè³‡æ–™
        uiContext.Post(state => 
        {
            // --- é€™æ®µç¨‹å¼ç¢¼ç¾åœ¨ä¿è­‰åœ¨ UI åŸ·è¡Œç·’ä¸Šå®‰å…¨åŸ·è¡Œ ---
            // 'state' åƒæ•¸å°±æ˜¯æˆ‘å€‘å‚³å…¥çš„ 'result'
            // (éœ€è¦åšä¸€æ¬¡å‹åˆ¥è½‰æ›)
            string data = (string)state;
            myLabel.Text = data;
            
        }, result); // <-- æŠŠ result ç•¶ä½œ state åƒæ•¸å‚³é
        
        // âš ï¸ ä¹Ÿå¯ä»¥ä¾è³´é–‰åŒ… (Closure)ï¼Œä½†ä¸å»ºè­°
        // uiContext.Post(_ => 
        // {
        //     myLabel.Text = result; // æ•ç²å¤–å±¤è®Šæ•¸
        // }, null);
        
    });
}
```

### å‡½å¼åº«å±¤çš„æ‰‹å‹•æ”¹å¯«

#### åŸå§‹ async å¯«æ³•

```csharp
public static class MyAwesomeLibrary
{
    public static async Task<string> GetDataAsync()
    {
        // ConfigureAwait(false) å‘Šè¨´ awaitï¼š
        // ä¸‹é¢çš„ç¨‹å¼ç¢¼(return) ä¸éœ€è¦å›åˆ°åŸå§‹ä¸Šä¸‹æ–‡
        await Task.Delay(1000).ConfigureAwait(false);
        return "é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™";
    }
}
```

#### æ‰‹å‹• Task.Run / ThreadPool èˆŠå¯«æ³•

```csharp
public static class MyAwesomeLibrary
{
    // 1. æ–¹æ³•ä¸å†æ˜¯ async
    //    å®ƒåªæ˜¯ä¸€å€‹ã€Œå‚³å› Task çš„ä¸€èˆ¬æ–¹æ³•ã€
    public static Task<string> GetDataAsync()
    {
        // 2. Task.Run æœƒç«‹åˆ»æŠŠå·¥ä½œæ’å…¥ ThreadPool
        //    ä¸¦ã€Œç«‹åˆ»ã€å‚³å›ä¸€å€‹ Task ç‰©ä»¶
        return Task.Run(() => 
        {
            // --- é€™æ•´æ®µç¨‹å¼ç¢¼éƒ½åœ¨èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool) ä¸ŠåŸ·è¡Œ ---
            
            // 3. ä»¥å‰æ²’æœ‰ Task.Delayï¼Œæˆ‘å€‘æœƒç”¨ Thread.Sleep 
            //    (åœ¨èƒŒæ™¯åŸ·è¡Œç·’ Sleepï¼Œä¸æœƒå¡ä½ UI)
            Thread.Sleep(1000); 
            
            // 4. ç•¶ return æ™‚ï¼ŒTask.Run æœƒè‡ªå‹•æŠŠé€™å€‹ "Task<string>"
            //    æ¨™è¨˜ç‚ºã€Œå·²å®Œæˆã€ï¼Œä¸¦æŠŠçµæœåŒ…é€²å»
            return "é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™";
        });
    }
}
```

**è¨»ï¼š** `ThreadPool.QueueUserWorkItem` æ˜¯æ›´åº•å±¤çš„ APIï¼Œå®ƒä¸æœƒè‡ªå‹•å‚³å› Taskï¼Œæˆ‘å€‘é‚„å¿…é ˆæ­é… `TaskCompletionSource` æ‰èƒ½æ‰‹å‹•å»ºç«‹ Taskã€‚`Task.Run` å·²ç¶“æ˜¯æ›´æ–¹ä¾¿çš„å°è£äº†ã€‚

### async/await èªæ³•ç³–çš„åƒ¹å€¼

çœ‹å®Œäº†æ‰‹å‹•æ”¹å¯«çš„èˆŠç‰ˆæœ¬ï¼Œå¯ä»¥æ¸…æ¥šçœ‹åˆ° async/await èªæ³•ç³–çœŸçš„éå¸¸ã€Œç”œã€ã€éå¸¸å¼·å¤§ï¼

**å®ƒå¹«æˆ‘å€‘è‡ªå‹•åŒ–è™•ç†äº†ï¼š**

- `ContinueWith` çš„è¨»å†Š
- `SynchronizationContext.Current` çš„æ•ç²
- `Post` çš„å‘¼å«
- `Task.Run` çš„æ’ç¨‹
- è¤‡é›œçš„èª¿åº¦å·¥ä½œ

---

## 8. ContinueWith çš„éé˜»å¡ç‰¹æ€§

### ContinueWith æ˜¯é˜»å¡å¼çš„å—ï¼Ÿ

**ç­”æ¡ˆï¼šä¸æ˜¯ï¼å®ƒçµ•å°ä¸æ˜¯é˜»å¡å¼çš„ (Non-Blocking)**

### ç”Ÿæ´»æ¯”å–»

ä½ æ‰“é›»è©±å»é¤å»³è¨‚ä½ (`dataTask`)ï¼Œé¤å»³è«‹ä½ ç•™å€‹é›»è©± (`ContinueWith` è£¡é¢çš„ `task => { ... }`)ï¼Œä¸¦è·Ÿä½ èªªï¼šã€Œç­‰æœ‰ä½å­æ™‚ï¼Œæˆ‘ã€å†æ‰“é›»è©±é€šçŸ¥ä½ ã€ã€‚ã€

**é‡é»ï¼š**

- ä½ æ›æ‰é›»è©±ï¼ˆ`ContinueWith` æ–¹æ³•åŸ·è¡Œå®Œç•¢ï¼‰å¾Œï¼Œå°±ç«‹åˆ»å»åšè‡ªå·±çš„äº‹äº†
- ä½ ä¸æœƒå‚»å‚»åœ°æ‹¿è‘—é›»è©±åœ¨åŸåœ°ã€Œé˜»å¡ã€ï¼Œç›´åˆ°é¤å»³æ‰“é›»è©±å›ä¾†

### ContinueWith çš„é‹ä½œæ–¹å¼

**ã€Œè¨»å†Šä¸€å€‹æœªä¾†çš„å›å‘¼ (Callback)ã€**

```csharp
dataTask.ContinueWith(task => 
{
    // é€™æ˜¯ã€Œæœªä¾†ã€è¦åŸ·è¡Œçš„ç¨‹å¼ç¢¼
    // ç¾åœ¨åªæ˜¯ã€Œè¨»å†Šã€è€Œå·²
});
// ContinueWith åŸ·è¡Œå®Œç•¢å¾Œï¼Œç«‹åˆ»ç¹¼çºŒåŸ·è¡Œå¾Œé¢çš„ç¨‹å¼ç¢¼
```

### å®Œæ•´åŸ·è¡Œé †åºè¡¨

|åŸ·è¡Œæ™‚é–“|åŸ·è¡Œç·’|åŸ·è¡Œçš„ç¨‹å¼ç¢¼ (åœ¨ `myButton_Click` å…§éƒ¨)|
|---|---|---|
|**ç¬¬ 1 æ¯«ç§’**|**UI Thread**|`var uiContext = SynchronizationContext.Current;` (æ•ç² UI ä¸Šä¸‹æ–‡)|
|**ç¬¬ 2 æ¯«ç§’**|**UI Thread**|`Task<string> dataTask = MyAwesomeLibrary.GetDataAsync();` (é–‹å§‹èƒŒæ™¯ä»»å‹™)|
|**ç¬¬ 3 æ¯«ç§’**|**UI Thread**|`dataTask.ContinueWith(...);` (**è¨»å†Š**å›å‘¼ï¼Œ**ä¸æœƒ**ç­‰å¾…ï¼)|
|**ç¬¬ 4 æ¯«ç§’**|**UI Thread**|_(å‡è¨­ `ContinueWith` å¾Œé¢é‚„æœ‰ç¨‹å¼ç¢¼)_<br>`myLabel.Text = "å·²é€å‡ºè«‹æ±‚...";`<br>**é€™å›ç­”äº†å•é¡Œï¼šå¾Œé¢çš„ç¨‹å¼ç¢¼æœƒç«‹åˆ»åœ¨ UI Thread åŸ·è¡Œ**|
|**ç¬¬ 5 æ¯«ç§’**|**UI Thread**|`myButton_Click` æ–¹æ³•åŸ·è¡Œå®Œç•¢ï¼ŒUI åŸ·è¡Œç·’ç©ºé–’ä¸‹ä¾†|
|... 1 ç§’é˜å¾Œ ...|||
|**ç¬¬ 1001 æ¯«ç§’**|**èƒŒæ™¯ Thread** (Thread Pool)|`task => { ... }` (`ContinueWith` çš„å›å‘¼è¢«è§¸ç™¼)<br>å› ç‚ºå‡½å¼åº«ç”¨äº† `ConfigureAwait(false)`|
|**ç¬¬ 1002 æ¯«ç§’**|**èƒŒæ™¯ Thread**|`string result = task.Result;` (åœ¨èƒŒæ™¯å–å¾—çµæœ)|
|**ç¬¬ 1003 æ¯«ç§’**|**èƒŒæ™¯ Thread**|`uiContext.Post(...);` (å‘ UI åŸ·è¡Œç·’çš„ã€Œå·¥ä½œæ¸…å–®ã€ç™¼é€ä¸€å€‹æ–°å·¥ä½œ)|
|**ç¬¬ 1004 æ¯«ç§’**|**UI Thread**|UI åŸ·è¡Œç·’å¾æ¸…å–®ä¸­å–å‡ºå·¥ä½œ<br>åŸ·è¡Œ `state => { myLabel.Text = (string)state; }`|

### é—œéµè¦é»

1. **ContinueWith æ˜¯éé˜»å¡çš„**    
    - è¨»å†Šå›å‘¼å¾Œç«‹åˆ»è¿”å›
    - ä¸æœƒç­‰å¾… Task å®Œæˆ
	
2. **å¾Œé¢çš„ç¨‹å¼ç¢¼æœƒç«‹åˆ»åŸ·è¡Œ**    
    - åœ¨ UI Thread ä¸ŠåŸ·è¡Œ
    - ä¸éœ€è¦ç­‰å¾… ContinueWith çš„å›å‘¼
	
3. **å›å‘¼åœ¨æœªä¾†æ‰æœƒè¢«è§¸ç™¼**    
    - ç•¶ Task å®Œæˆæ™‚
    - å¯èƒ½åœ¨ä¸åŒçš„åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ

---

## 9. Task.Delay vs Task.Run + Thread.Sleep

### æ ¸å¿ƒå·®ç•°

**`Task.Delay` æ˜¯éé˜»å¡ (Non-Blocking) çš„**

**`Task.Run + Thread.Sleep` æ˜¯é˜»å¡ (Blocking) ä¸€å€‹åŸ·è¡Œç·’çš„**

### ç”Ÿæ´»æ¯”å–»ï¼šé¤å»³æœå‹™ç”Ÿ

**åŸ·è¡Œç·’æ±  (Thread Pool)** = é¤å»³è£¡æ‰€æœ‰æœå‹™ç”Ÿçš„ç¸½æ•¸ï¼ˆæ¯”å¦‚ 10 ä½æœå‹™ç”Ÿï¼‰

#### 1. Task.Run(() => { Thread.Sleep(5000); }) - é˜»å¡ ğŸ˜´

**æµç¨‹ï¼š**

- å®¢äººå°ç¸½ç®¡èªªï¼šã€Œè«‹æŒ‡æ´¾ä¸€ä½æœå‹™ç”Ÿï¼Œå«ä»–å»æ—é‚Šçš„ä¼‘æ¯å®¤ç½°ç«™ 5 ç§’é˜ ğŸ§±ï¼Œä»€éº¼äº‹éƒ½ä¸å‡†åšã€

**å¾Œæœï¼š**

- ç¸½ç®¡çœŸçš„æ´¾äº†ä¸€ä½æœå‹™ç”Ÿ
- åœ¨æ¥ä¸‹ä¾†çš„ 5 ç§’å…§ï¼Œé€™ä½æœå‹™ç”Ÿè¢«å®Œå…¨ä½”ç”¨
- ä»–ä¸èƒ½å»æœå‹™å…¶ä»–å®¢äººã€ä¸èƒ½é€é¤ã€ä¸èƒ½å€’æ°´

**å•é¡Œï¼š**

- å¦‚æœåŒæ™‚æœ‰ 10 å€‹å®¢äººæå‡ºã€Œç½°ç«™ã€è¦æ±‚
- ä½ é¤å»³çš„ 10 ä½æœå‹™ç”Ÿå°±å…¨éƒ¨è¢«ä½”æ»¿äº†
- æ•´å€‹é¤å»³ï¼ˆæ‡‰ç”¨ç¨‹å¼ï¼‰å°±åœæ“ºäº†ï¼Œç„¡æ³•å›æ‡‰ä»»ä½•æ–°çš„è«‹æ±‚ï¼

#### 2. Task.Delay(5000) - éé˜»å¡ â²ï¸

**æµç¨‹ï¼š**

- å®¢äººå°ç¸½ç®¡èªªï¼šã€Œè«‹ä½ åœ¨å»šæˆ¿è¨­å®šä¸€å€‹ 5 ç§’é˜çš„è¨ˆæ™‚å™¨ â²ï¸ã€‚æ™‚é–“åˆ°äº†å†é€šçŸ¥æˆ‘ã€

**å¾Œæœï¼š**

- ç¸½ç®¡å»å»šæˆ¿æŒ‰ä¸‹äº†è¨ˆæ™‚å™¨ï¼Œç„¶å¾Œç«‹åˆ»è½‰èº«å›å»ç¹¼çºŒå·¥ä½œ

**é‡é»ï¼š**

- **æ²’æœ‰ä»»ä½•ä¸€ä½æœå‹™ç”Ÿè¢«ä½”ç”¨**
- åœ¨è¨ˆæ™‚å™¨å€’æ•¸çš„ 5 ç§’å…§ï¼Œæ‰€æœ‰ 10 ä½æœå‹™ç”Ÿéƒ½é‚„åœ¨å¿™ç¢Œåœ°æœå‹™å®¢äºº
- ç•¶ 5 ç§’é˜å¾Œè¨ˆæ™‚å™¨ã€Œå®ï¼ã€éŸ¿èµ·æ™‚ï¼Œç³»çµ±æœƒé€šçŸ¥ä½ çš„ç¨‹å¼

**å¥½è™•ï¼š**

- å³ä½¿ 1000 å€‹å®¢äººåŒæ™‚è¦æ±‚ã€Œ5 ç§’è¨ˆæ™‚å™¨ã€
- ä½ çš„ 10 ä½æœå‹™ç”Ÿä¹Ÿå®Œå…¨æ‡‰ä»˜å¾—ä¾†
- å› ç‚ºä»–å€‘æ ¹æœ¬ä¸éœ€è¦ã€Œç­‰å¾…ã€ï¼Œåªéœ€è¦åœ¨è¨ˆæ™‚å™¨éŸ¿èµ·æ™‚å»è™•ç†çµæœ

### è©³ç´°æ¯”è¼ƒè¡¨

|æ¯”è¼ƒç‰¹æ€§|`Task.Delay(5000)`|`Task.Run(() => { Thread.Sleep(5000); })`|
|---|---|---|
|**åŸ·è¡Œç·’ä½¿ç”¨**|**éé˜»å¡ (Non-Blocking)** ğŸŸ¢|**é˜»å¡ (Blocking)** ğŸ”´|
|**é‹ä½œåŸç†**|ä½¿ç”¨ä¸€å€‹é«˜æ•ˆç‡çš„ç³»çµ±**è¨ˆæ™‚å™¨** â²ï¸|**ä½”ç”¨**ä¸€å€‹å¯¶è²´çš„åŸ·è¡Œç·’æ±  (Thread Pool) åŸ·è¡Œç·’|
|**ç­‰å¾…æœŸé–“...**|åŸ·è¡Œç·’æ˜¯**è‡ªç”±çš„**ï¼Œå¯ä»¥å›å»åŸ·è¡Œç·’æ± è™•ç†**å…¶ä»–å·¥ä½œ**|è©²åŸ·è¡Œç·’è¢«**å®Œå…¨å¡ä½**ï¼Œä¸èƒ½åšä»»ä½•å…¶ä»–äº‹|
|**è³‡æºæ¶ˆè€—**|**éå¸¸ä½**ã€‚å¹¾ä¹ä¸æ¶ˆè€— CPU|**éå¸¸é«˜**ã€‚æµªè²»äº†ä¸€å€‹å®Œæ•´çš„åŸ·è¡Œç·’è³‡æº|
|**ç”Ÿæ´»æ¯”å–»**|æœå‹™ç”Ÿè¨­å®šè¨ˆæ™‚å™¨å¾Œï¼Œ**å›å»æœå‹™å…¶ä»–å®¢äºº**|æœå‹™ç”Ÿè¢«**ç½°ç«™ 5 ç§’é˜**ï¼Œä»€éº¼äº‹éƒ½ä¸èƒ½åš|

### ç¨‹å¼é‹ä½œæµç¨‹æ¯”è¼ƒ

#### 1. await Task.Delay(5000)

```
1. ä¸»åŸ·è¡Œç·’é‡åˆ° Task.Delay
2. ä¸»åŸ·è¡Œç·’è¢«é‡‹æ”¾ (å¯ä»¥å»åšå…¶ä»–äº‹)
3. .NET åŸ·è¡Œç’°å¢ƒè¨­å®šä¸€å€‹ 5 ç§’é˜çš„ç³»çµ±è¨ˆæ™‚å™¨ â²ï¸
   âš ï¸ åœ¨é€™ 5 ç§’å…§ï¼Œæ²’æœ‰ä»»ä½•åŸ·è¡Œç·’è¢«ä½”ç”¨
   - ä¸»åŸ·è¡Œç·’æ˜¯è‡ªç”±çš„
   - èƒŒæ™¯åŸ·è¡Œç·’æ± ä¹Ÿæ˜¯å®Œå…¨è‡ªç”±çš„
4. 5 ç§’å¾Œï¼Œè¨ˆæ™‚å™¨éŸ¿äº†
5. ç³»çµ±å°‡ã€Œå¾Œé¢çš„ç¨‹å¼ç¢¼ã€æ’å…¥ä¸»åŸ·è¡Œç·’çš„å·¥ä½œæ¸…å–®
6. ä¸»åŸ·è¡Œç·’åŸ·è¡Œå¾Œé¢çš„ç¨‹å¼ç¢¼
```

#### 2. await Task.Run(() => { Thread.Sleep(5000); })

```
1. ä¸»åŸ·è¡Œç·’é‡åˆ° Task.Run
2. ä¸»åŸ·è¡Œç·’è¢«é‡‹æ”¾ (å¯ä»¥å»åšå…¶ä»–äº‹)
3. Task.Run å¾èƒŒæ™¯åŸ·è¡Œç·’æ± ä¸­æŠ“ä¸€å€‹åŸ·è¡Œç·’ ğŸ‘·
4. é€™å€‹èƒŒæ™¯åŸ·è¡Œç·’åŸ·è¡Œ Thread.Sleep(5000)
   âš ï¸ åœ¨é€™ 5 ç§’å…§ï¼š
   - ä¸»åŸ·è¡Œç·’æ˜¯è‡ªç”±çš„ âœ…
   - ä½†é€™å€‹èƒŒæ™¯åŸ·è¡Œç·’è¢«å®Œå…¨å¡ä½ âŒ
   - åŸ·è¡Œç·’æ± ä¸­å°‘äº†ä¸€å€‹å·¥ä½œäººå“¡
5. 5 ç§’å¾Œï¼ŒèƒŒæ™¯åŸ·è¡Œç·’é†’ä¾†ï¼Œä»»å‹™çµæŸ
6. ç³»çµ±å°‡ã€Œå¾Œé¢çš„ç¨‹å¼ç¢¼ã€æ’å…¥ä¸»åŸ·è¡Œç·’çš„å·¥ä½œæ¸…å–®
7. ä¸»åŸ·è¡Œç·’åŸ·è¡Œå¾Œé¢çš„ç¨‹å¼ç¢¼
```

### Task.Delay çš„çœŸæ­£é‹ä½œæ–¹å¼

**å•é¡Œï¼š** Task.Delay() ä¸éœ€è¦èƒŒæ™¯åŸ·è¡Œç·’ä¾†åŸ·è¡Œï¼ˆæˆ–åŸ·è¡Œè¨ˆæ•¸ï¼‰å—ï¼Ÿ

**ç­”æ¡ˆï¼š** Task.Delay ä¸éœ€è¦ä½¿ç”¨ã€ŒåŸ·è¡Œç·’æ±  (Thread Pool)ã€çš„åŸ·è¡Œç·’ä¾†è¨ˆæ•¸ï¼Œè€Œæ˜¯ä½¿ç”¨äº†æ›´åº•å±¤ã€æ›´è¼•é‡ç´šçš„**ç³»çµ±è¨ˆæ™‚å™¨ (System Timer)** â²ï¸

### ç³»çµ±è¨ˆæ™‚å™¨ vs åŸ·è¡Œç·’æ± 

**åŸ·è¡Œç·’æ±  (Thread Pool)ï¼š**

- é¤å»³è£¡æ‰€æœ‰èƒ½è·‘è…¿ã€é»é¤ã€é€é¤çš„æœå‹™ç”Ÿ (Workers) ğŸ‘·
- ä»–å€‘æ˜¯å¯¶è²´çš„ã€ŒäººåŠ›è³‡æºã€

**ç³»çµ±è¨ˆæ™‚å™¨ (Timer Queue)ï¼š**

- å»šæˆ¿ç‰†ä¸Šçš„ä¸€å€‹ä¸­å¤®è¨ˆæ™‚å™¨ä¸»æ©Ÿ â²ï¸
- å¯ä»¥åŒæ™‚ç®¡ç†æˆåƒä¸Šè¬å€‹å€’æ•¸è¨ˆæ™‚
- éå¸¸çœé›»ï¼ˆè³‡æºæ¶ˆè€—æ¥µä½ï¼‰

### å®Œæ•´æµç¨‹å°æ¯”

#### Task.Run(() => { Thread.Sleep(5000); })

|éšæ®µ|å‹•ä½œ|
|---|---|
|**1. ä»»å‹™é–‹å§‹æ™‚**|å¾åŸ·è¡Œç·’æ± **ä½”ç”¨** 1 å€‹åŸ·è¡Œç·’ ğŸ‘·|
|**2. åœ¨ 5 ç§’ç­‰å¾…æœŸé–“**|è¢«ä½”ç”¨çš„åŸ·è¡Œç·’ ğŸ‘· **å®Œå…¨å¡ä½ (Blocked)**|
|**3. 5 ç§’çµæŸæ™‚**|è¢«å¡ä½çš„åŸ·è¡Œç·’ ğŸ‘· é†’ä¾†ï¼Œæº–å‚™å›å ±|

#### Task.Delay(5000)

|éšæ®µ|å‹•ä½œ|
|---|---|
|**1. ä»»å‹™é–‹å§‹æ™‚**|å‘ç³»çµ±è¨ˆæ™‚å™¨**è¨»å†Š** 1 å€‹å›å‘¼ ğŸ—’ï¸|
|**2. åœ¨ 5 ç§’ç­‰å¾…æœŸé–“**|**æ²’æœ‰ä»»ä½•**åŸ·è¡Œç·’æ± çš„åŸ·è¡Œç·’è¢«ä½”ç”¨|
|**3. 5 ç§’çµæŸæ™‚**|è¨ˆæ™‚å™¨ â²ï¸ è§¸ç™¼ï¼Œå¾åŸ·è¡Œç·’æ± **å– 1 å€‹ç©ºé–’çš„**åŸ·è¡Œç·’ ğŸ‘· ä¾†å›å ±|

### æœ€å¤§çš„ã€ŒAha!ã€æ™‚åˆ»

> **`Thread.Sleep` æ˜¯åœ¨ 5 ç§’é˜çš„ã€ŒæœŸé–“ã€éœ¸ä½”ä¸€å€‹åŸ·è¡Œç·’**
> 
> **`Task.Delay` æ˜¯åœ¨ 5 ç§’é˜ã€ŒçµæŸå¾Œã€çš„é‚£ä¸€ç¬é–“ï¼Œæ‰éœ€è¦ä¸€å€‹åŸ·è¡Œç·’ä¾†è™•ç†å¾ŒçºŒå·¥ä½œ**

### å¯¦éš›æ‡‰ç”¨å ´æ™¯

**ç‚ºä»€éº¼åœ¨ä¸€å€‹éœ€è¦åŒæ™‚è™•ç† 1000 å€‹è«‹æ±‚çš„ç¶²ç«™ä¼ºæœå™¨ (ASP.NET) ä¸Šï¼š**

#### ä½¿ç”¨ Thread.Sleep æœƒæ˜¯ç½é›£ âŒ

```csharp
// æ¯å€‹è«‹æ±‚éƒ½é€™æ¨£åš
await Task.Run(() => Thread.Sleep(5000));
```

- å¦‚æœåŒæ™‚æœ‰ 1000 å€‹è«‹æ±‚
- éœ€è¦ä½”ç”¨ 1000 å€‹åŸ·è¡Œç·’
- ä½†åŸ·è¡Œç·’æ± å¯èƒ½åªæœ‰ 100 å€‹åŸ·è¡Œç·’
- **çµæœï¼š** ä¼ºæœå™¨ç™±ç˜“ï¼Œç„¡æ³•å›æ‡‰æ–°è«‹æ±‚

#### ä½¿ç”¨ Task.Delay å¯ä»¥è¼•é¬†æ‡‰ä»˜ âœ…

```csharp
// æ¯å€‹è«‹æ±‚éƒ½é€™æ¨£åš
await Task.Delay(5000);
```

- å¦‚æœåŒæ™‚æœ‰ 1000 å€‹è«‹æ±‚
- åªéœ€è¦è¨»å†Š 1000 å€‹è¨ˆæ™‚å™¨ï¼ˆå¹¾ä¹ä¸æ¶ˆè€—è³‡æºï¼‰
- åŸ·è¡Œç·’æ± ä¿æŒè‡ªç”±ï¼Œå¯ä»¥è™•ç†å…¶ä»–å·¥ä½œ
- **çµæœï¼š** ä¼ºæœå™¨é‹ä½œæ­£å¸¸ï¼Œæ•ˆèƒ½å„ªç•°

---

## 10. ä¸åŒç’°å¢ƒçš„ SynchronizationContext è¡Œç‚º

### await ä¹‹å¾Œç¨‹å¼ç¢¼åœ¨å“ªåŸ·è¡Œï¼Ÿ

**é—œéµç­”æ¡ˆï¼š** await çš„é è¨­è¡Œç‚º `ConfigureAwait(true)`ï¼Œæ˜¯ã€Œå˜—è©¦å›åˆ°å®ƒè¢«å‘¼å«æ™‚æ‰€åœ¨çš„ SynchronizationContextã€

**ã€Œæœ‰æ²’æœ‰ SynchronizationContextã€å°±æ˜¯ä¸åŒç’°å¢ƒæœ€å¤§çš„å·®åˆ¥**

### ä¸åŒç’°å¢ƒçš„è¡Œç‚ºè¡¨

|åŸ·è¡Œç’°å¢ƒ|æœ‰æ²’æœ‰ `SynchronizationContext`ï¼Ÿ|`await Task.Delay(1000);` å¾ŒçºŒç¨‹å¼ç¢¼åœ¨å“ªåŸ·è¡Œï¼Ÿ|
|---|---|---|
|**WinForms / WPF**|âœ… **æœ‰** (UI ä¸Šä¸‹æ–‡)|**å›åˆ° UI åŸ·è¡Œç·’** (ç‚ºäº†å®‰å…¨æ›´æ–°ç•«é¢)|
|**ASP.NET (.NET Framework)**|âœ… **æœ‰** (`AspNetSynchronizationContext`)|**å›åˆ°åŸå§‹è«‹æ±‚çš„ä¸Šä¸‹æ–‡** (ç‚ºäº†å­˜å– `HttpContext`)|
|**Console æ‡‰ç”¨ç¨‹å¼**|âŒ **æ²’æœ‰** (é è¨­ç‚º `null`)|åœ¨**ä»»ä½•å¯ç”¨çš„èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool)** ä¸Šç¹¼çºŒ|
|**ASP.NET Core**|âŒ **æ²’æœ‰** (è¨­è¨ˆä¸Šç§»é™¤äº†)|åœ¨**ä»»ä½•å¯ç”¨çš„èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool)** ä¸Šç¹¼çºŒ|

### WinForms / WPF ç’°å¢ƒçš„è©³ç´°æµç¨‹

```csharp
private async void button1_Click(object sender, EventArgs e)
{
    // é€™è£¡åœ¨ UI Thread ä¸Š
    myLabel.Text = "ä¸‹è¼‰ä¸­...";
    
    // 1. await åŸ·è¡Œï¼Œå®ƒç™¼ç¾ SynchronizationContext.Current 
    //    (UI åŸ·è¡Œç·’çš„ä¸Šä¸‹æ–‡) å­˜åœ¨
    // 2. å®ƒã€Œæ•ç²ã€äº†é€™å€‹ UI ä¸Šä¸‹æ–‡
    // 3. Task.Delay(5000) åœ¨èƒŒæ™¯åŸ·è¡Œç·’æ± ä¸ŠåŸ·è¡Œ
    // 4. UI åŸ·è¡Œç·’è¢«é‡‹æ”¾ï¼Œå›å»è™•ç†ç•«é¢æ›´æ–°ã€å›æ‡‰ä½¿ç”¨è€…é»æ“Šç­‰
    await Task.Delay(5000);
    
    // 5. Task.Delay å®Œæˆå¾Œï¼Œawait æ©Ÿåˆ¶æœƒã€ŒPostã€å¾ŒçºŒçš„ç¨‹å¼ç¢¼
    //    (ä¹Ÿå°±æ˜¯ myLabel.Text = "...") åˆ°å®ƒã€Œæ•ç²ã€çš„ UI ä¸Šä¸‹æ–‡ä¸­
    // 6. UI åŸ·è¡Œç·’å¾å®ƒçš„å·¥ä½œä½‡åˆ—ä¸­å–å‡ºé€™é …å·¥ä½œä¸¦åŸ·è¡Œ
    
    // âœ… æ‰€ä»¥ï¼Œé€™ä¸€è¡Œ 100% æ˜¯åœ¨ã€ŒUI Threadã€ä¸ŠåŸ·è¡Œçš„ï¼
    myLabel.Text = "æª”æ¡ˆä¸‹è¼‰å®Œæˆï¼"; 
}
```

**çµè«–ï¼š** åœ¨ WinForms, WPF é€™ç¨® UI ç’°å¢ƒä¸‹ï¼Œawait é è¨­æœƒå¹«ä½ æŠŠç¨‹å¼ç¢¼ã€Œå‚³å›ã€UI åŸ·è¡Œç·’ï¼Œè®“ä½ å®‰å…¨åœ°æ›´æ–°ç•«é¢

### Console æ‡‰ç”¨ç¨‹å¼ / ASP.NET Core ç’°å¢ƒ

```csharp
static async Task Main(string[] args)
{
    Console.WriteLine($"åŸ·è¡Œå‰: Thread {Thread.CurrentThread.ManagedThreadId}");
    
    // SynchronizationContext.Current æ˜¯ null
    await Task.Delay(1000);
    
    // é€™æ®µç¨‹å¼ç¢¼æœƒåœ¨æŸå€‹ Thread Pool çš„åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ
    // å¯èƒ½æ˜¯ä¸åŒçš„åŸ·è¡Œç·’
    Console.WriteLine($"åŸ·è¡Œå¾Œ: Thread {Thread.CurrentThread.ManagedThreadId}");
}
```

**çµè«–ï¼š** åœ¨æ²’æœ‰ SynchronizationContext çš„ç’°å¢ƒä¸‹ï¼Œawait ä¹‹å¾Œçš„ç¨‹å¼ç¢¼æœƒç›´æ¥åœ¨å®Œæˆä»»å‹™çš„èƒŒæ™¯åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ

### ç‚ºä»€éº¼è½åˆ°å…©ç¨®èªªæ³•

**ã€Œç”±å…¶ä»– Thread åŸ·è¡Œã€å’Œã€Œå›åˆ°ä¸»åŸ·è¡Œç·’ã€é€™å…©ç¨®èªªæ³•éƒ½æ˜¯å°çš„**

**å·®åˆ¥åœ¨æ–¼ï¼š**

- **æœ‰ SynchronizationContext** â†’ å›åˆ°åŸå§‹åŸ·è¡Œç·’ï¼ˆUI Thread æˆ–è«‹æ±‚ä¸Šä¸‹æ–‡ï¼‰
- **æ²’æœ‰ SynchronizationContext** â†’ åœ¨ä»»ä½•å¯ç”¨çš„ Thread Pool åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ

---

## ç¸½çµèˆ‡æœ€ä½³å¯¦è¸

### æ ¸å¿ƒè§€å¿µå›é¡§

1. **SynchronizationContext æ˜¯åŸ·è¡Œç·’é–“æºé€šçš„æ©‹æ¨‘**
    
    - ç¢ºä¿ç¨‹å¼ç¢¼åœ¨æ­£ç¢ºçš„åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ
    - UI ç’°å¢ƒï¼šä¿è­· UI æ§åˆ¶é …ä¸è¢«è·¨åŸ·è¡Œç·’å­˜å–
    - ASP.NET Frameworkï¼šä¿è­· HttpContext ä¸æœƒä¸Ÿå¤±
2. **async/await è‡ªå‹•åŒ–äº†è¤‡é›œçš„åŸ·è¡Œç·’èª¿åº¦**
    
    - è‡ªå‹•æ•ç² SynchronizationContext
    - è‡ªå‹• Post å›åŸå§‹ä¸Šä¸‹æ–‡
    - è®“éåŒæ­¥ç¨‹å¼ç¢¼çœ‹èµ·ä¾†åƒåŒæ­¥ç¨‹å¼ç¢¼
3. **ConfigureAwait(false) æ˜¯å‡½å¼åº«é–‹ç™¼çš„é»ƒé‡‘æ³•å‰‡**
    
    - å‡½å¼åº«ä¸æ‡‰å‡è¨­å‘¼å«è€…çš„ä¸Šä¸‹æ–‡
    - é¿å…æ½›åœ¨çš„æ­»çµå•é¡Œ
    - æå‡æ•ˆèƒ½
4. **é¿å…ä½¿ç”¨ .Result æˆ– .Wait()**
    
    - å®¹æ˜“é€ æˆæ­»çµ
    - é˜»å¡åŸ·è¡Œç·’ï¼Œæµªè²»è³‡æº
    - æ‡‰è©²ä½¿ç”¨ await åˆ°åº•
5. **Task.Delay å„ªæ–¼ Thread.Sleep**
    
    - Task.Delay æ˜¯éé˜»å¡çš„ï¼Œä½¿ç”¨ç³»çµ±è¨ˆæ™‚å™¨
    - Thread.Sleep æœƒé˜»å¡åŸ·è¡Œç·’
    - åœ¨é«˜ä½µç™¼å ´æ™¯ä¸‹å·®ç•°å·¨å¤§

### å¿«é€Ÿæ±ºç­–æŒ‡å—

#### ä½•æ™‚ä½¿ç”¨é è¨­ awaitï¼Ÿ

- åœ¨æ‡‰ç”¨ç¨‹å¼å±¤
- éœ€è¦æ›´æ–° UI
- éœ€è¦å­˜å– HttpContext
- ç›´æ¥èˆ‡ä½¿ç”¨è€…äº’å‹•çš„ç¨‹å¼ç¢¼

#### ä½•æ™‚ä½¿ç”¨ ConfigureAwait(false)ï¼Ÿ

- åœ¨å‡½å¼åº«æˆ–å…±ç”¨ç¨‹å¼ç¢¼
- ä¸éœ€è¦å›åˆ°åŸå§‹ä¸Šä¸‹æ–‡
- è¿½æ±‚æ•ˆèƒ½æœ€ä½³åŒ–
- é¿å…æ­»çµé¢¨éšª

#### å¦‚ä½•é¿å…æ­»çµï¼Ÿ

1. **æ°¸é ä½¿ç”¨ async/awaitï¼Œä¸è¦ä½¿ç”¨ .Result æˆ– .Wait()**
2. **åœ¨å‡½å¼åº«ä¸­ä½¿ç”¨ ConfigureAwait(false)**
3. **è®“ async ä¸€è·¯å‚³æ’­åˆ°æœ€ä¸Šå±¤**

### async/await çš„ç²¾ç¥

> **Non-Blockingï¼ˆéé˜»å¡ï¼‰æ˜¯ async/await çš„æ ¸å¿ƒç²¾ç¥**
> 
> é‡‹æ”¾åŸ·è¡Œç·’ï¼Œè®“å®ƒå»åšæ›´æœ‰åƒ¹å€¼çš„äº‹æƒ…ï¼Œè€Œä¸æ˜¯å‚»å‚»åœ°ç­‰å¾…

---

## åƒè€ƒè³‡æº

### å»¶ä¼¸é–±è®€ä¸»é¡Œ

1. **TaskCompletionSource**ï¼šæ‰‹å‹•å»ºç«‹å’Œæ§åˆ¶ Task
2. **ValueTask**ï¼šæ¸›å°‘è¨˜æ†¶é«”é…ç½®çš„è¼•é‡ç´š Task
3. **IAsyncEnumerable**ï¼šéåŒæ­¥ä¸²æµè™•ç†
4. **Channels**ï¼šé«˜æ•ˆèƒ½çš„ç”Ÿç”¢è€…-æ¶ˆè²»è€…æ¨¡å¼
5. **async çš„æ•ˆèƒ½è€ƒé‡**ï¼šState Machine å’Œè¨˜æ†¶é«”é…ç½®

### å¯¦å‹™å»ºè­°

- åœ¨æ–°å°ˆæ¡ˆä¸­ï¼Œå„ªå…ˆä½¿ç”¨ ASP.NET Coreï¼ˆæ²’æœ‰ SynchronizationContext çš„è¤‡é›œæ€§ï¼‰
- ç†è§£ async/await çš„åº•å±¤æ©Ÿåˆ¶ï¼Œä½†æ—¥å¸¸é–‹ç™¼ä¸­ä¿¡ä»»å®ƒçš„è‡ªå‹•åŒ–
- ä½¿ç”¨ async åˆ†æå™¨ï¼ˆRoslyn Analyzersï¼‰æª¢æŸ¥å¸¸è¦‹éŒ¯èª¤
- å®šæœŸ review ç¨‹å¼ç¢¼ä¸­çš„ ConfigureAwait ä½¿ç”¨