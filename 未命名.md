---
date : 2025-07-16 22:45
aliases:
  - åˆ¥åæ¸¬è©¦1
  - åˆ¥åæ¸¬è©¦2
tags:
  - æ¨™ç±¤æ¸¬è©¦1
  - æ¨™ç±¤æ¸¬è©¦2

---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[]]
#### ğŸ“‘ [[]]

---
# Entity Framework æ•ˆèƒ½å„ªåŒ–èˆ‡æŸ¥è©¢æ·±åº¦è§£æ

## ç›®éŒ„

1. [Include vs ThenInclude æ•ˆèƒ½å·®ç•°](https://claude.ai/chat/6f26951b-447c-4131-8710-4ad63ac99b93#include-vs-theninclude-%E6%95%88%E8%83%BD%E5%B7%AE%E7%95%B0)
2. [N+1 æŸ¥è©¢å•é¡Œè©³è§£](https://claude.ai/chat/6f26951b-447c-4131-8710-4ad63ac99b93#n1-%E6%9F%A5%E8%A9%A2%E5%95%8F%E9%A1%8C%E8%A9%B3%E8%A7%A3)
3. [Select æŠ•å½±èˆ‡æŸ¥è©¢è½‰è­¯](https://claude.ai/chat/6f26951b-447c-4131-8710-4ad63ac99b93#select-%E6%8A%95%E5%BD%B1%E8%88%87%E6%9F%A5%E8%A9%A2%E8%BD%89%E8%AD%AF)
4. [å»¶é²åŸ·è¡Œ vs ç«‹å³åŸ·è¡Œ](https://claude.ai/chat/6f26951b-447c-4131-8710-4ad63ac99b93#%E5%BB%B6%E9%81%B2%E5%9F%B7%E8%A1%8C-vs-%E7%AB%8B%E5%8D%B3%E5%9F%B7%E8%A1%8C)
5. [SQL å­æŸ¥è©¢èˆ‡ EF è½‰è­¯æ©Ÿåˆ¶](https://claude.ai/chat/6f26951b-447c-4131-8710-4ad63ac99b93#sql-%E5%AD%90%E6%9F%A5%E8%A9%A2%E8%88%87-ef-%E8%BD%89%E8%AD%AF%E6%A9%9F%E5%88%B6)
6. [ç„¡å°èˆªå±¬æ€§æ™‚çš„æŸ¥è©¢ç­–ç•¥](https://claude.ai/chat/6f26951b-447c-4131-8710-4ad63ac99b93#%E7%84%A1%E5%B0%8E%E8%88%AA%E5%B1%AC%E6%80%A7%E6%99%82%E7%9A%84%E6%9F%A5%E8%A9%A2%E7%AD%96%E7%95%A5)
7. [æœ€ä½³å¯¦å‹™å»ºè­°](https://claude.ai/chat/6f26951b-447c-4131-8710-4ad63ac99b93#%E6%9C%80%E4%BD%B3%E5%AF%A6%E5%8B%99%E5%BB%BA%E8%AD%B0)

---

## Include vs ThenInclude æ•ˆèƒ½å·®ç•°

### åŸºæœ¬æ¦‚å¿µ

- **Include**ï¼šç”¨æ–¼è¼‰å…¥ç›´æ¥é—œè¯çš„å¯¦é«”
- **ThenInclude**ï¼šç”¨æ–¼è¼‰å…¥é–“æ¥é—œè¯ï¼ˆé—œè¯çš„é—œè¯ï¼‰çš„å¯¦é«”

### æ•ˆèƒ½æ¯”è¼ƒ

#### 1. SQL æŸ¥è©¢å±¤é¢

```csharp
// ä½¿ç”¨ Includeï¼ˆå–®å±¤é—œè¯ï¼‰
var orders = context.Orders
    .Include(o => o.Customer)
    .ToList();

// ä½¿ç”¨ Include + ThenIncludeï¼ˆå¤šå±¤é—œè¯ï¼‰
var orders = context.Orders
    .Include(o => o.Customer)
    .ThenInclude(c => c.Address)
    .ToList();
```

**SQL è¤‡é›œåº¦å·®ç•°**ï¼š

- **Include**: ç°¡å–®çš„ LEFT JOIN
- **ThenInclude**: å¤šé‡ LEFT JOINï¼ŒæŸ¥è©¢è¼ƒè¤‡é›œ

#### 2. è¨˜æ†¶é«”ä½¿ç”¨æ•ˆç‡

- **Include**: åªè¼‰å…¥éœ€è¦çš„ç›´æ¥é—œè¯è³‡æ–™
- **ThenInclude**: è¼‰å…¥å¤šå±¤é—œè¯ï¼Œè¨˜æ†¶é«”ä½¿ç”¨é‡è¼ƒé«˜

#### 3. ç¬›å¡çˆ¾ç©å•é¡Œ

åœ¨ä¸€å°å¤šé—œè¯ä¸­ï¼ŒThenInclude å¯èƒ½ç”¢ç”Ÿå¤§é‡é‡è¤‡è³‡æ–™ï¼š

```sql
-- ä¸€å°å¤šé—œè¯çš„ ThenInclude æœƒç”¢ç”Ÿé‡è¤‡çš„ä¸»è³‡æ–™
SELECT o.*, c.*, oi.*
FROM Orders o
LEFT JOIN Customers c ON o.CustomerId = c.Id
LEFT JOIN OrderItems oi ON o.Id = oi.OrderId
```

### EF6 vs EF Core èªæ³•å·®ç•°

#### EF6.1.3 èªæ³•

```csharp
// å­—ä¸²è·¯å¾‘èªæ³•
var orders = context.Orders
    .Include("Customer.Address")
    .ToList();

// Lambda è¡¨é”å¼ï¼ˆæ¨è–¦ï¼‰
var orders = context.Orders
    .Include(o => o.Customer.Address)  // è‡ªå‹•è¼‰å…¥ Customer å’Œ Address
    .ToList();
```

#### EF Core 3.1.2 èªæ³•

```csharp
// ThenInclude èªæ³•ï¼ˆæ¨è–¦ï¼‰
var orders = await context.Orders
    .Include(o => o.Customer)
    .ThenInclude(c => c.Address)
    .ToListAsync();
```

### é‡è¦è§€å¿µï¼šEF6 çš„è‡ªå‹•æ¨æ–·

åœ¨ EF6 ä¸­ï¼Œä½¿ç”¨ `Include(o => o.Customer.Address)` æ™‚ï¼š

- **ä¸éœ€è¦é¡å¤– Include Customer**
- EF6 æœƒè‡ªå‹•æ¨æ–·è·¯å¾‘ä¸¦è¼‰å…¥ä¸­é–“å¯¦é«”
- ç”¢ç”Ÿçš„ SQL æœƒåŒ…å«å¿…è¦çš„ JOIN èªå¥

---

## N+1 æŸ¥è©¢å•é¡Œè©³è§£

### ä»€éº¼æ˜¯ N+1 å•é¡Œï¼Ÿ

**N+1 å•é¡Œ**æŒ‡çš„æ˜¯ï¼šåŸ·è¡Œ 1 æ¬¡ä¸»æŸ¥è©¢ + N æ¬¡é¡å¤–æŸ¥è©¢ï¼Œç¸½å…± N+1 æ¬¡è³‡æ–™åº«æŸ¥è©¢ã€‚

### å¯¦éš›ç¯„ä¾‹

#### é€ æˆ N+1 å•é¡Œçš„ç¨‹å¼ç¢¼

```csharp
// 1. ä¸»æŸ¥è©¢ï¼šå–å¾—æ‰€æœ‰è¨‚å–®ï¼ˆæ²’æœ‰ Include Customerï¼‰
var orders = context.Orders.ToList(); // 1 æ¬¡æŸ¥è©¢

// 2. åœ¨è¿´åœˆä¸­å­˜å– Customer è³‡æ–™
foreach (var order in orders) 
{
    // æ¯æ¬¡éƒ½æœƒè§¸ç™¼ä¸€æ¬¡è³‡æ–™åº«æŸ¥è©¢ï¼
    Console.WriteLine($"è¨‚å–® {order.Id} - å®¢æˆ¶ï¼š{order.Customer.Name}");
    // â†‘ é€™è£¡æœƒç”¢ç”Ÿ N æ¬¡æŸ¥è©¢ï¼ˆN = è¨‚å–®æ•¸é‡ï¼‰
}
```

#### ç”¢ç”Ÿçš„ SQL æŸ¥è©¢

```sql
-- ç¬¬ 1 æ¬¡æŸ¥è©¢ï¼šä¸»æŸ¥è©¢
SELECT Id, CustomerId FROM Orders

-- ç¬¬ 2 æ¬¡æŸ¥è©¢ï¼šç¬¬ä¸€ç­†è¨‚å–®çš„å®¢æˆ¶
SELECT Id, Name FROM Customers WHERE Id = 1

-- ç¬¬ 3 æ¬¡æŸ¥è©¢ï¼šç¬¬äºŒç­†è¨‚å–®çš„å®¢æˆ¶
SELECT Id, Name FROM Customers WHERE Id = 2

-- ç¬¬ 4 æ¬¡æŸ¥è©¢ï¼šç¬¬ä¸‰ç­†è¨‚å–®çš„å®¢æˆ¶
SELECT Id, Name FROM Customers WHERE Id = 3
-- ... ä»¥æ­¤é¡æ¨
```

### è§£æ±ºæ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: ä½¿ç”¨ Includeï¼ˆæ¨è–¦ï¼‰

```csharp
// åªæœƒç”¢ç”Ÿ 1 æ¬¡æŸ¥è©¢
var orders = context.Orders
    .Include(o => o.Customer)  // é å…ˆè¼‰å…¥å®¢æˆ¶è³‡æ–™
    .ToList();

foreach (var order in orders) 
{
    // ä¸æœƒè§¸ç™¼é¡å¤–æŸ¥è©¢ï¼Œè³‡æ–™å·²ç¶“è¼‰å…¥äº†
    Console.WriteLine($"è¨‚å–® {order.Id} - å®¢æˆ¶ï¼š{order.Customer.Name}");
}
```

#### æ–¹æ¡ˆ 2: ä½¿ç”¨ Select æŠ•å½±

```csharp
var orderData = context.Orders
    .Select(o => new {
        OrderId = o.Id,
        CustomerName = o.Customer.Name
    })
    .ToList();
```

### æª¢æ¸¬ N+1 å•é¡Œçš„æ–¹æ³•

#### 1. å•Ÿç”¨ SQL æ—¥èªŒ

```csharp
// EF6
Database.Log = sql => Console.WriteLine(sql);

// EF Core
builder.Services.AddDbContext<YourDbContext>(options =>
    options.UseSqlServer(connectionString)
           .LogTo(Console.WriteLine));
```

#### 2. è§€å¯Ÿç—‡ç‹€

- ç¨‹å¼åŸ·è¡Œå¾ˆæ…¢
- è³‡æ–™åº«é€£ç·šæ•¸éå¤š
- æ—¥èªŒä¸­çœ‹åˆ°å¤§é‡é‡è¤‡çš„æŸ¥è©¢

---

## Select æŠ•å½±èˆ‡æŸ¥è©¢è½‰è­¯

### Select æŠ•å½±é¿å… N+1 å•é¡Œçš„åŸç†

ç•¶ä½¿ç”¨ Select æŠ•å½±æ™‚ï¼ŒEF æœƒè‡ªå‹•ç”¢ç”ŸåŒ…å« JOIN çš„å–®ä¸€æŸ¥è©¢ï¼Œè€Œä¸æ˜¯åˆ†åˆ¥æŸ¥è©¢æ¯å€‹è¡¨æ ¼ã€‚

### å¯¦éš› SQL æ¯”è¼ƒ

#### é€ æˆ N+1 å•é¡Œçš„å¯«æ³•

```csharp
var orders = context.Orders.ToList();
foreach (var order in orders) 
{
    var customerName = order.Customer.Name; // æ¯æ¬¡éƒ½æŸ¥è©¢è³‡æ–™åº«
}
```

ç”¢ç”Ÿçš„ SQLï¼ˆå‡è¨­æœ‰ 3 ç­†è¨‚å–®ï¼‰ï¼š

```sql
-- ä¸»æŸ¥è©¢
SELECT [o].[Id], [o].[CustomerId], [o].[OrderDate]
FROM [Orders] AS [o]

-- ç¬¬ 1 æ¬¡é¡å¤–æŸ¥è©¢
SELECT [c].[Id], [c].[Name]
FROM [Customers] AS [c]
WHERE [c].[Id] = 1

-- ç¬¬ 2 æ¬¡é¡å¤–æŸ¥è©¢
SELECT [c].[Id], [c].[Name]
FROM [Customers] AS [c]
WHERE [c].[Id] = 2

-- ç¬¬ 3 æ¬¡é¡å¤–æŸ¥è©¢
SELECT [c].[Id], [c].[Name]
FROM [Customers] AS [c]
WHERE [c].[Id] = 3
```

#### ä½¿ç”¨ Select æŠ•å½±

```csharp
var orderData = context.Orders
    .Select(o => new {
        OrderId = o.Id,
        OrderDate = o.OrderDate,
        CustomerName = o.Customer.Name,
        CustomerEmail = o.Customer.Email
    })
    .ToList();
```

ç”¢ç”Ÿçš„ SQLï¼ˆåªæœ‰ 1 æ¬¡æŸ¥è©¢ï¼‰ï¼š

```sql
SELECT [o].[Id] AS [OrderId], 
       [o].[OrderDate], 
       [c].[Name] AS [CustomerName],
       [c].[Email] AS [CustomerEmail]
FROM [Orders] AS [o]
INNER JOIN [Customers] AS [c] ON [o].[CustomerId] = [c].[Id]
```

### è¤‡é›œæŠ•å½±çš„è™•ç†

```csharp
var orderData = context.Orders
    .Select(o => new {
        OrderId = o.Id,
        CustomerName = o.Customer.Name,
        CustomerCity = o.Customer.Address.City,           // è·¨å¤šå€‹è¡¨æ ¼
        CustomerCountry = o.Customer.Address.Country,
        OrderItemCount = o.OrderItems.Count()             // èšåˆå‡½æ•¸
    })
    .ToList();
```

ç”¢ç”Ÿçš„ SQLï¼š

```sql
SELECT [o].[Id] AS [OrderId],
       [c].[Name] AS [CustomerName],
       [a].[City] AS [CustomerCity],
       [a].[Country] AS [CustomerCountry],
       (
           SELECT COUNT(*)
           FROM [OrderItems] AS [oi]
           WHERE [oi].[OrderId] = [o].[Id]
       ) AS [OrderItemCount]
FROM [Orders] AS [o]
INNER JOIN [Customers] AS [c] ON [o].[CustomerId] = [c].[Id]
LEFT JOIN [Addresses] AS [a] ON [c].[AddressId] = [a].[Id]
```

---

## å»¶é²åŸ·è¡Œ vs ç«‹å³åŸ·è¡Œ

### å»¶é²åŸ·è¡Œçš„æ¦‚å¿µ

Entity Framework æ¡ç”¨å»¶é²åŸ·è¡Œï¼ˆDeferred Executionï¼‰æ¨¡å¼ï¼ŒæŸ¥è©¢åœ¨å»ºç«‹æ™‚ä¸æœƒç«‹å³åŸ·è¡Œï¼Œç›´åˆ°éœ€è¦å¯¦éš›è³‡æ–™æ™‚æ‰åŸ·è¡Œã€‚

### ä¸æœƒç«‹å³åŸ·è¡Œè³‡æ–™åº«æŸ¥è©¢çš„æ“ä½œ

```csharp
// âœ… é€™äº›éƒ½ä¸æœƒå‘è³‡æ–™åº«æŸ¥è©¢
var query = entities.Orders.Where(o => o.IsActive);
var query2 = query.Select(o => o.Id);
var query3 = query2.OrderBy(o => o.CreatedDate);

// æ­¤æ™‚éƒ½é‚„æ²’æœ‰å‘è³‡æ–™åº«ç™¼é€ä»»ä½• SQL æŒ‡ä»¤ï¼
```

### æœƒç«‹å³åŸ·è¡Œè³‡æ–™åº«æŸ¥è©¢çš„æ“ä½œ

```csharp
// âŒ é€™äº›æœƒç«‹å³åŸ·è¡Œè³‡æ–™åº«æŸ¥è©¢
var list = query.ToList();        // ç«‹å³åŸ·è¡Œ
var array = query.ToArray();      // ç«‹å³åŸ·è¡Œ
var count = query.Count();        // ç«‹å³åŸ·è¡Œ
var first = query.First();        // ç«‹å³åŸ·è¡Œ
var any = query.Any();           // ç«‹å³åŸ·è¡Œ

// æˆ–è€…ä½¿ç”¨ foreach
foreach (var item in query)       // ç«‹å³åŸ·è¡Œ
{
    // ...
}
```

### ç«‹å³åŸ·è¡Œ vs å»¶é²åŸ·è¡Œçš„åˆ¤æ–·è¦å‰‡

#### ç«‹å³åŸ·è¡Œçš„æ¢ä»¶

1. **ç›´æ¥å° DbSet ä½¿ç”¨çµ‚çµæ–¹æ³•**

```csharp
entities.Orders.Count();        // ç«‹å³åŸ·è¡Œ
entities.Orders.ToList();       // ç«‹å³åŸ·è¡Œ
entities.Orders.First();        // ç«‹å³åŸ·è¡Œ
```

2. **å°å·²å…·ç¾åŒ–çš„é›†åˆä½¿ç”¨**

```csharp
var list = new List<Order> { ... };
list.Count();                   // ç«‹å³åŸ·è¡Œï¼ˆè¨˜æ†¶é«”ä¸­ï¼‰
```

#### å»¶é²åŸ·è¡Œçš„æ¢ä»¶

1. **åœ¨æŸ¥è©¢éˆçš„ä¸­é–“ä½¿ç”¨**

```csharp
var query = entities.Orders
    .Where(...)
    .Select(...)                // é‚„åœ¨å»ºæ§‹æŸ¥è©¢
    .OrderBy(...);              // é‚„åœ¨å»ºæ§‹æŸ¥è©¢
// ç›´åˆ°é‡åˆ°çµ‚çµæ–¹æ³•æ‰åŸ·è¡Œ
```

2. **åœ¨æŠ•å½±å…§éƒ¨ä½¿ç”¨èšåˆå‡½æ•¸**

```csharp
.Select(o => new {
    Count = o.OrderItems.Count()  // å»¶é²åŸ·è¡Œï¼Œæˆç‚º SQL å­æŸ¥è©¢
})
```

### æŠ•å½±å…§éƒ¨çš„ ToList() é€ æˆ N+1 å•é¡Œ

```csharp
var result = query.Select(s => new ATWebViewModel.BaseLineCPUSpecModel {
    Id = s.Id,
    Year = s.Year,
    // ğŸ”¥ é—œéµï¼šé€™å€‹ ToList() æœƒå¼·åˆ¶åŸ·è¡Œï¼
    BaseLineCPUs = s.Performance_BaseLineCPU.Where(c => c.IsValid).ToList()
}).ToList(); // ğŸ”¥ æœ€å¤–å±¤çš„ ToList() ä¹ŸæœƒåŸ·è¡Œ
```

åŸ·è¡Œé †åºï¼š

1. **ç¬¬ä¸€æ¬¡æŸ¥è©¢**ï¼šæœ€å¤–å±¤çš„ `ToList()` è§¸ç™¼ä¸»æŸ¥è©¢
2. **N æ¬¡æŸ¥è©¢**ï¼šæŠ•å½±å…§éƒ¨çš„ `ToList()` å°æ¯ç­†è³‡æ–™è§¸ç™¼å­æŸ¥è©¢

---

## SQL å­æŸ¥è©¢èˆ‡ EF è½‰è­¯æ©Ÿåˆ¶

### EF å¯ä»¥è½‰è­¯ vs ä¸èƒ½è½‰è­¯çš„æ–¹æ³•

#### âœ… å¯ä»¥è½‰è­¯æˆ SQL å­æŸ¥è©¢ï¼ˆä¸æœƒé€ æˆ N+1ï¼‰

```csharp
// èšåˆå‡½æ•¸
o.OrderItems.Count()
o.OrderItems.Count(oi => oi.IsActive)
o.OrderItems.Sum(oi => oi.Price)
o.OrderItems.Max(oi => oi.Price)
o.OrderItems.Min(oi => oi.Price)
o.OrderItems.Average(oi => oi.Price)

// å­˜åœ¨æ€§æª¢æŸ¥
o.OrderItems.Any()
o.OrderItems.Any(oi => oi.IsActive)

// å–®ä¸€è¨˜éŒ„æŸ¥è©¢
o.OrderItems.First()
o.OrderItems.First(oi => oi.IsActive)
o.OrderItems.FirstOrDefault()
o.OrderItems.FirstOrDefault(oi => oi.IsActive)
o.OrderItems.Single()
o.OrderItems.SingleOrDefault()
```

#### âŒ ç„¡æ³•è½‰è­¯æˆ SQLï¼ˆæœƒé€ æˆ N+1ï¼‰

```csharp
// é›†åˆå…·ç¾åŒ–
o.OrderItems.ToList()
o.OrderItems.ToArray()
o.OrderItems.ToHashSet()
o.OrderItems.ToDictionary(oi => oi.Id)

// é›†åˆæ“ä½œ
o.OrderItems.AsEnumerable()
o.OrderItems.Distinct()  // åœ¨æŸäº›ç‰ˆæœ¬ä¸­
o.OrderItems.GroupBy()   // è¤‡é›œçš„ GroupBy
```

### è¨˜æ†¶æ³•å‰‡

åœ¨ Select æŠ•å½±å…§éƒ¨ï¼Œå¦‚æœæœ‰é€™äº›ã€Œé›†åˆå…·ç¾åŒ–ã€æ–¹æ³•ï¼š

- `.ToList()`
- `.ToArray()`
- `.ToDictionary()`
- `.AsEnumerable()`

å°±å¿…é ˆå…ˆç”¨ Include è¼‰å…¥ç›¸é—œè³‡æ–™ï¼Œé¿å… N+1 å•é¡Œã€‚

### SQL å­æŸ¥è©¢çš„èƒ½åŠ›èˆ‡é™åˆ¶

#### SQL å¯ä»¥è™•ç†çš„æƒ…æ³

```sql
-- âœ… èšåˆå‡½æ•¸ï¼šå¤šç­† â†’ å–®ä¸€å€¼
SELECT o.Id, (SELECT COUNT(*) FROM OrderItems oi WHERE oi.OrderId = o.Id)

-- âœ… TOP/LIMITï¼šå¤šç­† â†’ å–®ç­†
SELECT o.Id, (SELECT TOP(1) oi.ProductName FROM OrderItems oi WHERE oi.OrderId = o.Id)

-- âœ… æ¢ä»¶æª¢æŸ¥ï¼šå¤šç­† â†’ å¸ƒæ—å€¼
SELECT o.Id, (SELECT CASE WHEN EXISTS(SELECT 1 FROM OrderItems oi WHERE oi.OrderId = o.Id) THEN 1 ELSE 0 END)
```

#### SQL ç„¡æ³•è™•ç†çš„æƒ…æ³

```sql
-- âŒ å¤šç­†è¨˜éŒ„ä½œç‚ºé›†åˆ
SELECT o.Id, (å¤šç­† OrderItems ä½œç‚ºä¸€å€‹é›†åˆ) -- SQL èªæ³•æ ¹æœ¬ä¸æ”¯æ´
```

### FirstOrDefault() åœ¨ Select æŠ•å½±ä¸­çš„è™•ç†

```csharp
var result = entities.Orders
    .Select(o => new {
        OrderId = o.Id,
        // FirstOrDefault() å›å‚³æ•´å€‹ç‰©ä»¶
        FirstItem = o.OrderItems.FirstOrDefault(oi => oi.IsActive)
    })
    .ToList();
```

ç”¢ç”Ÿçš„ SQLï¼š

```sql
SELECT 
    o.[Id] AS [OrderId],
    -- FirstOrDefault() æœƒç”¢ç”Ÿå­æŸ¥è©¢ï¼Œé¸å–æ‰€æœ‰æ¬„ä½
    (
        SELECT TOP(1) oi.[Id], oi.[Name], oi.[Price], oi.[OrderId]
        FROM [OrderItems] AS [oi]
        WHERE [oi].[OrderId] = o.[Id] AND [oi].[IsActive] = 1
    ) AS [FirstItem]
FROM [Orders] AS [o]
```

### ç¾ä»£ SQL çš„ JSON æ”¯æ´

```sql
-- SQL Server 2016+ æ”¯æ´ JSON èšåˆ
SELECT 
    o.Id,
    (
        SELECT oi.ProductName, oi.Price
        FROM OrderItems oi 
        WHERE oi.OrderId = o.Id
        FOR JSON PATH  -- å°‡å¤šç­†è¨˜éŒ„è½‰æˆ JSON å­—ä¸²
    ) AS ItemsJson
FROM Orders o
```

EF åœ¨æŸäº›æƒ…æ³ä¸‹æœƒä½¿ç”¨ JSON ä¾†è™•ç†è¤‡é›œçš„ç‰©ä»¶æŸ¥è©¢ã€‚

---

## ç„¡å°èˆªå±¬æ€§æ™‚çš„æŸ¥è©¢ç­–ç•¥

### å•é¡Œæƒ…å¢ƒ

ç•¶å…©å€‹å¯¦é«”é–“æ²’æœ‰è¨­å®š ForeignKey ä¸²æ¥æ™‚ï¼Œå¦‚ä½•é€²è¡Œé—œè¯æŸ¥è©¢ï¼Ÿ

### æ¸¬è©¦æ¡ˆä¾‹

```csharp
var result = entities.GroupSetting
    .Select(g => new {
        GroupId = g.Id,        
        FirstModel = entities.ModelSettings.Where(m => m.GroupId == g.Id).FirstOrDefault()
    })
    .ToList();
```

### æƒ…æ³åˆ†æ

#### æƒ…æ³ä¸€ï¼šæœ‰å°èˆªå±¬æ€§

- **é æœŸçµæœ**ï¼šâœ… æœƒè½‰è­¯æˆå­æŸ¥è©¢
- **åŸå› **ï¼šEF çŸ¥é“è¡¨æ ¼ä¹‹é–“çš„é—œè¯é—œä¿‚

#### æƒ…æ³äºŒï¼šæ²’æœ‰å°èˆªå±¬æ€§

- **é æœŸçµæœ**ï¼šâŒ å¯èƒ½ç„¡æ³•è½‰è­¯æˆ–é€ æˆ N+1 å•é¡Œ
- **åŸå› **ï¼šEF ä¸çŸ¥é“è¡¨æ ¼ä¹‹é–“çš„æ­£å¼é—œè¯

### å¯èƒ½çš„åŸ·è¡Œçµæœ

#### çµæœ1ï¼šæˆåŠŸè½‰è­¯æˆå­æŸ¥è©¢ âœ…

```sql
SELECT 
    g.[Id] AS [GroupId],
    (
        SELECT TOP(1) m.[Id], m.[Name], m.[IsValid]
        FROM [ModelSettings] AS [m]
        WHERE [m].[GroupId] = g.[Id]
    ) AS [FirstModel]
FROM [GroupSetting] AS [g]
```

#### çµæœ2ï¼šåŸ·è¡Œæ™‚éŒ¯èª¤ âŒ

```
System.NotSupportedException: ç„¡æ³•å°‡è¡¨é”å¼è½‰æ›ç‚º SQL
```

#### çµæœ3ï¼šN+1 æŸ¥è©¢ âš ï¸

```sql
-- ä¸»æŸ¥è©¢
SELECT g.[Id] FROM [GroupSetting] AS [g]

-- å°æ¯ç­†è³‡æ–™åŸ·è¡Œä¸€æ¬¡
SELECT TOP(1) m.* FROM [ModelSettings] AS [m] WHERE [m].[GroupId] = 1
SELECT TOP(1) m.* FROM [ModelSettings] AS [m] WHERE [m].[GroupId] = 2
-- ... ä»¥æ­¤é¡æ¨
```

### æ¨è–¦çš„è§£æ±ºæ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ‰‹å‹• JOINï¼ˆæ¨è–¦ï¼‰

```csharp
var result = entities.GroupSetting
    .GroupJoin(entities.ModelSettings,
               g => g.Id,
               m => m.GroupId,
               (g, models) => new {
                   GroupId = g.Id,
                   FirstModel = models.FirstOrDefault()
               })
    .ToList();
```

#### æ–¹æ¡ˆ2ï¼šè¤‡é›œçš„ JOIN èˆ‡ GROUP BY

```csharp
var result = entities.GroupSetting
    .Join(entities.ModelSettings, 
          g => g.Id, 
          m => m.GroupId, 
          (g, m) => new { g, m })
    .GroupBy(x => x.g.Id)
    .Select(group => new {
        GroupId = group.Key,
        FirstModel = group.Select(x => x.m).FirstOrDefault()
    })
    .ToList();
```

#### æ–¹æ¡ˆ3ï¼šåˆ†é–‹æŸ¥è©¢

```csharp
var groups = entities.GroupSetting.ToList();
var groupIds = groups.Select(g => g.Id).ToList();
var modelSettings = entities.ModelSettings
    .Where(m => groupIds.Contains(m.GroupId))
    .ToList();

var result = groups.Select(g => new {
    GroupId = g.Id,
    FirstModel = modelSettings.FirstOrDefault(m => m.GroupId == g.Id)
}).ToList();
```

#### æ–¹æ¡ˆ4ï¼šæ·»åŠ å°èˆªå±¬æ€§ï¼ˆæœ€ä½³è§£æ±ºæ–¹æ¡ˆï¼‰

```csharp
// åœ¨ GroupSetting å¯¦é«”é¡åˆ¥ä¸­åŠ å…¥ï¼š
public virtual ICollection<ModelSetting> ModelSettings { get; set; }

// åœ¨ DbContext é…ç½®ä¸­åŠ å…¥ï¼š
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder.Entity<GroupSetting>()
        .HasMany(g => g.ModelSettings)
        .WithOne(m => m.GroupSetting)
        .HasForeignKey(m => m.GroupId);
}
```

### ç‚ºä»€éº¼æ¨è–¦æ‰‹å‹• JOINï¼Ÿ

#### 1. å¯é æ¸¬æ€§

- ä¸€å®šæœƒç”¢ç”Ÿå–®ä¸€æŸ¥è©¢
- ä¸æœƒæœ‰ N+1 å•é¡Œ

#### 2. æ•ˆèƒ½ä¿è­‰

- ç”¢ç”Ÿå¯é æ¸¬çš„ SQL
- é¿å…ä¾è³´ EF çš„æŸ¥è©¢è½‰è­¯èƒ½åŠ›

#### 3. è·¨ç‰ˆæœ¬ç›¸å®¹æ€§

- åœ¨æ‰€æœ‰ EF ç‰ˆæœ¬ä¸­éƒ½èƒ½æ­£å¸¸é‹ä½œ

---

## æœ€ä½³å¯¦å‹™å»ºè­°

### 1. æŸ¥è©¢æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

#### å„ªå…ˆé †åº

1. **ä½¿ç”¨å°èˆªå±¬æ€§**ï¼šç¢ºä¿å¯¦é«”é–“æœ‰æ­£ç¢ºçš„é—œè¯è¨­å®š
2. **é¸æ“‡é©ç•¶çš„è¼‰å…¥ç­–ç•¥**ï¼š
    - éœ€è¦å®Œæ•´å¯¦é«”ç‰©ä»¶ â†’ ä½¿ç”¨ Include/ThenInclude
    - åªéœ€è¦éƒ¨åˆ†è³‡æ–™ â†’ ä½¿ç”¨ Select æŠ•å½±
3. **é¿å… N+1 å•é¡Œ**ï¼šæŠ•å½±å…§éƒ¨ä¸ä½¿ç”¨ ToList()ã€ToArray() ç­‰
4. **ä½¿ç”¨ç•°æ­¥æ–¹æ³•**ï¼šToListAsync()ã€CountAsync() ç­‰

#### ä¸åŒå ´æ™¯çš„æœ€ä½³é¸æ“‡

**API å›å‚³è³‡æ–™**ï¼š

```csharp
// âœ… ä½¿ç”¨ Select æŠ•å½±
public async Task<IActionResult> GetOrderList()
{
    var data = await context.Orders
        .Select(o => new {
            o.Id,
            o.OrderDate,
            CustomerName = o.Customer.Name,
            CustomerCity = o.Customer.Address.City
        })
        .ToListAsync();
    
    return Json(data);
}
```

**æ¥­å‹™é‚è¼¯è™•ç†**ï¼š

```csharp
// âœ… ä½¿ç”¨ Include/ThenInclude
public async Task ProcessOrder(int orderId)
{
    var order = await context.Orders
        .Include(o => o.Customer)
        .ThenInclude(c => c.Address)
        .Include(o => o.OrderItems)
        .FirstOrDefaultAsync(o => o.Id == orderId);
    
    // å¯ä»¥å­˜å–å®Œæ•´çš„å¯¦é«”ç‰©ä»¶
    order.Customer.LastOrderDate = DateTime.Now;
    order.OrderItems.Add(new OrderItem { ... });
    
    await context.SaveChangesAsync();
}
```

### 2. ç‰ˆæœ¬å·®ç•°è€ƒé‡

#### Portal ç³»çµ± (.NET Core 3.1 + EF Core 3.1.2)

```csharp
// æ¨è–¦ä½¿ç”¨ç¾ä»£èªæ³•
public async Task<IActionResult> GetOrderData()
{
    var data = await _context.Orders
        .Include(o => o.Customer)
        .ThenInclude(c => c.Address)
        .Select(o => new {
            o.Id,
            CustomerName = o.Customer.Name,
            CustomerCity = o.Customer.Address.City
        })
        .ToListAsync();
    
    return Json(data);
}
```

#### GTS ç³»çµ± (.NET Framework 4.8 + EF6.1.3)

```csharp
// ä½¿ç”¨ EF6 ç›¸å®¹èªæ³•
public async Task<List<OrderDto>> GetOrderData()
{
    return await context.Orders
        .Include(o => o.Customer.Address)  // EF6 å¯ä»¥ç›´æ¥é€™æ¨£å¯«
        .Select(o => new OrderDto {
            Id = o.Id,
            CustomerName = o.Customer.Name,
            CustomerCity = o.Customer.Address.City
        })
        .ToListAsync();
}
```

### 3. æ•ˆèƒ½ç›£æ§èˆ‡åµéŒ¯

#### å•Ÿç”¨ SQL æ—¥èªŒ

```csharp
// EF6
Database.Log = sql => Console.WriteLine(sql);

// EF Core
protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
    optionsBuilder.LogTo(Console.WriteLine, Microsoft.Extensions.Logging.LogLevel.Information);
}
```

#### æª¢æŸ¥æŸ¥è©¢æ•ˆèƒ½

```csharp
// æª¢æŸ¥æ˜¯å¦æœ‰ N+1 å•é¡Œ
var stopwatch = Stopwatch.StartNew();
var result = await context.Orders
    .Select(o => new {
        o.Id,
        CustomerName = o.Customer.Name
    })
    .ToListAsync();
stopwatch.Stop();

Console.WriteLine($"æŸ¥è©¢è€—æ™‚: {stopwatch.ElapsedMilliseconds}ms");
Console.WriteLine($"è³‡æ–™ç­†æ•¸: {result.Count}");
```

### 4. å¸¸è¦‹éŒ¯èª¤èˆ‡é¿å…æ–¹å¼

#### éŒ¯èª¤ 1ï¼šæŠ•å½±å…§éƒ¨ä½¿ç”¨ ToList()

```csharp
// âŒ éŒ¯èª¤
var bad = context.Orders
    .Select(o => new {
        OrderId = o.Id,
        Items = o.OrderItems.ToList()  // é€ æˆ N+1
    })
    .ToList();

// âœ… æ­£ç¢º
var good = context.Orders
    .Include(o => o.OrderItems)
    .Select(o => new {
        OrderId = o.Id,
        Items = o.OrderItems.ToList()
    })
    .ToList();
```

#### éŒ¯èª¤ 2ï¼šéåº¦ä½¿ç”¨ ThenInclude

```csharp
// âŒ éŒ¯èª¤ï¼šéå¤šå±¤ç´š
var bad = context.Orders
    .Include(o => o.Customer)
    .ThenInclude(c => c.Address)
    .ThenInclude(a => a.City)
    .ThenInclude(c => c.Country)
    .ToList();

// âœ… æ­£ç¢ºï¼šæŒ‰éœ€è¼‰å…¥
var good = context.Orders
    .Include(o => o.Customer)
    .Where(o => o.OrderDate > DateTime.Now.AddMonths(-1))
    .ToList();
```

#### éŒ¯èª¤ 3ï¼šå¿˜è¨˜ä½¿ç”¨ç•°æ­¥æ–¹æ³•

```csharp
// âŒ éŒ¯èª¤ï¼šåŒæ­¥æ–¹æ³•
var orders = context.Orders.ToList();

// âœ… æ­£ç¢ºï¼šç•°æ­¥æ–¹æ³•
var orders = await context.Orders.ToListAsync();
```

### 5. è¨˜æ†¶å£è¨£

#### æŸ¥è©¢å„ªåŒ–å£è¨£

1. **å…ˆæƒ³æŠ•å½±ï¼Œå†æƒ³åŒ…å«**ï¼šå„ªå…ˆè€ƒæ…®æ˜¯å¦åªéœ€è¦éƒ¨åˆ†è³‡æ–™
2. **é›†åˆå…·ç¾åŒ–è¦å°å¿ƒ**ï¼šToList()ã€ToArray() è¦å…ˆ Include
3. **èšåˆå‡½æ•¸å¯å®‰å¿ƒ**ï¼šCount()ã€Sum()ã€FirstOrDefault() å¯ä»¥ç›´æ¥ç”¨
4. **å°èˆªå±¬æ€§æ˜¯ç‹é“**ï¼šæœ‰é—œè¯è¨­å®šå°±ç”¨å°èˆªå±¬æ€§
5. **ç•°æ­¥æ–¹æ³•è¦è¨˜å¾—**ï¼šToListAsync()ã€CountAsync() æå‡æ•ˆèƒ½

#### æ•ˆèƒ½æª¢æŸ¥æ¸…å–®

- [ ] æ˜¯å¦ä½¿ç”¨äº†é©ç•¶çš„è¼‰å…¥ç­–ç•¥ï¼Ÿ
- [ ] æ˜¯å¦é¿å…äº† N+1 å•é¡Œï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨äº†ç•°æ­¥æ–¹æ³•ï¼Ÿ
- [ ] æ˜¯å¦å•Ÿç”¨äº† SQL æ—¥èªŒä¾†ç›£æ§ï¼Ÿ
- [ ] æ˜¯å¦é‡å°ä¸åŒå ´æ™¯é¸æ“‡äº†æœ€ä½³æ–¹æ¡ˆï¼Ÿ

---

## ç¸½çµ

Entity Framework çš„æŸ¥è©¢å„ªåŒ–æ˜¯ä¸€å€‹è¤‡é›œä½†é‡è¦çš„ä¸»é¡Œã€‚é€šéæ·±å…¥ç†è§£ Include/ThenInclude çš„æ•ˆèƒ½å·®ç•°ã€N+1 å•é¡Œçš„åŸå› èˆ‡è§£æ±ºæ–¹æ¡ˆã€Select æŠ•å½±çš„è½‰è­¯æ©Ÿåˆ¶ã€ä»¥åŠå»¶é²åŸ·è¡Œèˆ‡ç«‹å³åŸ·è¡Œçš„å·®ç•°ï¼Œæˆ‘å€‘å¯ä»¥å¯«å‡ºæ›´é«˜æ•ˆçš„è³‡æ–™å­˜å–ä»£ç¢¼ã€‚

è¨˜ä½é—œéµåŸå‰‡ï¼š

- æ ¹æ“šéœ€æ±‚é¸æ“‡é©ç•¶çš„è¼‰å…¥ç­–ç•¥
- é¿å…åœ¨æŠ•å½±å…§éƒ¨ä½¿ç”¨é›†åˆå…·ç¾åŒ–æ–¹æ³•
- å–„ç”¨ EF çš„æŸ¥è©¢è½‰è­¯èƒ½åŠ›
- å§‹çµ‚ç›£æ§ SQL æŸ¥è©¢çš„å¯¦éš›åŸ·è¡Œæƒ…æ³

é€šéé€™äº›æœ€ä½³å¯¦å‹™çš„æ‡‰ç”¨ï¼Œæ‚¨çš„ Portal ç³»çµ±å’Œ GTS ç³»çµ±éƒ½èƒ½ç²å¾—æ›´å¥½çš„æ•ˆèƒ½è¡¨ç¾ã€‚
