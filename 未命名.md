---
date : 2025-07-10 15:21
aliases:
  - åˆ¥åæ¸¬è©¦1
  - åˆ¥åæ¸¬è©¦2
tags:
  - æ¨™ç±¤æ¸¬è©¦1
  - æ¨™ç±¤æ¸¬è©¦2

---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[æ­¡è¿]]
#### ğŸ“‘ [[æ­¡è¿]]

---

# ClosedXML Excel åŒ¯å‡ºå®Œæ•´æ•™å­¸

## 1. ç’°å¢ƒæº–å‚™

### 1.1 å®‰è£ NuGet å¥—ä»¶
```bash
Install-Package ClosedXML -Version 0.95.2
```

### 1.2 å¿…è¦çš„ using å®£å‘Š
```csharp
using ClosedXML.Excel;
using System.IO;
using System.ComponentModel;
using System.ComponentModel.DataAnnotations;
using System.Reflection;
```

## 2. åŸºæœ¬ Excel åŒ¯å‡ºæ¶æ§‹

### 2.1 Controller æ–¹æ³•çµæ§‹
```csharp
[HttpPost]
public IActionResult ExportToExcel()
{
    try
    {
        // 1. å»ºç«‹ Workbook å’Œ MemoryStream
        using (var workbook = new XLWorkbook())
        using (var ms = new MemoryStream())
        {
            // 2. å»ºç«‹å·¥ä½œè¡¨
            var worksheet = workbook.Worksheets.Add("è³‡æ–™è¡¨");
            
            // 3. å¡«å…¥è³‡æ–™
            PopulateWorksheet(worksheet);
            
            // 4. å„²å­˜åˆ° MemoryStream
            workbook.SaveAs(ms);
            ms.Flush();
            ms.Position = 0;
            
            // 5. ç”¢ç”Ÿæª”æ¡ˆåç¨±ä¸¦å›å‚³
            string fileName = DateTime.Now.ToString("yyyyMMddHHmmssfff") + "_MemberList.xlsx";
            return File(ms.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
        }
    }
    catch (Exception ex)
    {
        // éŒ¯èª¤è™•ç†
        return BadRequest("åŒ¯å‡ºå¤±æ•—: " + ex.Message);
    }
}
```

## 3. è³‡æ–™å¡«å…¥æ–¹æ³•

### 3.1 ä½¿ç”¨åå°„å–å¾—å±¬æ€§è³‡è¨Š
```csharp
private void PopulateWorksheet(IXLWorksheet worksheet)
{
    // å–å¾—è³‡æ–™
    var data = GetDataList(); // æ‚¨çš„è³‡æ–™ä¾†æº
    
    if (data?.Any() == true)
    {
        // å–å¾—ç¬¬ä¸€ç­†è³‡æ–™çš„å‹åˆ¥
        var dataType = data.First().GetType();
        var properties = dataType.GetProperties();
        
        // å»ºç«‹æ¨™é¡Œåˆ—
        CreateHeaderRow(worksheet, properties);
        
        // å¡«å…¥è³‡æ–™åˆ—
        FillDataRows(worksheet, data, properties);
        
        // èª¿æ•´æ¬„ä½å¯¬åº¦
        worksheet.Columns().AdjustToContents();
    }
}
```

### 3.2 å»ºç«‹æ¨™é¡Œåˆ—
```csharp
private void CreateHeaderRow(IXLWorksheet worksheet, PropertyInfo[] properties)
{
    int colIndex = 1;
    
    foreach (var property in properties)
    {
        // å–å¾— DisplayName å±¬æ€§ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨å±¬æ€§åç¨±
        string displayName = property.Name;
        var displayNameAttr = property.GetCustomAttribute(typeof(DisplayNameAttribute)) as DisplayNameAttribute;
        if (displayNameAttr != null)
        {
            displayName = displayNameAttr.DisplayName;
        }
        
        // è¨­å®šæ¨™é¡Œå„²å­˜æ ¼
        var headerCell = worksheet.Cell(1, colIndex);
        headerCell.Value = displayName;
        
        // è¨­å®šæ¨™é¡Œæ¨£å¼
        headerCell.Style.Font.Bold = true;
        headerCell.Style.Fill.BackgroundColor = XLColor.FromArgb(220, 220, 220);
        headerCell.Style.Border.OutsideBorder = XLBorderStyleValues.Thin;
        headerCell.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;
        
        colIndex++;
    }
}
```

### 3.3 å¡«å…¥è³‡æ–™åˆ—
```csharp
private void FillDataRows(IXLWorksheet worksheet, IEnumerable<object> data, PropertyInfo[] properties)
{
    int rowIndex = 2; // å¾ç¬¬äºŒåˆ—é–‹å§‹ï¼ˆç¬¬ä¸€åˆ—æ˜¯æ¨™é¡Œï¼‰
    
    foreach (var item in data)
    {
        int colIndex = 1;
        
        foreach (var property in properties)
        {
            var value = property.GetValue(item);
            var cell = worksheet.Cell(rowIndex, colIndex);
            
            // è¨­å®šå„²å­˜æ ¼å€¼
            cell.Value = value?.ToString() ?? "";
            
            // è¨­å®šè³‡æ–™åˆ—æ¨£å¼
            cell.Style.Border.OutsideBorder = XLBorderStyleValues.Thin;
            
            colIndex++;
        }
        
        rowIndex++;
    }
}
```

## 4. é€²éšæ¨£å¼è¨­å®š

### 4.1 åˆä½µå„²å­˜æ ¼
```csharp
// åˆä½µæŒ‡å®šç¯„åœçš„å„²å­˜æ ¼
var range = worksheet.Range(1, 1, 1, 5); // ç¬¬1åˆ—ï¼Œç¬¬1æ¬„åˆ°ç¬¬5æ¬„
range.Merge();
range.Value = "å ±è¡¨æ¨™é¡Œ";
range.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;
```

### 4.2 è¨­å®šå­—å‹å’Œé¡è‰²
```csharp
var cell = worksheet.Cell(1, 1);
cell.Style.Font.Bold = true;
cell.Style.Font.FontColor = XLColor.FromArgb(255, 0, 0); // ç´…è‰²å­—é«”
cell.Style.Fill.BackgroundColor = XLColor.FromArgb(255, 255, 0); // é»ƒè‰²èƒŒæ™¯
```

### 4.3 è¨­å®šé‚Šæ¡†
```csharp
var range = worksheet.Range("A1:E10");
range.Style.Border.OutsideBorder = XLBorderStyleValues.Thick;
range.Style.Border.InsideBorder = XLBorderStyleValues.Thin;
```

## 5. å®Œæ•´ç¯„ä¾‹

### 5.1 è³‡æ–™æ¨¡å‹
```csharp
public class MemberModel
{
    [DisplayName("ç·¨è™Ÿ")]
    public int Id { get; set; }
    
    [DisplayName("å§“å")]
    public string Name { get; set; }
    
    [DisplayName("é›»å­éƒµä»¶")]
    public string Email { get; set; }
    
    [DisplayName("å»ºç«‹æ—¥æœŸ")]
    public DateTime CreateDate { get; set; }
}
```

### 5.2 å®Œæ•´çš„ Controller æ–¹æ³•
```csharp
[HttpPost]
public IActionResult ExportMemberList()
{
    try
    {
        var members = GetMemberList(); // å–å¾—æœƒå“¡æ¸…å–®
        
        using (var workbook = new XLWorkbook())
        using (var ms = new MemoryStream())
        {
            var worksheet = workbook.Worksheets.Add("æœƒå“¡æ¸…å–®");
            
            // å»ºç«‹æ¨™é¡Œåˆ—
            CreateMemberHeader(worksheet);
            
            // å¡«å…¥è³‡æ–™
            FillMemberData(worksheet, members);
            
            // èª¿æ•´æ¬„ä½å¯¬åº¦
            worksheet.Columns().AdjustToContents();
            
            // å„²å­˜ä¸¦å›å‚³
            workbook.SaveAs(ms);
            ms.Flush();
            ms.Position = 0;
            
            string fileName = $"MemberList_{DateTime.Now:yyyyMMddHHmmssfff}.xlsx";
            return File(ms.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
        }
    }
    catch (Exception ex)
    {
        return BadRequest($"åŒ¯å‡ºå¤±æ•—: {ex.Message}");
    }
}

private void CreateMemberHeader(IXLWorksheet worksheet)
{
    // è¨­å®šæ¨™é¡Œåˆ—
    var headers = new[] { "ç·¨è™Ÿ", "å§“å", "é›»å­éƒµä»¶", "å»ºç«‹æ—¥æœŸ" };
    for (int i = 0; i < headers.Length; i++)
    {
        var cell = worksheet.Cell(1, i + 1);
        cell.Value = headers[i];
        cell.Style.Font.Bold = true;
        cell.Style.Fill.BackgroundColor = XLColor.FromArgb(220, 220, 220);
        cell.Style.Border.OutsideBorder = XLBorderStyleValues.Thin;
        cell.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;
    }
}

private void FillMemberData(IXLWorksheet worksheet, IEnumerable<MemberModel> members)
{
    int rowIndex = 2;
    
    foreach (var member in members)
    {
        worksheet.Cell(rowIndex, 1).Value = member.Id;
        worksheet.Cell(rowIndex, 2).Value = member.Name;
        worksheet.Cell(rowIndex, 3).Value = member.Email;
        worksheet.Cell(rowIndex, 4).Value = member.CreateDate.ToString("yyyy/MM/dd");
        
        // è¨­å®šè³‡æ–™åˆ—é‚Šæ¡†
        var range = worksheet.Range(rowIndex, 1, rowIndex, 4);
        range.Style.Border.OutsideBorder = XLBorderStyleValues.Thin;
        
        rowIndex++;
    }
}
```

## 6. æª”æ¡ˆå„²å­˜æ–¹å¼

### 6.1 ç›´æ¥ä¸‹è¼‰ (æ¨è–¦)
```csharp
string fileName = $"Export_{DateTime.Now:yyyyMMddHHmmssfff}.xlsx";
return File(ms.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
```

### 6.2 å„²å­˜åˆ°ä¼ºæœå™¨
```csharp
string folderPath = @"C:\Exports\";
string fileName = $"Export_{DateTime.Now:yyyyMMddHHmmss}.xlsx";
string fullPath = Path.Combine(folderPath, fileName);

// ç¢ºä¿ç›®éŒ„å­˜åœ¨
Directory.CreateDirectory(folderPath);

workbook.SaveAs(fullPath);
```

### 6.3 Base64 ç·¨ç¢¼æ–¹å¼
```csharp
workbook.SaveAs(ms);
ms.Flush();
ms.Position = 0;

// è½‰æ›ç‚º Base64
string base64String = Convert.ToBase64String(ms.ToArray());

// è§£ç¢¼ä¸¦ä¸‹è¼‰
var xls = new MemoryStream(Convert.FromBase64String(base64String));
return File(xls.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
```

## 7. æœ€ä½³å¯¦å‹™å»ºè­°

### 7.1 è¨˜æ†¶é«”ç®¡ç†
```csharp
// ä½¿ç”¨ using ç¢ºä¿è³‡æºæ­£ç¢ºé‡‹æ”¾
using (var workbook = new XLWorkbook())
using (var ms = new MemoryStream())
{
    // è™•ç†é‚è¼¯
    
    // æ‰‹å‹•æ¸…ç†ï¼ˆå¯é¸ï¼‰
    workbook.Dispose();
    ms.Flush();
    ms.Close();
}
```

### 7.2 éŒ¯èª¤è™•ç†
```csharp
try
{
    // Excel åŒ¯å‡ºé‚è¼¯
}
catch (Exception ex)
{
    // è¨˜éŒ„éŒ¯èª¤
    logger.LogError(ex, "Excel åŒ¯å‡ºå¤±æ•—");
    
    // å›å‚³éŒ¯èª¤è¨Šæ¯
    return BadRequest("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
}
```

### 7.3 å¤§é‡è³‡æ–™è™•ç†
```csharp
// å°æ–¼å¤§é‡è³‡æ–™ï¼Œè€ƒæ…®åˆ†æ‰¹è™•ç†
const int batchSize = 1000;
var batches = data.Skip(skip).Take(batchSize);

foreach (var batch in batches)
{
    // è™•ç†æ¯æ‰¹è³‡æ–™
}
```

## 8. å‰ç«¯ JavaScript é…åˆ

### 8.1 AJAX å‘¼å«
```javascript
function exportExcel() {
    $.ajax({
        url: '/YourController/ExportToExcel',
        type: 'POST',
        responseType: 'blob',
        success: function(data, status, xhr) {
            // å»ºç«‹ä¸‹è¼‰é€£çµ
            var blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'export.xlsx';
            a.click();
            window.URL.revokeObjectURL(url);
        },
        error: function() {
            alert('åŒ¯å‡ºå¤±æ•—');
        }
    });
}
```

### 8.2 è¡¨å–®æäº¤æ–¹å¼
```html
<form method="post" action="/YourController/ExportToExcel">
    <button type="submit" class="btn btn-primary">
        <i class="fa fa-download"></i> åŒ¯å‡º Excel
    </button>
</form>
```

é€™å€‹æ•™å­¸æ¶µè“‹äº†æ‚¨åœ¨ Portal ç³»çµ±ä¸­çœ‹åˆ°çš„æ‰€æœ‰é—œéµæŒ‡ä»¤ï¼Œä¸¦æä¾›äº†å®Œæ•´çš„å¯¦ä½œç¯„ä¾‹ã€‚æ‚¨å¯ä»¥æ ¹æ“šå¯¦éš›éœ€æ±‚èª¿æ•´æ¨£å¼å’ŒåŠŸèƒ½ã€‚