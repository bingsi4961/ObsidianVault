---
date : 2025-07-10 15:21
aliases:
  - 別名測試1
  - 別名測試2
tags:
  - 標籤測試1
  - 標籤測試2

---
# Metadata
Status :: 🌱
Note Type :: 📰
Source URL :: {文章 URL}
Author :: {作者名稱}
Topics :: {筆記跟什麼主題有關，用 `[Topic],[Topic]` 格式}

---
# 連結筆記
#### 📑 [[歡迎]]
#### 📑 [[歡迎]]

---

# ClosedXML Excel 匯出完整教學

## 1. 環境準備

### 1.1 安裝 NuGet 套件
```bash
Install-Package ClosedXML -Version 0.95.2
```

### 1.2 必要的 using 宣告
```csharp
using ClosedXML.Excel;
using System.IO;
using System.ComponentModel;
using System.ComponentModel.DataAnnotations;
using System.Reflection;
```

## 2. 基本 Excel 匯出架構

### 2.1 Controller 方法結構
```csharp
[HttpPost]
public IActionResult ExportToExcel()
{
    try
    {
        // 1. 建立 Workbook 和 MemoryStream
        using (var workbook = new XLWorkbook())
        using (var ms = new MemoryStream())
        {
            // 2. 建立工作表
            var worksheet = workbook.Worksheets.Add("資料表");
            
            // 3. 填入資料
            PopulateWorksheet(worksheet);
            
            // 4. 儲存到 MemoryStream
            workbook.SaveAs(ms);
            ms.Flush();
            ms.Position = 0;
            
            // 5. 產生檔案名稱並回傳
            string fileName = DateTime.Now.ToString("yyyyMMddHHmmssfff") + "_MemberList.xlsx";
            return File(ms.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
        }
    }
    catch (Exception ex)
    {
        // 錯誤處理
        return BadRequest("匯出失敗: " + ex.Message);
    }
}
```

## 3. 資料填入方法

### 3.1 使用反射取得屬性資訊
```csharp
private void PopulateWorksheet(IXLWorksheet worksheet)
{
    // 取得資料
    var data = GetDataList(); // 您的資料來源
    
    if (data?.Any() == true)
    {
        // 取得第一筆資料的型別
        var dataType = data.First().GetType();
        var properties = dataType.GetProperties();
        
        // 建立標題列
        CreateHeaderRow(worksheet, properties);
        
        // 填入資料列
        FillDataRows(worksheet, data, properties);
        
        // 調整欄位寬度
        worksheet.Columns().AdjustToContents();
    }
}
```

### 3.2 建立標題列
```csharp
private void CreateHeaderRow(IXLWorksheet worksheet, PropertyInfo[] properties)
{
    int colIndex = 1;
    
    foreach (var property in properties)
    {
        // 取得 DisplayName 屬性，如果沒有則使用屬性名稱
        string displayName = property.Name;
        var displayNameAttr = property.GetCustomAttribute(typeof(DisplayNameAttribute)) as DisplayNameAttribute;
        if (displayNameAttr != null)
        {
            displayName = displayNameAttr.DisplayName;
        }
        
        // 設定標題儲存格
        var headerCell = worksheet.Cell(1, colIndex);
        headerCell.Value = displayName;
        
        // 設定標題樣式
        headerCell.Style.Font.Bold = true;
        headerCell.Style.Fill.BackgroundColor = XLColor.FromArgb(220, 220, 220);
        headerCell.Style.Border.OutsideBorder = XLBorderStyleValues.Thin;
        headerCell.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;
        
        colIndex++;
    }
}
```

### 3.3 填入資料列
```csharp
private void FillDataRows(IXLWorksheet worksheet, IEnumerable<object> data, PropertyInfo[] properties)
{
    int rowIndex = 2; // 從第二列開始（第一列是標題）
    
    foreach (var item in data)
    {
        int colIndex = 1;
        
        foreach (var property in properties)
        {
            var value = property.GetValue(item);
            var cell = worksheet.Cell(rowIndex, colIndex);
            
            // 設定儲存格值
            cell.Value = value?.ToString() ?? "";
            
            // 設定資料列樣式
            cell.Style.Border.OutsideBorder = XLBorderStyleValues.Thin;
            
            colIndex++;
        }
        
        rowIndex++;
    }
}
```

## 4. 進階樣式設定

### 4.1 合併儲存格
```csharp
// 合併指定範圍的儲存格
var range = worksheet.Range(1, 1, 1, 5); // 第1列，第1欄到第5欄
range.Merge();
range.Value = "報表標題";
range.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;
```

### 4.2 設定字型和顏色
```csharp
var cell = worksheet.Cell(1, 1);
cell.Style.Font.Bold = true;
cell.Style.Font.FontColor = XLColor.FromArgb(255, 0, 0); // 紅色字體
cell.Style.Fill.BackgroundColor = XLColor.FromArgb(255, 255, 0); // 黃色背景
```

### 4.3 設定邊框
```csharp
var range = worksheet.Range("A1:E10");
range.Style.Border.OutsideBorder = XLBorderStyleValues.Thick;
range.Style.Border.InsideBorder = XLBorderStyleValues.Thin;
```

## 5. 完整範例

### 5.1 資料模型
```csharp
public class MemberModel
{
    [DisplayName("編號")]
    public int Id { get; set; }
    
    [DisplayName("姓名")]
    public string Name { get; set; }
    
    [DisplayName("電子郵件")]
    public string Email { get; set; }
    
    [DisplayName("建立日期")]
    public DateTime CreateDate { get; set; }
}
```

### 5.2 完整的 Controller 方法
```csharp
[HttpPost]
public IActionResult ExportMemberList()
{
    try
    {
        var members = GetMemberList(); // 取得會員清單
        
        using (var workbook = new XLWorkbook())
        using (var ms = new MemoryStream())
        {
            var worksheet = workbook.Worksheets.Add("會員清單");
            
            // 建立標題列
            CreateMemberHeader(worksheet);
            
            // 填入資料
            FillMemberData(worksheet, members);
            
            // 調整欄位寬度
            worksheet.Columns().AdjustToContents();
            
            // 儲存並回傳
            workbook.SaveAs(ms);
            ms.Flush();
            ms.Position = 0;
            
            string fileName = $"MemberList_{DateTime.Now:yyyyMMddHHmmssfff}.xlsx";
            return File(ms.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
        }
    }
    catch (Exception ex)
    {
        return BadRequest($"匯出失敗: {ex.Message}");
    }
}

private void CreateMemberHeader(IXLWorksheet worksheet)
{
    // 設定標題列
    var headers = new[] { "編號", "姓名", "電子郵件", "建立日期" };
    for (int i = 0; i < headers.Length; i++)
    {
        var cell = worksheet.Cell(1, i + 1);
        cell.Value = headers[i];
        cell.Style.Font.Bold = true;
        cell.Style.Fill.BackgroundColor = XLColor.FromArgb(220, 220, 220);
        cell.Style.Border.OutsideBorder = XLBorderStyleValues.Thin;
        cell.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;
    }
}

private void FillMemberData(IXLWorksheet worksheet, IEnumerable<MemberModel> members)
{
    int rowIndex = 2;
    
    foreach (var member in members)
    {
        worksheet.Cell(rowIndex, 1).Value = member.Id;
        worksheet.Cell(rowIndex, 2).Value = member.Name;
        worksheet.Cell(rowIndex, 3).Value = member.Email;
        worksheet.Cell(rowIndex, 4).Value = member.CreateDate.ToString("yyyy/MM/dd");
        
        // 設定資料列邊框
        var range = worksheet.Range(rowIndex, 1, rowIndex, 4);
        range.Style.Border.OutsideBorder = XLBorderStyleValues.Thin;
        
        rowIndex++;
    }
}
```

## 6. 檔案儲存方式

### 6.1 直接下載 (推薦)
```csharp
string fileName = $"Export_{DateTime.Now:yyyyMMddHHmmssfff}.xlsx";
return File(ms.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
```

### 6.2 儲存到伺服器
```csharp
string folderPath = @"C:\Exports\";
string fileName = $"Export_{DateTime.Now:yyyyMMddHHmmss}.xlsx";
string fullPath = Path.Combine(folderPath, fileName);

// 確保目錄存在
Directory.CreateDirectory(folderPath);

workbook.SaveAs(fullPath);
```

### 6.3 Base64 編碼方式
```csharp
workbook.SaveAs(ms);
ms.Flush();
ms.Position = 0;

// 轉換為 Base64
string base64String = Convert.ToBase64String(ms.ToArray());

// 解碼並下載
var xls = new MemoryStream(Convert.FromBase64String(base64String));
return File(xls.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
```

## 7. 最佳實務建議

### 7.1 記憶體管理
```csharp
// 使用 using 確保資源正確釋放
using (var workbook = new XLWorkbook())
using (var ms = new MemoryStream())
{
    // 處理邏輯
    
    // 手動清理（可選）
    workbook.Dispose();
    ms.Flush();
    ms.Close();
}
```

### 7.2 錯誤處理
```csharp
try
{
    // Excel 匯出邏輯
}
catch (Exception ex)
{
    // 記錄錯誤
    logger.LogError(ex, "Excel 匯出失敗");
    
    // 回傳錯誤訊息
    return BadRequest("匯出失敗，請稍後再試");
}
```

### 7.3 大量資料處理
```csharp
// 對於大量資料，考慮分批處理
const int batchSize = 1000;
var batches = data.Skip(skip).Take(batchSize);

foreach (var batch in batches)
{
    // 處理每批資料
}
```

## 8. 前端 JavaScript 配合

### 8.1 AJAX 呼叫
```javascript
function exportExcel() {
    $.ajax({
        url: '/YourController/ExportToExcel',
        type: 'POST',
        responseType: 'blob',
        success: function(data, status, xhr) {
            // 建立下載連結
            var blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'export.xlsx';
            a.click();
            window.URL.revokeObjectURL(url);
        },
        error: function() {
            alert('匯出失敗');
        }
    });
}
```

### 8.2 表單提交方式
```html
<form method="post" action="/YourController/ExportToExcel">
    <button type="submit" class="btn btn-primary">
        <i class="fa fa-download"></i> 匯出 Excel
    </button>
</form>
```

這個教學涵蓋了您在 Portal 系統中看到的所有關鍵指令，並提供了完整的實作範例。您可以根據實際需求調整樣式和功能。