---
date : 2025-07-15 15:48
aliases:
  - 別名測試1
  - 別名測試2
tags:
  - 標籤測試1
  - 標籤測試2

---
# Metadata
Status :: 🌱
Note Type :: 📰
Source URL :: {文章 URL}
Author :: {作者名稱}
Topics :: {筆記跟什麼主題有關，用 `[Topic],[Topic]` 格式}

---
# 連結筆記
#### 📑 [[]]
#### 📑 [[]]

---

```CSharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.ViewFeatures;

public class HomeController : Controller
{
    // 假設這是同事寫好的 functionB
    public IActionResult FunctionB()
    {
        // 建立 Model
        var model = new PersonModel
        {
            Name = "張三",
            Age = 30,
            Email = "zhang@example.com"
        };

        // 設定 ViewBag
        ViewBag.Title = "個人資料";
        ViewBag.Message = "歡迎使用系統";
        ViewBag.CurrentTime = DateTime.Now;

        return View(model);
    }

    // 您的 MainFunction，從 functionB 取得 Model 和 ViewBag
    public IActionResult MainFunction()
    {
        // 方法 1：直接呼叫並轉換為 ViewResult
        var viewResult = FunctionB() as ViewResult;
        
        if (viewResult != null)
        {
            // 取得 Model
            var model = viewResult.Model as PersonModel;
            
            // 取得 ViewBag
            var viewBag = viewResult.ViewData;
            
            // 現在您可以使用 model 和 viewBag 的內容
            Console.WriteLine($"Name: {model?.Name}");
            Console.WriteLine($"Age: {model?.Age}");
            Console.WriteLine($"Title: {viewBag["Title"]}");
            Console.WriteLine($"Message: {viewBag["Message"]}");
            
            // 您可以修改或新增 ViewBag 內容
            viewBag["AdditionalInfo"] = "這是從 MainFunction 新增的資訊";
            
            // 您也可以修改 Model（如果需要的話）
            if (model != null)
            {
                model.Age = 31; // 修改年齡
            }
            
            // 回傳修改後的 ViewResult，或者建立新的 View
            return View("MainView", model);
        }
        
        return View();
    }

    // 方法 2：更安全的取得方式
    public IActionResult MainFunctionSafe()
    {
        var result = FunctionB();
        
        // 檢查是否為 ViewResult
        if (result is ViewResult viewResult)
        {
            // 安全地取得 Model
            var model = viewResult.Model as PersonModel;
            
            // 取得 ViewBag (ViewData)
            var viewData = viewResult.ViewData;
            
            // 建立新的 ViewBag 給目前的 Action
            ViewBag.OriginalTitle = viewData["Title"];
            ViewBag.OriginalMessage = viewData["Message"];
            ViewBag.ProcessedBy = "MainFunction";
            
            // 可以將原始 Model 傳遞給新的 View
            return View("ProcessedView", model);
        }
        
        return View("Error");
    }

    // 方法 3：取得特定 ViewBag 項目的泛型方法
    public IActionResult MainFunctionGeneric()
    {
        var viewResult = FunctionB() as ViewResult;
        
        if (viewResult != null)
        {
            var model = viewResult.Model as PersonModel;
            var viewData = viewResult.ViewData;
            
            // 使用泛型方法安全地取得 ViewBag 值
            var title = GetViewBagValue<string>(viewData, "Title");
            var currentTime = GetViewBagValue<DateTime>(viewData, "CurrentTime");
            
            // 設定新的 ViewBag
            ViewBag.ProcessedTitle = $"處理後的標題: {title}";
            ViewBag.ProcessedTime = currentTime.ToString("yyyy-MM-dd HH:mm:ss");
            
            return View("FinalView", model);
        }
        
        return View();
    }

    // 輔助方法：安全地取得 ViewBag 值
    private T GetViewBagValue<T>(ViewDataDictionary viewData, string key)
    {
        if (viewData.ContainsKey(key) && viewData[key] is T value)
        {
            return value;
        }
        return default(T);
    }

    // 方法 4：如果您需要取得 ViewResult 的其他屬性
    public IActionResult MainFunctionAdvanced()
    {
        var viewResult = FunctionB() as ViewResult;
        
        if (viewResult != null)
        {
            // 取得 Model
            var model = viewResult.Model;
            
            // 取得 ViewData (包含 ViewBag)
            var viewData = viewResult.ViewData;
            
            // 取得 View 名稱
            var viewName = viewResult.ViewName;
            
            // 取得 TempData
            var tempData = viewResult.TempData;
            
            // 取得 ContentType
            var contentType = viewResult.ContentType;
            
            // 取得 StatusCode
            var statusCode = viewResult.StatusCode;
            
            Console.WriteLine($"View Name: {viewName}");
            Console.WriteLine($"Status Code: {statusCode}");
            Console.WriteLine($"Content Type: {contentType}");
            
            // 複製所有 ViewData 到當前的 ViewData
            foreach (var item in viewData)
            {
                ViewData[item.Key] = item.Value;
            }
            
            // 新增額外的 ViewBag 資訊
            ViewBag.ProcessedByAdvanced = true;
            ViewBag.ProcessingTime = DateTime.Now;
            
            return View("AdvancedView", model);
        }
        
        return View();
    }
}

// 範例 Model 類別
public class PersonModel
{
    public string Name { get; set; }
    public int Age { get; set; }
    public string Email { get; set; }
}
```