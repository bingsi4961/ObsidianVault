---
date : 2025-07-23 09:10
aliases:
  - åˆ¥åæ¸¬è©¦1
  - åˆ¥åæ¸¬è©¦2
tags:
  - æ¨™ç±¤æ¸¬è©¦1
  - æ¨™ç±¤æ¸¬è©¦2

---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[]]
#### ğŸ“‘ [[]]

---

# Entity Framework - Select æŠ•å½± vs ThenInclude å·®ç•°ç­†è¨˜

## æ ¸å¿ƒæ¦‚å¿µå·®ç•°

### Select æŠ•å½± vs ThenInclude çš„æ ¹æœ¬å·®ç•°

1. **å›å‚³è³‡æ–™é¡å‹ä¸åŒ**
    - **Select æŠ•å½±**: å›å‚³åŒ¿åç‰©ä»¶æˆ– DTOï¼Œç„¡æ³•å­˜å–åŸå§‹å¯¦é«”
    - **ThenInclude**: å›å‚³å®Œæ•´çš„å¯¦é«”ç‰©ä»¶ï¼Œå¯å­˜å–æ‰€æœ‰å°èˆªå±¬æ€§

### ç¨‹å¼ç¢¼ç¯„ä¾‹å°æ¯”

```csharp
// Select æŠ•å½±
var orderData = context.Orders
    .Select(o => new {
        OrderId = o.Id,
        CustomerName = o.Customer.Name
    })
    .ToList();
// çµæœï¼šorderData[0].Customer ç„¡æ³•å­˜å–ï¼

// ThenInclude
var orders = context.Orders
    .Include(o => o.Customer)
    .ThenInclude(c => c.Address)
    .ToList();
// çµæœï¼šorders[0].Customer.Address.City å¯ä»¥å­˜å–
```

## ä½¿ç”¨æƒ…å¢ƒé¸æ“‡

### Select æŠ•å½±é©åˆçš„å ´æ™¯

- API å›å‚³ç‰¹å®šè³‡æ–™
- å ±è¡¨æŸ¥è©¢
- åªéœ€è¦éƒ¨åˆ†æ¬„ä½
- å”¯è®€æ“ä½œ

### ThenInclude é©åˆçš„å ´æ™¯

- éœ€è¦å®Œæ•´å¯¦é«”ç‰©ä»¶
- å¾ŒçºŒè¦æ›´æ–°è³‡æ–™
- éœ€è¦å­˜å–å¤šå€‹å°èˆªå±¬æ€§
- å•†æ¥­é‚è¼¯è™•ç†

## å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹

### å ´æ™¯ 1: API å›å‚³è³‡æ–™ (æ¨è–¦ Select æŠ•å½±)

```csharp
// âœ… Select æŠ•å½±æ›´é©åˆ
public async Task<IActionResult> GetOrderList()
{
    var data = await context.Orders
        .Select(o => new {
            o.Id,
            o.OrderDate,
            CustomerName = o.Customer.Name,
            CustomerCity = o.Customer.Address.City
        })
        .ToListAsync();
    
    return Json(data); // è¼•é‡ã€é«˜æ•ˆ
}

// âŒ ThenInclude æœƒè¼‰å…¥ä¸éœ€è¦çš„è³‡æ–™
public async Task<IActionResult> GetOrderListBad()
{
    var orders = await context.Orders
        .Include(o => o.Customer)
        .ThenInclude(c => c.Address)
        .ToListAsync();
    
    return Json(orders); // æœƒåºåˆ—åŒ–æ‰€æœ‰å±¬æ€§ï¼ŒåŒ…å«ä¸éœ€è¦çš„
}
```

### å ´æ™¯ 2: å•†æ¥­é‚è¼¯è™•ç† (æ¨è–¦ ThenInclude)

```csharp
// âœ… ThenInclude æ›´é©åˆ
public async Task ProcessOrder(int orderId)
{
    var order = await context.Orders
        .Include(o => o.Customer)
        .ThenInclude(c => c.Address)
        .Include(o => o.OrderItems)
        .FirstOrDefaultAsync(o => o.Id == orderId);
    
    // å¯ä»¥å­˜å–å®Œæ•´çš„å¯¦é«”ç‰©ä»¶
    order.Customer.LastOrderDate = DateTime.Now;
    order.OrderItems.Add(new OrderItem { ... });
    
    await context.SaveChangesAsync(); // å¯ä»¥æ›´æ–°
}

// âŒ Select æŠ•å½±ç„¡æ³•ç”¨æ–¼æ›´æ–°
public async Task ProcessOrderBad(int orderId)
{
    var orderData = await context.Orders
        .Select(o => new {
            o.Id,
            CustomerName = o.Customer.Name
        })
        .FirstOrDefaultAsync(o => o.Id == orderId);
    
    // ç„¡æ³•æ›´æ–°ï¼Œå› ç‚ºä¸æ˜¯å¯¦é«”ç‰©ä»¶
    // orderData.Customer.LastOrderDate = DateTime.Now; // ç·¨è­¯éŒ¯èª¤ï¼
}
```

## æ•ˆèƒ½å·®ç•°åˆ†æ

### Select æŠ•å½±çš„å„ªå‹¢

```csharp
// åªå‚³è¼¸éœ€è¦çš„è³‡æ–™
var lightData = context.Orders
    .Select(o => new {
        o.Id,
        CustomerName = o.Customer.Name  // åªè¦é€™å…©å€‹æ¬„ä½
    })
    .ToList();
```

### ThenInclude çš„æ•ˆèƒ½è€ƒé‡

```csharp
// è¼‰å…¥å®Œæ•´çš„å¯¦é«”ç‰©ä»¶
var fullData = context.Orders
    .Include(o => o.Customer)
    .ThenInclude(c => c.Address)
    .ToList();

// æœƒè¼‰å…¥æ‰€æœ‰æ¬„ä½ï¼š
// Order: Id, OrderDate, Amount, CreatedDate, UpdatedDate...
// Customer: Id, Name, Email, Phone, CreatedDate, UpdatedDate...  
// Address: Id, Street, City, Country, PostalCode, CreatedDate...
```

## SQL èªæ³•æ¯”è¼ƒ

### Select æŠ•å½±ç”¢ç”Ÿçš„ SQL

```sql
SELECT [o].[Id], [c].[Name] AS [CustomerName]
FROM [Orders] AS [o]
INNER JOIN [Customers] AS [c] ON [o].[CustomerId] = [c].[Id]
```

### ThenInclude ç”¢ç”Ÿçš„ SQL

```sql
SELECT [o].[Id], [o].[OrderDate], [o].[Amount], [o].[CreatedDate], [o].[UpdatedDate],
       [c].[Id], [c].[Name], [c].[Email], [c].[Phone], [c].[CreatedDate], [c].[UpdatedDate],
       [a].[Id], [a].[Street], [a].[City], [a].[Country], [a].[PostalCode], [a].[CreatedDate]
FROM [Orders] AS [o]
LEFT JOIN [Customers] AS [c] ON [o].[CustomerId] = [c].[Id]
LEFT JOIN [Addresses] AS [a] ON [c].[AddressId] = [a].[Id]
```

## EF6 Include è¡Œç‚ºé‡è¦èªªæ˜ âš ï¸

### EF6 è‡ªå‹•è¼‰å…¥æ©Ÿåˆ¶

æ‚¨å®Œå…¨æ­£ç¢ºï¼åœ¨ **Entity Framework 6.1.3** ä¸­ï¼ŒEF6 æœƒè‡ªå‹•æ¨æ–·ä¸¦è¼‰å…¥å°èˆªè·¯å¾‘ä¸Šçš„ä¸­é–“å¯¦é«”ï¼š

```csharp
// âœ… æ­£ç¢ºï¼šåªéœ€è¦é€™ä¸€è¡Œ
var orders = context.Orders
    .Include(o => o.Customer.Address)  // Customer æœƒè‡ªå‹•è¢«è¼‰å…¥
    .ToList();

// âŒ å¤šé¤˜ï¼šä¸éœ€è¦é¡å¤– Include Customer
var orders = context.Orders
    .Include(o => o.Customer)           // é€™è¡Œæ˜¯å¤šé¤˜çš„ï¼
    .Include(o => o.Customer.Address)   
    .ToList();
```

### åŸç†èªªæ˜

ç•¶ä½¿ç”¨ `.Include(o => o.Customer.Address)` æ™‚ï¼š

1. **EF6 æœƒè‡ªå‹•æ¨æ–·è·¯å¾‘**ï¼šè¦å­˜å– `Address`ï¼Œå¿…é ˆå…ˆç¶“é `Customer`
2. **è‡ªå‹•è¼‰å…¥ä¸­é–“å¯¦é«”**ï¼š`Customer` æœƒè‡ªå‹•è¢«è¼‰å…¥
3. **ç”¢ç”Ÿé©ç•¶çš„ JOIN**ï¼šSQL æœƒåŒ…å«å¿…è¦çš„ JOIN èªå¥

### å¯¦éš›ç”¢ç”Ÿçš„ SQL

```sql
SELECT 
    [o].[Id], [o].[OrderDate], [o].[CustomerId],
    [c].[Id], [c].[Name], [c].[Email],           -- Customer è‡ªå‹•è¢«è¼‰å…¥
    [a].[Id], [a].[Street], [a].[City]           -- Address è¢«è¼‰å…¥
FROM [Orders] AS [o]
LEFT JOIN [Customers] AS [c] ON [o].[CustomerId] = [c].[Id]
LEFT JOIN [Addresses] AS [a] ON [c].[AddressId] = [a].[Id]
```

### é©—è­‰æ–¹æ³•

```csharp
// æ¸¬è©¦ç¨‹å¼ç¢¼
var orders = context.Orders
    .Include(o => o.Customer.Address)
    .ToList();

foreach (var order in orders)
{
    // é€™äº›éƒ½ä¸æœƒè§¸ç™¼é¡å¤–æŸ¥è©¢
    Console.WriteLine($"è¨‚å–® ID: {order.Id}");
    Console.WriteLine($"å®¢æˆ¶åç¨±: {order.Customer.Name}");      // Customer å·²è¼‰å…¥
    Console.WriteLine($"å®¢æˆ¶åŸå¸‚: {order.Customer.Address.City}"); // Address å·²è¼‰å…¥
}
```

## ç‰ˆæœ¬å·®ç•° (é‡è¦æ›´æ­£)

### Portal ç³»çµ±ç’°å¢ƒ

- **.NET Core 3.1**
- **Entity Framework Core 3.1.2**
- **ç¾ä»£èªæ³•æ”¯æ´**

### GTS ç³»çµ±ç’°å¢ƒ

- **.NET Framework 4.8**
- **Entity Framework 6.1.3**
- **å‚³çµ±èªæ³•**

## å„ç‰ˆæœ¬èªæ³•å·®ç•°

### EF Core 3.1.2 (Portal ç³»çµ±)

```csharp
// æ–¹æ³•éˆå¼èªæ³•
var orders = context.Orders
    .Include(o => o.Customer)
    .ThenInclude(c => c.Address)
    .ThenInclude(a => a.Country)
    .ToList();

// å®Œæ•´çš„ç•°æ­¥æ”¯æ´
var orders = await context.Orders
    .Include(o => o.Customer)
    .ToListAsync();
```

### EF6.1.3 (GTS ç³»çµ±)

```csharp
// å­—ä¸²è·¯å¾‘èªæ³•
var orders = context.Orders
    .Include("Customer.Address.Country")
    .ToList();

// Lambda è¡¨é”å¼ï¼ˆEF6 æœƒè‡ªå‹•è¼‰å…¥ä¸­é–“å¯¦é«”ï¼‰
var orders = context.Orders
    .Include(o => o.Customer.Address.Country)  // æœƒè‡ªå‹•è¼‰å…¥ Customer å’Œ Address
    .ToList();

// âŒ å¤šé¤˜çš„å¯«æ³•ï¼ˆä¸éœ€è¦åˆ†åˆ¥ Includeï¼‰
var orders = context.Orders
    .Include(o => o.Customer)                  // ä¸å¿…è¦
    .Include(o => o.Customer.Address)          // ä¸å¿…è¦
    .Include(o => o.Customer.Address.Country)
    .ToList();

// åŸºæœ¬ç•°æ­¥æ”¯æ´
var orders = await context.Orders
    .Include(o => o.Customer.Address)  // Customer æœƒè‡ªå‹•è¢«è¼‰å…¥
    .ToListAsync();
```

## å„ç‰ˆæœ¬æœ€ä½³å¯¦å‹™å»ºè­°

### åœ¨ GTS ç³»çµ±ä¸­ (EF6.1.3)

```csharp
// âœ… æ¨è–¦ï¼šç°¡æ½”æ˜ç¢ºï¼Œè‡ªå‹•è¼‰å…¥ä¸­é–“å¯¦é«”
var orders = context.Orders
    .Include(o => o.Customer.Address)
    .ToList();

// âœ… æˆ–è€…ä½¿ç”¨å­—ä¸²è·¯å¾‘
var orders = context.Orders
    .Include("Customer.Address")
    .ToList();

// âœ… å¤šå±¤é—œè¯ä¹Ÿåªéœ€è¦ä¸€è¡Œ
var orders = context.Orders
    .Include(o => o.Customer.Address.Country)  // Customer å’Œ Address éƒ½æœƒè‡ªå‹•è¼‰å…¥
    .ToList();
```

### åœ¨ Portal ç³»çµ±ä¸­ (EF Core 3.1.2)

```csharp
// âœ… æ¨è–¦ï¼šä½¿ç”¨ ThenInclude èªæ³•
var orders = await context.Orders
    .Include(o => o.Customer)
    .ThenInclude(c => c.Address)
    .ToListAsync();
```

## å°ˆæ¡ˆæ‡‰ç”¨ç¯„ä¾‹

```csharp
// æ¨è–¦ä½¿ç”¨ç¾ä»£èªæ³•
public async Task<IActionResult> GetOrderData()
{
    var data = await _context.Orders
        .Include(o => o.Customer)
        .ThenInclude(c => c.Address)
        .Select(o => new {
            o.Id,
            CustomerName = o.Customer.Name,
            CustomerCity = o.Customer.Address.City
        })
        .ToListAsync();
    
    return Json(data);
}
```

### Portal ç³»çµ± (.NET Core 3.1 + EF Core 3.1.2)

```csharp
// æ¨è–¦ä½¿ç”¨ç¾ä»£èªæ³•
public async Task<IActionResult> GetOrderData()
{
    var data = await _context.Orders
        .Include(o => o.Customer)
        .ThenInclude(c => c.Address)
        .Select(o => new {
            o.Id,
            CustomerName = o.Customer.Name,
            CustomerCity = o.Customer.Address.City
        })
        .ToListAsync();
    
    return Json(data);
}
```

### GTS ç³»çµ± (.NET Framework 4.8 + EF6.1.3)

```csharp
// ä½¿ç”¨ EF6 ç›¸å®¹èªæ³•ï¼ˆæ­£ç¢ºç‰ˆæœ¬ï¼‰
public async Task<List<OrderDto>> GetOrderData()
{
    return await context.Orders
        .Include(o => o.Customer.Address)  // âœ… åªéœ€è¦é€™ä¸€è¡Œï¼ŒCustomer æœƒè‡ªå‹•è¼‰å…¥
        .Select(o => new OrderDto {
            Id = o.Id,
            CustomerName = o.Customer.Name,
            CustomerCity = o.Customer.Address.City
        })
        .ToListAsync();
}
```

## ç¸½çµèˆ‡é¸æ“‡åŸå‰‡

### åŠŸèƒ½å®šä½å·®ç•°

- **Select æŠ•å½±**: è³‡æ–™æŸ¥è©¢ï¼Œè¼•é‡é«˜æ•ˆï¼Œå”¯è®€æ“ä½œ
- **ThenInclude**: å¯¦é«”è¼‰å…¥ï¼ŒåŠŸèƒ½å®Œæ•´ï¼Œå¯æ›´æ–°æ“ä½œ

### é¸æ“‡åŸå‰‡

1. **éœ€è¦æ›´æ–°è³‡æ–™** â†’ ä½¿ç”¨ ThenInclude
2. **åªéœ€è®€å–ç‰¹å®šæ¬„ä½** â†’ ä½¿ç”¨ Select æŠ•å½±
3. **API å›å‚³è³‡æ–™** â†’ å„ªå…ˆè€ƒæ…® Select æŠ•å½±
4. **æ¥­å‹™é‚è¼¯è™•ç†** â†’ å„ªå…ˆè€ƒæ…® ThenInclude

### EF6 Include é‡é»æé†’ âš ï¸

åœ¨ EF6 ä¸­ï¼Œ**åªéœ€è¦ Include æœ€æ·±å±¤çš„å¯¦é«”**ï¼Œä¸­é–“çš„å°èˆªå¯¦é«”æœƒè‡ªå‹•è¼‰å…¥ï¼š

```csharp
// âœ… æ­£ç¢ºåšæ³•
.Include(o => o.Customer.Address)  // Customer è‡ªå‹•è¼‰å…¥

// âŒ å†—é¤˜åšæ³•
.Include(o => o.Customer)
.Include(o => o.Customer.Address)
```

### å…±é€šå„ªå‹¢

å…©è€…éƒ½èƒ½æœ‰æ•ˆé¿å… N+1 æŸ¥è©¢å•é¡Œï¼Œä½†æœå‹™æ–¼ä¸åŒçš„æ¥­å‹™éœ€æ±‚å ´æ™¯ã€‚

## é·ç§»è€ƒé‡

è‹¥æœªä¾†å°‡ GTS ç³»çµ±å‡ç´šè‡³ EF Coreï¼Œéœ€æ³¨æ„ï¼š

- EF6 â†’ EF Core çš„èªæ³•å·®ç•°
- æŸäº› EF6 åŠŸèƒ½åœ¨ EF Core ä¸­å¯èƒ½ä¸å­˜åœ¨
- æ•ˆèƒ½ç‰¹æ€§å¯èƒ½æœ‰æ‰€ä¸åŒ