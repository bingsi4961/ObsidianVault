---
date : 2025-10-25 15:04
aliases:
  - åˆ¥åæ¸¬è©¦1
  - åˆ¥åæ¸¬è©¦2
tags:
  - æ¨™ç±¤æ¸¬è©¦1
  - æ¨™ç±¤æ¸¬è©¦2

---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[]]

---

# C# éåŒæ­¥ç¨‹å¼è¨­è¨ˆ (async/await) ç³»çµ±æ€§å­¸ç¿’ç­†è¨˜

## ç›®éŒ„

1. [ç¶“å…¸æ­»çµå ´æ™¯åˆ†æ](https://claude.ai/chat/a1674804-a26c-4010-bcc9-de7bfe7e04f2#1-%E7%B6%93%E5%85%B8%E6%AD%BB%E7%B5%90%E5%A0%B4%E6%99%AF%E5%88%86%E6%9E%90)
2. [æ­»çµç™¼ç”Ÿçš„æ ¹æœ¬åŸå› ](https://claude.ai/chat/a1674804-a26c-4010-bcc9-de7bfe7e04f2#2-%E6%AD%BB%E7%B5%90%E7%99%BC%E7%94%9F%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0)
3. [TaskCompletionSource çš„åŸ·è¡Œç·’å®‰å…¨æ€§](https://claude.ai/chat/a1674804-a26c-4010-bcc9-de7bfe7e04f2#3-taskcompletionsource-%E7%9A%84%E5%9F%B7%E8%A1%8C%E7%B7%92%E5%AE%89%E5%85%A8%E6%80%A7)
4. [ThreadPool.QueueUserWorkItem çš„åŸ·è¡Œé †åº](https://claude.ai/chat/a1674804-a26c-4010-bcc9-de7bfe7e04f2#4-threadpoolqueueuserworkitem-%E7%9A%84%E5%9F%B7%E8%A1%8C%E9%A0%86%E5%BA%8F)
5. [async/await å¦‚ä½•è§£æ±ºæ­»çµ](https://claude.ai/chat/a1674804-a26c-4010-bcc9-de7bfe7e04f2#5-asyncawait-%E5%A6%82%E4%BD%95%E8%A7%A3%E6%B1%BA%E6%AD%BB%E7%B5%90)
6. [await çš„ä¸Šä¸‹æ–‡æ•æ‰æ©Ÿåˆ¶](https://claude.ai/chat/a1674804-a26c-4010-bcc9-de7bfe7e04f2#6-await-%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8D%95%E6%8D%89%E6%A9%9F%E5%88%B6)
7. [ConfigureAwait(false) çš„ä½¿ç”¨æ™‚æ©Ÿ](https://claude.ai/chat/a1674804-a26c-4010-bcc9-de7bfe7e04f2#7-configureawaitfalse-%E7%9A%84%E4%BD%BF%E7%94%A8%E6%99%82%E6%A9%9F)

---
## 1. ç¶“å…¸æ­»çµå ´æ™¯åˆ†æ

### 1.1 æœƒé€ æˆæ­»çµçš„ç¨‹å¼ç¢¼

```csharp
// UI äº‹ä»¶ (ä¾‹å¦‚ WinForms æˆ– WPF)
private void myButton_Click(object sender, EventArgs e)
{
    // é—œéµï¼šåœ¨ UI åŸ·è¡Œç·’ä¸Šã€ŒåŒæ­¥ã€ç­‰å¾… Task
    // UI åŸ·è¡Œç·’æœƒåœ¨é€™è£¡è¢«ã€Œå‡çµã€ï¼Œç›´åˆ° Task å®Œæˆ
    var data = MyAwesomeLibrary.GetDataAsync().Result; // <--- æ­»çµç™¼ç”Ÿé»
    myLabel.Text = data;
}

public static class MyAwesomeLibrary
{
    // æ–¹æ³•å¿…é ˆå›å‚³ Task<string> æ‰èƒ½è¢« .Result ç­‰å¾…
    public static Task<string> GetDataAsync()
    {
        // 1. å–å¾—ç•¶å‰çš„ SynchronizationContext (ä¹Ÿå°±æ˜¯ UI åŸ·è¡Œç·’çš„ Context)
        var uiContext = SynchronizationContext.Current;
        
        // TaskCompletionSource æ˜¯æ‰‹å‹•æ§åˆ¶ Task ç‹€æ…‹çš„å·¥å…·
        var tcs = new TaskCompletionSource<string>();
        
        // 2. å°‡å·¥ä½œä¸Ÿåˆ°èƒŒæ™¯åŸ·è¡Œç·’æ± 
        ThreadPool.QueueUserWorkItem(_ => {
            
            // æ¨¡æ“¬é•·æ™‚é–“çš„å·¥ä½œ
            Thread.Sleep(5000); 
            
            // 3. å·¥ä½œå®Œæˆå¾Œï¼Œå˜—è©¦ã€Œè²¼å›ã€UI åŸ·è¡Œç·’å»è¨­å®š Task çš„çµæœ
            uiContext.Post(state => {
                // é€™æ®µç¨‹å¼ç¢¼ã€Œæ’éšŠã€ç­‰è‘—åœ¨ UI åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ
                tcs.SetResult("é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™");
            }, null);			
        });	
        
        // 4. ç«‹åˆ»å›å‚³é€™å€‹ã€Œå°šæœªå®Œæˆã€çš„ Task
        return tcs.Task;
    }
}
```

---
## 2. æ­»çµç™¼ç”Ÿçš„æ ¹æœ¬åŸå› 

### 2.1 æ­»çµç™¼ç”Ÿæ­¥é©Ÿ (Step-by-Step)

|æ­¥é©Ÿ|åŸ·è¡Œç·’|å‹•ä½œ|ç‹€æ…‹|
|---|---|---|---|
|1|UI åŸ·è¡Œç·’|ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•ï¼Œ`myButton_Click` åœ¨ UI åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ|æ­£å¸¸åŸ·è¡Œ|
|2|UI åŸ·è¡Œç·’|å‘¼å« `GetDataAsync()`|æ­£å¸¸åŸ·è¡Œ|
|3|UI åŸ·è¡Œç·’|`GetDataAsync()` å¿«é€Ÿå›å‚³ã€Œå°šæœªå®Œæˆã€çš„ `tcs.Task`ï¼Œæ¥è‘—åŸ·è¡Œåˆ° `.Result`|æº–å‚™é˜»æ“‹|
|4|UI åŸ·è¡Œç·’|`.Result` åŒæ­¥é˜»æ“‹ (Block) UI åŸ·è¡Œç·’ï¼Œç›´åˆ° `tcs.Task` å®Œæˆ|**è¢«å‡çµ** âŒ|
|5|èƒŒæ™¯åŸ·è¡Œç·’|ThreadPool ä¸­çš„èƒŒæ™¯åŸ·è¡Œç·’é–‹å§‹å·¥ä½œï¼Œ`Thread.Sleep(5000)`|æ­£å¸¸åŸ·è¡Œ|
|6|èƒŒæ™¯åŸ·è¡Œç·’|5 ç§’å¾Œï¼Œå‘¼å« `uiContext.Post(...)`ï¼Œå°‡ `tcs.SetResult(...)` æ’å…¥ UI åŸ·è¡Œç·’çš„è¨Šæ¯ä½‡åˆ—|æ­£å¸¸åŸ·è¡Œ|
|7|**æ­»çµ**|UI åŸ·è¡Œç·’æ­£åœ¨ç­‰å¾… `tcs.Task` å®Œæˆï¼›`tcs.Task` æ­£åœ¨ç­‰å¾… UI åŸ·è¡Œç·’åŸ·è¡Œ `tcs.SetResult(...)`ï¼›å…©è€…äº’ç›¸ç­‰å¾…|**æ‡‰ç”¨ç¨‹å¼å‡çµ** ğŸ’€|

### 2.2 æ­»çµçš„æ ¸å¿ƒçŸ›ç›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             UI åŸ·è¡Œç·’çš„å›°å¢ƒ                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  [.Result ç­‰å¾…ä¸­] â”€â”€ç­‰å¾…â”€â”€> [Task å®Œæˆ]           â”‚
â”‚         â–²                          â”‚            â”‚
â”‚         â”‚                          â”‚            â”‚
â”‚         â”‚                          â–¼            â”‚
â”‚     éœ€è¦ UI åŸ·è¡Œç·’    <â”€â”€â”€éœ€è¦â”€â”€â”€  [åŸ·è¡Œ SetResult] â”‚
â”‚      æ‰èƒ½è§£é™¤ç­‰å¾…                (åœ¨è¨Šæ¯ä½‡åˆ—ä¸­)     â”‚
â”‚                                                 â”‚
â”‚  çµè«–ï¼šUI åŸ·è¡Œç·’åœ¨ç­‰è‡ªå·±ï¼Œæ‰€ä»¥æ°¸é ç­‰ä¸åˆ°             â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—œéµç†è§£**ï¼š

- **UI åŸ·è¡Œç·’**è¢« `.Result` é˜»æ“‹ï¼Œç„¡æ³•è™•ç†è¨Šæ¯ä½‡åˆ—
- **è¨Šæ¯ä½‡åˆ—**ä¸­æœ‰ `tcs.SetResult(...)`ï¼Œéœ€è¦ UI åŸ·è¡Œç·’ä¾†åŸ·è¡Œ
- **tcs.Task** éœ€è¦ `SetResult` è¢«åŸ·è¡Œæ‰èƒ½å®Œæˆ
- **.Result** éœ€è¦ `tcs.Task` å®Œæˆæ‰èƒ½è§£é™¤é˜»æ“‹

é€™æ˜¯ä¸€å€‹å¾ªç’°ä¾è³´ï¼Œå°è‡´æ­»çµã€‚

---
## 3. TaskCompletionSource çš„åŸ·è¡Œç·’å®‰å…¨æ€§

### 3.1 é‡è¦è§€å¿µé‡æ¸…

**å•é¡Œ**ï¼šç‚ºä»€éº¼ `tcs.SetResult("é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™")` éœ€è¦åœ¨ UI Thread åŸ·è¡Œï¼Ÿ

**ç­”æ¡ˆ**ï¼šå…¶å¯¦**ä¸éœ€è¦**ï¼

- `TaskCompletionSource` (TCS) æ˜¯ä¸€å€‹**åŸ·è¡Œç·’å®‰å…¨**çš„ç‰©ä»¶
- æ‚¨å¯ä»¥åœ¨**ä»»ä½•åŸ·è¡Œç·’**ï¼ˆåŒ…å«èƒŒæ™¯åŸ·è¡Œç·’ï¼‰ä¸Šå‘¼å« `tcs.SetResult()`
- å®ƒéƒ½èƒ½æ­£å¸¸é‹ä½œï¼Œå°‡ Task æ¨™è¨˜ç‚ºã€Œå·²å®Œæˆã€

### 3.2 æ­»çµçš„çœŸæ­£åŸå› 

æ­»çµçš„çœŸæ­£åŸå› ä¸¦ä¸æ˜¯ã€Œ`SetResult` å¿…é ˆåœ¨ UI åŸ·è¡Œç·’åŸ·è¡Œã€ã€‚

**çœŸæ­£åŸå› æ˜¯**ï¼š

> ã€Œä¸€å€‹è¢«é˜»æ“‹çš„åŸ·è¡Œç·’ï¼ˆUI Threadï¼‰ï¼Œæ­£åœ¨ç­‰å¾…ä¸€å€‹ã€è¢«æ’ç¨‹åˆ°è‡ªå·±èº«ä¸Šã€ä½†è‡ªå·±å»æ²’ç©ºåŸ·è¡Œçš„ä»»å‹™ï¼ˆ`uiContext.Post` è£¡çš„å·¥ä½œï¼‰ã€

### 3.3 ä¸æœƒæ­»çµçš„ç‰ˆæœ¬ï¼ˆä½†ä»æ˜¯ä¸å¥½çš„å¯«æ³•ï¼‰

```csharp
// UI äº‹ä»¶
private void myButton_Click(object sender, EventArgs e)
{
    // UI åŸ·è¡Œç·’ä»ç„¶åœ¨é€™è£¡ã€ŒåŒæ­¥ã€ç­‰å¾…
    // ä½†é€™æ¬¡... ä¸æœƒæ­»çµäº†
    var data = MyAwesomeLibrary.GetDataAsync_NoDeadlock().Result; 
    
    // å¤§ç´„ 5 ç§’å¾Œï¼ŒUI æœƒæˆåŠŸæ›´æ–°
    myLabel.Text = data; 
}

public static class MyAwesomeLibrary
{
    public static Task<string> GetDataAsync_NoDeadlock()
    {
        // var uiContext = SynchronizationContext.Current; // <-- ä¸å†éœ€è¦äº†
        
        var tcs = new TaskCompletionSource<string>();
        
        // 2. å°‡å·¥ä½œä¸Ÿåˆ°èƒŒæ™¯åŸ·è¡Œç·’æ± 
        ThreadPool.QueueUserWorkItem(_ => {
            
            Thread.Sleep(5000); 
            
            // 3. é—œéµï¼ç›´æ¥åœ¨ã€ŒèƒŒæ™¯åŸ·è¡Œç·’ã€ä¸Šè¨­å®š Task çµæœ
            //    ä¸éœ€è¦è²¼å› UI åŸ·è¡Œç·’
            tcs.SetResult("é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™");
            
            // ä¸å†ä½¿ç”¨ uiContext.Post(...)
        });	
        
        // 4. ç«‹åˆ»å›å‚³é€™å€‹ã€Œå°šæœªå®Œæˆã€çš„ Task
        return tcs.Task;
    }
}
```

### 3.4 GetDataAsync_NoDeadlock çš„åŸ·è¡Œæµç¨‹

|æ­¥é©Ÿ|åŸ·è¡Œç·’|å‹•ä½œ|ç‹€æ…‹|
|---|---|---|---|
|1|UI åŸ·è¡Œç·’|`myButton_Click` åœ¨ UI åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ|æ­£å¸¸åŸ·è¡Œ|
|2|UI åŸ·è¡Œç·’|`GetDataAsync_NoDeadlock()` è¢«å‘¼å«|æ­£å¸¸åŸ·è¡Œ|
|3|UI åŸ·è¡Œç·’|`.Result` é˜»æ“‹äº† UI åŸ·è¡Œç·’|**è¢«å‡çµ 5 ç§’** âš ï¸|
|4|èƒŒæ™¯åŸ·è¡Œç·’|é–‹å§‹ `Sleep(5000)`|æ­£å¸¸åŸ·è¡Œ|
|5|èƒŒæ™¯åŸ·è¡Œç·’|5 ç§’å¾Œï¼Œå‘¼å« `tcs.SetResult(...)`|æ­£å¸¸åŸ·è¡Œ|
|6|èƒŒæ™¯åŸ·è¡Œç·’|Task (`tcs.Task`) çš„ç‹€æ…‹è®Šç‚ºã€Œå®Œæˆã€|Task å·²å®Œæˆ âœ…|
|7|UI åŸ·è¡Œç·’|åµæ¸¬åˆ° `tcs.Task` å·²å®Œæˆï¼Œè§£é™¤é˜»æ“‹ (Unblock)|æ¢å¾©åŸ·è¡Œ|
|8|UI åŸ·è¡Œç·’|ç¹¼çºŒåŸ·è¡Œ `myLabel.Text = data;`|ç•«é¢æ›´æ–°æˆåŠŸ|

### 3.5 ç‚ºä»€éº¼é€™ä»æ˜¯ä¸å¥½çš„å¯«æ³•

é›–ç„¶ `GetDataAsync_NoDeadlock()` é€™å€‹ç‰ˆæœ¬æŠ€è¡“ä¸Šä¸æœƒé€ æˆæ­»çµï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸€å€‹éå¸¸ç³Ÿç³•çš„è¨­è¨ˆï¼Œæ˜¯æˆ‘å€‘åœ¨é–‹ç™¼ UI æ‡‰ç”¨ç¨‹å¼æ™‚æ¥µåŠ›é¿å…çš„ã€Œåæ¨¡å¼ã€(Anti-pattern)ã€‚

**åŸå› **ï¼šåœ¨æ­¥é©Ÿ 3ï¼Œ`myButton_Click` å‘¼å« `.Result` æ™‚ï¼ŒUI åŸ·è¡Œç·’è¢«ã€ŒåŒæ­¥é˜»æ“‹ã€äº†æ•´æ•´ 5 ç§’é˜ï¼

**åœ¨é€™ 5 ç§’å…§çš„å¾Œæœ**ï¼š

- âŒ æ‚¨çš„æ‡‰ç”¨ç¨‹å¼æœƒå®Œå…¨å‡çµ (Freeze)
- âŒ ä½¿ç”¨è€…ç„¡æ³•é»æ“Šä»»ä½•æŒ‰éˆ•æˆ–é¸å–®
- âŒ ä½¿ç”¨è€…ç„¡æ³•æ‹–å‹•è¦–çª—
- âŒ å¦‚æœä½¿ç”¨è€…å˜—è©¦é»æ“Šï¼ŒWindows ç³»çµ±å¯èƒ½æœƒå°‡æ‚¨çš„æ‡‰ç”¨ç¨‹å¼æ¨™è¨˜ç‚ºã€Œæ²’æœ‰å›æ‡‰ã€
- âŒ é€™æœƒçµ¦ä½¿ç”¨è€…å¸¶ä¾†æ¥µå·®çš„é«”é©—

### 3.6 é—œéµçµè«–

| å•é¡Œ                             | ç­”æ¡ˆ                                                                                         |
| ------------------------------ | ------------------------------------------------------------------------------------------ |
| `tcs.SetResult` éœ€è¦åœ¨ UI åŸ·è¡Œç·’åŸ·è¡Œå—ï¼Ÿ | **ä¸éœ€è¦**ï¼Œå®ƒæ˜¯åŸ·è¡Œç·’å®‰å…¨çš„                                                                           |
| ç‚ºä»€éº¼åŸå§‹ç‰ˆæœ¬æœƒæ­»çµï¼Ÿ                    | å› ç‚ºåŒæ™‚åŒ…å«ã€Œ(A) åœ¨ UI åŸ·è¡Œç·’ç­‰å¾…ã€+ã€Œ(B) æŠŠå®Œæˆè¨Šè™Ÿè²¼å› UI åŸ·è¡Œç·’ã€é€™å…©å€‹äº’ç›¸è¡çªçš„è¡Œç‚ºã€‚(A) é˜»æ“‹äº† (B) çš„åŸ·è¡Œï¼Œ(B) åˆæ˜¯ (A) è§£é™¤é˜»æ“‹çš„å”¯ä¸€å¸Œæœ› |
| å°±ç®—ä¸æ­»çµï¼Œèƒ½ç”¨ `.Result` å—ï¼Ÿ          | **ä¸èƒ½**ï¼Œåœ¨ UI åŸ·è¡Œç·’ä¸Šä½¿ç”¨ `.Result` åŒæ­¥ç­‰å¾…ï¼Œä¹Ÿæœƒå‡çµç•«é¢ï¼Œæ˜¯æ‡‰é¿å…çš„åæ¨¡å¼                                          |

**å”¯ä¸€çš„æ­£ç¢ºè§£æ³•**ï¼šå§‹çµ‚ä½¿ç”¨ `async` / `await`ï¼Œå®ƒèƒ½ç¢ºä¿ UI åŸ·è¡Œç·’åœ¨ç­‰å¾…æœŸé–“ä¿æŒè‡ªç”±ï¼Œæ‡‰ç”¨ç¨‹å¼æ‰èƒ½ä¿æŒå›æ‡‰ã€‚

---

## 4. ThreadPool.QueueUserWorkItem çš„åŸ·è¡Œé †åº

### 4.1 æ ¸å¿ƒå•é¡Œ

**å•é¡Œ**ï¼š`return tcs.Task;` æœƒç­‰ `ThreadPool.QueueUserWorkItem` å®Œæˆå¾Œæ‰åŸ·è¡Œå—ï¼Ÿé‚„æ˜¯åŸ·è¡Œé †åºæ‡‰è©²æ˜¯æ€éº¼æ¨£çš„ï¼Ÿ

**ç›´æ¥å›ç­”**ï¼š**ä¸æœƒç­‰å¾…**ã€‚

`return tcs.Task;` å¹¾ä¹æ˜¯ç«‹å³åŸ·è¡Œçš„ï¼Œå®ƒ**çµ•å°ä¸æœƒ**ç­‰å¾… `ThreadPool.QueueUserWorkItem` è£¡é¢çš„ç¨‹å¼ç¢¼ï¼ˆ`Thread.Sleep` æˆ– `tcs.SetResult`ï¼‰åŸ·è¡Œå®Œç•¢ã€‚

### 4.2 ThreadPool.QueueUserWorkItem çš„é‹ä½œæ©Ÿåˆ¶

æ‚¨å¯ä»¥å°‡ `ThreadPool.QueueUserWorkItem` æƒ³åƒæˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ThreadPool çš„æ¯”å–»                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  æ‚¨ï¼ˆä¸»åŸ·è¡Œç·’ï¼‰ï¼š                                 â”‚
â”‚  ã€ŒåŠ©ç†ï¼Œé€™ä»½æ–‡ä»¶ï¼ˆLambdaï¼‰æœ‰ç©ºæ™‚å¹«æˆ‘è™•ç†ã€‚ã€      â”‚
â”‚                                                 â”‚
â”‚  åŠ©ç†ï¼ˆThreadPoolï¼‰ï¼š                             â”‚
â”‚  ã€Œå¥½çš„ï¼Œæˆ‘æœƒæ‰¾å€‹ç©ºé–’çš„èƒŒæ™¯åŸ·è¡Œç·’ä¾†åšã€‚ã€         â”‚
â”‚                                                 â”‚
â”‚  æ‚¨ï¼ˆä¸»åŸ·è¡Œç·’ï¼‰ï¼š                                 â”‚
â”‚  ã€Œå¤ªå¥½äº†ï¼ã€ï¼ˆç«‹åˆ»è½‰èº«åšä¸‹ä¸€ä»¶äº‹ â†’ returnï¼‰      â”‚
â”‚                                                 â”‚
â”‚  ï¼ˆæ‚¨ä¸æœƒç«™åœ¨é‚£è£¡ç­‰åŠ©ç†çœŸçš„é–‹å§‹è™•ç†ï¼‰             â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 è©³ç´°åŸ·è¡Œæµç¨‹åˆ†æ

```csharp
public static Task<string> GetDataAsync()
{
    var uiContext = SynchronizationContext.Current;  // æ­¥é©Ÿ 1
    var tcs = new TaskCompletionSource<string>();    // æ­¥é©Ÿ 2
    
    ThreadPool.QueueUserWorkItem(_ => {              // æ­¥é©Ÿ 3
        Thread.Sleep(5000);                          // æ­¥é©Ÿ 5ï¼ˆç¨å¾ŒåŸ·è¡Œï¼‰
        uiContext.Post(state => {                    // æ­¥é©Ÿ 6ï¼ˆç¨å¾ŒåŸ·è¡Œï¼‰
            tcs.SetResult("é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™");
        }, null);
    });
    
    return tcs.Task;                                 // æ­¥é©Ÿ 4
}
```

**åŸ·è¡Œé †åºæ™‚é–“è»¸**ï¼š

|æ™‚é–“é»|æ­¥é©Ÿ|åŸ·è¡Œç·’|å‹•ä½œ|Task ç‹€æ…‹|
|---|---|---|---|---|
|T0|1|å‘¼å«åŸ·è¡Œç·’|å–å¾— `SynchronizationContext.Current`|-|
|T0|2|å‘¼å«åŸ·è¡Œç·’|å»ºç«‹ `TaskCompletionSource<string>`|å°šæœªé–‹å§‹|
|T0|3|å‘¼å«åŸ·è¡Œç·’|å‘¼å« `ThreadPool.QueueUserWorkItem`ï¼Œå°‡å·¥ä½œã€Œç™»è¨˜ã€åˆ° ThreadPool çš„å¾…è¾¦æ¸…å–®|å°šæœªé–‹å§‹|
|T0|4|å‘¼å«åŸ·è¡Œç·’|**ç«‹å³åŸ·è¡Œ** `return tcs.Task;`ï¼Œå›å‚³ã€Œå°šæœªå®Œæˆã€çš„ Task|**å°šæœªå®Œæˆ** â³|
|T0 ä¹‹å¾Œ|5|**èƒŒæ™¯åŸ·è¡Œç·’**|ThreadPool æ‰¾åˆ°ç©ºé–’åŸ·è¡Œç·’ï¼Œé–‹å§‹åŸ·è¡Œ `Thread.Sleep(5000)`|å°šæœªå®Œæˆ|
|T0 + 5ç§’|6|**èƒŒæ™¯åŸ·è¡Œç·’**|å‘¼å« `uiContext.Post(...)`ï¼Œæ’ç¨‹ `SetResult`|å°šæœªå®Œæˆ|
|T0 + 5ç§’+|-|**UI åŸ·è¡Œç·’**|åŸ·è¡Œ `tcs.SetResult(...)`ï¼ˆå¦‚æœ UI åŸ·è¡Œç·’æœ‰ç©ºçš„è©±ï¼‰|**å·²å®Œæˆ** âœ…|

### 4.4 é—œéµç†è§£

```csharp
ThreadPool.QueueUserWorkItem(_ => {
    // é€™è£¡é¢çš„ç¨‹å¼ç¢¼ã€Œä¸æœƒç«‹å³åŸ·è¡Œã€
    // å®ƒåªæ˜¯è¢«ã€Œæ’ç¨‹ã€äº†ï¼Œç­‰å¾… ThreadPool æœ‰ç©ºé–’åŸ·è¡Œç·’æ™‚æ‰æœƒåŸ·è¡Œ
    Thread.Sleep(5000);
});

// é€™è¡Œç¨‹å¼ç¢¼æœƒã€Œç«‹å³åŸ·è¡Œã€ï¼Œä¸æœƒç­‰å¾…ä¸Šé¢çš„ Lambda å®Œæˆ
return tcs.Task;
```

**æ¯”è¼ƒè¡¨**ï¼š

|æ–¹æ³•|æ˜¯å¦ç­‰å¾…å®Œæˆ|å‘¼å«åŸ·è¡Œç·’çš„è¡Œç‚º|
|---|---|---|
|`ThreadPool.QueueUserWorkItem`|âŒ ä¸ç­‰å¾…|ç«‹å³è¿”å›ï¼Œç¹¼çºŒåŸ·è¡Œä¸‹ä¸€è¡Œ|
|ç›´æ¥å‘¼å«å‡½å¼ï¼ˆå¦‚ `DoWork()`ï¼‰|âœ… ç­‰å¾…|é˜»æ“‹åˆ°å‡½å¼åŸ·è¡Œå®Œç•¢æ‰è¿”å›|
|`Task.Run(...).Wait()`|âœ… ç­‰å¾…|é˜»æ“‹åˆ° Task å®Œæˆ|
|`await Task.Run(...)`|â¸ï¸ é‡‹æ”¾åŸ·è¡Œç·’|é‡‹æ”¾åŸ·è¡Œç·’ï¼Œç­‰å®Œæˆå¾Œç¹¼çºŒ|

### 4.5 çµè«–

**`return tcs.Task;` ç¸½æ˜¯åœ¨ `ThreadPool.QueueUserWorkItem` æäº¤ä¹‹å¾Œå°±ç«‹åˆ»åŸ·è¡Œäº†ï¼Œè€Œä¸æ˜¯å®Œæˆä¹‹å¾Œæ‰åŸ·è¡Œã€‚**

é€™å°±æ˜¯ç‚ºä»€éº¼ï¼š

- âœ… `GetDataAsync()` å¯ä»¥ç«‹å³å›å‚³ä¸€å€‹ Task
- âœ… å‘¼å«ç«¯å¯ä»¥é¸æ“‡ç”¨ `await` éåŒæ­¥ç­‰å¾…ï¼ˆæ­£ç¢ºåšæ³•ï¼‰
- âŒ æˆ–ç”¨ `.Result` åŒæ­¥é˜»æ“‹ç­‰å¾…ï¼ˆéŒ¯èª¤åšæ³•ï¼Œå¯èƒ½æ­»çµæˆ–å‡çµ UIï¼‰

---

## 5. async/await å¦‚ä½•è§£æ±ºæ­»çµ

### 5.1 å•é¡Œå›é¡§

åŸå§‹çš„æ­»çµç¨‹å¼ç¢¼ï¼š

```csharp
private void myButton_Click(object sender, EventArgs e)
{
    var data = MyAwesomeLibrary.GetDataAsync().Result;  // âŒ æ­»çµ
    myLabel.Text = data.ToString();
}

public static class MyAwesomeLibrary
{
    public static Task<string> GetDataAsync()
    {
        var uiContext = SynchronizationContext.Current;
        var tcs = new TaskCompletionSource<string>();
        
        ThreadPool.QueueUserWorkItem(_ => {
            Thread.Sleep(5000);
            uiContext.Post(state => {
                tcs.SetResult("xxxx");  // éœ€è¦ UI åŸ·è¡Œç·’åŸ·è¡Œï¼Œä½† UI è¢«é˜»æ“‹äº†
            }, null);
        });
        
        return tcs.Task;
    }
}
```

### 5.2 ä¿®æ­£å¾Œçš„ç‰ˆæœ¬

**å•é¡Œ**ï¼šå¦‚æœå°‡ `myButton_Click()` æ”¹æˆé€™æ¨£ï¼Œé‚„æœƒæ­»çµå—ï¼Ÿ

```csharp
private async Task myButton_Click(object sender, EventArgs e)
{
    var data = await MyAwesomeLibrary.GetDataAsync();  // âœ… ä¸æœƒæ­»çµ
    myLabel.Text = data.ToString();
}
```

**ç­”æ¡ˆ**ï¼š**ä¸æœƒæ­»çµ**ï¼Œé€™æ­£æ˜¯ async/await è¢«è¨­è¨ˆå‡ºä¾†è¦è§£æ±ºçš„ç¶“å…¸å•é¡Œã€‚

### 5.3 ç‚ºä»€éº¼ä¸æœƒæ­»çµï¼Ÿ

#### 5.3.1 åŸæœ¬æ­»çµçš„åŸå›  (Sync over Async)

|æ­¥é©Ÿ|åŸ·è¡Œç·’|å‹•ä½œ|å•é¡Œ|
|---|---|---|---|
|1|UI|`myButton_Click` åŸ·è¡Œåœ¨ UI åŸ·è¡Œç·’ä¸Š|-|
|2|UI|å‘¼å« `GetDataAsync()`ï¼Œå–å¾— `uiContext`|-|
|3|UI|å‘¼å« `.Result`ï¼Œ**éœ¸ä½”ä¸¦é˜»æ–·** UI åŸ·è¡Œç·’|**UI è¢«å‡çµ** âŒ|
|4|èƒŒæ™¯|ThreadPool åŸ·è¡Œ `Sleep(5000)` å¾Œï¼Œå‘¼å« `uiContext.Post(...)`|-|
|5|**æ­»çµ**|UI åŸ·è¡Œç·’è¢« `.Result` é˜»æ–·ï¼Œç„¡æ³•è™•ç† `Post` çš„è¨Šæ¯ï¼›`Post` çš„è¨Šæ¯ç„¡æ³•åŸ·è¡Œï¼Œ`.Result` æ°¸é ç­‰ä¸åˆ°å®Œæˆ|**äº’ç›¸ç­‰å¾…** ğŸ’€|

#### 5.3.2 æ–°ç‰ˆæ­£å¸¸é‹ä½œçš„åŸå›  (Async/Await)

|æ­¥é©Ÿ|åŸ·è¡Œç·’|å‹•ä½œ|Task ç‹€æ…‹|
|---|---|---|---|
|1|UI|`myButton_Click` åŸ·è¡Œåœ¨ UI åŸ·è¡Œç·’ä¸Š|-|
|2|UI|å‘¼å« `GetDataAsync()`ï¼ŒåŒæ¨£å–å¾— `uiContext`|-|
|3|UI|é‡åˆ° `await` é—œéµå­—|å°šæœªå®Œæˆ|
|4|UI|`await` **ä¸æœƒé˜»æ–·** UI åŸ·è¡Œç·’ï¼Œè€Œæ˜¯è¨­å®šã€Œå¾…è¾¦äº‹é …ã€(continuation)ï¼Œç„¶å¾Œç«‹å³å°‡æ§åˆ¶æ¬Šäº¤é‚„ (yield) çµ¦ UI çš„è¨Šæ¯è¿´åœˆ|å°šæœªå®Œæˆ|
|5|UI|**UI åŸ·è¡Œç·’æ˜¯è‡ªç”±çš„**ï¼Œå¯ä»¥ç¹¼çºŒè™•ç†ä½¿ç”¨è€…çš„é»æ“Šã€ç•«é¢é‡ç¹ªç­‰|å°šæœªå®Œæˆ âœ…|
|6|èƒŒæ™¯|ThreadPool åŸ·è¡Œ `Sleep(5000)` å¾Œï¼Œå‘¼å« `uiContext.Post(...)`ï¼Œå°‡ `tcs.SetResult("xxxx")` æ’ç¨‹å› UI|å°šæœªå®Œæˆ|
|7|UI|**å› ç‚º UI åŸ·è¡Œç·’æ˜¯è‡ªç”±çš„**ï¼Œå®ƒå¾è¨Šæ¯è¿´åœˆä¸­å–å‡ºå·¥ä½œä¸¦åŸ·è¡Œ `tcs.SetResult("xxxx")`|**Task å®Œæˆ** âœ…|
|8|UI|`await` åµæ¸¬åˆ° Task å·²å®Œæˆï¼Œå°‡ã€Œå¾…è¾¦äº‹é …ã€ï¼ˆ`myLabel.Text = data.ToString();`ï¼‰æ’ç¨‹å› UI åŸ·è¡Œç·’|å·²å®Œæˆ|
|9|UI|UI åŸ·è¡Œç·’åŸ·è¡Œå¾…è¾¦äº‹é …ï¼ŒæˆåŠŸæ›´æ–° Label|å·²å®Œæˆ|

### 5.4 é—œéµå·®ç•°æ¯”è¼ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         .Result vs await çš„è¡Œç‚ºå·®ç•°              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  ä½¿ç”¨ .Resultï¼ˆéŒ¯èª¤ï¼Œæœƒæ­»çµï¼‰ï¼š                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ UI åŸ·è¡Œç·’                            â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ [.Result] â†’ é˜»æ“‹ UI åŸ·è¡Œç·’ âŒ       â”‚        â”‚
â”‚  â”‚     â†“                               â”‚        â”‚
â”‚  â”‚ ç­‰å¾… Task å®Œæˆ...                   â”‚        â”‚
â”‚  â”‚     â†“                               â”‚        â”‚
â”‚  â”‚ (ç„¡æ³•è™•ç† uiContext.Post è¨Šæ¯)      â”‚        â”‚
â”‚  â”‚     â†“                               â”‚        â”‚
â”‚  â”‚ æ°¸é ç­‰ä¸åˆ°å®Œæˆ ğŸ’€                   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                 â”‚
â”‚  ä½¿ç”¨ awaitï¼ˆæ­£ç¢ºï¼Œä¸æœƒæ­»çµï¼‰ï¼š                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ UI åŸ·è¡Œç·’                            â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ [await] â†’ é‡‹æ”¾ UI åŸ·è¡Œç·’ âœ…         â”‚        â”‚
â”‚  â”‚     â†“                               â”‚        â”‚
â”‚  â”‚ UI åŸ·è¡Œç·’è‡ªç”±ï¼Œå¯è™•ç†å…¶ä»–è¨Šæ¯        â”‚        â”‚
â”‚  â”‚     â†“                               â”‚        â”‚
â”‚  â”‚ åŸ·è¡Œ uiContext.Post è¨Šæ¯ âœ…         â”‚        â”‚
â”‚  â”‚     â†“                               â”‚        â”‚
â”‚  â”‚ Task å®Œæˆ â†’ await ç¹¼çºŒåŸ·è¡Œ âœ…       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.5 ç¸½çµ

| æ–¹æ³•        | UI åŸ·è¡Œç·’è¡Œç‚º            | æ˜¯å¦æ­»çµ   | é©ç”¨å ´æ™¯               |
| --------- | ------------------- | ------ | ------------------ |
| `.Result` | é˜»æ–·åŸ·è¡Œç·’ (Blocking) ğŸš« | âœ… æœƒæ­»çµ  | **æ°¸é ä¸è¦åœ¨ UI åŸ·è¡Œç·’ä½¿ç”¨** |
| `.Wait()` | é˜»æ–·åŸ·è¡Œç·’ (Blocking) ğŸš« | âœ… æœƒæ­»çµ  | **æ°¸é ä¸è¦åœ¨ UI åŸ·è¡Œç·’ä½¿ç”¨** |
| `await`   | é‡‹æ”¾åŸ·è¡Œç·’ (Yielding) âœ…  | âŒ ä¸æœƒæ­»çµ | **UI æ‡‰ç”¨ç¨‹å¼çš„æ­£ç¢ºåšæ³•**   |

**ä¿®æ­£å¾Œçš„ç‰ˆæœ¬æ˜¯ä½¿ç”¨ C# éåŒæ­¥ç¨‹å¼è¨­è¨ˆçš„æ­£ç¢ºæ–¹å¼ã€‚**

---

## 6. await çš„ä¸Šä¸‹æ–‡æ•æ‰æ©Ÿåˆ¶

### 6.1 æ ¸å¿ƒå•é¡Œ

**å•é¡Œ**ï¼šç‚ºä»€éº¼ `myLabel.Text = data.ToString();` æœƒåœ¨ UI åŸ·è¡Œç·’åŸ·è¡Œï¼Ÿ

```csharp
private async Task myButton_Click(object sender, EventArgs e)
{
    var data = await MyAwesomeLibrary.GetDataAsync();
    myLabel.Text = data.ToString();  // â† ç‚ºä»€éº¼é€™è¡Œåœ¨ UI åŸ·è¡Œç·’ï¼Ÿ
}
```

### 6.2 ç°¡å–®å›ç­”

**é—œéµåœ¨æ–¼ `await` é—œéµå­—åœ¨èƒŒå¾Œæ‰€åšçš„ã€Œé­”æ³•ã€ã€‚**

**ç°¡å–®ä¾†èªª**ï¼š`await` é è¨­æœƒã€Œæ•æ‰ã€ç•¶å‰çš„ä¸Šä¸‹æ–‡ (Context)ï¼Œä¸¦åœ¨ Task å®Œæˆå¾Œï¼Œå˜—è©¦å°‡å¾ŒçºŒçš„ç¨‹å¼ç¢¼ã€Œé‚„åŸã€å›è©²ä¸Šä¸‹æ–‡åŸ·è¡Œã€‚

### 6.3 è©³ç´°åˆ†è§£æ­¥é©Ÿ

#### æ­¥é©Ÿ 1ï¼šåŸ·è¡Œåœ¨ UI åŸ·è¡Œç·’ä¸Š

```csharp
private async Task myButton_Click(object sender, EventArgs e)
{
    // é€™å€‹æ–¹æ³•æ˜¯äº‹ä»¶è™•ç†å¸¸å¼ (Event Handler)
    // å®ƒé è¨­ç”± Windows çš„ã€ŒUI è¨Šæ¯è¿´åœˆ (Message Loop)ã€å‘¼å«
    // æ‰€ä»¥å®ƒ 100% åŸ·è¡Œåœ¨ UI åŸ·è¡Œç·’ä¸Š
```

**èªªæ˜**ï¼š`myButton_Click` æ˜¯ä¸€å€‹äº‹ä»¶è™•ç†å¸¸å¼ (Event Handler)ï¼Œå®ƒé è¨­å°±æ˜¯ç”± Windows çš„ã€ŒUI è¨Šæ¯è¿´åœˆ (Message Loop)ã€æ‰€å‘¼å«çš„ï¼Œæ‰€ä»¥å®ƒ 100% åŸ·è¡Œåœ¨ UI åŸ·è¡Œç·’ä¸Šã€‚

#### æ­¥é©Ÿ 2ï¼šawait æ•æ‰ä¸Šä¸‹æ–‡

```csharp
    var data = await MyAwesomeLibrary.GetDataAsync();
    //          â†‘
    //          ç•¶ç¨‹å¼åŸ·è¡Œåˆ°é€™è£¡æ™‚ï¼š
```

**await æœƒåšä»¥ä¸‹äº‹æƒ…**ï¼š

1. **æª¢æŸ¥ç•¶å‰çš„ `SynchronizationContext.Current`ï¼ˆåŒæ­¥ä¸Šä¸‹æ–‡ï¼‰**    
    - å› ç‚ºç¾åœ¨æ˜¯åœ¨ UI åŸ·è¡Œç·’ä¸Šï¼Œæ‰€ä»¥ `SynchronizationContext.Current` ä¸æ˜¯ `null`
    - å®ƒæœƒæ˜¯ UI åŸ·è¡Œç·’çš„é‚£å€‹ç‰¹å®šä¸Šä¸‹æ–‡
	
2. **ã€Œæ•æ‰ã€ä¸¦å„²å­˜é€™å€‹ UI ä¸Šä¸‹æ–‡**    
    - `await` æœƒ**è¨˜ä½**ï¼šã€Œæˆ‘æ˜¯å¾ UI åŸ·è¡Œç·’ä¾†çš„ã€

#### æ­¥é©Ÿ 3ï¼šawait é‡‹æ”¾ UI åŸ·è¡Œç·’

```csharp
    var data = await MyAwesomeLibrary.GetDataAsync();
    //          â†‘
    //          await åšçš„äº‹æƒ…ï¼š
```

**await æ¥è‘—æœƒï¼š**

1. å‘ `GetDataAsync()` é€™å€‹ Task è¨»å†Šä¸€å€‹ã€Œå¾…è¾¦äº‹é …ã€(continuation)    
    - é€™å€‹å¾…è¾¦äº‹é …å°±æ˜¯ `await` ä¹‹å¾Œçš„æ‰€æœ‰ç¨‹å¼ç¢¼ï¼ˆåŒ…å« `myLabel.Text = ...`ï¼‰
	
2. è¨»å†Šå®Œç•¢å¾Œï¼Œ`await` æœƒç«‹åˆ»è®“ `myButton_Click` æ–¹æ³•è¿”å› (return)    
    - å°‡ UI åŸ·è¡Œç·’çš„æ§åˆ¶æ¬Šäº¤é‚„çµ¦è¨Šæ¯è¿´åœˆ
	
3. **é€™å°±æ˜¯ç‚ºä»€éº¼ UI ä¸æœƒå¡ä½çš„é—œéµ**    
    - UI åŸ·è¡Œç·’ç¾åœ¨æ˜¯è‡ªç”±çš„ï¼Œå¯ä»¥å»è™•ç†å…¶ä»–çš„é»æ“Šæˆ–ç•«é¢æ›´æ–°

#### æ­¥é©Ÿ 4ï¼šTask åœ¨èƒŒæ™¯å®Œæˆ

```csharp
// GetDataAsync() è£¡é¢çš„ç¨‹å¼ç¢¼ï¼š
ThreadPool.QueueUserWorkItem(_ => {
    Thread.Sleep(5000);  // èƒŒæ™¯åŸ·è¡Œç·’èŠ±äº† 5 ç§’é˜
    uiContext.Post(state => {
        tcs.SetResult("xxxx");  // Task è®Šç‚ºå®Œæˆç‹€æ…‹
    }, null);
});
```

#### æ­¥é©Ÿ 5ï¼šawait é‚„åŸä¸Šä¸‹æ–‡ï¼ˆé€™æ˜¯æ‚¨å•é¡Œçš„ç­”æ¡ˆï¼‰

**ç•¶ Task å®Œæˆæ™‚ï¼Œ`await` æ©Ÿåˆ¶æœƒè¢«è§¸ç™¼ï¼š**

1. å®ƒæœƒæ‹¿å‡ºåœ¨**æ­¥é©Ÿ 2** å„²å­˜çš„é‚£å€‹**ã€ŒUI ä¸Šä¸‹æ–‡ã€**
    
2. å®ƒæœƒé€éé€™å€‹ UI ä¸Šä¸‹æ–‡ï¼Œå°‡ã€Œå¾…è¾¦äº‹é …ã€ï¼ˆä¹Ÿå°±æ˜¯ `myLabel.Text = data.ToString();` é€™æ®µç¨‹å¼ç¢¼ï¼‰`Post`ï¼ˆå¼µè²¼ï¼‰å› UI åŸ·è¡Œç·’çš„è¨Šæ¯è¿´åœˆä¸­ï¼Œæ’éšŠç­‰å¾…åŸ·è¡Œ
    

```csharp
// await èƒŒå¾Œåšçš„äº‹æƒ…ï¼ˆæ¦‚å¿µæ€§ç¨‹å¼ç¢¼ï¼‰ï¼š
uiContext.Post(state => {
    // åŸ·è¡Œ await ä¹‹å¾Œçš„ç¨‹å¼ç¢¼
    myLabel.Text = data.ToString();
}, null);
```

#### æ­¥é©Ÿ 6ï¼šUI åŸ·è¡Œç·’åŸ·è¡Œå¾ŒçºŒç¨‹å¼ç¢¼

1. UI åŸ·è¡Œç·’çš„è¨Šæ¯è¿´åœˆæ˜¯å€‹ã€Œå¾…è¾¦æ¸…å–®ã€
2. å®ƒç™¼ç¾æ¸…å–®ä¸Šæœ‰ä¸€é …æ–°å·¥ä½œï¼ˆæ›´æ–° Label çš„æ–‡å­—ï¼‰
3. å› ç‚º UI åŸ·è¡Œç·’æ˜¯è‡ªç”±çš„ï¼ˆåœ¨**æ­¥é©Ÿ 3** è¢«é‡‹æ”¾äº†ï¼‰ï¼Œå®ƒå°±æœƒå¾æ¸…å–®ä¸­å–å‡ºé€™é …å·¥ä½œä¾†åŸ·è¡Œ
4. å› æ­¤ï¼Œ`myLabel.Text = data.ToString();` é€™è¡Œç¨‹å¼ç¢¼ï¼Œæœ€çµ‚åˆå›åˆ°äº†å®ƒæœ€ä¸€é–‹å§‹çš„ UI åŸ·è¡Œç·’ä¸Šè¢«å®‰å…¨åœ°åŸ·è¡Œ

### 6.4 å®Œæ•´æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               await çš„ä¸Šä¸‹æ–‡æ•æ‰èˆ‡é‚„åŸæ©Ÿåˆ¶                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  [æ­¥é©Ÿ 1] UI åŸ·è¡Œç·’åŸ·è¡Œ myButton_Click                   â”‚
â”‚      â†“                                                  â”‚
â”‚  [æ­¥é©Ÿ 2] åŸ·è¡Œåˆ° awaitï¼Œæ•æ‰ UI ä¸Šä¸‹æ–‡                   â”‚
â”‚      â”œâ”€ å„²å­˜ï¼šã€Œæˆ‘ä¾†è‡ª UI åŸ·è¡Œç·’ã€                        â”‚
â”‚      â””â”€ è¨»å†Šï¼šã€ŒTask å®Œæˆå¾Œï¼Œè«‹å›åˆ° UI åŸ·è¡Œç·’ã€           â”‚
â”‚      â†“                                                  â”‚
â”‚  [æ­¥é©Ÿ 3] await é‡‹æ”¾ UI åŸ·è¡Œç·’                           â”‚
â”‚      â”œâ”€ myButton_Click ç«‹å³è¿”å›                         â”‚
â”‚      â””â”€ UI åŸ·è¡Œç·’è‡ªç”±ï¼Œå¯è™•ç†å…¶ä»–è¨Šæ¯ âœ…                  â”‚
â”‚      â†“                                                  â”‚
â”‚  [æ­¥é©Ÿ 4] èƒŒæ™¯åŸ·è¡Œç·’åŸ·è¡Œ Taskï¼ˆ5 ç§’å¾Œå®Œæˆï¼‰               â”‚
â”‚      â†“                                                  â”‚
â”‚  [æ­¥é©Ÿ 5] Task å®Œæˆï¼Œawait é‚„åŸä¸Šä¸‹æ–‡                     â”‚
â”‚      â”œâ”€ å–å‡ºå„²å­˜çš„ã€ŒUI ä¸Šä¸‹æ–‡ã€                          â”‚
â”‚      â”œâ”€ å°‡å¾ŒçºŒç¨‹å¼ç¢¼ Post å› UI è¨Šæ¯è¿´åœˆ                 â”‚
â”‚      â””â”€ myLabel.Text = ... æ’å…¥ UI å¾…è¾¦æ¸…å–®              â”‚
â”‚      â†“                                                  â”‚
â”‚  [æ­¥é©Ÿ 6] UI åŸ·è¡Œç·’åŸ·è¡Œå¾…è¾¦æ¸…å–®ä¸­çš„å·¥ä½œ                   â”‚
â”‚      â””â”€ å®‰å…¨åœ°æ›´æ–° UI âœ…                                 â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.5 ç¸½çµ

**await çš„æ™ºæ…§ä¹‹è™•åœ¨æ–¼ï¼Œå®ƒä¸åƒ…æ˜¯ã€Œç­‰å¾…ã€ï¼Œå®ƒé‚„æœƒã€Œè¨˜ä½è‡ªå·±åœ¨å“ªè£¡ã€ï¼ˆæ•æ‰ SynchronizationContextï¼‰ï¼Œä¸¦ä¸”åœ¨ç­‰å¾…çµæŸå¾Œï¼Œã€Œæƒ³è¾¦æ³•å›åˆ°åŸä¾†çš„åœ°æ–¹ã€ï¼ˆPost å›è©² Contextï¼‰å»åŸ·è¡Œå¾ŒçºŒçš„ç¨‹å¼ç¢¼ã€‚**

**é€™æ•´å€‹æ©Ÿåˆ¶ç¢ºä¿äº†æ‚¨ä¸éœ€è¦æ‰‹å‹•ä½¿ç”¨ `Invoke` æˆ– `BeginInvoke` ä¾†è™•ç†è·¨åŸ·è¡Œç·’æ›´æ–° UI çš„å•é¡Œï¼Œ`async`/`await` å¹«æ‚¨è‡ªå‹•å®Œæˆäº†ã€‚**

---

## 7. ConfigureAwait(false) çš„ä½¿ç”¨æ™‚æ©Ÿ

### 7.1 ä»€éº¼æ˜¯ ConfigureAwait(false)

```csharp
// é€™æ¨£æœƒè®“ await ä¸å»æ•æ‰ UI ä¸Šä¸‹æ–‡
// å¾ŒçºŒçš„ç¨‹å¼ç¢¼ (myLabel.Text = ...) å°±æœƒæ”¹åœ¨ ThreadPool åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ
// *é€™æ¨£åè€Œæœƒå°è‡´ã€Œè·¨åŸ·è¡Œç·’å­˜å– UIã€çš„éŒ¯èª¤ï¼*
var data = await MyAwesomeLibrary.GetDataAsync().ConfigureAwait(false);

// é€™è¡Œæœƒå‡ºéŒ¯ï¼Œå› ç‚ºå®ƒåœ¨ ThreadPool åŸ·è¡Œç·’ä¸Šè¢«å‘¼å«
myLabel.Text = data.ToString();  // âŒ è·¨åŸ·è¡Œç·’éŒ¯èª¤
```

### 7.2 ConfigureAwait(false) çš„ä½œç”¨

|æ–¹æ³•|ä¸Šä¸‹æ–‡æ•æ‰|await ä¹‹å¾Œåœ¨å“ªåŸ·è¡Œ|
|---|---|---|
|`await task`|âœ… æ•æ‰|å›åˆ°åŸå§‹ä¸Šä¸‹æ–‡ï¼ˆUI åŸ·è¡Œç·’ï¼‰|
|`await task.ConfigureAwait(false)`|âŒ ä¸æ•æ‰|åœ¨ä»»æ„ ThreadPool åŸ·è¡Œç·’|

### 7.3 ä½•æ™‚ä½¿ç”¨ ConfigureAwait(false)

**é©ç”¨å ´æ™¯**ï¼š

1. **åœ¨å…±ç”¨ç¨‹å¼åº« (Library) ä¸­**
    
    - æ‚¨çš„ç¨‹å¼ç¢¼ä¸çŸ¥é“å‘¼å«ç«¯æ˜¯èª°ï¼ˆå¯èƒ½æ˜¯ UIï¼Œå¯èƒ½æ˜¯ Web APIï¼Œå¯èƒ½æ˜¯ Consoleï¼‰
    - ä¸éœ€è¦å›åˆ°ç‰¹å®šä¸Šä¸‹æ–‡
    - å¯ä»¥æå‡æ•ˆèƒ½ï¼ˆé¿å…ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ›ï¼‰
2. **åœ¨ä¸éœ€è¦å­˜å– UI çš„ç¨‹å¼ç¢¼ä¸­**
    
    - ç´”ç²¹çš„é‹ç®—æˆ– I/O æ“ä½œ
    - ä¸æ¶‰åŠ UI æ§åˆ¶é …çš„å­˜å–

**ç¯„ä¾‹**ï¼š

```csharp
public static class MyLibrary
{
    public static async Task<string> GetDataAsync()
    {
        // é€™æ˜¯ä¸€å€‹å…±ç”¨ç¨‹å¼åº«ï¼Œä¸æ‡‰è©²å‡è¨­å‘¼å«ç«¯çš„ä¸Šä¸‹æ–‡
        await Task.Delay(5000).ConfigureAwait(false);
        
        // é€™è£¡ä¸å­˜å– UIï¼Œæ‰€ä»¥åœ¨ ThreadPool åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œæ²’å•é¡Œ
        return "é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™";
    }
}
```

### 7.4 ä½•æ™‚ä¸è¦ä½¿ç”¨ ConfigureAwait(false)

**ä¸é©ç”¨å ´æ™¯**ï¼š

1. **åœ¨ UI äº‹ä»¶è™•ç†å¸¸å¼ä¸­**
    
    - `await` ä¹‹å¾Œçš„ç¨‹å¼ç¢¼éœ€è¦å­˜å– UI æ§åˆ¶é …
    - **å¿…é ˆ**å›åˆ° UI åŸ·è¡Œç·’
2. **åœ¨ ASP.NET Core ä¸­**
    
    - ASP.NET Core æ²’æœ‰ `SynchronizationContext`
    - ä½¿ç”¨ `ConfigureAwait(false)` æ²’æœ‰æ•ˆèƒ½æå‡
    - åè€Œå¯èƒ½é€ æˆæ··æ·†

**éŒ¯èª¤ç¯„ä¾‹**ï¼š

```csharp
private async void myButton_Click(object sender, EventArgs e)
{
    // âŒ éŒ¯èª¤ï¼šå¾ŒçºŒè¦å­˜å– UIï¼Œä¸æ‡‰è©²ä½¿ç”¨ ConfigureAwait(false)
    var data = await MyLibrary.GetDataAsync().ConfigureAwait(false);
    
    // âŒ é€™è¡Œæœƒå‡ºéŒ¯ï¼Œå› ç‚ºç¾åœ¨åœ¨ ThreadPool åŸ·è¡Œç·’ä¸Š
    myLabel.Text = data;
}
```

**æ­£ç¢ºç¯„ä¾‹**ï¼š

```csharp
private async void myButton_Click(object sender, EventArgs e)
{
    // âœ… æ­£ç¢ºï¼šä¸ä½¿ç”¨ ConfigureAwait(false)ï¼Œè®“ await è‡ªå‹•å›åˆ° UI
    var data = await MyLibrary.GetDataAsync();
    
    // âœ… å®‰å…¨åœ°åœ¨ UI åŸ·è¡Œç·’ä¸Šæ›´æ–° UI
    myLabel.Text = data;
}
```

### 7.5 ç¸½çµè¡¨

|å ´æ™¯|æ˜¯å¦ä½¿ç”¨ ConfigureAwait(false)|åŸå› |
|---|---|---|
|UI äº‹ä»¶è™•ç†å¸¸å¼|âŒ å¦|await ä¹‹å¾Œéœ€è¦å­˜å– UI æ§åˆ¶é …|
|WinForms / WPF æ‡‰ç”¨ç¨‹å¼|âŒ å¦ï¼ˆé™¤éç¢ºå®šå¾ŒçºŒä¸å­˜å– UIï¼‰|éœ€è¦å›åˆ° UI åŸ·è¡Œç·’|
|å…±ç”¨ç¨‹å¼åº« (Library)|âœ… æ˜¯|æå‡æ•ˆèƒ½ï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ›|
|ASP.NET Core|âš ï¸ å¯é¸ï¼ˆæ•ˆæœä¸å¤§ï¼‰|ASP.NET Core æ²’æœ‰ SynchronizationContext|
|Console æ‡‰ç”¨ç¨‹å¼|âš ï¸ å¯é¸ï¼ˆæ•ˆæœä¸å¤§ï¼‰|Console æ²’æœ‰ SynchronizationContext|

### 7.6 æœ€ä½³å¯¦è¸

```csharp
// åœ¨å…±ç”¨ç¨‹å¼åº«ä¸­
public static class MyLibrary
{
    public static async Task<string> GetDataAsync()
    {
        // âœ… ä½¿ç”¨ ConfigureAwait(false)
        await SomeIoOperationAsync().ConfigureAwait(false);
        await AnotherOperationAsync().ConfigureAwait(false);
        return "çµæœ";
    }
}

// åœ¨ UI æ‡‰ç”¨ç¨‹å¼ä¸­
private async void myButton_Click(object sender, EventArgs e)
{
    // âŒ ä¸ä½¿ç”¨ ConfigureAwait(false)
    var data = await MyLibrary.GetDataAsync();
    
    // âœ… å®‰å…¨åœ°æ›´æ–° UI
    myLabel.Text = data;
}
```

---

## é™„éŒ„ï¼šå¿«é€ŸæŸ¥è©¢è¡¨

### A. å¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±ºæ–¹æ¡ˆ

|éŒ¯èª¤å¯«æ³•|å•é¡Œ|æ­£ç¢ºå¯«æ³•|
|---|---|---|
|`task.Result` åœ¨ UI åŸ·è¡Œç·’|æœƒæ­»çµæˆ–å‡çµ UI|`await task`|
|`task.Wait()` åœ¨ UI åŸ·è¡Œç·’|æœƒæ­»çµæˆ–å‡çµ UI|`await task`|
|`await task.ConfigureAwait(false)` ç„¶å¾Œå­˜å– UI|è·¨åŸ·è¡Œç·’éŒ¯èª¤|`await task`|
|å›å‚³ `void` çš„ async æ–¹æ³•|ç„¡æ³•è¿½è¹¤éŒ¯èª¤|å›å‚³ `Task`ï¼ˆé™¤éæ˜¯äº‹ä»¶è™•ç†å¸¸å¼ï¼‰|

### B. éåŒæ­¥æ–¹æ³•å‘½åæ…£ä¾‹

```csharp
// âœ… æ­£ç¢ºï¼šéåŒæ­¥æ–¹æ³•ä»¥ Async çµå°¾
public async Task<string> GetDataAsync()

// âŒ éŒ¯èª¤ï¼šéåŒæ­¥æ–¹æ³•æ²’æœ‰ Async å¾Œç¶´
public async Task<string> GetData()
```

### C. Task çš„ç‹€æ…‹

|ç‹€æ…‹|èªªæ˜|å¦‚ä½•é”æˆ|
|---|---|---|
|`RanToCompletion`|æˆåŠŸå®Œæˆ|`tcs.SetResult(value)`|
|`Faulted`|ç™¼ç”Ÿä¾‹å¤–|`tcs.SetException(ex)`|
|`Canceled`|è¢«å–æ¶ˆ|`tcs.SetCanceled()`|
|`WaitingForActivation`|å°šæœªé–‹å§‹|å‰›å»ºç«‹çš„ `TaskCompletionSource`|

---

## å­¸ç¿’é‡é»ç¸½çµ

1. **çµ•å°ä¸è¦åœ¨ UI åŸ·è¡Œç·’ä¸Šä½¿ç”¨ `.Result` æˆ– `.Wait()`**
    
    - æœƒé€ æˆæ­»çµæˆ–å‡çµ UI
    - æ°¸é ä½¿ç”¨ `async`/`await`
2. **`await` æœƒè‡ªå‹•æ•æ‰ä¸¦é‚„åŸä¸Šä¸‹æ–‡**
    
    - åœ¨ UI åŸ·è¡Œç·’å‘¼å«ï¼Œ`await` ä¹‹å¾Œæœƒè‡ªå‹•å›åˆ° UI åŸ·è¡Œç·’
    - ä¸éœ€è¦æ‰‹å‹•ä½¿ç”¨ `Invoke` æˆ– `BeginInvoke`
3. **`ThreadPool.QueueUserWorkItem` ä¸æœƒç­‰å¾…å·¥ä½œå®Œæˆ**
    
    - å®ƒåªæ˜¯ã€Œæ’ç¨‹ã€å·¥ä½œ
    - `return tcs.Task` æœƒç«‹å³åŸ·è¡Œ
4. **`TaskCompletionSource` æ˜¯åŸ·è¡Œç·’å®‰å…¨çš„**
    
    - å¯ä»¥åœ¨ä»»ä½•åŸ·è¡Œç·’ä¸Šå‘¼å« `SetResult`
    - æ­»çµçš„åŸå› ä¸æ˜¯ `SetResult` å¿…é ˆåœ¨ UI åŸ·è¡Œç·’åŸ·è¡Œ
5. **`ConfigureAwait(false)` åªåœ¨å…±ç”¨ç¨‹å¼åº«ä¸­ä½¿ç”¨**
    
    - UI æ‡‰ç”¨ç¨‹å¼çš„äº‹ä»¶è™•ç†å¸¸å¼ä¸è¦ä½¿ç”¨
    - ASP.NET Core ä¸­æ•ˆæœä¸å¤§

é€™ä»½ç­†è¨˜å®Œæ•´ä¿ç•™äº†æ‚¨èˆ‡åŒäº‹è¨è«–çš„æ‰€æœ‰é‡è¦å…§å®¹ï¼ŒåŒ…æ‹¬æ¯ä¸€å€‹èªªæ˜ã€è¨»è§£ã€è¡¨æ ¼å’Œç¯„ä¾‹ã€‚å¸Œæœ›é€™ä»½ç³»çµ±æ€§çš„æ•´ç†èƒ½å¹«åŠ©æ‚¨æ›´æ·±å…¥ç†è§£ C# çš„éåŒæ­¥ç¨‹å¼è¨­è¨ˆï¼