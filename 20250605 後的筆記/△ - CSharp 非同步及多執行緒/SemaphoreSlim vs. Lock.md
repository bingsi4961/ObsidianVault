---
date: 2025-08-29 15:27
aliases:
tags:
  - CSharp
  - async/await
---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[]]

---
# C# åŒæ­¥æ©Ÿåˆ¶ç­†è¨˜: SemaphoreSlim vs. Lock

é€™ä»½ç­†è¨˜æ•´ç†äº† C# ä¸­å…©å€‹æ ¸å¿ƒçš„åŒæ­¥å·¥å…·ï¼š`SemaphoreSlim` å’Œ `lock`ï¼Œæ¶µè“‹äº†å®ƒå€‘çš„æ¦‚å¿µã€ç”¨æ³•ã€å€åˆ¥èˆ‡æœ€ä½³å¯¦è¸ã€‚

## 1. `SemaphoreSlim` (å’–å•¡å»³åº§ä½ â˜•)

`SemaphoreSlim` æ˜¯ä¸€å€‹éåŒæ­¥çš„åŒæ­¥å·¥å…·ï¼Œä¸»è¦ç”¨ä¾†**é™åˆ¶èƒ½åŒæ™‚å­˜å–ç‰¹å®šè³‡æºçš„ä»»å‹™æ•¸é‡**ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

- **æ¯”å–»**ï¼šåƒä¸€é–“æœ‰ N å€‹åº§ä½çš„å’–å•¡å»³ã€‚ä»»å‹™ï¼ˆé¡§å®¢ï¼‰å¿…é ˆå…ˆå–å¾—ä¸€å€‹åº§ä½ (`WaitAsync`) æ‰èƒ½é€²å…¥ï¼Œé›¢é–‹æ™‚æ­¸é‚„åº§ä½ (`Release`)ã€‚å¦‚æœå®¢æ»¿ï¼Œå¾Œä¾†çš„ä»»å‹™å°±å¿…é ˆæ’éšŠç­‰å¾…ã€‚
    
- **ç”¨é€”**ï¼šå¸¸ç”¨æ–¼é™åˆ¶ I/O å¯†é›†å‹æ“ä½œçš„ä½µç™¼æ•¸é‡ï¼Œå¦‚ API å‘¼å«ã€æª”æ¡ˆä¸‹è¼‰ã€è³‡æ–™åº«é€£ç·šç­‰ï¼Œé˜²æ­¢ç³»çµ±è³‡æºè¶…è¼‰ã€‚
    

### åŸºæœ¬ç”¨æ³•ç¯„ä¾‹

æœ€å®‰å…¨ã€æ¨™æº–çš„å¯«æ³•æ˜¯æ­é… `try...finally` å€å¡Šï¼Œç¢ºä¿è³‡æºä¸€å®šæœƒè¢«é‡‹æ”¾ã€‚

```csharp
// å»ºç«‹ä¸€å€‹æœ€å¤šåªå…è¨± 3 å€‹ä»»å‹™åŒæ™‚é€²å…¥çš„è™ŸèªŒ
private static SemaphoreSlim semaphore = new SemaphoreSlim(3);

public async Task AccessResourceAsync()
{
    // ç­‰å¾…ã€Œç¶ ç‡ˆã€ï¼ˆè¦æ±‚ä¸€å€‹ä½ç½®ï¼‰ï¼Œå¦‚æœå®¢æ»¿æœƒåœ¨æ­¤éåŒæ­¥ç­‰å¾…
    await semaphore.WaitAsync();
    try
    {
        // --- é€™è£¡çš„ç¨‹å¼ç¢¼å€å¡Š ---
        // --- åŒä¸€æ™‚é–“æœ€å¤šåªæœƒæœ‰ 3 å€‹ä»»å‹™èƒ½åŸ·è¡Œåˆ°é€™è£¡ ---
        Console.WriteLine($"ä»»å‹™ {Task.CurrentId} é€²å…¥äº†æ§åˆ¶å€ã€‚");
        await Task.Delay(1000); // æ¨¡æ“¬å·¥ä½œ
    }
    finally
    {
        // é‡‹æ”¾ã€Œç¶ ç‡ˆã€ï¼ˆæ­¸é‚„ä½ç½®ï¼‰ï¼Œè®“ä¸‹ä¸€å€‹ä»»å‹™å¯ä»¥é€²ä¾†
        // é€™æ˜¯è‡³é—œé‡è¦çš„ä¸€æ­¥ï¼Œå¯é˜²æ­¢è³‡æºæ´©æ¼å°è‡´çš„æ­»é–
        semaphore.Release();
        Console.WriteLine($"ä»»å‹™ {Task.CurrentId} é›¢é–‹äº†ã€‚");
    }
}
```

> **é‡é»**: `Release()` å¿…é ˆæ”¾åœ¨ `finally` å€å¡Šï¼Œç¢ºä¿ç„¡è«– `try` å€å¡Šæ˜¯å¦ç™¼ç”Ÿä¾‹å¤–ï¼Œé–éƒ½æœƒè¢«é‡‹æ”¾ã€‚

### `Wait()` vs. `WaitAsync()`

- `Wait()`: **åŒæ­¥**ç­‰å¾…ï¼Œæœƒ**é˜»å¡**ç•¶å‰åŸ·è¡Œç·’ï¼Œç›´åˆ°å–å¾—é–ã€‚
    
- `WaitAsync()`: **éåŒæ­¥**ç­‰å¾…ï¼Œ**ä¸æœƒé˜»å¡**åŸ·è¡Œç·’ã€‚åŸ·è¡Œç·’æœƒè¢«é‡‹æ”¾å›åŸ·è¡Œç·’æ± è™•ç†å…¶ä»–å·¥ä½œï¼Œæ˜¯ç¾ä»£éåŒæ­¥ç¨‹å¼çš„é¦–é¸ã€‚
    

### ç›£æ§å¯ç”¨åé¡ `CurrentCount`

`SemaphoreSlim` æä¾›ä¸€å€‹éå¸¸æœ‰ç”¨çš„å±¬æ€§ï¼š`CurrentCount`ã€‚

- **åŠŸèƒ½**ï¼šå®ƒæœƒå›å‚³**ç›®å‰é‚„å‰©ä¸‹å¤šå°‘å€‹å¯ç”¨çš„åé¡**ã€‚
    
- **ç”¨é€”**ï¼šä¸»è¦ç”¨æ–¼ç›£æ§å’Œé™¤éŒ¯ï¼Œå¯ä»¥å³æ™‚äº†è§£è™ŸèªŒçš„è² è¼‰ç‹€æ³ã€‚å®ƒçš„å€¼æœƒåœ¨ `WaitAsync` æˆåŠŸå¾Œæ¸› 1ï¼Œåœ¨ `Release` å¾ŒåŠ  1ã€‚
    

### å¯¦ç”¨ç¯„ä¾‹ï¼šé™åˆ¶ä½µç™¼ä¸‹è¼‰æ•¸é‡ (å« `CurrentCount`)

```csharp
// é™åˆ¶æœ€å¤šåªèƒ½åŒæ™‚åŸ·è¡Œ 5 å€‹ä¸‹è¼‰ä»»å‹™
private static SemaphoreSlim downloaderSemaphore = new SemaphoreSlim(5);

// æ¨¡æ“¬ä¸‹è¼‰å–®ä¸€æª”æ¡ˆçš„æ–¹æ³•
public async Task DownloadFileAsync(int fileId)
{
    Console.WriteLine($"[æª”æ¡ˆ {fileId,3}] - æ’éšŠç­‰å¾…ä¸‹è¼‰... (ç›®å‰å¯ç”¨åé¡: {downloaderSemaphore.CurrentCount})");
    await downloaderSemaphore.WaitAsync();
    try
    {
        // æˆåŠŸé€²å…¥å¾Œï¼Œå¯ä»¥é€é (åˆå§‹æ•¸é‡ - CurrentCount) ä¾†è§€å¯Ÿç›®å‰çš„ä½µç™¼æ•¸
        Console.WriteLine($"âœ… [æª”æ¡ˆ {fileId,3}] - é–‹å§‹ä¸‹è¼‰... (ç›®å‰ä½µç™¼æ•¸: {5 - downloaderSemaphore.CurrentCount})");
        await Task.Delay(2000); // æ¨¡æ“¬ä¸‹è¼‰æ™‚é–“
        Console.WriteLine($"âœ”ï¸ [æª”æ¡ˆ {fileId,3}] - ä¸‹è¼‰å®Œæˆï¼");
    }
    finally
    {
        downloaderSemaphore.Release();
    }
}

// ä¸»ç¨‹å¼ï¼šä¸€æ¬¡å•Ÿå‹• 100 å€‹ä»»å‹™ï¼Œä½† SemaphoreSlim æœƒç¢ºä¿ä½µç™¼æ•¸ä¸è¶…é 5
public async Task DownloadAllFilesAsync()
{
    var allTasks = new List<Task>();
    for (int i = 1; i <= 100; i++)
    {
        allTasks.Add(DownloadFileAsync(i));
    }
    await Task.WhenAll(allTasks);
}
```

## 2. `lock` (å»æ‰€é‘°åŒ™ ğŸ”‘)

`lock` æ˜¯ C# çš„ä¸€å€‹é—œéµå­—ï¼Œç”¨æ–¼ç¢ºä¿ä¸€æ®µç¨‹å¼ç¢¼å€å¡Šåœ¨åŒä¸€æ™‚é–“**åªæœƒè¢«ä¸€å€‹åŸ·è¡Œç·’åŸ·è¡Œ**ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

- **æ¯”å–»**ï¼šåƒä¸€æŠŠå»æ‰€çš„é‘°åŒ™ã€‚ä¸€æ¬¡åªèƒ½æœ‰ä¸€å€‹äººï¼ˆåŸ·è¡Œç·’ï¼‰æ‹¿åˆ°é‘°åŒ™é€²å»ã€‚å…¶ä»–äººå¿…é ˆåœ¨é–€å£æ’éšŠï¼ˆåŒæ­¥é˜»å¡ï¼‰ã€‚
    
- **ç”¨é€”**ï¼šä¿è­·å…±äº«çš„**è¨˜æ†¶é«”ä¸­ç‰©ä»¶**ï¼Œé˜²æ­¢å› å¤šåŸ·è¡Œç·’åŒæ™‚å¯«å…¥è€Œå°è‡´çš„è³‡æ–™éŒ¯äº‚ã€‚ä¾‹å¦‚ä¿è­· `List`ã€`Dictionary` æˆ–å…¶ä»–å…±äº«è®Šæ•¸ã€‚
    

### åŸºæœ¬ç”¨æ³•ç¯„ä¾‹

`lock` é—œéµå­—çš„èªæ³•éå¸¸ç°¡æ½”ï¼Œå®ƒæœƒè‡ªå‹•è™•ç† `try...finally` å’Œé–çš„é‡‹æ”¾ã€‚

```csharp
// æœ€ä½³å¯¦è¸ï¼šå»ºç«‹ä¸€å€‹ç§æœ‰çš„ã€å”¯è®€çš„ç‰©ä»¶ç•¶ä½œã€Œé‘°åŒ™ã€
private readonly object _lockObject = new object();
private int _sharedCounter = 0;

public void IncrementCounter()
{
    // é–ä¸Šé€™å€‹ã€Œé‘°åŒ™ã€
    lock (_lockObject)
    {
        // åœ¨é€™å€‹å€å¡Šå…§ï¼Œç¨‹å¼ç¢¼æ˜¯åŸ·è¡Œç·’å®‰å…¨çš„
        _sharedCounter++;
    } // é›¢é–‹å€å¡Šæ™‚ï¼Œé–æœƒè‡ªå‹•é‡‹æ”¾
}
```

### `lock` çš„æœ€ä½³å¯¦è¸ï¼šé¿å…æ­»é–

> **é»ƒé‡‘æ³•å‰‡**: æ°¸é é–å®šä¸€å€‹ `private readonly object`ï¼Œé€™å€‹ç‰©ä»¶çš„å”¯ä¸€ç”¨é€”å°±æ˜¯ç•¶ä½œé–ã€‚

- **ä¸è¦ `lock (this)` æˆ– `lock (å…¬é–‹çš„ç‰©ä»¶)`**ï¼šå› ç‚ºå¤–éƒ¨ç¨‹å¼ç¢¼ä¹Ÿå¯èƒ½é–å®šåŒä¸€å€‹å…¬é–‹çš„ç‰©ä»¶ï¼Œå¦‚æœä½ å€‘é–å®šè³‡æºçš„é †åºä¸åŒï¼Œå°±æ¥µæœ‰å¯èƒ½å°è‡´**æ­»é– (Deadlock)**ã€‚
    
- **æ­»é– (Deadlock)**ï¼šæŒ‡å…©å€‹æˆ–å¤šå€‹åŸ·è¡Œç·’äº’ç›¸æŒæœ‰å°æ–¹éœ€è¦çš„è³‡æºï¼Œä¸¦ç­‰å¾…å°æ–¹é‡‹æ”¾ï¼Œå°è‡´æ‰€æœ‰åŸ·è¡Œç·’éƒ½ç„¡é™æœŸåœ°å¡ä½ã€‚
    

#### æ­»é–ç¨‹å¼ç¢¼ç¯„ä¾‹

ä»¥ä¸‹ç¯„ä¾‹å±•ç¤ºäº†å…©å€‹åŸ·è¡Œç·’å¦‚ä½•å› ç‚ºé–å®šé †åºç›¸åï¼Œè€Œå°è‡´äº’ç›¸ç­‰å¾…ï¼Œå½¢æˆæ­»é–ã€‚

```csharp
private static readonly object lockA = new object();
private static readonly object lockB = new object();

public static void Thread1_Work()
{
    lock (lockA) // åŸ·è¡Œç·’ 1: å…ˆæ‹¿ A
    {
        Thread.Sleep(100);
        lock (lockB) // å†æ‹¿ B
        {
            // ...
        }
    }
}

public static void Thread2_Work()
{
    lock (lockB) // åŸ·è¡Œç·’ 2: å…ˆæ‹¿ B
    {
        Thread.Sleep(100);
        lock (lockA) // å†æ‹¿ A
        {
            // ...
        }
    }
}
// åŒæ™‚åŸ·è¡Œ Thread1_Work å’Œ Thread2_Work å°‡å°è‡´æ­»é–ã€‚
```

## 3. `SemaphoreSlim` vs. `Lock` ç¸½çµ

|   |   |   |
|---|---|---|
|**ç‰¹æ€§**|**lock (Monitor)**|**SemaphoreSlim**|
|**å…è¨±æ•¸é‡**|**æ°¸é åªæœ‰ 1 å€‹**åŸ·è¡Œç·’|**å¯ä»¥è‡ªè¨‚ N å€‹** (N â‰¥ 1) ä»»å‹™|
|**ç­‰å¾…æ–¹å¼**|**åŒæ­¥é˜»å¡** (åŸ·è¡Œç·’æœƒå¡ä½)|**æ”¯æ´éåŒæ­¥ç­‰å¾…** (`WaitAsync`)|
|**`async/await`**|**ä¸æ”¯æ´** (åœ¨ `lock` å…§ `await` æœƒå ±éŒ¯)|**å®Œç¾æ”¯æ´** (å®ƒçš„ä¸»è¦ä½¿ç”¨æƒ…å¢ƒ)|
|**å¸¸è¦‹ç”¨é€”**|ä¿è­·**è¨˜æ†¶é«”**ä¸­çš„ç‰©ä»¶ (List, Dictionary)|é™åˆ¶å°**å¤–éƒ¨è³‡æº**çš„å­˜å– (API, DB)|

### ç¶“é©—æ³•å‰‡

- å¦‚æœä½ çš„ç¨‹å¼ç¢¼å€å¡Šæ˜¯**åŒæ­¥**çš„ (æ²’æœ‰ `await`)ï¼Œè«‹å„ªå…ˆä½¿ç”¨ `lock`ã€‚
    
- å¦‚æœä½ çš„ç¨‹å¼ç¢¼å€å¡Šæ˜¯**éåŒæ­¥**çš„ (`async/await`)ï¼Œè«‹ä½¿ç”¨ `SemaphoreSlim`ã€‚