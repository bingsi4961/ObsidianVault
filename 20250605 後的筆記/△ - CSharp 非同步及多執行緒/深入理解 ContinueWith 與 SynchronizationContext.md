---
date: 2025-10-27 00:05
aliases:
tags:
---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[]]

---
#### ç¯„ä¾‹ç¨‹å¼ç¢¼

```csharp
// 1. ä¸èƒ½ç”¨ async Taskï¼Œæ”¹å› void
private void myButton_Click(object sender, EventArgs e)
{
    // 2. æ‰‹å‹•æ•ç²ç•¶å‰çš„ UI ä¸Šä¸‹æ–‡ (SynchronizationContext)
    var uiContext = SynchronizationContext.Current;
    
    // 3. å‘¼å«å‡½å¼åº«æ–¹æ³•ï¼Œé€™æœƒå‚³å›ä¸€å€‹ Task ç‰©ä»¶
    Task<string> dataTask = MyAwesomeLibrary.GetDataAsync();
    
    // 4. ã€Œawaitã€çš„çœŸæ­£æ›¿ä»£å“ï¼š.ContinueWith
    //    æ„æ€æ˜¯ã€Œç•¶ dataTask å®Œæˆå¾Œï¼Œè«‹åŸ·è¡Œä»¥ä¸‹...ã€
    dataTask.ContinueWith(task => 
    {
        // --- é€™æ®µç¨‹å¼ç¢¼å¯èƒ½åœ¨ã€Œä»»ä½•åŸ·è¡Œç·’ã€ä¸ŠåŸ·è¡Œ ---
        
        // 5. å¾å®Œæˆçš„ Task ä¸­å–å¾—çµæœ
        string result = task.Result; 
        
        // 6. é—œéµæ­¥é©Ÿï¼š
        //    æˆ‘å€‘ä¸èƒ½åœ¨é€™è£¡ç›´æ¥æ›´æ–° myLabel.Text (æœƒå´©æ½°ï¼)
        //    å¿…é ˆä½¿ç”¨ä¸€é–‹å§‹æ•ç²çš„ uiContext
        //    æŠŠæ›´æ–°ä»»å‹™ã€ŒPostã€å› UI åŸ·è¡Œç·’
        
        // âœ… æ¨™æº–å¯«æ³•ï¼šé€é state åƒæ•¸å‚³éè³‡æ–™
        uiContext.Post(state => 
        {
            // --- é€™æ®µç¨‹å¼ç¢¼ç¾åœ¨ä¿è­‰åœ¨ UI åŸ·è¡Œç·’ä¸Šå®‰å…¨åŸ·è¡Œ ---
            // 'state' åƒæ•¸å°±æ˜¯æˆ‘å€‘å‚³å…¥çš„ 'result'
            // (éœ€è¦åšä¸€æ¬¡å‹åˆ¥è½‰æ›)
            string data = (string)state;
            myLabel.Text = data;
            
        }, result); // <-- æŠŠ result ç•¶ä½œ state åƒæ•¸å‚³é
    });
}

public static class MyAwesomeLibrary
{
    public static Task<string> GetDataAsync()
    {
        // 1. å»ºç«‹ä¸€å€‹ 1000ms å¾Œæœƒå®Œæˆçš„ Task
        var delayTask = Task.Delay(1000);
        
        // 2. ä¸²æ¥ä¸€å€‹ Continuation (æ¥çºŒå·¥ä½œ) 
        // ä½¿ç”¨ ContinueWith<TResult> æ–¹æ³• (å‚³å› Task<string>) 
        // 
        // ContinueWith çš„é‹ä½œåŸç†ï¼š 
        // - ğŸš¨ ç«‹åˆ»å»ºç«‹ä¸¦å‚³å›ç¬¬äºŒå€‹ Task ç‰©ä»¶ (resultTask)
        // - ğŸš¨ resultTask çš„å·¥ä½œå…§å®¹å°±æ˜¯é€™å€‹ lambda è¡¨é”å¼ 
        // - åœ¨ delayTask ä¸Šè¨»å†Šä¸€å€‹ã€Œå›å‘¼å‡½å¼ã€(Callback) 
        // - ç•¶ delayTask å®Œæˆæ™‚ï¼Œè‡ªå‹•åŸ·è¡Œé€™å€‹ lambda 
        // - lambda åŸ·è¡Œçµæœæœƒå­˜åœ¨ resultTask.Result è£¡ 
        // - TaskContinuationOptions.OnlyOnRanToCompletion ç¢ºä¿åªæœ‰åœ¨å‰ä¸€å€‹ä»»å‹™ "æˆåŠŸ" å®Œæˆæ™‚æ‰åŸ·è¡Œ
        //
        // ç°¡å–®ä¾†èªªï¼šç•¶ delayTask æˆåŠŸå®Œæˆå¾Œï¼Œæœƒå»ºç«‹ç¬¬äºŒå€‹ Task ç‰©ä»¶ï¼Œ 
        // å…¶å·¥ä½œå…§å®¹å°±æ˜¯é€™å€‹ Lambda è¡¨é”å¼
        Task<string> resultTask = delayTask.ContinueWith(task => 
        {
            // 3. ç•¶ delayTask å®Œæˆå¾Œï¼Œé€™å€‹ lambda æœƒè¢«åŸ·è¡Œ
            //    (é è¨­æœƒåœ¨ Thread Pool ä¸ŠåŸ·è¡Œ)
            //    æˆ‘å€‘åœ¨é€™è£¡å›å‚³å­—ä¸²
            return "é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™";

        }, TaskContinuationOptions.OnlyOnRanToCompletion);

        // 4. ç«‹åˆ»å‚³å›é€™å€‹ã€Œæœªä¾†æœƒåŒ…å«çµæœã€çš„ resultTask
        return resultTask;
    }
}
```

---
#### æ ¸å¿ƒå•é¡Œ

> ç‚ºä»€éº¼åœ¨ `myButton_Click` (UI åŸ·è¡Œç·’) ä¸­å‘¼å« `GetDataAsync()`ï¼Œä½† `dataTask.ContinueWith(...)` è£¡çš„ç¨‹å¼ç¢¼å»æ˜¯åœ¨ **ThreadPool (èƒŒæ™¯åŸ·è¡Œç·’)** ä¸ŠåŸ·è¡Œï¼Œè€Œä¸æ˜¯åœ¨ UI åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œï¼Ÿ

---
#### é—œéµè§£ç­”ï¼š`ContinueWith` çš„åŸ·è¡Œç·’æ­¸å±¬

`ContinueWith` å…§çš„ lambda ç¨‹å¼ç¢¼**é è¨­æœƒåœ¨å“ªæ¢åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œ**ï¼Œä¸¦**ä¸æ˜¯**ç”±ã€Œ`ContinueWith` æ˜¯åœ¨å“ªæ¢åŸ·è¡Œç·’ä¸Šè¢«_è¨»å†Š_çš„ã€ä¾†æ±ºå®šã€‚

è€Œæ˜¯ç”±ã€Œ**<mark style="background: #FFF3A3A6;">å®ƒæ‰€ç­‰å¾…çš„å‰ä¸€å€‹ Task (antecedent task) æ˜¯åœ¨å“ªç¨®åŸ·è¡Œç·’ä¸Š_å®Œæˆ_(Completed)çš„</mark>**ã€ä¾†æ±ºå®šã€‚

`Task` ç‰©ä»¶æœ¬èº«ä¸¦ä¸ã€Œæ”œå¸¶ã€æˆ–ã€Œç¶å®šã€åˆ°ä»»ä½•åŸ·è¡Œç·’ã€‚å®ƒåªæ˜¯ä¸€å€‹ã€Œæœªä¾†å·¥ä½œã€çš„æ†‘è­‰ã€‚

---
#### ç¨‹å¼ç¢¼åŸ·è¡Œç·’é€æ­¥åˆ†æ

##### éšæ®µä¸€ï¼š`myButton_Click` (UI åŸ·è¡Œç·’)

1. **`private void myButton_Click(...)`**
    
    - **åŸ·è¡Œç·’:** **UI åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼Œç”± UI è¨Šæ¯è¿´åœˆè§¸ç™¼ã€‚
        
2. **`var uiContext = SynchronizationContext.Current;`**
    
    - **åŸ·è¡Œç·’:** **UI åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** æ•ç²ç•¶å‰çš„ `WindowsFormsSynchronizationContext`ï¼Œé€™æ˜¯æ‰‹å‹•åˆ‡æ›å› UI åŸ·è¡Œç·’çš„é—œéµã€‚
        
3. **`Task<string> dataTask = MyAwesomeLibrary.GetDataAsync();`**
    
    - **åŸ·è¡Œç·’:** **UI åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** UI åŸ·è¡Œç·’**åŒæ­¥å‘¼å«** `GetDataAsync`ã€‚ç¨‹å¼æµç¨‹é€²å…¥è©²æ–¹æ³•ã€‚        

##### éšæ®µäºŒï¼šé€²å…¥ `GetDataAsync()` (UI åŸ·è¡Œç·’ - åŒæ­¥éƒ¨åˆ†)

4. **`var delayTask = Task.Delay(1000);`**
    
    - **åŸ·è¡Œç·’:** **UI åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** `Task.Delay` **ä¸æœƒ**é˜»å¡åŸ·è¡Œç·’ã€‚å®ƒåªæ˜¯å‘ .NET çš„è¨ˆæ™‚å™¨è¨»å†Šä¸€å€‹ 1 ç§’å¾Œçš„å›å‘¼ï¼Œä¸¦ç«‹å³å‚³å›ä¸€å€‹ã€Œå°šæœªå®Œæˆã€çš„ `Task` (`delayTask`)ã€‚
        
5. **`Task<string> resultTask = delayTask.ContinueWith(...)`**
    
    - **åŸ·è¡Œç·’:** **UI åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** é€™æ˜¯**è¨»å†Š**å‹•ä½œã€‚UI åŸ·è¡Œç·’å‘Šè¨´ .NETï¼šã€Œç­‰ `delayTask` å®Œæˆå¾Œï¼Œè«‹åŸ·è¡Œé€™å€‹ lambdaã€ã€‚lambda å…§éƒ¨çš„ç¨‹å¼ç¢¼**æ­¤æ™‚å®Œå…¨ä¸æœƒåŸ·è¡Œ**ã€‚        
    - æˆ‘å€‘ç¨±é€™å€‹ `ContinueWith` ç‚º **Continuation A**ã€‚        
    - `resultTask` å°±æ˜¯ `Continuation A` é€™å€‹ Task ç‰©ä»¶ã€‚
        
6. **`return resultTask;`**
    
    - **åŸ·è¡Œç·’:** **UI åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** `GetDataAsync` åŒæ­¥åœ°å‚³å›äº†é€™å€‹ã€Œå°šæœªå®Œæˆã€çš„ `resultTask`ã€‚ç¨‹å¼æµç¨‹å›åˆ° `myButton_Click`ã€‚        

##### éšæ®µä¸‰ï¼šå›åˆ° `myButton_Click` (UI åŸ·è¡Œç·’)

7. **`dataTask.ContinueWith(task => ...)`**
    
    - **åŸ·è¡Œç·’:** **UI åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** `dataTask` ç¾åœ¨å°±æ˜¯ `resultTask` (ä¹Ÿå°±æ˜¯ `Continuation A`)ã€‚        
    - UI åŸ·è¡Œç·’å†æ¬¡åŸ·è¡Œä¸€å€‹**è¨»å†Š**å‹•ä½œï¼šã€Œç­‰ `dataTask` å®Œæˆå¾Œï¼Œè«‹åŸ·è¡Œé€™å€‹ lambdaã€ã€‚        
    - æˆ‘å€‘ç¨±é€™å€‹ `ContinueWith` ç‚º **Continuation B**ã€‚
        
8. **`}` (myButton_Click çµæŸ)**
    
    - **åŸ·è¡Œç·’:** **UI åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** `myButton_Click` æ–¹æ³•åŸ·è¡Œå®Œç•¢ã€‚UI åŸ·è¡Œç·’**æ²’æœ‰è¢«é˜»å¡**ï¼Œå®ƒç¾åœ¨ç©ºé–’äº†ï¼Œå¯ä»¥ç¹¼çºŒè™•ç†å…¶ä»– UI äº‹ä»¶ã€‚        

---
## **(... 1 ç§’é˜éå» ...) ---**

##### éšæ®µå››ï¼šéåŒæ­¥å·¥ä½œé–‹å§‹ (èƒŒæ™¯åŸ·è¡Œç·’)

9. **`delayTask` å®Œæˆ**
    
    - **åŸ·è¡Œç·’:** (ä¾†è‡ªè¨ˆæ™‚å™¨ï¼Œç„¡ç‰¹å®šä¸Šä¸‹æ–‡)ã€‚        
    - **èªªæ˜:** 1 ç§’é˜åˆ°ã€‚`delayTask` ç‹€æ…‹è®Šç‚º `Completed`ã€‚
        
10. **.NET åŸ·è¡Œ `Continuation A` (åœ¨ `GetDataAsync` å…§)**
    
    - **åŸ·è¡Œç·’:** **ThreadPool åŸ·è¡Œç·’ (èƒŒæ™¯åŸ·è¡Œç·’)**ã€‚        
    - **èªªæ˜:** `delayTask` å®Œæˆæ™‚æ²’æœ‰ `SynchronizationContext`ï¼Œå› æ­¤ .NET **é è¨­**å¾ ThreadPool æŠ“ä¸€æ¢åŸ·è¡Œç·’ä¾†åŸ·è¡Œ `Continuation A`ã€‚
        
11. **`return "é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™";`**
    
    - **åŸ·è¡Œç·’:** **ThreadPool åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** `Continuation A` åŸ·è¡Œå®Œç•¢ï¼Œä¸¦å‚³å›ä¸€å€‹å­—ä¸²ã€‚        
    - **é—œéµæ™‚åˆ»ï¼š** `resultTask` (ä¹Ÿå°±æ˜¯ `dataTask`) åœ¨**æ­¤åˆ»**ç‹€æ…‹è®Šç‚º `Completed`ã€‚        
    - **é‡é»ï¼š`dataTask` æ˜¯åœ¨ ThreadPool åŸ·è¡Œç·’ä¸Šå®Œæˆçš„ï¼**        

##### éšæ®µäº”ï¼šæ¥åŠ›è³½çš„æœ€å¾Œä¸€æ£’ (æ ¸å¿ƒé—œéµ)

12. **.NET åŸ·è¡Œ `Continuation B` (åœ¨ `myButton_Click` å…§)**
    
    - **åŸ·è¡Œç·’:** **ThreadPool åŸ·è¡Œç·’ (èƒŒæ™¯åŸ·è¡Œç·’)**ã€‚        
    - **èªªæ˜:** .NET åµæ¸¬åˆ° `dataTask` å‰›å‰›å®Œæˆäº†ã€‚å®ƒæœƒæª¢æŸ¥ `dataTask` æ˜¯åœ¨å“ªè£¡å®Œæˆçš„ï¼Ÿç­”æ¡ˆæ˜¯ï¼šã€Œåœ¨ ThreadPool ä¸Šã€ã€‚        
    - å› ç‚º `Continuation B` (æ‚¨çš„ `dataTask.ContinueWith`) æ˜¯ä½¿ç”¨**é è¨­**é¸é …è¨»å†Šçš„ï¼Œå®ƒæœƒ**ç¹¼æ‰¿**å‰ä¸€å€‹ä»»å‹™ (`dataTask`) çš„å®Œæˆä¸Šä¸‹æ–‡ã€‚        
    - å› æ­¤ï¼Œ`Continuation B` ä¹Ÿè¢«å®‰æ’åœ¨ **ThreadPool** ä¸ŠåŸ·è¡Œã€‚**é€™å°±æ˜¯æ‚¨å•é¡Œçš„ç­”æ¡ˆï¼**
        
13. **`string result = task.Result;`**
    
    - **åŸ·è¡Œç·’:** **ThreadPool åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** åœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¸Šå®‰å…¨åœ°å–å¾—çµæœ (å› ç‚º `task` å·²ç¶“å®Œæˆäº†)ã€‚
        
14. **`uiContext.Post(state => ... , result);`**
    
    - **åŸ·è¡Œç·’:** **ThreadPool åŸ·è¡Œç·’**ã€‚
    - **èªªæ˜:** ThreadPool åŸ·è¡Œç·’åŸ·è¡Œ `Post` æ–¹æ³•ã€‚é€™å€‹æ–¹æ³•çš„ä½œç”¨æ˜¯æŠŠ `state => { ... }` é€™å€‹å§”æ´¾ (delegate) å’Œ `result` ç‰©ä»¶ï¼Œä¸€èµ·ã€Œæ’ç¨‹ã€åˆ° `uiContext` (ä¹Ÿå°±æ˜¯ UI åŸ·è¡Œç·’) çš„è¨Šæ¯ä½‡åˆ—ä¸­ã€‚        
    - åŸ·è¡Œå®Œ `Post` å¾Œï¼Œé€™å€‹ ThreadPool åŸ·è¡Œç·’çš„ä»»å‹™å°±çµæŸäº†ã€‚        

##### éšæ®µå…­ï¼šå®‰å…¨æ›´æ–° UI (å›åˆ° UI åŸ·è¡Œç·’)

15. **`state => { ... }` (Post çš„å›å‘¼)**
    
    - **åŸ·è¡Œç·’:** **UI åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** UI åŸ·è¡Œç·’çš„è¨Šæ¯è¿´åœˆç™¼ç¾ä½‡åˆ—ä¸­æœ‰ä¸€å€‹æ–°ä»»å‹™ï¼Œä¾¿å–å‡ºä¸¦åŸ·è¡Œå®ƒã€‚
        
16. **`myLabel.Text = data;`**
    
    - **åŸ·è¡Œç·’:** **UI åŸ·è¡Œç·’**ã€‚        
    - **èªªæ˜:** ç¨‹å¼ç¢¼ç¾åœ¨å®‰å…¨åœ°å›åˆ°äº† UI åŸ·è¡Œç·’ï¼Œå¯ä»¥åˆæ³•åœ°å­˜å– UI æ§åˆ¶é …ã€‚        

---

#### çµè«–èˆ‡é‡è¦è§€å¿µ

1. **ã€Œè¨»å†Šã€ä¸ç­‰æ–¼ã€ŒåŸ·è¡Œã€ï¼š** æ‚¨åœ¨ UI åŸ·è¡Œç·’ä¸Šå‘¼å« `ContinueWith`ï¼Œåªæ˜¯ã€Œè¨»å†Šã€äº†é€™å€‹æ¥çºŒå·¥ä½œï¼Œä¸¦ä¸ä»£è¡¨å®ƒæœƒåœ¨ UI åŸ·è¡Œç·’ä¸Šã€ŒåŸ·è¡Œã€ã€‚
    
2. **`ContinueWith` çš„é è¨­è¡Œç‚ºï¼š** é è¨­æƒ…æ³ä¸‹ï¼Œ`ContinueWith` æœƒåœ¨**å‰ä¸€å€‹ Task å®Œæˆæ™‚**çš„åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œã€‚å¦‚æœå‰ä¸€å€‹ Task åœ¨ ThreadPool ä¸Šå®Œæˆï¼Œ`ContinueWith` ä¹Ÿæœƒåœ¨ ThreadPool ä¸ŠåŸ·è¡Œã€‚
    
3. **Task éˆçš„ã€Œä¸Šä¸‹æ–‡å‚³éã€ï¼š** åœ¨æ‚¨çš„ç¯„ä¾‹ä¸­ï¼Œ`GetDataAsync` å…§éƒ¨å› ç‚º `Task.Delay` çš„é—œä¿‚ï¼Œå·²ç¶“å°‡åŸ·è¡Œç·’åˆ‡æ›åˆ°äº† ThreadPoolã€‚å®ƒå‚³å›çš„ `Task` (`dataTask`) æœ€çµ‚ä¹Ÿæ˜¯åœ¨ ThreadPool ä¸Šå®Œæˆçš„ã€‚å› æ­¤ï¼Œ`myButton_Click` ä¸­çš„ `ContinueWith` è‡ªç„¶ä¹Ÿå°±åœ¨ ThreadPool ä¸ŠåŸ·è¡Œäº†ã€‚
    
4. **`async/await` çš„é­”æ³•ï¼š** `await` é—œéµå­—ä¹‹æ‰€ä»¥å¼·å¤§ï¼Œå°±æ˜¯å®ƒåœ¨ç·¨è­¯æ™‚æœƒè‡ªå‹•å¹«æˆ‘å€‘è™•ç†é€™ä¸€åˆ‡ã€‚
    
    - `await` æœƒè‡ªå‹•æ•ç²ç•¶å‰çš„ `SynchronizationContext` (ç­‰åŒæ–¼æ‚¨çš„ `var uiContext = ...`)ã€‚        
    - å®ƒæœƒè‡ªå‹•ç”¢ç”Ÿä¸€å€‹ `ContinueWith`ï¼Œä¸¦ä¸”é€™å€‹ `ContinueWith` æœƒè‡ªå‹•ä½¿ç”¨æ•ç²åˆ°çš„ `uiContext` ä¾† `Post` å¾ŒçºŒçš„ç¨‹å¼ç¢¼ (ç­‰åŒæ–¼æ‚¨çš„ `uiContext.Post(...)`)ã€‚        

æ‚¨æ‰‹å‹•ç·¨å¯«çš„ `ContinueWith` + `uiContext.Post` ç¨‹å¼ç¢¼ï¼Œæ­£æ˜¯ `await` é—œéµå­—åœ¨èƒŒå¾Œç‚ºæˆ‘å€‘æ‰€åšçš„ã€ŒåŸå‹ã€ï¼Œæ‚¨çš„åˆ†æèˆ‡å¯¦ä½œæ˜¯å®Œå…¨æ­£ç¢ºçš„ã€‚