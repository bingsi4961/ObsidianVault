---
date: 2025-07-08 18:29
aliases: 
tags:
  - jQuery
  - AJAX
  - async/await
---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[$.ajax() deferred (Promise-like)  vs  Javascript Promise (å­¸å¾—å¾ˆæ··æ·†)]]
#### ğŸ“‘ [[æ­¡è¿]]

---

## å•é¡Œèµ·æº

å¾é€™å€‹å•é¡Œé–‹å§‹ï¼š

- `$.ajax` æˆåŠŸæ™‚æ˜¯å‚³ä»€éº¼å‡ºä¾†ï¼Œ`await` åˆæ˜¯å–ä»€éº¼ï¼Ÿ
- `$.ajax` å¤±æ•—æ™‚æ˜¯å‚³ä»€éº¼å‡ºä¾†ï¼Œç³»çµ±æ˜¯å¦‚ä½•çŸ¥é“æ‡‰è©²è¦è§¸ç™¼ `catch` äº†ï¼Ÿ

## æ ¸å¿ƒæ¦‚å¿µ

### 1. jQuery Deferred ç‰©ä»¶çš„ç‰¹æ€§

- `$.ajax()` å›å‚³çš„æ˜¯ **jQuery Deferred ç‰©ä»¶**ï¼Œä¸æ˜¯æ¨™æº– Promise
- Deferred ç‰©ä»¶åŒæ™‚å¯¦ä½œäº†ï¼š
    - **jQuery ä»‹é¢**ï¼š`.done()`, `.fail()`, `.always()`
    - **Promise ä»‹é¢**ï¼š`.then()`, `.catch()` (thenable)
- **æ²’æœ‰ã€Œè½‰å‹ã€éç¨‹**ï¼Œå¾ä¸€é–‹å§‹å°±æ”¯æ´å…©ç¨®ä»‹é¢

### 2. æˆåŠŸæ™‚çš„æµç¨‹

```javascript
// jQuery å…§éƒ¨æ©Ÿåˆ¶
deferred.resolve(data, textStatus, jqXHR)
    â†“ 
// ç•¶ä½¿ç”¨ Promise ä»‹é¢æ™‚ï¼ˆå¦‚ awaitï¼‰
Promise.resolve(data)  // åªä¿ç•™ç¬¬ä¸€å€‹åƒæ•¸
    â†“
// await çš„çµæœ
await å–å¾— dataï¼ˆAPI å›å‚³çš„è³‡æ–™ï¼‰
```

**é‡é»ï¼š** `await $.ajax()` å–å¾—çš„æ˜¯ **API å›å‚³çš„è³‡æ–™æœ¬èº«**

### 3. å¤±æ•—æ™‚çš„æµç¨‹

```javascript
// jQuery å…§éƒ¨æ©Ÿåˆ¶
deferred.reject(jqXHR, textStatus, errorThrown)
    â†“
// ç•¶ä½¿ç”¨ Promise ä»‹é¢æ™‚ï¼ˆå¦‚ awaitï¼‰
Promise.reject(jqXHR)  // åªä¿ç•™ç¬¬ä¸€å€‹åƒæ•¸
    â†“
// catch çš„çµæœ
catch æ¥æ”¶åˆ° jqXHR ç‰©ä»¶
```

**é‡é»ï¼š** `catch` æ¥æ”¶åˆ°çš„æ˜¯ **jqXHR ç‰©ä»¶**ï¼Œä¸æ˜¯ Error ç‰©ä»¶

### 4. ç³»çµ±å¦‚ä½•çŸ¥é“è§¸ç™¼ catchï¼Ÿ

jQuery æ ¹æ“šä»¥ä¸‹æ¢ä»¶æ±ºå®šæ˜¯ resolve é‚„æ˜¯ rejectï¼š

- **æˆåŠŸæ¢ä»¶**ï¼šHTTP ç‹€æ…‹ç¢¼ 200-299
- **å¤±æ•—æ¢ä»¶**ï¼š
    - HTTP ç‹€æ…‹ç¢¼ >= 400ï¼ˆå¦‚ 404ã€500ï¼‰
    - ç¶²è·¯éŒ¯èª¤ï¼ˆé€£ç·šé€¾æ™‚ã€ç„¡æ³•é€£æ¥ï¼‰
    - è§£æéŒ¯èª¤ï¼ˆé æœŸ JSON ä½†æ”¶åˆ° HTMLï¼‰

## å¯¦éš›ç¯„ä¾‹å°æ¯”

### åŸå§‹ Promise åŒ…è£æ–¹å¼

```javascript
function ajaxPromise(options) {
    return new Promise((resolve, reject) => {
        $.ajax(options)
            .done((data, textStatus, jqXHR) => {
                resolve(data);    // æ¨™æº– Promise.resolve(data)
            })
            .fail((jqXHR, textStatus, errorThrown) => {
                const error = new Error(`Ajax Error: ${jqXHR.status}`);
                error.jqXHR = jqXHR;
                reject(error);    // æ¨™æº– Promise.reject(Error)
            });
    });
}
```

### ç›´æ¥ä½¿ç”¨ async/await æ–¹å¼

```javascript
async function ajaxPromise(options) {
    try {
	    // await æœƒæŠŠ jQuery Promise è½‰æˆåŸç”Ÿ Promiseï¼Œä¸Ÿå¤±é¡å¤–åƒæ•¸ (textStatus, jqXHR)
        const result = await $.ajax(options);  // å–å¾— data
        return result;
    } catch (jqXHR) {                          // æ¥æ”¶ jqXHR
        const error = new Error(`Ajax Error: ${jqXHR.status}`);
        error.jqXHR = jqXHR;
        throw error;
    }
}
```

**é€™å…©ç¨®æ–¹å¼åŠŸèƒ½å®Œå…¨ç›¸åŒï¼**

## é—œéµå·®ç•°èªªæ˜

### æ¨™æº– Promise è¡Œç‚º

```javascript
// æ¨™æº– Promise
const standardPromise = new Promise((resolve, reject) => {
    resolve(data);           // await å–å¾— data
    reject(new Error());     // catch å–å¾— Error ç‰©ä»¶
});
```

### jQuery ajax è¡Œç‚º

```javascript
// jQuery ajax çš„ç‰¹æ®Šè¡Œç‚º
$.ajax()
    .done(data, textStatus, jqXHR)     // æˆåŠŸï¼šå‚³éä¸‰å€‹åƒæ•¸
    .fail(jqXHR, textStatus, errorThrown)  // å¤±æ•—ï¼šå‚³éä¸‰å€‹åƒæ•¸

// ä½†è½‰æ›æˆ Promise ä»‹é¢æ™‚
await $.ajax()  // åªå–å¾—ç¬¬ä¸€å€‹åƒæ•¸ data
catch(jqXHR)    // åªå–å¾—ç¬¬ä¸€å€‹åƒæ•¸ jqXHR
```

## ç‚ºä»€éº¼å¯ä»¥åŒæ™‚ä½¿ç”¨å…©ç¨®èªæ³•ï¼Ÿ

```javascript
// åŒä¸€å€‹ Deferred ç‰©ä»¶å¯ä»¥åŒæ™‚ä½¿ç”¨ï¼š
const ajaxRequest = $.ajax({ url: '/api/data' });

// jQuery ä»‹é¢
ajaxRequest.done(data => console.log('done:', data));
ajaxRequest.fail(jqXHR => console.log('fail:', jqXHR));

// Promise ä»‹é¢
ajaxRequest.then(data => console.log('then:', data));
ajaxRequest.catch(jqXHR => console.log('catch:', jqXHR));

// éˆå¼å‘¼å«
$.ajax({ url: '/api/data' })
    .done(data => console.log('done'))
    .fail(jqXHR => console.log('fail'))
    .then(data => console.log('then'))
    .catch(jqXHR => console.log('catch'));
```

## await å¯ä»¥ä½¿ç”¨çš„åŸå› 

JavaScript çš„ `await` æœƒæª¢æŸ¥ç‰©ä»¶æ˜¯å¦ç‚º **thenable**ï¼ˆæœ‰ `.then()` æ–¹æ³•ï¼‰ï¼š

```javascript
// ç•¶ä½ å¯« await $.ajax() æ™‚
const ajaxRequest = $.ajax({ url: '/api/data' });
if (typeof ajaxRequest.then === 'function') {
    // å¯ä»¥ awaitï¼Œå› ç‚ºæœ‰ .then() æ–¹æ³•
    const result = await ajaxRequest;
}
```

## ç¸½çµ

1. **jQuery Deferred åŒæ™‚å¯¦ä½œå…©ç¨®ä»‹é¢**ï¼Œæ²’æœ‰è½‰å‹éç¨‹
2. **æˆåŠŸæ™‚**ï¼š`await` å–å¾— API å›å‚³çš„è³‡æ–™
3. **å¤±æ•—æ™‚**ï¼š`catch` æ¥æ”¶åˆ° jqXHR ç‰©ä»¶
4. **è§¸ç™¼ catch**ï¼šæ ¹æ“š HTTP ç‹€æ…‹ç¢¼å’Œç¶²è·¯ç‹€æ³æ±ºå®š
5. **ç¾ä»£ç”¨æ³•**ï¼šå¯ä»¥ç›´æ¥ç”¨ `await $.ajax()` å–ä»£æ‰‹å‹• Promise åŒ…è£


## è£œå……

**å¾ jQuery 1.5 é–‹å§‹åˆ°ç¾åœ¨çš„æ‰€æœ‰ç‰ˆæœ¬ï¼ˆ1.xã€2.xã€3.xï¼‰ï¼Œ$.ajax() éƒ½å›å‚³åŒä¸€ç¨®ç‰©ä»¶ï¼šjqXHR**

### ç‰ˆæœ¬çµ±ä¸€æ€§

- **jQuery 1.4.x ä»¥å‰**ï¼šå›å‚³åŸç”Ÿ XMLHttpRequest ç‰©ä»¶
- **jQuery 1.5+ è‡³ç¾åœ¨**ï¼šçµ±ä¸€å›å‚³ jqXHR ç‰©ä»¶
- **ä½ å€‘çš„ç³»çµ±**ï¼š
    - GTS (jQuery 1.10.2)ï¼šå›å‚³ jqXHR ç‰©ä»¶ âœ…
    - Portal (jQuery 3.3.1)ï¼šå›å‚³ jqXHR ç‰©ä»¶ âœ…

### å¯ç”¨æ–¹æ³•ï¼ˆæ‰€æœ‰ç‰ˆæœ¬ä¸€è‡´ï¼‰

#### æˆåŠŸæ™‚çš„å›èª¿

```javascript
$.ajax(url)
  .done(function(data, textStatus, jqXHR) {
    // æˆåŠŸè™•ç†
  })
  .then(function(data, textStatus, jqXHR) {
    // æˆåŠŸè™•ç†ï¼ˆPromise é¢¨æ ¼ï¼‰
  });
```

#### å¤±æ•—æ™‚çš„å›èª¿

```javascript
$.ajax(url)
  .fail(function(jqXHR, textStatus, errorThrown) {
    // å¤±æ•—è™•ç†
  })
  .catch(function(jqXHR, textStatus, errorThrown) {
    // å¤±æ•—è™•ç†ï¼ˆåƒ… jQuery 3.0+ æ”¯æ´ï¼‰
  });
```

#### å®Œæˆæ™‚çš„å›èª¿

```javascript
$.ajax(url)
  .always(function(dataOrJqXHR, textStatus, jqXHROrErrorThrown) {
    // æˆåŠŸæ™‚ï¼š(data, textStatus, jqXHR)
    // å¤±æ•—æ™‚ï¼š(jqXHR, textStatus, errorThrown)
  });
```

**æ³¨æ„ï¼šjQuery æ²’æœ‰ `.finally()` æ–¹æ³•ï¼Œåªæœ‰ `.always()` æ–¹æ³•**

### ç‰ˆæœ¬é–“çš„çœŸæ­£å·®ç•°

#### jQuery 1.x/2.x (åŒ…å«ä½ å€‘çš„ 1.10.2)

- jqXHR ç‰©ä»¶æœ‰ Promise ä»‹é¢ï¼Œä½†**é Promise/A+ ç›¸å®¹**
- åŒ…å«å·²æ£„ç”¨æ–¹æ³•ï¼š`.success()`, `.error()`, `.complete()`
- `.then()` æ–¹æ³•è¡Œç‚ºèˆ‡æ¨™æº– Promise ç•¥æœ‰ä¸åŒ

#### jQuery 3.x (åŒ…å«ä½ å€‘çš„ 3.3.1)

- ç›¸åŒçš„ jqXHR ç‰©ä»¶ï¼Œä½†**å®Œå…¨ Promise/A+ ç›¸å®¹**
- ç§»é™¤å·²æ£„ç”¨æ–¹æ³•ï¼š`.success()`, `.error()`, `.complete()`
- æ–°å¢ `.catch()` æ–¹æ³•
- `.then()` æ–¹æ³•å®Œå…¨ç¬¦åˆ Promise/A+ è¦ç¯„

### await è¡Œç‚º

#### çµ±ä¸€è¡Œç‚ºï¼ˆæ‰€æœ‰ç‰ˆæœ¬ï¼‰

```javascript
// æˆåŠŸæ™‚
const data = await $.ajax(url); // åªç²å¾— data åƒæ•¸

// å¤±æ•—æ™‚
try {
  const data = await $.ajax(url);
} catch (jqXHR) {
  // ç²å¾— jqXHR ç‰©ä»¶
  console.log(jqXHR.status, jqXHR.statusText);
}
```

#### é‡è¦æ³¨æ„äº‹é …

- `await` åªæœƒå›å‚³ç¬¬ä¸€å€‹åƒæ•¸
- æˆåŠŸæ™‚ï¼šç²å¾— `data`
- å¤±æ•—æ™‚ï¼šç²å¾— `jqXHR` ç‰©ä»¶
- å…¶ä»–åƒæ•¸ï¼ˆtextStatus, errorThrownï¼‰ç„¡æ³•é€é await å–å¾—

### å¯¦éš›ä½¿ç”¨å»ºè­°

#### å°æ–¼ä½ å€‘çš„ç³»çµ±

**GTS (jQuery 1.10.2) å»ºè­°ä½¿ç”¨ï¼š**

```javascript
$.ajax(url)
  .done(function(data, textStatus, jqXHR) { /* æˆåŠŸ */ })
  .fail(function(jqXHR, textStatus, errorThrown) { /* å¤±æ•— */ })
  .always(function() { /* å®Œæˆ */ });
```

**Portal (jQuery 3.3.1) å»ºè­°ä½¿ç”¨ï¼š**

```javascript
$.ajax(url)
  .then(function(data, textStatus, jqXHR) { /* æˆåŠŸ */ })
  .catch(function(jqXHR, textStatus, errorThrown) { /* å¤±æ•— */ })
  .always(function() { /* å®Œæˆ */ });

// æˆ–ä½¿ç”¨ async/await
async function fetchData() {
  try {
    const data = await $.ajax(url);
    return data;
  } catch (jqXHR) {
    console.error('è«‹æ±‚å¤±æ•—:', jqXHR.status);
  }
}
```

### æœ€å¾Œ

- **ç‰©ä»¶é¡å‹**ï¼šå…©å€‹ç‰ˆæœ¬éƒ½æ˜¯ jqXHR ç‰©ä»¶
- **ä¸»è¦å·®ç•°**ï¼šPromise/A+ ç›¸å®¹æ€§ï¼Œè€Œéç‰©ä»¶é¡å‹
- **æ–¹æ³•å·®ç•°**ï¼šjQuery 3.x æ–°å¢ `.catch()` ä¸¦ç§»é™¤å·²æ£„ç”¨æ–¹æ³•
- **å¯¦éš›å½±éŸ¿**ï¼šå°æ–¼ä¸€èˆ¬ä½¿ç”¨ï¼Œå…©å€‹ç‰ˆæœ¬è¡Œç‚ºåŸºæœ¬ç›¸åŒ