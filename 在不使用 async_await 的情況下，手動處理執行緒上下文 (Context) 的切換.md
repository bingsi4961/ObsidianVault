---
date: 2025-10-26 22:29
aliases:
tags:
---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[]]

---

```csharp
// 1. ä¸èƒ½ç”¨ async Taskï¼Œæ”¹å› void
private void myButton_Click(object sender, EventArgs e)
{
    // 2. æ‰‹å‹•æ•ç²ç•¶å‰çš„ UI ä¸Šä¸‹æ–‡ (SynchronizationContext)
    var uiContext = SynchronizationContext.Current;
    
    // 3. å‘¼å«å‡½å¼åº«æ–¹æ³•ï¼Œé€™æœƒå‚³å›ä¸€å€‹ Task ç‰©ä»¶
    Task<string> dataTask = MyAwesomeLibrary.GetDataAsync();
    
    // 4. ã€Œawaitã€çš„çœŸæ­£æ›¿ä»£å“ï¼š.ContinueWith
    //    æ„æ€æ˜¯ã€Œç•¶ dataTask å®Œæˆå¾Œï¼Œè«‹åŸ·è¡Œä»¥ä¸‹...ã€
    dataTask.ContinueWith(task => 
    {
        // --- é€™æ®µç¨‹å¼ç¢¼å¯èƒ½åœ¨ã€Œä»»ä½•åŸ·è¡Œç·’ã€ä¸ŠåŸ·è¡Œ ---
        
        // 5. å¾å®Œæˆçš„ Task ä¸­å–å¾—çµæœ
        string result = task.Result; 
        
        // 6. é—œéµæ­¥é©Ÿï¼š
        //    æˆ‘å€‘ä¸èƒ½åœ¨é€™è£¡ç›´æ¥æ›´æ–° myLabel.Text (æœƒå´©æ½°ï¼)
        //    å¿…é ˆä½¿ç”¨ä¸€é–‹å§‹æ•ç²çš„ uiContext
        //    æŠŠæ›´æ–°ä»»å‹™ã€ŒPostã€å› UI åŸ·è¡Œç·’
        
        // âœ… æ¨™æº–å¯«æ³•ï¼šé€é state åƒæ•¸å‚³éè³‡æ–™
        uiContext.Post(state => 
        {
            // --- é€™æ®µç¨‹å¼ç¢¼ç¾åœ¨ä¿è­‰åœ¨ UI åŸ·è¡Œç·’ä¸Šå®‰å…¨åŸ·è¡Œ ---
            // 'state' åƒæ•¸å°±æ˜¯æˆ‘å€‘å‚³å…¥çš„ 'result'
            // (éœ€è¦åšä¸€æ¬¡å‹åˆ¥è½‰æ›)
            string data = (string)state;
            myLabel.Text = data;
            
        }, result); // <-- æŠŠ result ç•¶ä½œ state åƒæ•¸å‚³é
        
        // âš ï¸ ä¹Ÿå¯ä»¥ä¾è³´é–‰åŒ… (Closure)ï¼Œä½†ä¸å»ºè­°
        // uiContext.Post(_ => 
        // {
        //     myLabel.Text = result; // æ•ç²å¤–å±¤è®Šæ•¸
        // }, null);
        
    });
}

public static class MyAwesomeLibrary
{
    // 1. æ–¹æ³•ä¸å†æ˜¯ async
    //    å®ƒåªæ˜¯ä¸€å€‹ã€Œå‚³å› Task çš„ä¸€èˆ¬æ–¹æ³•ã€
    public static Task<string> GetDataAsync()
    {
        // 2. Task.Run æœƒç«‹åˆ»æŠŠå·¥ä½œæ’å…¥ ThreadPool
        //    ä¸¦ã€Œç«‹åˆ»ã€å‚³å›ä¸€å€‹ Task ç‰©ä»¶
        return Task.Run(() => 
        {
            // --- é€™æ•´æ®µç¨‹å¼ç¢¼éƒ½åœ¨èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool) ä¸ŠåŸ·è¡Œ ---
            
            // 3. ä»¥å‰æ²’æœ‰ Task.Delayï¼Œæˆ‘å€‘æœƒç”¨ Thread.Sleep 
            //    (åœ¨èƒŒæ™¯åŸ·è¡Œç·’ Sleepï¼Œä¸æœƒå¡ä½ UI)
            Thread.Sleep(1000); 
            
            // 4. ç•¶ return æ™‚ï¼ŒTask.Run æœƒè‡ªå‹•æŠŠé€™å€‹ "Task<string>"
            //    æ¨™è¨˜ç‚ºã€Œå·²å®Œæˆã€ï¼Œä¸¦æŠŠçµæœåŒ…é€²å»
            return "é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™";
        });
    }
}
```

é€™å€‹ç¯„ä¾‹ï¼Œç”¨ä¾†èªªæ˜åœ¨æ²’æœ‰ `async/await` çš„æƒ…æ³ä¸‹ï¼Œå¦‚ä½•æ‰‹å‹•è™•ç†åŸ·è¡Œç·’ä¸Šä¸‹æ–‡ (Context) çš„åˆ‡æ›ã€‚

é€™æ®µç¨‹å¼ç¢¼ä¸»è¦æ¶‰åŠå…©ç¨®åŸ·è¡Œç·’ï¼š
1. **UI åŸ·è¡Œç·’ (UI Thread)**ï¼šå”¯ä¸€çš„ï¼Œè² è²¬è™•ç†æ‰€æœ‰ä½¿ç”¨è€…ä»‹é¢æ“ä½œï¼ˆé»æ“Šã€ç¹ªè£½ã€æ›´æ–°æ–‡å­—ï¼‰çš„åŸ·è¡Œç·’ã€‚    
2. **èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool Thread)**ï¼šç”± .NET åŸ·è¡Œéšæ®µç®¡ç†çš„ä¸€çµ„åŸ·è¡Œç·’ï¼Œç”¨æ–¼åŸ·è¡Œè€—æ™‚çš„èƒŒæ™¯å·¥ä½œï¼Œä»¥å…å¡ä½ UIã€‚    

---
### `myButton_Click` æ–¹æ³• (äº‹ä»¶è™•ç†å¸¸å¼)

```csharp
private void myButton_Click(object sender, EventArgs e)
{
```

- **åŸ·è¡Œç·’ï¼š** `UI åŸ·è¡Œç·’`    
- **èªªæ˜ï¼š** æ‰€æœ‰çš„ UI äº‹ä»¶ï¼ˆä¾‹å¦‚æŒ‰éˆ•é»æ“Šï¼‰å¿…å®šæ˜¯å¾ UI åŸ·è¡Œç·’é–‹å§‹åŸ·è¡Œçš„ã€‚
    
```csharp
    var uiContext = SynchronizationContext.Current;
```

- **åŸ·è¡Œç·’ï¼š** `UI åŸ·è¡Œç·’`    
- **èªªæ˜ï¼š** æ‰¿ä¸Šï¼Œç¨‹å¼ä»åœ¨ UI åŸ·è¡Œç·’ä¸Šï¼Œæ­¤è¡Œç¨‹å¼ç¢¼æœƒã€Œæ•ç²ã€ç•¶å‰çš„ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå°±æ˜¯ UI åŸ·è¡Œç·’çš„ä¸Šä¸‹æ–‡ã€‚
    
```csharp
    Task<string> dataTask = MyAwesomeLibrary.GetDataAsync();
```

- **åŸ·è¡Œç·’ï¼š** `UI åŸ·è¡Œç·’`    
- **èªªæ˜ï¼š**    
    1. ç¨‹å¼åœ¨ UI åŸ·è¡Œç·’ä¸Šå‘¼å« `GetDataAsync()`ã€‚        
    2. `GetDataAsync()` å…§éƒ¨çš„ `Task.Run` æœƒã€Œç«‹å³ã€å°‡å·¥ä½œä¸Ÿå…¥èƒŒæ™¯åŸ·è¡Œç·’æ±  (Thread Pool)ã€‚        
    3. `GetDataAsync()` ã€Œç«‹å³ã€å‚³å›ä¸€å€‹ `Task<string>` ç‰©ä»¶ï¼ˆä¸€å€‹ã€Œæ‰¿è«¾ã€ï¼‰ï¼Œ<mark style="background: #FFF3A3A6;">æ­¤æ™‚å®ƒé‚„åœ¨ UI åŸ·è¡Œç·’ä¸Š</mark>ã€‚        
    4. UI åŸ·è¡Œç·’ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œï¼Œå®Œå…¨æ²’æœ‰è¢« `Task.Run` å…§éƒ¨çš„å·¥ä½œï¼ˆ`Thread.Sleep`ï¼‰å¡ä½ã€‚        

```csharp
    dataTask.ContinueWith(task => 
    {
```

- **åŸ·è¡Œç·’ï¼š** `UI åŸ·è¡Œç·’`    
- **èªªæ˜ï¼š** é€™ä¸€è¡Œç¨‹å¼ç¢¼çš„ã€Œè¨»å†Šã€å‹•ä½œæœ¬èº«æ˜¯åœ¨ UI åŸ·è¡Œç·’ä¸Šå®Œæˆçš„ã€‚å®ƒå‘Šè¨´ Task Schedulerï¼šã€Œå˜¿ï¼Œç­‰ `dataTask` å®Œæˆå¾Œï¼Œè«‹å¹«æˆ‘åŸ·è¡Œé€™å€‹ Lambda è£¡é¢çš„ç¨‹å¼ç¢¼ã€‚ã€    
- **é‡é»ï¼š** `ContinueWith` å…§éƒ¨çš„ç¨‹å¼ç¢¼ `task => { ... }` **å°šæœªåŸ·è¡Œ**ã€‚UI åŸ·è¡Œç·’è¨»å†Šå®Œç•¢å¾Œï¼Œ`myButton_Click` æ–¹æ³•å°±åŸ·è¡Œå®Œç•¢äº†ï¼ŒUI åŸ·è¡Œç·’æ¢å¾©è‡ªç”±ï¼Œå¯ä»¥ç¹¼çºŒè™•ç†å…¶ä»– UI äº‹ä»¶ã€‚    

---
### `MyAwesomeLibrary.GetDataAsync` æ–¹æ³• (å‡½å¼åº«)

åœ¨ `myButton_Click` å‘¼å«å®ƒæ™‚ï¼š

```csharp
public static Task<string> GetDataAsync()
{
    return Task.Run(() => 
    {
```

- **åŸ·è¡Œç·’ (å‘¼å«æ™‚)ï¼š** `UI åŸ·è¡Œç·’`    
- **èªªæ˜ï¼š** å¦‚å‰æ‰€è¿°ï¼Œ`Task.Run` æœ¬èº«æ˜¯åœ¨ UI åŸ·è¡Œç·’ä¸Šè¢«å‘¼å«çš„ã€‚å®ƒæœƒã€Œç«‹å³ã€å‚³å›ä¸€å€‹ `Task` ç‰©ä»¶çµ¦ `myButton_Click`ã€‚    
- **åŸ·è¡Œç·’ (Lambda å…§éƒ¨)ï¼š** `èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool åŸ·è¡Œç·’)`    
- **èªªæ˜ï¼š** `Task.Run` çš„å®šç¾©å°±æ˜¯å°‡ `() => { ... }` è£¡é¢çš„æ‰€æœ‰ç¨‹å¼ç¢¼ï¼Œéƒ½ä¸Ÿåˆ° Thread Pool ä¸­å»åŸ·è¡Œã€‚    

```csharp
        Thread.Sleep(1000); 
```

- **åŸ·è¡Œç·’ï¼š** `èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool åŸ·è¡Œç·’)`    
- **èªªæ˜ï¼š** æŸä¸€å€‹èƒŒæ™¯åŸ·è¡Œç·’è¢«ã€Œé˜»å¡ã€äº† 1 ç§’é˜ã€‚å› ç‚ºé€™ä¸æ˜¯ UI åŸ·è¡Œç·’ï¼Œæ‰€ä»¥ä½¿ç”¨è€…çš„ä»‹é¢ä¾ç„¶æ˜¯æµæš¢çš„ã€‚    

```csharp
        return "é€™æ˜¯å¾ä¼ºæœå™¨æ‹¿åˆ°çš„è³‡æ–™";
    });
}
```

- **åŸ·è¡Œç·’ï¼š** `èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool åŸ·è¡Œç·’)`    
- **èªªæ˜ï¼š**    
    1. èƒŒæ™¯åŸ·è¡Œç·’åŸ·è¡Œå®Œ `Sleep`ã€‚        
    2. èƒŒæ™¯åŸ·è¡Œç·’æº–å‚™å¥½è¦å›å‚³çš„å­—ä¸²ã€‚        
    3. ç•¶ `return` åŸ·è¡Œæ™‚ï¼Œé€™å€‹èƒŒæ™¯åŸ·è¡Œç·’æœƒé€šçŸ¥ `Task` ç‰©ä»¶ï¼šã€Œæˆ‘å®Œæˆäº†ï¼Œçµæœæ˜¯é€™å€‹å­—ä¸²ã€ã€‚        
    4. `Task` ç‰©ä»¶çš„ç‹€æ…‹è®Šç‚ºã€Œå·²å®Œæˆã€(Completed)ã€‚        
    5. é€™å€‹ã€Œå®Œæˆã€äº‹ä»¶æœƒè§¸ç™¼å…ˆå‰åœ¨ `myButton_Click` ä¸­è¨»å†Šçš„ `ContinueWith`ã€‚        

---
### `dataTask.ContinueWith` çš„å›å‘¼ (Callback)

åœ¨ `GetDataAsync` å®Œæˆå¾Œï¼Œ`ContinueWith` å…§çš„ç¨‹å¼ç¢¼æœƒè¢«è§¸ç™¼ï¼š

```csharp
    dataTask.ContinueWith(task => 
    {
        // --- é€™æ®µç¨‹å¼ç¢¼å¯èƒ½åœ¨ã€Œä»»ä½•åŸ·è¡Œç·’ã€ä¸ŠåŸ·è¡Œ ---
```

- **åŸ·è¡Œç·’ï¼š** <mark style="background: #FFF3A3A6;">èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool åŸ·è¡Œç·’)</mark>    
- **èªªæ˜ï¼š**    
    - ç”±æ–¼ `dataTask` (ä¾†è‡ª `Task.Run`) æ˜¯åœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¸Šå®Œæˆçš„ï¼Œé è¨­çš„ `ContinueWith` æœƒç›´æ¥ä½¿ç”¨åŒä¸€å€‹èƒŒæ™¯åŸ·è¡Œç·’ï¼ˆæˆ–å¦ä¸€å€‹å¯ç”¨çš„èƒŒæ™¯åŸ·è¡Œç·’ï¼‰ä¾†æ¥çºŒåŸ·è¡Œï¼Œé€™æ¨£æœ€æœ‰æ•ˆç‡ã€‚        
    - é€™å°±æ˜¯æ‚¨è¨»è§£ã€Œå¯èƒ½åœ¨ä»»ä½•åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œã€çš„æ„æ€â€”â€”å®ƒ**å¹¾ä¹å¯ä»¥è‚¯å®šä¸åœ¨ UI åŸ·è¡Œç·’ä¸Š**ã€‚        

```csharp
        string result = task.Result; 
```

- **åŸ·è¡Œç·’ï¼š** `èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool åŸ·è¡Œç·’)`    
- **èªªæ˜ï¼š** æ‰¿ä¸Šï¼Œç¨‹å¼ä»åœ¨èƒŒæ™¯åŸ·è¡Œç·’ã€‚`task.Result` æ˜¯å®‰å…¨çš„ï¼Œå› ç‚º `ContinueWith` ä¿è­‰ `task` å·²ç¶“å®Œæˆäº†ï¼Œæ‰€ä»¥è®€å– `.Result` ä¸æœƒé€ æˆé–æ­»ã€‚    

```csharp
        uiContext.Post(state => 
        {
```

- **åŸ·è¡Œç·’ï¼š** `èƒŒæ™¯åŸ·è¡Œç·’ (Thread Pool åŸ·è¡Œç·’)`    
- **èªªæ˜ï¼š** ç¨‹å¼åœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¸Šï¼Œå‘¼å«äº† `uiContext.Post` æ–¹æ³•ã€‚    
- **é‡é»ï¼š** `Post` æ–¹æ³•æœ¬èº«æ˜¯ä¸€å€‹ã€ŒéåŒæ­¥ã€æ“ä½œã€‚å®ƒæœƒæŠŠ `state => { ... }` é€™å€‹å§”æ´¾ï¼ˆdelegateï¼‰æ‰“åŒ…æˆä¸€å€‹è¨Šæ¯ï¼Œç„¶å¾Œã€Œç™¼ä½ˆã€åˆ° `uiContext`ï¼ˆä¹Ÿå°±æ˜¯ UI åŸ·è¡Œç·’ï¼‰çš„è¨Šæ¯ä½‡åˆ— (Message Queue) ä¸­ï¼Œç„¶å¾Œ**ç«‹å³è¿”å›**ï¼Œè®“èƒŒæ™¯åŸ·è¡Œç·’ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œ (é›–ç„¶é€™å€‹ç¯„ä¾‹ä¸­ `ContinueWith` å·²ç¶“æ²’äº‹åšäº†)ã€‚    

```csharp
        }, result);
    });
} // myButton_Click çµæŸ
```

---
### `uiContext.Post` çš„å›å‘¼ (Callback)

UI åŸ·è¡Œç·’åœ¨è™•ç†å®Œå®ƒæ‰‹é‚Šçš„å·¥ä½œï¼ˆä¾‹å¦‚ç¹ªè£½ã€å…¶ä»–äº‹ä»¶ï¼‰å¾Œï¼Œæœƒå¾å®ƒçš„è¨Šæ¯ä½‡åˆ—ä¸­å–å‡ºç”± `Post` ç™¼é€çš„é‚£å€‹è¨Šæ¯ï¼š

```csharp
        uiContext.Post(state => 
        {
            // --- é€™æ®µç¨‹å¼ç¢¼ç¾åœ¨ä¿è­‰åœ¨ UI åŸ·è¡Œç·’ä¸Šå®‰å…¨åŸ·è¡Œ ---
            string data = (string)state;
            myLabel.Text = data;
        }, result); 
```

- **åŸ·è¡Œç·’ï¼š** `UI åŸ·è¡Œç·’`    
- **èªªæ˜ï¼š** `Post` å…§éƒ¨çš„æ‰€æœ‰ç¨‹å¼ç¢¼ `state => { ... }`ï¼Œç¾åœ¨ä¿è­‰å›åˆ°äº† UI åŸ·è¡Œç·’ä¸ŠåŸ·è¡Œã€‚    
- `string data = (string)state;`ï¼šåœ¨ `UI åŸ·è¡Œç·’` ä¸ŠåŸ·è¡Œå‹åˆ¥è½‰æ›ã€‚    
- `myLabel.Text = data;`ï¼šåœ¨ `UI åŸ·è¡Œç·’` ä¸Šå®‰å…¨åœ°æ›´æ–° UI æ§åˆ¶é …ã€‚    

### ç¸½çµ (åŸ·è¡Œç·’åˆ‡æ›æµç¨‹)

1. **UI åŸ·è¡Œç·’**ï¼šå•Ÿå‹• `myButton_Click` -> æ•ç² `uiContext` -> å‘¼å« `GetDataAsync`ã€‚
    
2. **UI åŸ·è¡Œç·’**ï¼š`GetDataAsync` å‘¼å« `Task.Run` ä¸¦ã€Œç«‹å³ã€å‚³å› `Task`ã€‚
    
3. **èƒŒæ™¯åŸ·è¡Œç·’**ï¼š`Task.Run` å…§éƒ¨çš„ `Thread.Sleep` é–‹å§‹åŸ·è¡Œã€‚
    
4. UI åŸ·è¡Œç·’ï¼š(å¹¾ä¹åœ¨åŒæ™‚) ContinueWith è¨»å†Šå®Œæˆ -> myButton_Click çµæŸ -> UI åŸ·è¡Œç·’ç©ºé–’ã€‚
    
    ... (1 ç§’å¾Œ) ...
    
5. **èƒŒæ™¯åŸ·è¡Œç·’**ï¼š`Thread.Sleep` çµæŸ -> `return "..."` -> `dataTask` æ¨™è¨˜ç‚ºå®Œæˆã€‚
    
6. **èƒŒæ™¯åŸ·è¡Œç·’**ï¼š(å› ç‚º Task å®Œæˆäº†) `ContinueWith` çš„ Lambda è¢«è§¸ç™¼ -> è®€å– `task.Result` -> å‘¼å« `uiContext.Post`ã€‚
    
7. **UI åŸ·è¡Œç·’**ï¼š(åœ¨å®ƒæ–¹ä¾¿çš„æ™‚å€™) å¾è¨Šæ¯ä½‡åˆ—ä¸­å–å‡º `Post` çš„ä»»å‹™ -> åŸ·è¡Œ Lambda -> æ›´æ–° `myLabel.Text`ã€‚