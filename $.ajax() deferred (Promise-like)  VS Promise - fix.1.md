---
date: 2025-07-07 11:44
aliases: 
tags:
  - jQuery
  - AJAX
  - JavaScript
  - Promise

---
# Metadata
Status :: ğŸŒ±
Note Type :: ğŸ“°
Source URL :: {æ–‡ç«  URL}
Author :: {ä½œè€…åç¨±}
Topics :: {ç­†è¨˜è·Ÿä»€éº¼ä¸»é¡Œæœ‰é—œï¼Œç”¨ `[Topic],[Topic]` æ ¼å¼}

---
# é€£çµç­†è¨˜
#### ğŸ“‘ [[HttpResponse]]

---
## å‰è¨€

é€™ä»½ç­†è¨˜è©³ç´°è¨˜éŒ„äº† `$.ajax().done().fail()` èˆ‡ `Promise.then().catch()` çš„å·®ç•°ï¼Œç‰¹åˆ¥æ˜¯åœ¨éŒ¯èª¤è™•ç†æ©Ÿåˆ¶å’Œè³‡æ–™å‚³éæ¨¡å¼ä¸Šçš„é‡è¦å€åˆ¥ã€‚

## ç¬¬ä¸€ç« ï¼šç‰©ä»¶å‹æ…‹èˆ‡åŸºç¤æ¦‚å¿µ

### $.ajax() å›å‚³çš„ç‰©ä»¶å‹æ…‹

ç•¶æˆ‘å€‘åŸ·è¡Œ `$.ajax()` æ™‚ï¼Œå®ƒå›å‚³çš„æ˜¯ **jQuery Deferred ç‰©ä»¶**ã€‚é€™å€‹ç‰©ä»¶æ˜¯ jQuery ç‰¹æœ‰çš„ Promise-like å¯¦ä½œï¼Œé›–ç„¶å®ƒéµå¾ª Promise/A+ æ¨™æº–ï¼Œä½†å®ƒä¸¦éåŸç”Ÿçš„ JavaScript Promiseã€‚Deferred ç‰©ä»¶æä¾›äº†å…©å¥— APIï¼šå‚³çµ±çš„ `.done()`, `.fail()`, `.always()` æ–¹æ³•ï¼Œä»¥åŠç¾ä»£çš„ `.then()`, `.catch()`, `.finally()` æ–¹æ³•ã€‚

ç†è§£é€™å€‹é›™é‡æ€§è³ªå¾ˆé‡è¦ï¼Œå› ç‚ºå‚³çµ±æ–¹æ³•å’Œç¾ä»£æ–¹æ³•åœ¨è³‡æ–™è™•ç†ä¸Šæœ‰æ ¹æœ¬æ€§çš„å·®ç•°ã€‚å‚³çµ±æ–¹æ³•æ¡ç”¨çš„æ˜¯ã€Œè§€å¯Ÿè€…æ¨¡å¼ã€ï¼Œè€Œç¾ä»£æ–¹æ³•æ¡ç”¨çš„æ˜¯ã€Œéˆå¼å‚³éæ¨¡å¼ã€ã€‚

### Promise å›å‚³çš„ç‰©ä»¶å‹æ…‹

åŸç”Ÿ JavaScript Promise æ˜¯ ES6 æ¨™æº–çš„ç•°æ­¥è™•ç†ç‰©ä»¶ï¼Œå®ƒåªæä¾› `.then()`, `.catch()`, `.finally()` ç­‰æ–¹æ³•ã€‚Promise çš„è¨­è¨ˆå“²å­¸æ˜¯ç´”ç²¹çš„éˆå¼å‚³éï¼Œæ¯å€‹ `.then()` éƒ½æœƒå›å‚³ä¸€å€‹æ–°çš„ Promiseï¼Œå½¢æˆæ¸…æ™°çš„è³‡æ–™æµå‘ã€‚

## ç¬¬äºŒç« ï¼šæ–¹æ³•åƒæ•¸èˆ‡è³‡æ–™å‹æ…‹çš„æ·±åº¦åˆ†æ

### jQuery å‚³çµ±æ–¹æ³•çš„è±å¯Œåƒæ•¸çµæ§‹

**done() æ–¹æ³•æ¥æ”¶ä¸‰å€‹åƒæ•¸ï¼š**

```javascript
$.ajax('/api/users')
.done(function(data, textStatus, jqXHR) {
    // data: ä¼ºæœå™¨å›å‚³çš„è³‡æ–™ï¼ŒjQuery å·²è‡ªå‹•æ ¹æ“š dataType è§£æ
    // textStatus: å­—ä¸²ï¼Œé€šå¸¸æ˜¯ "success"ï¼Œè¡¨ç¤ºè«‹æ±‚çš„ç‹€æ…‹
    // jqXHR: jQuery XMLHttpRequest ç‰©ä»¶ï¼ŒåŒ…å«å®Œæ•´çš„è«‹æ±‚è³‡è¨Š
    
    console.log('æ”¶åˆ°çš„è³‡æ–™:', data);
    console.log('è«‹æ±‚ç‹€æ…‹:', textStatus);
    console.log('HTTP ç‹€æ…‹ç¢¼:', jqXHR.status);
});

$.ajax('/api/users')
.done(function(data) {
    // data: ä¼ºæœå™¨å›å‚³çš„è³‡æ–™ï¼ŒjQuery å·²è‡ªå‹•æ ¹æ“š dataType è§£æ    
    console.log('æ”¶åˆ°çš„è³‡æ–™:', data);
});
```

**fail() æ–¹æ³•çš„éŒ¯èª¤è³‡è¨Šåƒæ•¸ï¼š**

```javascript
$.ajax('/api/users')
.fail(function(jqXHR, textStatus, errorThrown) {
    // jqXHR: åŒ…å«è©³ç´°éŒ¯èª¤è³‡è¨Šçš„ XMLHttpRequest ç‰©ä»¶
    // textStatus: éŒ¯èª¤é¡å‹ï¼Œå¦‚ "error", "timeout", "abort", "parsererror"
    // errorThrown: HTTP éŒ¯èª¤è¨Šæ¯ï¼Œå¦‚ "Not Found", "Internal Server Error"
    
    console.log('HTTP ç‹€æ…‹:', jqXHR.status);
    console.log('éŒ¯èª¤é¡å‹:', textStatus);
    console.log('éŒ¯èª¤è¨Šæ¯:', errorThrown);
    console.log('å›æ‡‰å…§å®¹:', jqXHR.responseText);
});

$.ajax('/api/users')
.fail(function(jqXHR) {
    // jqXHR: åŒ…å«è©³ç´°éŒ¯èª¤è³‡è¨Šçš„ XMLHttpRequest ç‰©ä»¶
    console.log('HTTP ç‹€æ…‹:', jqXHR.status);  
});
```

### Promise æ–¹æ³•çš„ç°¡åŒ–åƒæ•¸çµæ§‹

**then() æ–¹æ³•é€šå¸¸åªæ¥æ”¶ä¸€å€‹åƒæ•¸ï¼š**

```javascript
fetch('/api/users')
.then(function(response) {
    // ğŸ”¥ fetch() å›å‚³ Promise<Response>
    // response: Response ç‰©ä»¶ï¼ˆéœ€è¦é€²ä¸€æ­¥è§£æï¼‰
    
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    return response.json();
    // å–å¾—å›æ‡‰å…§å®¹ï¼šå¾ Response ç‰©ä»¶ä¸­è®€å– HTTP å›æ‡‰çš„ body å…§å®¹
    // è§£æ JSONï¼šå°‡å›æ‡‰å…§å®¹ï¼ˆé€šå¸¸æ˜¯ JSON å­—ä¸²ï¼‰è§£ææˆ JavaScript ç‰©ä»¶
    // å›å‚³ Promiseï¼šé€™æ˜¯ä¸€å€‹éåŒæ­¥æ“ä½œï¼Œæ‰€ä»¥å›å‚³ Promise
})
.then(function(data) {
    // data: è§£æå¾Œçš„ JSON è³‡æ–™
    console.log('ç”¨æˆ¶è³‡æ–™:', data);
});
```

**catch() æ–¹æ³•è™•ç†å„ç¨®éŒ¯èª¤ï¼š**

```javascript
Promise.reject(new Error('è‡ªå®šç¾©éŒ¯èª¤'))
.catch(function(error) {
    // error: å¯èƒ½æ˜¯ Error ç‰©ä»¶ã€å­—ä¸²æˆ–ä»»ä½•è¢« reject çš„å€¼
    console.log('éŒ¯èª¤è¨Šæ¯:', error.message || error);
});
```

## ç¬¬ä¸‰ç« ï¼šè³‡æ–™å‚³éæ©Ÿåˆ¶çš„æ ¹æœ¬å·®ç•°

### jQuery å‚³çµ±æ–¹æ³•çš„è§€å¯Ÿè€…æ¨¡å¼ç‰¹æ€§

ğŸ”¥ **é‡è¦ç™¼ç¾ï¼šdone()ã€fail()ã€always() çš„ return å€¼éƒ½å®Œå…¨ç„¡æ•ˆ**

ç¶“éæ·±å…¥æ¸¬è©¦é©—è­‰ï¼Œæˆ‘å€‘ç¢ºèªäº† jQuery å‚³çµ±æ–¹æ³•çš„ä¸€å€‹é‡è¦ç‰¹æ€§ï¼šå®ƒå€‘éƒ½æ¡ç”¨ç´”ç²¹çš„è§€å¯Ÿè€…æ¨¡å¼ï¼Œä»»ä½• return å€¼éƒ½æœƒè¢«å®Œå…¨å¿½ç•¥ã€‚

#### done() æ–¹æ³•çš„è§€å¯Ÿè€…æ¨¡å¼

ğŸ”¥**å¤šå€‹ done() æ–¹æ³•éƒ½æ¥æ”¶ç›¸åŒçš„åŸå§‹è³‡æ–™ï¼Œä¸æœƒå½¢æˆè³‡æ–™å‚³ééˆ**

javascript

```javascript
$.ajax('/api/users')
.done(function(users) {
	// ğŸ”¥users = data from { data, textStatus, jqXHR }
    console.log('ç¬¬ä¸€å€‹ done æ¥æ”¶:', users[0].name); // åŸå§‹è³‡æ–™
    
    // è™•ç†è³‡æ–™ä¸¦å›å‚³
    var processedUsers = users.map(function(user) {
        return {
            id: user.id,
            displayName: user.firstName + ' ' + user.lastName,
            isActive: user.status === 'active'
        };
    });
    
    return processedUsers; // âŒ é€™å€‹å›å‚³å€¼å®Œå…¨ç„¡ç”¨ï¼
})
.done(function(users) {
	// users = data from { data, textStatus, jqXHR }
    console.log('ç¬¬äºŒå€‹ done æ¥æ”¶:', users[0].name); // ä»ç„¶æ˜¯åŸå§‹è³‡æ–™
    // é€™è£¡æ¥æ”¶åˆ°çš„ä¸æ˜¯ä¸Šä¸€å€‹ done() çš„ processedUsers
    // è€Œæ˜¯åŒæ¨£çš„åŸå§‹ AJAX å›æ‡‰è³‡æ–™
});
```

#### fail() æ–¹æ³•çš„åŒæ¨£ç‰¹æ€§

ğŸ”¥**é‡è¦ç™¼ç¾ï¼šfail() çš„ return å€¼å’Œ done() ä¸€æ¨£ï¼Œå®Œå…¨æ²’æœ‰ä»»ä½•ä½œç”¨**

javascript

```javascript
$.ajax('/nonexistent-endpoint') // ç”¢ç”Ÿ 404 éŒ¯èª¤
.fail(function(jqXHR, textStatus, errorThrown) {
    console.log('ç¬¬ä¸€å€‹ fail è™•ç†éŒ¯èª¤:', textStatus); // "error"
    
    // å˜—è©¦æä¾›æ¢å¾©è³‡æ–™
    var recoveryData = {
        recovered: true,
        message: 'å˜—è©¦å¾éŒ¯èª¤ä¸­æ¢å¾©',
        defaultUsers: []
    };
    
    return recoveryData; // âŒ é€™å€‹å›å‚³å€¼å®Œå…¨ç„¡ç”¨ï¼ä¹Ÿä¸æœƒä¸Ÿå‡º $.ajax() å¤–
})
.fail(function(jqXHR, textStatus, errorThrown) {
    console.log('ç¬¬äºŒå€‹ fail æ¥æ”¶:', textStatus); // ä»ç„¶æ˜¯ "error"
    // é€™è£¡ä¸æœƒæ¥æ”¶åˆ°ä¸Šä¸€å€‹ fail() çš„ recoveryData
    // è€Œæ˜¯åŒæ¨£çš„åŸå§‹éŒ¯èª¤è³‡è¨Š
})
.catch(function(error) {
    // åŸå§‹éŒ¯èª¤ï¼Œä¸æ˜¯ fail() çš„å›å‚³å€¼
    // ğŸ”¥error = jqXHR from {jqXHR, textStatus, errorThrown}
    // fail() çš„ return å€¼å° catch() ä¹Ÿæ²’æœ‰ä»»ä½•å½±éŸ¿
    console.log('catch æ¥æ”¶åˆ°:', error);     
})
.then(function(result) {
    
    // æƒ…æ³1ï¼š
    // è‹¥ $.ajax() æˆåŠŸï¼Œresult æœƒæ¥æ”¶åˆ°æˆåŠŸçš„å›å‚³çµæœ data from {data, textStatus, jqXHR}
	
	// æƒ…æ³2ï¼š
	// è‹¥ $.ajax() éŒ¯èª¤ï¼Œthen æ¥æ”¶åˆ° catch çš„éš±å« return Promise.resolve(undefined);
	
    console.log(result); // fail() ç„¡æ³•æ”¹è®Š Promise ç‹€æ…‹
});
```

#### always() æ–¹æ³•çš„ä¸€è‡´æ€§

javascript

```javascript
$.ajax('/api/data')
.always(function() {
    console.log('æ¸…ç†å·¥ä½œå®Œæˆ');
    
    var cleanupResult = {
        cleaned: true,
        timestamp: Date.now()
    };
    
    return cleanupResult; // âŒ é€™å€‹å›å‚³å€¼ä¹Ÿå®Œå…¨ç„¡ç”¨ï¼
})
.then(function(result) {
    // å¦‚æœåŸå§‹è«‹æ±‚æˆåŠŸï¼Œé€™è£¡æ¥æ”¶çš„æ˜¯åŸå§‹ AJAX è³‡æ–™ (result = data from { data, textStatus, jqXHR })
    // ğŸ”¥ å¦‚æœåŸå§‹è«‹æ±‚å¤±æ•—ï¼Œthen() ä¸æœƒåŸ·è¡Œ (æœƒåŸ·è¡Œ failã€catchã€always)
    // ä¸æ˜¯ always() çš„å›å‚³å€¼
    console.log(result)
});
```

### then() æ–¹æ³•çš„éˆå¼å‚³éæ¨¡å¼

**then() æ–¹æ³•å½¢æˆçœŸæ­£çš„è³‡æ–™è™•ç†ç®¡é“**

```javascript
$.ajax('https://jsonplaceholder.typicode.com/users')
.then(function(users) {
    console.log('ç¬¬ä¸€å€‹ then æ¥æ”¶:', users[0].name); // åŸå§‹è³‡æ–™
    
    // æ ¹æ“šå¯¦éš›è³‡æ–™çµæ§‹è™•ç†
    var processedUsers = users.map(function(user) {
        return {
            id: user.id,
            displayName: user.name,              // âœ… ç›´æ¥ä½¿ç”¨ name
            email: user.email,
            isActive: user.id % 2 === 1          // âœ… æ¨¡æ“¬æ´»èºç‹€æ…‹ï¼ˆå¥‡æ•¸IDç‚ºæ´»èºï¼‰
        };
    });
    
    return processedUsers; // é€™å€‹å›å‚³å€¼æœƒå‚³éçµ¦ä¸‹ä¸€å€‹ then()
})
.then(function(processedUsers) {
    console.log('ç¬¬äºŒå€‹ then æ¥æ”¶:', processedUsers[0].displayName); // è™•ç†å¾Œçš„è³‡æ–™
    // é€™è£¡æ¥æ”¶åˆ°çš„æ˜¯ä¸Šä¸€å€‹ then() å›å‚³çš„ processedUsers
    
    // ç¹¼çºŒè™•ç†ï¼Œä¾‹å¦‚éæ¿¾æ´»èºç”¨æˆ¶
    return processedUsers.filter(function(user) {
        return user.isActive;
    });
})
.then(function(activeUsers) {
    console.log('ç¬¬ä¸‰å€‹ then æ¥æ”¶æ´»èºç”¨æˆ¶æ•¸é‡:', activeUsers.length);
    // é€™è£¡æ¥æ”¶åˆ°çš„æ˜¯éæ¿¾å¾Œçš„æ´»èºç”¨æˆ¶é™£åˆ—
});
```

### Promise è‡ªå‹•è§£ææ©Ÿåˆ¶çš„é‡è¦æ€§

then() æ–¹æ³•é‚„æœ‰ä¸€å€‹é‡è¦ç‰¹æ€§ï¼šå®ƒæœƒè‡ªå‹•è§£æ Promise ç‰©ä»¶ã€‚é€™æ„å‘³è‘—å¦‚æœä½ åœ¨ then() ä¸­å›å‚³ä¸€å€‹ Promiseï¼Œä¸‹ä¸€å€‹ then() æœƒç­‰å¾…è©² Promise è§£æå®Œæˆå¾Œå†æ¥æ”¶è§£æçš„å€¼ï¼š

```javascript
$.ajax('https://jsonplaceholder.typicode.com/users')
.then(function(users) {
    // å‡è¨­æˆ‘å€‘éœ€è¦æ ¹æ“šç”¨æˆ¶ ID ç²å–é¡å¤–è³‡è¨Š
    var firstUserId = users[0].id;
    // ç²å–è©²ç”¨æˆ¶çš„æ–‡ç« 
	// posts æ˜¯ jqXHR ç‰©ä»¶
	var posts = $.ajax('https://jsonplaceholder.typicode.com/users/' + firstUserId + '/posts');		
	return posts;	// Promise.resolve(jqXHR);
})
// ç•¶ Promise éˆæ”¶åˆ°ä¸€å€‹ thenable ç‰©ä»¶æ™‚ï¼Œå®ƒæœƒè‡ªå‹•å‘¼å«è©²ç‰©ä»¶çš„ .then() æ–¹æ³•
// jqXHR ä¹Ÿæ˜¯ thenable ç‰©ä»¶ï¼Œåˆåœ¨ .then () ä¸€æ¬¡ï¼Œæ•… userPosts æ˜¯å¯¦éš›è³‡æ–™
.then(function(userPosts) {
    console.log('ç”¨æˆ¶çš„æ–‡ç« :', userPosts);
    console.log('æ–‡ç« æ•¸é‡:', userPosts.length);
});
```

## ç¬¬å››ç« ï¼šéŒ¯èª¤è™•ç†æ©Ÿåˆ¶çš„é—œéµå·®ç•°

### fail() æ–¹æ³•ç„¡æ³•æ”¹è®Š Promise ç‹€æ…‹

**é€™æ˜¯ jQuery Deferred æœ€é‡è¦çš„ç‰¹æ€§ä¹‹ä¸€ï¼šfail() çš„å›å‚³å€¼ä¸æœƒå½±éŸ¿ Promise éˆçš„ç‹€æ…‹**

```javascript
$.ajax('/nonexistent-endpoint') // å‡è¨­é€™æœƒç”¢ç”Ÿ 404 éŒ¯èª¤
.fail(function(jqXHR, textStatus, errorThrown) {
    console.log('fail æ–¹æ³•åŸ·è¡Œï¼Œè™•ç†éŒ¯èª¤');
    console.log('HTTP ç‹€æ…‹:', jqXHR.status); // 404
    console.log('éŒ¯èª¤é¡å‹:', textStatus); // "error"
    
    // å˜—è©¦æä¾›é è¨­è³‡æ–™
    var defaultData = {
        message: 'ä½¿ç”¨é è¨­è³‡æ–™',
        users: [],
        isDefault: true
    };

	// é€™å€‹å›å‚³å€¼ç„¡æ³•æ”¹è®Š Promise çš„ rejected ç‹€æ…‹ï¼
	// ğŸ”¥ ä¸æœƒå‚³çµ¦å¾Œé¢çš„éˆå¼ï¼Œä¹Ÿä¸æœƒå‚³åˆ° $.ajax å¤–é¢ï¼Œå¹¾ä¹æ²’ç”¨
    return defaultData;
})
.then(function(data) {
    console.log('é€™å€‹ then ä¸æœƒåŸ·è¡Œ'); // å› ç‚º ajax ç™¼ç”ŸéŒ¯èª¤ï¼Œåªæœƒèª¿ç”¨ failã€catch
    // è‹¥ ajax æ­£å¸¸ï¼Œå‰‡æœƒåŸ·è¡Œï¼Œ data = data from { data, textStatus, jqXHR }
})
.catch(function(error) {
    // error = jqXHR from { jqXHR, textStatus, errorThrown}
    console.log('catch ä»ç„¶æœƒåŸ·è¡Œ'); // æœƒåŸ·è¡Œï¼Œæ¥æ”¶åŸå§‹çš„ AJAX éŒ¯èª¤
    // é€™è£¡ä¸æœƒæ¥æ”¶åˆ° fail() å›å‚³çš„ defaultData
});
```

### catch() æ–¹æ³•å¯ä»¥æ¢å¾© Promise ç‹€æ…‹

**catch() æ–¹æ³•å¯ä»¥é€éå›å‚³å€¼å°‡ rejected Promise è½‰æ›ç‚º resolved Promise**

```javascript
$.ajax('/nonexistent-endpoint')
.catch(function(error) {
    console.log('catch æ–¹æ³•è™•ç†éŒ¯èª¤:', error);
    
    // æä¾›é è¨­è³‡æ–™ä¸¦æ¢å¾© Promise ç‹€æ…‹
    var recoveryData = {
        message: 'å·²æ¢å¾©ï¼Œä½¿ç”¨é è¨­è³‡æ–™',
        users: [
            { id: 1, name: 'é è¨­ç”¨æˆ¶', status: 'active' }
        ],
        isRecovered: true
    };
    
    return recoveryData; // é€™æœƒå°‡ Promise è½‰æ›ç‚º resolved ç‹€æ…‹
})
.then(function(data) {
    console.log('é€™å€‹ then æœƒåŸ·è¡Œ:', data.message); // æœƒåŸ·è¡Œä¸¦æ¥æ”¶ recoveryData
    console.log('è³‡æ–™å·²æ¢å¾©:', data.isRecovered); // true
});
```

### then() éŒ¯èª¤å›èª¿çš„ç‰¹æ®Šç”¨æ³•

å¦‚æœä½ æƒ³åœ¨ jQuery ç’°å¢ƒä¸­å¯¦ç¾é¡ä¼¼ catch() çš„æ¢å¾©åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ then() æ–¹æ³•çš„ç¬¬äºŒå€‹åƒæ•¸ï¼š

```javascript
$.ajax('/nonexistent-endpoint')
.then(
	ğŸ”¥ // åŒæ™‚è™•ç† ajax æˆåŠŸè·Ÿå¤±æ•—çš„æƒ…æ³ï¼Œè™•ç†å®Œæˆå¾Œï¼Œå†ä¸Ÿçµ¦ä¸‹ä¸€å€‹ then
    function(data) {
        // æˆåŠŸå›èª¿
        console.log('è«‹æ±‚æˆåŠŸ:', data);
        return data;
    },
    function(jqXHR, textStatus, errorThrown) {
        // éŒ¯èª¤å›èª¿ - é€™è£¡çš„å›å‚³å€¼å¯ä»¥æ¢å¾© Promise ç‹€æ…‹
        console.log('éŒ¯èª¤è™•ç†:', textStatus);
        
        var errorRecoveryData = {
            error: true,
            message: 'è«‹æ±‚å¤±æ•—ï¼Œä½†å·²è™•ç†',
            fallbackData: []
        };
        
        return errorRecoveryData; // é€™æœƒè®“ Promise è®Šæˆ resolved ç‹€æ…‹
    }
)
.then(function(result) {
    console.log('å¾ŒçºŒè™•ç†:', result);
    // é€™è£¡æœƒåŸ·è¡Œï¼Œä¸ç®¡åŸå§‹è«‹æ±‚æˆåŠŸé‚„æ˜¯å¤±æ•—
    // å¦‚æœå¤±æ•—ï¼Œresult å°±æ˜¯ errorRecoveryData
});
```

## ç¬¬äº”ç« ï¼šreturn å’Œ throw çš„åŒ…è£æ©Ÿåˆ¶è©³è§£

### jQuery å‚³çµ±æ–¹æ³•çš„ç›´æ¥å›å‚³

å‚³çµ±çš„ `done()`, `fail()`, `always()` æ–¹æ³•ä¸æœƒè‡ªå‹•åŒ…è£å›å‚³å€¼ã€‚å®ƒå€‘çš„å›å‚³å€¼æœƒè¢«å¿½ç•¥ï¼Œå¹¾ä¹æ²’ç”¨ ??

```javascript
$.ajax('/api/data')
.done(function(data) {
    var processedData = {
        original: data,
        processed: true,
        timestamp: Date.now()
    };
    
    return processedData; // é€™å€‹å›å‚³å€¼è¢«å¿½ç•¥ï¼Œä¸å½±éŸ¿å¾ŒçºŒçš„ done()
})
.done(function(data) {
    // é€™è£¡ä»ç„¶æ¥æ”¶åŸå§‹çš„ AJAX è³‡æ–™ï¼Œä¸æ˜¯ä¸Šé¢çš„ processedData
    console.log('ä»ç„¶æ˜¯åŸå§‹è³‡æ–™:', data);
});
```

### jQuery Promise æ–¹æ³•çš„è‡ªå‹•åŒ…è£

`then()`, `catch()`, `finally()` æ–¹æ³•æœƒè‡ªå‹•å°‡å›å‚³å€¼åŒ…è£æˆ Promiseï¼š

```javascript
$.ajax('/api/data')
.then(function(data) {
    var transformedData = data.items.map(function(item) {
        return {
            id: item.id,
            title: item.name.toUpperCase(),
            summary: item.description.substring(0, 100)
        };
    });
    
    return transformedData; // è‡ªå‹•åŒ…è£æˆ Promise.resolve(transformedData)
})
// å¾ä¸Šä¸€å€‹ then() æ‰€å›å‚³çš„ Promise ä¸­ï¼Œè§£æè³‡æ–™å–å¾— transformedDataï¼Œå†å‚³å…¥ä¸‹ä¸€å€‹ then()
.then(function(transformedData) {	
    console.log('æ¥æ”¶åˆ°è½‰æ›å¾Œçš„è³‡æ–™:', transformedData);
    console.log('è™•ç†å®Œæˆ');
	// å³ä½¿æ²’æœ‰æ˜ç¢ºçš„ return èªå¥
    // éš±å¼ return undefinedï¼Œæœƒè¢«åŒ…è£æˆ Promise.resolve(undefined)
})
.then(function(result) {
    console.log('é€™è£¡çš„ result æ˜¯:', result); // undefined
});
```

### éŒ¯èª¤æ‹‹å‡ºçš„å·®ç•°è™•ç†

åœ¨å‚³çµ±æ–¹æ³•ä¸­æ‹‹å‡ºéŒ¯èª¤å’Œåœ¨ Promise æ–¹æ³•ä¸­æ‹‹å‡ºéŒ¯èª¤ä¹Ÿæœ‰ä¸åŒçš„æ•ˆæœï¼š

```javascript
// åœ¨ done() ä¸­æ‹‹å‡ºéŒ¯èª¤
$.ajax('/api/data')
.done(function(data) {
    if (!data.isValid) {
        throw new Error('è³‡æ–™é©—è­‰å¤±æ•—'); // é€™å€‹éŒ¯èª¤å¯èƒ½ä¸æœƒè¢«æ­£ç¢ºè™•ç†
    }
	ğŸ”¥ // ç¶“æ¸¬è©¦ï¼Œé€™å€‹ return å³ä¸æ˜¯å‚³çµ¦å¾Œé¢çš„ done()ã€fail()ã€catch()ï¼Œä¹Ÿä¸æ˜¯å›å‚³åˆ°æ•´å€‹éˆå¼çµæœï¼Œå¹¾ä¹æ²’æœ‰ç”¨è™•
    return data;
})
.fail(function(jqXHR, textStatus, errorThrown) {
    console.log('fail ä¸æœƒæ•ç² done() ä¸­çš„éŒ¯èª¤'); // é€šå¸¸ä¸æœƒåŸ·è¡Œ
})
.catch(function(error) {
    console.log('catch ä¹Ÿä¸æœƒæ•ç² done() ä¸­çš„éŒ¯èª¤:', error.message); // æœƒåŸ·è¡Œ
});

// åœ¨ then() ä¸­æ‹‹å‡ºéŒ¯èª¤
$.ajax('/api/data')
.then(function(data) {
    if (!data.isValid) {
        throw new Error('è³‡æ–™é©—è­‰å¤±æ•—'); // é€™å€‹éŒ¯èª¤æœƒè¢«æ­£ç¢ºè™•ç†
    }
    return data;

	ğŸ”¥ // è¤‡ç¿’ä¸€ä¸‹ï¼Œåœ¨ Promise ä»¥ä¸‹æƒ…æ³ï¼Œæœƒè§¸ç™¼ catch
	// throw new Error('è³‡æ–™é©—è­‰å¤±æ•—')
	// Promise.reject(new Error('è³‡æ–™é©—è­‰å¤±æ•—'))
})
.catch(function(error) {
    console.log('catch æ•ç²éŒ¯èª¤:', error.message); // æœƒåŸ·è¡Œ
    return { isValid: true, data: [], isDefault: true }; // å¯ä»¥æ¢å¾©
})
.then(function(recoveredData) {
    console.log('ä½¿ç”¨æ¢å¾©çš„è³‡æ–™:', recoveredData); // æœƒåŸ·è¡Œ
});
```

## ç¬¬å…­ç« ï¼šAJAX éŒ¯èª¤åŸ·è¡Œæµç¨‹çš„å®Œæ•´åˆ†æ

### éŒ¯èª¤åŒæ™‚è§¸ç™¼å¤šå€‹è™•ç†å™¨

ç•¶ AJAX è«‹æ±‚å¤±æ•—æ™‚ï¼ŒjQuery Deferred æœƒåŒæ™‚è§¸ç™¼æ‰€æœ‰ç›¸é—œçš„éŒ¯èª¤è™•ç†æ–¹æ³•ï¼š

```javascript
$.ajax('/nonexistent-endpoint')
.done(function(data) {
    console.log('done: å› ç‚ºè«‹æ±‚å¤±æ•—ï¼Œé€™è£¡ä¸æœƒåŸ·è¡Œ');
})
.fail(function(jqXHR, textStatus, errorThrown) {
    console.log('1. fail åŸ·è¡Œ - æä¾›è©³ç´°éŒ¯èª¤è³‡è¨Š');
    console.log('   ç‹€æ…‹ç¢¼:', jqXHR.status);
    console.log('   éŒ¯èª¤é¡å‹:', textStatus);
    console.log('   éŒ¯èª¤è¨Šæ¯:', errorThrown);
    
    // å³ä½¿é€™è£¡ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œå¾Œé¢çš„ catch ä»ç„¶æœƒåŸ·è¡Œ
    // å› ç‚ºåŸå§‹çš„ AJAX éŒ¯èª¤æœƒç¹¼çºŒå‚³æ’­
})
.catch(function(error) {
    console.log('2. catch åŸ·è¡Œ - çµ±ä¸€éŒ¯èª¤è™•ç†');
    console.log('   æ•ç²åˆ°çš„éŒ¯èª¤:', error);
    
    // åªæœ‰åœ¨é€™è£¡å›å‚³å€¼ï¼Œæ‰èƒ½æ”¹è®Šå¾ŒçºŒçš„åŸ·è¡Œæµç¨‹
    return { handled: true, message: 'éŒ¯èª¤å·²è™•ç†' };
})
.then(function(result) {
    console.log('3. then åŸ·è¡Œ - æ¥æ”¶ catch çš„å›å‚³å€¼:', result);
})
.always(function() {
    console.log('4. always ç¸½æ˜¯åŸ·è¡Œ - æ¸…ç†å·¥ä½œ');
});
```

### è¤‡é›œéŒ¯èª¤è™•ç†ç­–ç•¥

åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œä½ å¯èƒ½éœ€è¦çµåˆä½¿ç”¨ä¸åŒçš„éŒ¯èª¤è™•ç†æ–¹æ³•ä¾†å¯¦ç¾å®Œæ•´çš„éŒ¯èª¤è™•ç†ç­–ç•¥ï¼š

```javascript
function handleUserRequest(userId) {
    return $.ajax('/api/users/' + userId)
    .fail(function(jqXHR, textStatus, errorThrown) {
        // è©³ç´°è¨˜éŒ„ AJAX å±¤ç´šçš„éŒ¯èª¤è³‡è¨Š
        logError('AJAX_ERROR', {
            url: '/api/users/' + userId,
            status: jqXHR.status,
            statusText: jqXHR.statusText,
            textStatus: textStatus,
            errorThrown: errorThrown,
            responseText: jqXHR.responseText
        });
        
        // fail() ä¸å˜—è©¦æ¢å¾©ï¼Œåªè² è²¬è¨˜éŒ„
    })
    .catch(function(error) {
        // æ ¹æ“šéŒ¯èª¤é¡å‹æä¾›ä¸åŒçš„æ¢å¾©ç­–ç•¥
        console.log('åŸ·è¡ŒéŒ¯èª¤æ¢å¾©ç­–ç•¥');
        
        if (error.status === 404) {
            // ç”¨æˆ¶ä¸å­˜åœ¨ï¼Œå›å‚³é è¨­ç”¨æˆ¶è³‡è¨Š
            return {
                id: userId,
                name: 'æœªçŸ¥ç”¨æˆ¶',
                status: 'inactive',
                isDefault: true
            };
        } else if (error.status >= 500) {
            // ä¼ºæœå™¨éŒ¯èª¤ï¼Œæ‹‹å‡ºæ–°çš„éŒ¯èª¤è®“ä¸Šå±¤è™•ç†
            throw new Error('ä¼ºæœå™¨æš«æ™‚ç„¡æ³•è™•ç†è«‹æ±‚ï¼Œè«‹ç¨å¾Œå†è©¦');
        } else {
            // å…¶ä»–éŒ¯èª¤ï¼Œå›å‚³ç©ºç”¨æˆ¶è³‡è¨Š
            return {
                id: null,
                name: 'è¼‰å…¥å¤±æ•—',
                status: 'error',
                isDefault: true
            };
        }
    })
    .then(function(userData) {
        // çµ±ä¸€è™•ç†æœ€çµ‚çš„ç”¨æˆ¶è³‡æ–™ï¼ˆç„¡è«–æ˜¯æˆåŠŸå–å¾—é‚„æ˜¯éŒ¯èª¤æ¢å¾©çš„ï¼‰
        if (userData.isDefault) {
            console.log('ä½¿ç”¨é è¨­æˆ–æ¢å¾©çš„ç”¨æˆ¶è³‡æ–™');
        }
        
        return {
            user: userData,
            timestamp: Date.now(),
            source: userData.isDefault ? 'fallback' : 'api'
        };
    });
}
```

## ç¬¬ä¸ƒç« ï¼šç‰ˆæœ¬å·®ç•°èˆ‡å¯¦å‹™æ‡‰ç”¨ç­–ç•¥

### Portal ç³»çµ±ï¼ˆjQuery 3.3.1ï¼‰çš„ç¾ä»£åŒ–é–‹ç™¼ç­–ç•¥

åœ¨è¼ƒæ–°çš„ jQuery ç‰ˆæœ¬ä¸­ï¼Œæˆ‘å€‘å¯ä»¥å……åˆ†åˆ©ç”¨ Promise çš„å„ªå‹¢ä¾†æ§‹å»ºæ›´æ¸…æ™°çš„ç•°æ­¥ç¨‹å¼ç¢¼ï¼š

```javascript
// æ¨è–¦çš„ç¾ä»£åŒ–éŒ¯èª¤è™•ç†æ¨¡å¼
function loadDashboardData() {
    // ä½¿ç”¨ Promise.all ä¸¦è¡Œè¼‰å…¥å¤šå€‹è³‡æ–™æº
    var userDataPromise = $.ajax('/api/current-user')
    .catch(function(error) {
        console.warn('ç”¨æˆ¶è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨è¨ªå®¢æ¨¡å¼');
        return { isGuest: true, name: 'è¨ªå®¢' };
    });
    
    var statisticsPromise = $.ajax('/api/statistics')
    .catch(function(error) {
        console.warn('çµ±è¨ˆè³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
        return { visits: 0, sales: 0, isDefault: true };
    });
    
    var notificationsPromise = $.ajax('/api/notifications')
    .catch(function(error) {
        console.warn('é€šçŸ¥è¼‰å…¥å¤±æ•—');
        return [];
    });
    
    return Promise.all([userDataPromise, statisticsPromise, notificationsPromise])
    .then(function(results) {
        var userData = results[0];
        var statistics = results[1];
        var notifications = results[2];
        
        return {
            user: userData,
            stats: statistics,
            notifications: notifications,
            loadTime: Date.now()
        };
    })
    .catch(function(error) {
        // å¦‚æœæ‰€æœ‰è«‹æ±‚éƒ½å¤±æ•—ï¼Œæä¾›æœ€åŸºæœ¬çš„é è¨­è³‡æ–™
        console.error('å„€è¡¨æ¿è³‡æ–™è¼‰å…¥å®Œå…¨å¤±æ•—:', error);
        return {
            user: { isGuest: true, name: 'è¨ªå®¢' },
            stats: { visits: 0, sales: 0, isDefault: true },
            notifications: [],
            error: true,
            message: 'éƒ¨åˆ†è³‡æ–™è¼‰å…¥å¤±æ•—'
        };
    });
}

// ä½¿ç”¨æ–¹å¼
loadDashboardData()
.then(function(dashboardData) {
    renderDashboard(dashboardData);
    
    if (dashboardData.error) {
        showWarningMessage('éƒ¨åˆ†è³‡æ–™ç„¡æ³•è¼‰å…¥ï¼Œé¡¯ç¤ºå¯ç”¨è³‡æ–™');
    }
})
.catch(function(error) {
    showErrorPage('å„€è¡¨æ¿ç„¡æ³•è¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
});
```

### GTS ç³»çµ±ï¼ˆjQuery 1.10.2ï¼‰çš„ç©©å®šé–‹ç™¼ç­–ç•¥

åœ¨è¼ƒèˆŠçš„ jQuery ç‰ˆæœ¬ä¸­ï¼Œå»ºè­°ä¸»è¦ä½¿ç”¨å‚³çµ±ä½†ç©©å®šçš„ Deferred æ–¹æ³•ï¼š

```javascript
// é©åˆèˆŠç‰ˆæœ¬çš„ç©©å®šéŒ¯èª¤è™•ç†æ¨¡å¼
function loadUserProfile(userId) {
    var loadingIndicator = showLoading('è¼‰å…¥ç”¨æˆ¶è³‡æ–™ä¸­...');
    
    $.ajax({
        url: '/api/users/' + userId,
        type: 'GET',
        timeout: 15000,
        cache: false,
        dataType: 'json'
    })
    .done(function(userData, textStatus, jqXHR) {
        // æˆåŠŸè¼‰å…¥ç”¨æˆ¶è³‡æ–™
        console.log('ç”¨æˆ¶è³‡æ–™è¼‰å…¥æˆåŠŸ:', userData.name);
        
        // é©—è­‰è³‡æ–™å®Œæ•´æ€§
        if (!userData.id || !userData.name) {
            handleIncompleteData(userData);
            return;
        }
        
        // æ¸²æŸ“ç”¨æˆ¶ä»‹é¢
        renderUserProfile(userData);
        updateUserMenu(userData);
        logUserActivity('profile_viewed', userData.id);
    })
    .fail(function(jqXHR, textStatus, errorThrown) {
        // è©³ç´°çš„éŒ¯èª¤è™•ç†
        console.error('ç”¨æˆ¶è³‡æ–™è¼‰å…¥å¤±æ•—:', {
            status: jqXHR.status,
            statusText: jqXHR.statusText,
            textStatus: textStatus,
            errorThrown: errorThrown
        });
        
        var errorMessage;
        var shouldRetry = false;
        
        switch (jqXHR.status) {
            case 401:
                errorMessage = 'ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥';
                redirectToLogin();
                break;
            case 403:
                errorMessage = 'æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•æŸ¥çœ‹æ­¤ç”¨æˆ¶è³‡æ–™';
                break;
            case 404:
                errorMessage = 'æ‰¾ä¸åˆ°æŒ‡å®šçš„ç”¨æˆ¶';
                break;
            case 408:
            case 504:
                errorMessage = 'è«‹æ±‚é€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š';
                shouldRetry = true;
                break;
            case 500:
            case 502:
            case 503:
                errorMessage = 'ä¼ºæœå™¨æš«æ™‚ç„¡æ³•è™•ç†è«‹æ±‚';
                shouldRetry = true;
                break;
            default:
                if (textStatus === 'timeout') {
                    errorMessage = 'é€£ç·šé€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦';
                    shouldRetry = true;
                } else if (textStatus === 'abort') {
                    errorMessage = 'è«‹æ±‚è¢«ä¸­æ­¢';
                } else {
                    errorMessage = 'è¼‰å…¥å¤±æ•—ï¼š' + (errorThrown || 'æœªçŸ¥éŒ¯èª¤');
                }
        }
        
        showErrorMessage(errorMessage);
        
        if (shouldRetry) {
            showRetryButton(function() {
                loadUserProfile(userId);
            });
        }
        
        // è¼‰å…¥é è¨­çš„è¨ªå®¢è³‡æ–™
        renderGuestProfile();
    })
    .always(function() {
        // æ¸…ç†å·¥ä½œ
        hideLoading(loadingIndicator);
        enableUserInterface();
    });
}
```

## ç¬¬å…«ç« ï¼šå¯¦å‹™é–‹ç™¼çš„æœ€ä½³å¯¦è¸èˆ‡æ¨¡å¼

### å»ºç«‹çµ±ä¸€çš„ AJAX å°è£å±¤

ç‚ºäº†åœ¨ä¸åŒå°ˆæ¡ˆä¸­ä¿æŒä¸€è‡´æ€§ï¼Œå»ºè­°å»ºç«‹ä¸€å€‹çµ±ä¸€çš„ AJAX å°è£å‡½æ•¸ï¼š

```javascript
// ç‚º Portal ç³»çµ±è¨­è¨ˆçš„ç¾ä»£åŒ–å°è£
function createApiClient() {
    var baseConfig = {
        timeout: 30000,
        cache: false,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    };
    
    function makeRequest(url, options) {
        var config = $.extend({}, baseConfig, { url: url }, options);
        
        return $.ajax(config)
        .then(function(data, textStatus, jqXHR) {
            // çµ±ä¸€çš„æˆåŠŸå›æ‡‰è™•ç†
            if (data && data.status === 'error') {
                // æ¥­å‹™å±¤ç´šçš„éŒ¯èª¤
                throw new Error(data.message || 'æ¥­å‹™è™•ç†å¤±æ•—');
            }
            
            return {
                data: data,
                status: jqXHR.status,
                headers: parseHeaders(jqXHR.getAllResponseHeaders()),
                timestamp: Date.now()
            };
        })
        .catch(function(error) {
            // çµ±ä¸€çš„éŒ¯èª¤è™•ç†å’Œè½‰æ›
            var standardError = {
                message: 'è«‹æ±‚å¤±æ•—',
                type: 'network_error',
                status: error.status || 0,
                timestamp: Date.now(),
                originalError: error
            };
            
            if (error.status) {
                switch (error.status) {
                    case 401:
                        standardError.type = 'auth_error';
                        standardError.message = 'éœ€è¦é‡æ–°ç™»å…¥';
                        break;
                    case 403:
                        standardError.type = 'permission_error';
                        standardError.message = 'æ¬Šé™ä¸è¶³';
                        break;
                    case 429:
                        standardError.type = 'rate_limit_error';
                        standardError.message = 'è«‹æ±‚éæ–¼é »ç¹';
                        break;
                    case 500:
                        standardError.type = 'server_error';
                        standardError.message = 'ä¼ºæœå™¨éŒ¯èª¤';
                        break;
                }
            }
            
            // è¨˜éŒ„éŒ¯èª¤
            logApiError(url, standardError);
            
            throw standardError;
        });
    }
    
    return {
        get: function(url, params) {
            return makeRequest(url, { type: 'GET', data: params });
        },
        post: function(url, data) {
            return makeRequest(url, { 
                type: 'POST', 
                data: JSON.stringify(data),
                contentType: 'application/json'
            });
        },
        put: function(url, data) {
            return makeRequest(url, { 
                type: 'PUT', 
                data: JSON.stringify(data),
                contentType: 'application/json'
            });
        },
        delete: function(url) {
            return makeRequest(url, { type: 'DELETE' });
        }
    };
}

// ä½¿ç”¨ç¯„ä¾‹
var apiClient = createApiClient();

apiClient.get('/api/users', { page: 1, limit: 10 })
.then(function(response) {
    console.log('æˆåŠŸè¼‰å…¥ç”¨æˆ¶åˆ—è¡¨:', response.data);
    renderUserList(response.data.users);
})
.catch(function(error) {
    console.error('è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨å¤±æ•—:', error);
    
    switch (error.type) {
        case 'auth_error':
            redirectToLogin();
            break;
        case 'permission_error':
            showPermissionError();
            break;
        default:
            showGenericError('ç„¡æ³•è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
});
```

### éŒ¯èª¤æ¢å¾©å’Œé™ç´šç­–ç•¥

åœ¨ä¼æ¥­ç´šæ‡‰ç”¨ä¸­ï¼Œå„ªé›…çš„éŒ¯èª¤è™•ç†å’Œæœå‹™é™ç´šæ˜¯éå¸¸é‡è¦çš„ï¼š

```javascript
// å¤šå±¤ç´šçš„éŒ¯èª¤æ¢å¾©ç­–ç•¥
function loadCriticalData() {
    return loadFromPrimaryAPI()
    .catch(function(primaryError) {
        console.warn('ä¸»è¦ API å¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨ API:', primaryError.message);
        return loadFromBackupAPI();
    })
    .catch(function(backupError) {
        console.warn('å‚™ç”¨ API ä¹Ÿå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å¿«å–:', backupError.message);
        return loadFromLocalCache();
    })
    .catch(function(cacheError) {
        console.warn('æœ¬åœ°å¿«å–ä¹Ÿå¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™:', cacheError.message);
        return getDefaultData();
    })
    .then(function(data) {
        // æ¨™è¨˜è³‡æ–™ä¾†æºï¼Œè®“ UI å¯ä»¥é©ç•¶åœ°é¡¯ç¤ºç‹€æ…‹
        if (data.source === 'default') {
            showDataSourceWarning('ä½¿ç”¨é è¨­è³‡æ–™ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™');
        } else if (data.source === 'cache') {
            showDataSourceInfo('ä½¿ç”¨å¿«å–è³‡æ–™ï¼Œå¯èƒ½ä¸æ˜¯æœ€æ–°è³‡è¨Š');
        }
        
        return data;
    });
}

function loadFromPrimaryAPI() {
    return $.ajax('/api/v2/data')
    .then(function(response) {
        return { ...response, source: 'primary' };
    });
}

function loadFromBackupAPI() {
    return $.ajax('/api/v1/data')
    .then(function(response) {
        return { ...response, source: 'backup' };
    });
}

function loadFromLocalCache() {
    var cachedData = localStorage.getItem('criticalData');
    if (cachedData) {
        try {
            var parsed = JSON.parse(cachedData);
            return Promise.resolve({ ...parsed, source: 'cache' });
        } catch (e) {
            return Promise.reject(new Error('å¿«å–è³‡æ–™æå£'));
        }
    }
    return Promise.reject(new Error('ç„¡å¿«å–è³‡æ–™'));
}

function getDefaultData() {
    return Promise.resolve({
        items: [],
        total: 0,
        message: 'ç„¡å¯ç”¨è³‡æ–™',
        source: 'default'
    });
}
```

### é€²éšéŒ¯èª¤è™•ç†æ¨¡å¼

å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæˆ‘å€‘é‚„éœ€è¦è€ƒæ…®é‡è©¦æ©Ÿåˆ¶ã€æ–·è·¯å™¨æ¨¡å¼ç­‰é€²éšç­–ç•¥ï¼š

```javascript
// å¯¦ä½œé‡è©¦æ©Ÿåˆ¶çš„ AJAX å°è£
function ajaxWithRetry(options, maxRetries = 3, retryDelay = 1000) {
    var attempt = 0;
    
    function makeAttempt() {
        attempt++;
        
        return $.ajax(options)
        .catch(function(error) {
            console.log(`è«‹æ±‚å¤±æ•—ï¼Œå˜—è©¦ ${attempt}/${maxRetries + 1}:`, error.status);
            
            // åˆ¤æ–·æ˜¯å¦æ‡‰è©²é‡è©¦
            var shouldRetry = attempt <= maxRetries && 
                             (error.status >= 500 || 
                              error.status === 0 || 
                              error.status === 408 ||
                              error.status === 429);
            
            if (shouldRetry) {
                // æŒ‡æ•¸é€€é¿ç­–ç•¥
                var delay = retryDelay * Math.pow(2, attempt - 1);
                console.log(`${delay}ms å¾Œé‡è©¦...`);
                
                return new Promise(function(resolve) {
                    setTimeout(resolve, delay);
                }).then(makeAttempt);
            } else {
                // ä¸å†é‡è©¦ï¼Œæ‹‹å‡ºæœ€çµ‚éŒ¯èª¤
                throw error;
            }
        });
    }
    
    return makeAttempt();
}

// ä½¿ç”¨é‡è©¦æ©Ÿåˆ¶
ajaxWithRetry({
    url: '/api/important-data',
    type: 'GET',
    timeout: 5000
}, 3, 1000)
.then(function(data) {
    console.log('è³‡æ–™è¼‰å…¥æˆåŠŸ:', data);
})
.catch(function(error) {
    console.error('å¤šæ¬¡é‡è©¦å¾Œä»ç„¶å¤±æ•—:', error);
    showCriticalError('ç³»çµ±æš«æ™‚ç„¡æ³•å­˜å–ï¼Œè«‹è¯çµ¡æŠ€è¡“æ”¯æ´');
});
```

### æ‰¹æ¬¡è«‹æ±‚çš„éŒ¯èª¤è™•ç†

åœ¨éœ€è¦è¼‰å…¥å¤šå€‹ç›¸é—œè³‡æ–™çš„æƒ…æ³ä¸‹ï¼Œé©ç•¶çš„éŒ¯èª¤è™•ç†ç­–ç•¥å¾ˆé‡è¦ï¼š

```javascript
// éƒ¨åˆ†æˆåŠŸçš„æ‰¹æ¬¡è¼‰å…¥ç­–ç•¥
function loadUserDashboard(userId) {
    var requests = {
        profile: $.ajax('/api/users/' + userId),
        permissions: $.ajax('/api/users/' + userId + '/permissions'),
        preferences: $.ajax('/api/users/' + userId + '/preferences'),
        notifications: $.ajax('/api/users/' + userId + '/notifications'),
        analytics: $.ajax('/api/users/' + userId + '/analytics')
    };
    
    // ç‚ºæ¯å€‹è«‹æ±‚æ·»åŠ éŒ¯èª¤æ¢å¾©
    var safeRequests = {};
    Object.keys(requests).forEach(function(key) {
        safeRequests[key] = requests[key].catch(function(error) {
            console.warn(`${key} è¼‰å…¥å¤±æ•—:`, error.status);
            
            // ç‚ºä¸åŒé¡å‹çš„è³‡æ–™æä¾›ä¸åŒçš„é è¨­å€¼
            switch (key) {
                case 'profile':
                    return { name: 'æœªçŸ¥ç”¨æˆ¶', status: 'inactive' };
                case 'permissions':
                    return { canEdit: false, canDelete: false, canView: true };
                case 'preferences':
                    return { theme: 'light', language: 'zh-TW' };
                case 'notifications':
                    return [];
                case 'analytics':
                    return { views: 0, clicks: 0, conversions: 0 };
                default:
                    return null;
            }
        });
    });
    
    // ç­‰å¾…æ‰€æœ‰è«‹æ±‚å®Œæˆï¼ˆåŒ…æ‹¬å¤±æ•—å¾Œçš„æ¢å¾©ï¼‰
    return Promise.all([
        safeRequests.profile,
        safeRequests.permissions,
        safeRequests.preferences,
        safeRequests.notifications,
        safeRequests.analytics
    ])
    .then(function(results) {
        return {
            profile: results[0],
            permissions: results[1],
            preferences: results[2],
            notifications: results[3],
            analytics: results[4],
            loadTime: Date.now(),
            hasPartialFailures: Object.keys(requests).some(function(key, index) {
                return results[index] && results[index].constructor === Object && 
                       Object.keys(results[index]).length < 3; // ç°¡å–®æª¢æŸ¥æ˜¯å¦ç‚ºé è¨­å€¼
            })
        };
    });
}
```

## ç¬¬ä¹ç« ï¼šé™¤éŒ¯èˆ‡æ¸¬è©¦ç­–ç•¥

### é–‹ç™¼éšæ®µçš„éŒ¯èª¤è¿½è¹¤

åœ¨é–‹ç™¼éç¨‹ä¸­ï¼Œå»ºç«‹å®Œæ•´çš„éŒ¯èª¤è¿½è¹¤æ©Ÿåˆ¶æœ‰åŠ©æ–¼å¿«é€Ÿå®šä½å•é¡Œï¼š

```javascript
// é–‹ç™¼ç’°å¢ƒçš„è©³ç´°éŒ¯èª¤è¨˜éŒ„
function setupAjaxDebugging() {
    // æ””æˆªæ‰€æœ‰ AJAX è«‹æ±‚
    $(document).ajaxSend(function(event, jqXHR, settings) {
        console.group(`ğŸš€ AJAX è«‹æ±‚: ${settings.type} ${settings.url}`);
        console.log('è¨­å®š:', settings);
        console.log('Headers:', jqXHR.getAllResponseHeaders());
        console.time('è«‹æ±‚æ™‚é–“');
    });
    
    $(document).ajaxComplete(function(event, jqXHR, settings) {
        console.timeEnd('è«‹æ±‚æ™‚é–“');
        console.log(`ğŸ“¥ å›æ‡‰ç‹€æ…‹: ${jqXHR.status} ${jqXHR.statusText}`);
        console.groupEnd();
    });
    
    $(document).ajaxError(function(event, jqXHR, settings, errorThrown) {
        console.group(`âŒ AJAX éŒ¯èª¤: ${settings.type} ${settings.url}`);
        console.error('ç‹€æ…‹:', jqXHR.status);
        console.error('éŒ¯èª¤:', errorThrown);
        console.error('å›æ‡‰:', jqXHR.responseText);
        console.groupEnd();
    });
}

// åœ¨é–‹ç™¼ç’°å¢ƒä¸­å•Ÿç”¨
if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
    setupAjaxDebugging();
}
```

### å–®å…ƒæ¸¬è©¦çš„éŒ¯èª¤è™•ç†é©—è­‰

```javascript
// ä½¿ç”¨ QUnit æ¸¬è©¦éŒ¯èª¤è™•ç†è¡Œç‚º
QUnit.module('AJAX éŒ¯èª¤è™•ç†æ¸¬è©¦');

QUnit.test('done() æ–¹æ³•ä¸æœƒå‚³éå›å‚³å€¼', function(assert) {
    var done = assert.async(2);
    var firstDoneData, secondDoneData;
    
    // æ¨¡æ“¬æˆåŠŸçš„ AJAX å›æ‡‰
    var mockData = { id: 1, name: 'Test User' };
    var deferred = $.Deferred();
    
    deferred.promise()
    .done(function(data) {
        firstDoneData = data;
        assert.deepEqual(data, mockData, 'ç¬¬ä¸€å€‹ done æ¥æ”¶åŸå§‹è³‡æ–™');
        done();
        
        return { processed: true, name: data.name.toUpperCase() };
    })
    .done(function(data) {
        secondDoneData = data;
        assert.deepEqual(data, mockData, 'ç¬¬äºŒå€‹ done ä»æ¥æ”¶åŸå§‹è³‡æ–™');
        assert.notOk(data.processed, 'ç¬¬äºŒå€‹ done æ²’æœ‰æ¥æ”¶åˆ°ç¬¬ä¸€å€‹ done çš„å›å‚³å€¼');
        done();
    });
    
    deferred.resolve(mockData);
});

QUnit.test('fail() æ–¹æ³•ç„¡æ³•æ¢å¾© Promise ç‹€æ…‹', function(assert) {
    var done = assert.async(2);
    var failExecuted = false;
    var thenExecuted = false;
    
    var deferred = $.Deferred();
    
    deferred.promise()
    .fail(function(error) {
        failExecuted = true;
        assert.ok(true, 'fail æ–¹æ³•åŸ·è¡Œ');
        done();
        
        return { recovered: true, data: 'default' };
    })
    .then(function(data) {
        thenExecuted = true;
        assert.ok(false, 'then ä¸æ‡‰è©²åŸ·è¡Œ');
    })
    .catch(function(error) {
        assert.ok(failExecuted, 'fail å·²åŸ·è¡Œ');
        assert.notOk(thenExecuted, 'then æ²’æœ‰åŸ·è¡Œ');
        assert.equal(error, 'test error', 'catch æ¥æ”¶åŸå§‹éŒ¯èª¤');
        done();
    });
    
    deferred.reject('test error');
});
```

## ç¸½çµèˆ‡æ ¸å¿ƒé‡é»

ç¶“éæ·±å…¥çš„è¨è«–ã€æ¸¬è©¦å’Œé©—è­‰ï¼Œæˆ‘å€‘å¾—å‡ºäº†ä»¥ä¸‹æ ¸å¿ƒçµè«–ï¼š

### æœ€é‡è¦çš„ç™¼ç¾

**ç¬¬ä¸€å€‹æ ¸å¿ƒç™¼ç¾**ï¼šjQuery çš„ `done()` æ–¹æ³•æ¡ç”¨è§€å¯Ÿè€…æ¨¡å¼ï¼Œå¤šå€‹ `done()` éƒ½æ¥æ”¶ç›¸åŒçš„åŸå§‹ AJAX è³‡æ–™ï¼Œä¸æœƒå½¢æˆè³‡æ–™å‚³ééˆã€‚é€™èˆ‡æˆ‘å€‘æœ€åˆçš„ç†è§£å®Œå…¨ä¸åŒã€‚

**ç¬¬äºŒå€‹æ ¸å¿ƒç™¼ç¾**ï¼š`fail()` æ–¹æ³•ç„¡æ³•é€éå›å‚³å€¼æ”¹è®Š Promise éˆçš„ç‹€æ…‹ã€‚å³ä½¿ `fail()` å›å‚³äº†è³‡æ–™ï¼Œå¾ŒçºŒçš„ `then()` ä»ç„¶ä¸æœƒåŸ·è¡Œï¼Œ`catch()` ä»ç„¶æœƒæ¥æ”¶åŸå§‹éŒ¯èª¤ã€‚

**ç¬¬ä¸‰å€‹æ ¸å¿ƒç™¼ç¾**ï¼šåªæœ‰ `then()`, `catch()`, `finally()` é€™äº› Promise æ–¹æ³•æ‰èƒ½å½¢æˆçœŸæ­£çš„éˆå¼å‚³éå’Œç‹€æ…‹è½‰æ›ã€‚

### å¯¦å‹™æ‡‰ç”¨æŒ‡å—

åœ¨è¯ç¢©çš„å…©å€‹ç³»çµ±é–‹ç™¼ä¸­ï¼š

**Portal ç³»çµ±ï¼ˆjQuery 3.3.1ï¼‰** å»ºè­°æ¡ç”¨ç¾ä»£ Promise æ¨¡å¼ï¼š

- ä½¿ç”¨ `then()/catch()` é€²è¡Œè³‡æ–™è½‰æ›å’ŒéŒ¯èª¤æ¢å¾©
- å»ºç«‹çµ±ä¸€çš„ API å®¢æˆ¶ç«¯å°è£
- å¯¦ä½œé‡è©¦æ©Ÿåˆ¶å’Œé™ç´šç­–ç•¥
- å……åˆ†åˆ©ç”¨ Promise.all å’Œ async/await èªæ³•

**GTS ç³»çµ±ï¼ˆjQuery 1.10.2ï¼‰** å»ºè­°ä¿æŒå‚³çµ±æ¨¡å¼çš„ç©©å®šæ€§ï¼š

- ä¸»è¦ä½¿ç”¨ `done()/fail()/always()`
- `fail()` å°ˆæ³¨æ–¼éŒ¯èª¤è¨˜éŒ„å’Œåˆ†æ
- é¿å…æ··ç”¨å‚³çµ±æ–¹æ³•å’Œ Promise æ–¹æ³•
- å»ºç«‹æ¸…æ™°çš„éŒ¯èª¤åˆ†é¡å’Œè™•ç†æµç¨‹

### é—œéµæé†’

1. **æ°¸é è¨˜ä½**ï¼š`done()` ä¸æœƒå‚³éè³‡æ–™ï¼Œæ¯å€‹ `done()` éƒ½æ¥æ”¶åŸå§‹è³‡æ–™
2. **æ°¸é è¨˜ä½**ï¼š`fail()` ä¸èƒ½æ¢å¾©éŒ¯èª¤ç‹€æ…‹ï¼Œè¦ç”¨ `catch()` æˆ– `then()` çš„éŒ¯èª¤å›èª¿
3. **ä¿æŒä¸€è‡´æ€§**ï¼šåœ¨åŒä¸€å€‹å°ˆæ¡ˆä¸­é¿å…æ··ç”¨ä¸åŒçš„éŒ¯èª¤è™•ç†æ¨¡å¼
4. **æ¸¬è©¦é©—è­‰**ï¼šä»»ä½•é—œæ–¼ jQuery è¡Œç‚ºçš„å‡è¨­éƒ½æ‡‰è©²é€éå¯¦éš›æ¸¬è©¦ä¾†é©—è­‰

é€™äº›ç†è§£å°‡å¹«åŠ©æˆ‘å€‘åœ¨æ—¥å¸¸é–‹ç™¼ä¸­åšå‡ºæ›´æº–ç¢ºçš„æŠ€è¡“æ±ºç­–ï¼Œé¿å…å¸¸è¦‹çš„é™·é˜±ï¼Œä¸¦å»ºç«‹æ›´ç©©å¥çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ã€‚